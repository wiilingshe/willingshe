angular.module("usercenter.account",["usercenter.relEmail"]),angular.module("usercenter.account").controller("UsercenterAccountCtrl",["$location","$rootScope","$scope","$window","usercenterService","$modal","ModalService","i18nNotifications","security","thirdpartyService","$translate","$timeout",function(e,n,t,r,o,c,s,i,a,u,l,d){function p(){t.progress="0",1==t.userinfo.checkEmail&&1==t.userinfo.checkPhone&&(t.redColor=!1,d(function(){t.progress="90"},100)),1!=t.userinfo.checkEmail&&1!=t.userinfo.checkPhone&&(d(function(){t.progress="20"},100),t.redColor=!0),(1!=t.userinfo.checkEmail&&1==t.userinfo.checkPhone||1==t.userinfo.checkEmail&&1!=t.userinfo.checkPhone)&&(t.redColor=!1,d(function(){t.progress="60"},100))}function m(e){e&&(e.state&&/WECHAT_STATE/.test(e.state)?(y={code:e.code,type:"weixin"},u.bindAccountCommon(y)):u.qqBindAccount(e))}t.PREFIX_CLIENT_HOST=PREFIX_HOST,t.XdpageSize=10,t.page={},t.pageChanged=function(e){return 1>e||e>t.branchesCount/10+1?void alert("此页超出范围"):(t.currentPage=e,void t.getBranches(e))},t.getBranches=function(e){o.getBranches(t.XdpageSize,e).then(function(e){e.data.success&&(t.branches=e.data.list,t.branchesCount=e.data.map.count,t.page.currentPage=e.data.map.pageNo,t.toPage=e.data.map.pageNo,t.branchesNumPages=Math.ceil(t.branchesCount/t.XdpageSize),f())},function(){})},t.getBranches(t.pageNo),t.branchName={};var f=function(){var r=e.search().branchid;if(r)for(var o=0;o<t.branches.length;o++)t.branches[o].id==r&&(t.branchName.name=t.branches[o].loginName);else n.branchid="",e.search("branchid",null)};t.$watch("branchid",function(e,n){e!=n&&f()}),t.changeCurrent=function(){n.branchid="",e.search("branchid",null)},t.selectBranch=function(t){n.branchid=t.id,e.path("main"),e.search({branchid:n.branchid})},t.$watch("userinfo",function(e){e&&p()});var h=/^EQS.*qq$/,g=/^EQS.*weixin$/;t.qqShow=!0,t.weixinShow=!0,h.test(a.currentUser.loginName)&&(t.qqShow=!1),g.test(a.currentUser.loginName)&&(t.weixinShow=!1);var v=null;t.goReset=function(){v=c.open({windowClass:"six-contain",templateUrl:BASE_URL+"templates/usercenter.tab.reset.tpl.html",controller:"UsercenterAccountCtrl",scope:t}).result.then(function(){v=null},function(){v=null})},t.checkOldPassword=function(){return t.password.old?(t.oldPassError="",!0):(t.oldPassError="原始密码不能为空",!1)},t.checkPassword=function(){if(t.password.newPw){if(/^[a-zA-Z0-9]{6,16}$/g.test(t.password.newPw))return t.passError="",!0;t.passError="密码为6~16个字符(英文字母或数字，区分大小写)"}else t.passError="新密码不能为空";return!1},t.checkRepeatPassword=function(){if(t.password.confirm){if(t.password.confirm==t.password.newPw)return t.rPassError="",!0;t.rPassError="两次密码输入不一致，请重新输入"}else t.rPassError="确认密码不能为空";return!1},t.reset=function(){if(t.checkOldPassword()&&t.checkPassword()&&t.checkRepeatPassword()){if(angular.equals(t.master,t.password))return void(t.authError="请不要重复提交！");t.oldPassError="",t.passError="",t.rPassError="",a.resetPassword(t.password.old,t.password.newPw).then(function(e){e.data.success?(i.pushForCurrentRoute("reset.psw.success","notify.success"),t.master=angular.copy(t.password),t.$close(t.master)):t.oldPassError=e.data.msg})}},t.quXiao=function(){t.$dismiss()},t.manageBranch=function(e){var n=e;if(!e)if(3==a.currentUser.memberType){if(t.branchesCount>=100)return void s.openMsgDialog({msg:"子账号数量已达到限制!"})}else if(2==a.currentUser.memberType){if(t.branchesCount>=50)return void s.openMsgDialog({msg:"子账号数量已达到限制!"})}else if(t.branchesCount>=30)return void s.openMsgDialog({msg:"子账号数量已达到限制!"});c.open({windowClass:"console six-contain branch-contain",templateUrl:BASE_URL+"templates/usercenter.console.branch.html",controller:"BranchCtrl",resolve:{branch:function(){return e}}}).result.then(function(r){e||(e={}),r.dept&&(e.deptId=r.dept.id,e.deptName=r.dept.name),e.name=r.name,e.id=r.id,e.extPermi=r.extPermi,n?t.branchesCount++:(e.loginName=r.loginName,e.status=1,e.regTime=(new Date).getTime(),t.branches.unshift(e),t.branches.length>10&&t.branches.splice(t.branches.length-1,1)),t.$emit("addBranch",e)},function(){})},t.openBranch=function(e,n){o.openBranch(e.id,n).then(function(t){t.data.success&&(n?(e.status=1,i.pushForCurrentRoute("branch.open.success","notify.success")):(e.status=2,i.pushForCurrentRoute("branch.close.success","notify.success")))},function(){alert("服务器异常")})},t.$on("rel.success",function(e,n){i.pushForCurrentRoute("mail.rel.success","notify.success"),"weixin"==n?t.wxRel=!0:"qq"==n&&(t.qqRel=!0)}),t.$watch("currentPage.branchCurrentPage",function(e,n){e!=n&&(t.getBranches(e),t.branchToPage=e)}),t.checkMobile=function(e){c.open({windowClass:"six-contain mobile-contain",templateUrl:BASE_URL+"templates/usercenter.console.checkMobile.html",controller:"CheckMobileCtrl",scope:t,resolve:{userinfo:function(){return{title:e,phone:t.userinfo.phone}}}}).result.then(function(e){t.userinfo.phone=e,t.userinfo.checkPhone=1},function(){})},t.createAccount=function(){t.emailAccount=!1,c.open({windowClass:"six-contain",templateUrl:BASE_URL+"templates/usercenter.console.register.html",controller:"RelRegisterAccountCtrl",scope:t,resolve:{userinfo:function(){return{id:t.userinfo.id}}}}).result.then(function(n){t.userinfo.noRel=null,t.userinfo.loginName=n.email,/qq/gi.test(n.type)&&(t.qqRel=!0),/weixin/gi.test(n.type)&&(t.wxRel=!0),/weibo/gi.test(n.type)&&(t.wbRel=!0),e.search("bindemail",null)},function(){e.search("bindemail",null)})},t.relAccount=function(n){t.emailAccount=!1,c.open({windowClass:"six-contain",templateUrl:BASE_URL+"templates/usercenter.console.relAccount.html",controller:"RelAccountCtrl",scope:t,resolve:{userinfo:function(){return{id:t.userinfo.id}}}}).result.then(function(n){t.userinfo.noRel=null,t.userinfo.loginName=n.email,/qq/gi.test(n.type)&&(t.qqRel=!0),/weixin/gi.test(n.type)&&(t.wxRel=!0),/weibo/gi.test(n.type)&&(t.wbRel=!0),e.search("bindemail",null)},function(){e.search("bindemail",null)})},t.relEmail=function(e){return t.userinfo.noRel?(alert("请先绑定账号"),void t.createAccount()):void c.open({windowClass:"six-contain",templateUrl:BASE_URL+"templates/usercenter.console.relEmail.html",controller:"RelEmailCtrl",scope:t,resolve:{userinfo:function(){return{id:t.userinfo.id,email:t.userinfo.email,checkEmail:t.userinfo.checkEmail,title:e}}}}).result.then(function(){},function(){})},t.verifyEmail=function(){o.verifyEmail().then(function(e){200==e.data.code&&s.openMsgDialog({msg:"申请绑定成功,已向您的邮箱发送验证邮件,请注意查收。"},function(){})},function(e){})},t.bindThirdAccount=function(e){return t.userinfo.noRel?(alert("请先绑定账号"),void t.createAccount()):void u.openThirtyPartyWindow(e)},t.unbindRelation=function(e){u.unbindRelation(e)},t.$on("mail.unbind.success",function(e,n){i.pushForCurrentRoute("mail.unbind.success","notify.success"),"weixin"==n?t.wxRel=!1:"qq"==n&&(t.qqRel=!1)});var y;r.setValue=function(e){t.bindParam=e,m(t.bindParam),t.$apply()},t.emailAccount=!1,t.upgradeCompany=function(){"eqs"==t.userinfo.loginName.substr(0,3)&&null==t.userinfo.email?t.emailAccount=!0:c.open({windowClass:"seven-contain",templateUrl:BASE_URL+"templates/usercenter.console.upgrade_company.html",controller:"UsercenterupgradeCtrl",resolve:{user:function(){return{id:t.userinfo.id}}}}).result.then(function(e){t.userinfo.phone=e,t.userinfo.checkPhone=1,a.currentUser.type=2},function(){})},t.companyMes=!0,t.$on("companyState",function(){t.companyInfo||(t.companyInfo={}),t.companyMes=!1,t.userinfo.type=2})}]),angular.module("usercenter.apply",["services.usercenter","services.i18nNotifications"]),angular.module("usercenter.apply").controller("ApplyCtrl",["$rootScope","$scope","usercenterService","$modal","ModalService","i18nNotifications","MineService","userinfo","$translate","$timeout",function(e,n,t,r,o,c,s,a,u,l){function d(){0===P?(n.isCodeAccessiable=!1,n.codeTip="获取验证码",P=60):(n.isCodeAccessiable=!0,n.codeTip="重新发送("+P+")",l(function(){P--,d()},1e3))}n.applyInfo={},n.applyInfo.nick=a.nick,n.invoiceStat=a.invoice,n.actionerror="",n.serverLabel=[],n.cateLabel=[],n.payLabel=[];var p;n.applyXiuke=!0,n.title=a.title,0===a.status||3===a.status?(p=0,n.applyXiuke=!0):(p=1,n.applyXiuke=!1);var m=function(e){t.getAPPlyMessage(e).then(function(t){"province"===e?(n.serverLabel=t.data.list,t.data.list.length>0&&(n.moreArea=!0)):"company_industry"===e?(n.cateLabel=t.data.list,t.data.list.length>0&&(n.moreLabel=!0)):"payType"===e&&(n.payLabel=t.data.list)})};m("province"),m("company_industry"),m("payType"),n.cancel=function(){n.$dismiss()},n.cate_cancel=function(e){for(var t=0;t<n.cateLabel.length;t++)if(n.cateLabel[t].ischecked=!1,n.cateSelected.length>0)for(var r=0;r<n.cateSelected.length;r++)n.cateLabel[t].id===n.cateSelected[r].id&&(n.cateLabel[t].ischecked=!0);n.cateError="",setTimeout(function(){$(e.target).parents(".dropdown.open").trigger("click")})},n.server_cancel=function(e){for(i=0;i<n.serverLabel.length;i++)if(n.serverLabel[i].ischecked=!1,n.serverSelected.length>0)for(k=0;k<n.serverSelected.length;k++)n.serverLabel[i].id===n.serverSelected[k].id&&(n.serverLabel[i].ischecked=!0);setTimeout(function(){$(e.target).parents(".dropdown.open").trigger("click")}),n.serverError=""},n.scene_cancel=function(e){for(i=0;i<n.myShowScene.length;i++)if(n.myShowScene[i].ischecked=!1,n.sceneSelected.length>0)for(k=0;k<n.sceneSelected.length;k++)n.myShowScene[i].id===n.sceneSelected[k].id&&(n.myShowScene[i].ischecked=!0);setTimeout(function(){$(e.target).parents(".dropdown.open").trigger("click")}),n.sceneError=""},n.checkIntroFormat=function(e){return e.shortIntroduction?countCharacters(e.shortIntroduction)>30?(n.introError="简短介绍不能超过30个字符",!1):(n.introError="",!0):(n.introError="请填写简短介绍",!1)},n.checkIntroFormat1=function(e){return e.introduction?countCharacters(e.introduction)>400?(n.introError1="秀客介绍不能超过400个字符",!1):(n.introError1="",!0):(n.introError1="请填写秀客介绍",!1)},t.getUserScene().then(function(e){e.data.list.length>0?n.myShowScene=e.data.list:n.myShowScene=null});var f=[];n.sceneSelected=[],n.sceneSelect=function(e,t,r){return f=[],angular.forEach(n.myShowScene,function(e){e.ischecked&&f.push({code:e.code,name:e.name})}),3!==f.length?(n.sceneError="请选择三个代表作品",!1):(n.sceneSelected=f,n.sceneNull="",void(r&&(setTimeout(function(){$(t.target).parents(".dropdown.open").trigger("click")}),n.sceneError="")))};var h=function(){return 3!==n.sceneSelected.length?(n.sceneNull="请选择三个代表作品",!1):(n.sceneNull="",!0)},g=[],v=[];n.serverSelected=[],n.serverSubmit=function(e,t,r){return g=[],angular.forEach(n.serverLabel,function(e){e.ischecked&&g.push({name:e.name,id:e.id})}),g.length<=0?void(n.serverError="请选择服务地域"):g.length>3?void(n.serverError="服务地域不能超过3个"):(n.serverSelected=g,void(r&&(setTimeout(function(){$(t.target).parents(".dropdown.open").trigger("click")}),n.serverError="",n.serverNull="")))};var y=function(){return n.serverSelected.length<=0||n.serverSelected.length>3?(n.serverNull="请选择1-3个服务地域",!1):(n.serverNull="",!0)},E=[],b=[];n.cateSelected=[],n.queren=function(e,t,r){return E=[],angular.forEach(n.cateLabel,function(e){e.ischecked&&E.push({name:e.name,id:e.id})}),E.length<=0?void(n.cateError="请选择擅长领域"):E.length>3?void(n.cateError="擅长领域不能超过3个"):(n.cateSelected=E,n.cateNull="",void(r&&(setTimeout(function(){$(t.target).parents(".dropdown.open").trigger("click")}),n.cateError="")))};var S=function(){return n.cateSelected.length<=0||n.cateSelected.length>3?(n.cateNull="请选择1-3个擅长领域",!1):(n.cateNull="",!0)},C=[],w=function(){C=[];var e=!1;return angular.forEach(n.payLabel,function(n){n.ischecked&&(C.push(n.id),e=!0)}),C=C.join(","),e?(n.payError="",!0):(n.payError="请选择支付方式",!1)},I=/^[0-9]*$/;n.checkQQFormat=function(e){return e.qq&&!I.test(e.qq)?(n.qqError="qq填写格式错误",!1):e.qq?(n.qqError="",!0):(n.qqError="请填写QQ号码",!1)};var R=function(e){return e.wechat?(n.wechatError="",!0):(n.wechatError="请填写微信号",!1)};n.checkEmailFormat=function(e){var t=/^([a-zA-Z0-9]+[_|\_|\.|-]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[\.|-]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;return e.email&&!t.test(e.email)?(n.emailError="邮箱格式不正确",!1):e.email?(n.emailError="",!0):(n.emailError="邮箱不能为空",!1)},n.checkCode=function(e){return e.code?(n.codeError="",!0):(n.codeError="请输入手机验证码",!1)},n.getCode=function(e,r){return e.phone?(n.telError="",void t.relMobileCode(e.phone,r).then(function(e){e.data.success?d():n.telError=e.data.msg})):(n.telError="请填写手机号码",!1)};var P=60;n.checkFormFormat=function(e){return!!(n.checkIntroFormat(e)&&n.checkIntroFormat1(e)&&h()&&y()&&S()&&w()&&n.checkQQFormat(e)&&R(e)&&n.checkEmailFormat(e))},n.submit=function(e){if(n.checkFormFormat(e)){for(U&&!U.checkPhone&&1!==U.checkPhone&&n.checkCode(e),v=[],b=[],k=0;k<n.cateSelected.length;k++)b.push(n.cateSelected[k].id);for(_cateSelected2=b.join(","),i=0;i<n.serverSelected.length;i++)v.push(n.serverSelected[i].id);_serverSelected2=v.join(",");var r={shortIntroduction:e.shortIntroduction,introduction:e.introduction,represent1:n.sceneSelected[0].code+"_"+n.sceneSelected[0].name,represent2:n.sceneSelected[1].code+"_"+n.sceneSelected[1].name,represent3:n.sceneSelected[2].code+"_"+n.sceneSelected[2].name,qq:e.qq,wechat:e.wechat,phone:e.phone,email:e.email,addr:_serverSelected2||"",pay:C||"",good:_cateSelected2||"",code:e.code,type:p};t.saveApplyInfo(r).then(function(e){e.data.success?(n.applyInfo=e.data.map.status,c.pushForCurrentRoute("visitor.apply","notify.success"),n.$close(n.applyInfo)):n.authError=e.data.msg})}},n.checkFormFormat2=function(e){return!!(n.checkIntroFormat(e)&&n.checkIntroFormat1(e)&&h()&&y()&&S()&&w()&&n.checkQQFormat(e)&&R(e)&&n.checkEmailFormat(e))},n.reset=function(e){if(n.sceneSelect(),n.serverSubmit(),n.queren(),n.checkFormFormat2(e)){for(b=[],k=0;k<n.cateSelected.length;k++)b.push(n.cateSelected[k].id);for(_cateSelected2=b.join(","),v=[],i=0;i<n.serverSelected.length;i++)v.push(n.serverSelected[i].id);_serverSelected2=v.join(",");var r={nick:n.applyInfo.nick,shortIntroduction:e.shortIntroduction,introduction:e.introduction,represent1:n.sceneSelected[0].code+"_"+n.sceneSelected[0].name,represent2:n.sceneSelected[1].code+"_"+n.sceneSelected[1].name,represent3:n.sceneSelected[2].code+"_"+n.sceneSelected[2].name,qq:e.qq,wechat:e.wechat,email:e.email,addr:_serverSelected2||"",pay:C||"",good:_cateSelected2||"",type:p,phone:e.phone,code:e.code};t.resetApplyInfo(r).then(function(e){e.data.success?(c.pushForCurrentRoute("visitor.apply","notify.success"),n.$close({applyInfoNew:r,status:e.data.map.status})):n.authError=e.data.msg})}},n.showPhone=!0;var U;0!==a.status&&l(function(){t.getVisitorMsg().then(function(e){if(e.data.obj){U=n.applyInfo=e.data.obj;var t=angular.copy(n.applyInfo.phone);U.checkPhone&&1==U.checkPhone&&(n.showPhone=!1,n.$watch("applyInfo.phone",function(e,r){e&&e!==t?n.showPhone=!0:n.showPhone=!1}));for(var r=U.represent1,o=r.substr(0,r.indexOf("_")),c=U.represent2,s=c.substr(0,c.indexOf("_")),i=U.represent3,a=i.substr(0,i.indexOf("_")),u=0;u<n.myShowScene.length;u++)(n.myShowScene[u].code===o||n.myShowScene[u].code===s||n.myShowScene[u].code===a)&&(n.myShowScene[u].ischecked=!0,n.sceneSelected.push(n.myShowScene[u]));var l=U.tagList;for(u=0;u<l.length;u++){for(var d=0;d<n.serverLabel.length;d++)l[u].tagId===n.serverLabel[d].id&&(n.serverLabel[d].ischecked=!0,n.serverSelected.push({name:l[u].name,id:l[u].tagId}));for(var p=0;p<n.payLabel.length;p++)l[u].tagId===n.payLabel[p].id&&(n.payLabel[p].ischecked=!0);for(var m=0;m<n.cateLabel.length;m++)l[u].tagId===n.cateLabel[m].id&&(n.cateLabel[m].ischecked=!0,n.cateSelected.push({name:l[u].name,id:l[u].tagId}))}}})},1e3),n.invoice=function(){r.open({windowClass:"six-contain",templateUrl:BASE_URL+"templates/usercenter.console.invoice.tpl.html",controller:"InvoiceCtrl",scope:n,resolve:{userinfo:function(){return{}}}}).result.then(function(e){},function(){})}}]),angular.module("usercenter.branch",["services.usercenter","services.i18nNotifications"]),angular.module("usercenter.branch").controller("BranchCtrl",["$rootScope","$scope","$window","$stateParams","usercenterService","security","$modal","ModalService","$location","branch","i18nNotifications","$translate",function(e,n,t,r,o,c,s,i,a,u,l,d){n.originData=n.branch=angular.copy(u),n.dept={},n.depts=[],n.resetDefalt=!1,u?n.resetDefalt=!0:(n.resetDefalt=!1,setTimeout(function(){$("button").css("background-color","#ccc")},0),n.branch={}),n.openResetModal=function(e){s.open({windowClass:"console six-contain",templateUrl:BASE_URL+"templates/usercenter.console.resetbranchpass.tpl.html",controller:"ResetBranchPassCtrl",resolve:{branch:function(){return e}}}).result.then(function(){l.pushForCurrentRoute("branch.reset.success","notify.success")},function(){})},n.getDepts=function(){o.getDepts(n.branch.id).then(function(e){if(n.branchPermi.edit=e.data.company_ext[0],n.branchPermi.delete=e.data.company_ext[1],n.branchPermi.export=e.data.company_ext[2],console.log(n.branchPermi),n.depts=e.data.list,n.branch.deptName||n.branch.deptId)for(var t=0;t<n.depts.length;t++)if(n.depts[t].id==n.branch.deptId)return void(n.branch.dept=n.depts[t])},function(){})},n.getDepts(),n.authError="",n.checkDeptFormat=function(e){return e.name?countCharacters(e.name)>30?($(".dept-name").addClass("error"),$(".dept-name").change(function(){$(this).removeClass("error")}),n.deptFormatError=d.instant("usercenter.account.DEPT_ERR2"),!1):(n.deptFormatError="",!0):(n.deptFormatError=d.instant("usercenter.account.DEPT_ERR1"),$(".dept-name").focus(),deptF={},!1)},n.addDept=function(){n.checkDeptFormat(n.dept)&&o.addDept(n.dept).then(function(e){e.data.success&&(n.showAddSec=!1,n.depts.unshift({id:e.data.obj,name:n.dept.name}),l.pushForCurrentRoute("dept.create.success","notify.success"),n.dept={})},function(){n.authError=d.instant("usercenter.account.SERVER_ERROR")})},n.branchPermi={edit:!0,delete:!0,export:!0},n.branch.extPermi&&(/^([\d,]+,)?1(,[\d,]*)?$/.test(n.branch.extPermi)&&(n.branchPermi.edit=!0),/^([\d,]+,)?2(,[\d,]*)?$/.test(n.branch.extPermi)&&(n.branchPermi.delete=!0),/^([\d,]+,)?3(,[\d,]*)?$/.test(n.branch.extPermi)&&(n.branchPermi.export=!0)),n.checkEmailFormat=function(e){return n.branch.loginName?/^[-_a-z0-9\.@]{6,40}$/g.test(n.branch.loginName)?(n.emailFormatError="",!0):(n.emailFormatError=d.instant("usercenter.account.BRANCH_ERR2"),!1):(n.emailFormatError=d.instant("usercenter.account.BRANCH_ERR1"),!1)},n.checkNameFormat=function(e){return e.name?countCharacters(e.name)>30?(n.nameFormatErr=d.instant("usercenter.account.LOGIN_NAME_ERR2"),!1):(n.nameFormatErr="",!0):($(".branch-name").focus(),n.nameFormatErr=d.instant("usercenter.account.LOGIN_NAME_ERR1"),!1)},n.confirm=function(){if(n.checkEmailFormat(n.branch)&&n.checkNameFormat(n.branch)){var e={};n.branch.dept&&(n.branch.deptName=n.branch.dept.name,n.branch.dept.id&&(e.deptId=n.branch.deptId=n.branch.dept.id));var t=[];$.each(n.branchPermi,function(e,n){"edit"==e&&n?t.push("1"):"export"==e&&n?t.push("3"):"delete"==e&&n&&t.push("2")}),n.branch.extPermi=t.join(","),u?($.extend(e,{id:n.branch.id,name:n.branch.name,extPermi:n.branch.extPermi}),o.updateBranch(e).then(function(e){e.data.success&&(n.$close(n.branch),l.pushForCurrentRoute("branch.update.success","notify.success"))},function(e){n.serverError=d.instant("usercenter.account.SERVER_ERROR")})):($.extend(e,{loginName:n.branch.loginName,name:n.branch.name,extPermi:n.branch.extPermi}),o.createBranch(e).then(function(e){e.data.success?(n.branch.id=e.data.obj.id,l.pushForCurrentRoute("branch.create.success","notify.success"),n.$close(n.branch)):n.serverError=e.data.msg},function(e){n.serverError=d.instant("usercenter.account.SERVER_ERROR")}))}},n.cancel=function(){n.$dismiss()}}]),angular.module("usercenter.branch.reset",["services.usercenter","services.i18nNotifications"]),angular.module("usercenter.branch.reset").controller("ResetBranchPassCtrl",["$rootScope","$scope","$window","$stateParams","usercenterService","security","$modal","ModalService","$location","branch","i18nNotifications",function(e,n,t,r,o,c,s,i,a,u,l){n.branch=u,n.reset=function(){o.resetBranchPass(u.id)},n.cancel=function(){n.$dismiss()},n.$on("reset.branch.success",function(){n.$close()})}]),angular.module("usercenter.checkMobil",["services.usercenter","services.i18nNotifications"]),angular.module("usercenter.checkMobil").controller("CheckMobileCtrl",["$rootScope","$scope","$window","usercenterService","$modal","ModalService","$location","$timeout","userinfo","i18nNotifications","$translate",function(e,n,t,r,o,c,s,i,a,u,l){function d(){0===p?(n.isCodeAccessiable=!1,n.codeTip=l.instant("usercenter.account.CODE_TIP1"),p=60):(n.isCodeAccessiable=!0,n.codeTip=l.instant("usercenter.account.CODE_TIP2")+"("+p+")",i(function(){p--,d()},1e3))}switch(n.title=a.title,n.userinfo=a,n.userinfo.code="",n.title){case l.instant("usercenter.account.REL_MOBILE"):n.dec=l.instant("usercenter.account.REL_MOBILE_DEC");break;case l.instant("usercenter.account.VALIDATE_MOBILE"):n.dec=l.instant("usercenter.account.VALIDATE_MOBILE_DEC");break;case l.instant("usercenter.account.CHANGE_MOBILE"):n.dec=l.instant("usercenter.account.CHANGE_MOBILE_DEC")}n.checkMobile=function(){return/^1\d{10}$/.test(n.userinfo.phone)?(n.mobileError="",!0):($(".mobile").focus(),n.mobileError=l.instant("usercenter.account.MOBILE_ERROR1"),!1)},n.checkCode=function(){return n.userinfo.code?(n.codeError="",!0):($(".code").focus(),n.codeError=l.instant("usercenter.account.CODE_ERROR"),!1)},n.getCode=function(){n.userinfo.phone?(n.mobileError="",r.relMobileCode(n.userinfo.phone).then(function(e){e.data.success?d():n.relErr=e.data.msg})):(n.mobileError=l.instant("usercenter.account.MOBILE_ERROR2"),$(".mobile").focus())};var p=60;n.relAccount=function(){n.checkMobile()&&n.checkCode()&&(n.mobileError="",n.codeError="",r.relMobile(n.userinfo.phone,n.userinfo.password,n.userinfo.code).then(function(e){e.data.success?c.openMsgDialog({msg:e.data.msg},function(){n.$close(n.userinfo.phone)}):n.relErr=e.data.msg}))},n.cancel=function(){n.$dismiss()}}]),angular.module("usercenter.companyinfo",["services.usercenter","services.i18nNotifications"]),angular.module("usercenter.companyinfo").controller("companyInfoCtrl",["$scope","$modal","userinfo","usercenterService","i18nNotifications",function(e,n,t,r,o){e.companyUserInfo={},e.designerUserInfo={},e.companyUserInfo.nick=t.nick,e.type=t.type,e.pid={};var c=function(){r.getDesignerUserInfo().then(function(n){e.designerUserInfo=n.data.obj}),r.getProvince().then(function(n){e.provinces=n.data})},s=function(){r.getCompanyInfo().then(function(n){e.companyUserInfo=n.data.obj})};e.getProvinceInfo=function(n,t){if(e.pid=n,e.name=t,e.cities=[],console.log("a.pid "+e.pid+"11111"),void 0==e.pid)e.cities=[],e.designerUserInfo.proid="",e.designerUserInfo.proname="";else{e.designerUserInfo.proid=e.pid,e.designerUserInfo.proname=e.name;var r=PREFIX_URL+"index.php?c=Designer&a=getcity&pid="+e.pid;$.get(r,function(n){n=JSON.parse(n),e.cities=n,e.$apply(),console.log(e.cities)})}},e.getCityInfo=function(n,t){e.designerUserInfo.cityid=n,e.designerUserInfo.cityname=t,console.log("a.cid "+n),console.log("a.name "+t)},e.clearProvinceInfo=function(){e.$apply(function(){e.designerUserInfo.proid="",e.designerUserInfo.proname=""})},e.clearCityInfo=function(){e.$apply(function(){e.designerUserInfo.cityid="",e.designerUserInfo.cityname=""})},e.checkEmail=function(n){var t=/^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;return n.email&&!t.test(n.email)?(e.authError="请正确填写邮箱",!1):(e.authError="",!0)},2==e.type&&(s(),e.title="企业会员基本信息"),1==e.type||12==e.type&&(e.title="个人用户基本信息"),3==e.type&&(e.title="高级用户基本信息"),22==e.type&&(c(),e.title="设计师基本信息"),e.saveUserInfo=function(n){n.id=t.id,r.saveUserInfo(n).then(function(t){t.data.success&&(e.$close(n),o.pushForCurrentRoute("save.success","notify.success"))})},e.saveCompanyInfo=function(n){return!!e.checkEmail(n)&&(n.nick=e.companyUserInfo.nick,void r.saveCompanyInfo(n).then(function(t){t.data.success?(o.pushForCurrentRoute("account.success","notify.success"),e.$close(n)):e.codeError=t.data.msg}))},e.saveDesignerInfo=function(n){return!!e.checkEmail(n)&&(n.nick=e.designerUserInfo.nick,void r.saveDesignerInfo(n).then(function(t){t.data.success?(o.pushForCurrentRoute("account.success","notify.success"),e.$close(n)):e.codeError=t.data.msg}))},e.cancel=function(){e.$close()},e.invoice=function(){n.open({windowClass:"six-contain",templateUrl:BASE_URL+"templates/usercenter.console.invoice.tpl.html",controller:"InvoiceCtrl",scope:e,resolve:{userinfo:function(){return{}}}}).result.then(function(e){},function(){})}}]),angular.module("usercenter.invoice",["services.usercenter","services.i18nNotifications"]),angular.module("usercenter.invoice").controller("InvoiceCtrl",["$scope","usercenterService","$modal","i18nNotifications","userinfo",function(e,n,t,r,o){e.invoiceStatus="",e.changeType=function(n){e.invoiceStatus=n},e.editInfo={isEditable:!0},o.view&&(e.view=o.view,e.editInfo.isEditable=!1,o.orderIds=o.orderIds.join(","));var c=[];e.authError="",e.picture={},e.invoice={receiver:"",phone:"",address:""},e.reset=function(){e.editInfo.isEditable=!0},e.invoiceListPu={invoiceType:1},e.invoiceListzhuan={invoiceType:2};var s=function(){n.getUserInvoice().then(function(n){if(200==n.data.code){n.data.obj&&(e.invoice=n.data.obj),n.data.map.invoiceType?e.invoiceStatus=n.data.map.invoiceType:e.invoiceStatus=1;for(var t=n.data.list,r=0;r<t.length;r++)1==t[r].invoiceType&&(e.invoiceListPu=t[0]),2==t[r].invoiceType&&(e.invoiceListzhuan=t[1],c=t[1].licenseImgsJson.split(","),e.picture={tax:c[0],bank:c[1],people:c[2],mes:c[3]})}})};s(),e.addPictures=function(n){t.open({windowClass:"console img_console",templateUrl:BASE_URL+"templates/scene.console.bg.tpl.html",controller:"BgConsoleCtrl",resolve:{obj:function(){return{fileType:1,count:1}}}}).result.then(function(t){"tax"==n?e.picture.tax=t.data:"bank"==n?e.picture.bank=t.data:"people"==n?e.picture.people=t.data:"mes"==n&&(e.picture.mes=t.data),r.pushForCurrentRoute("upload.success","notify.success")})};var i=function(){return e.picture.tax?e.picture.bank?e.picture.people?!!e.picture.mes||(e.authError="请上传开票信息加盖公章",!1):(e.authError="请上传一般纳税人资质证明",!1):(e.authError="请上传银行许可证",!1):(e.authError="请上传税务登记证",!1)};e.submit=function(t){if(!e.invoice.receiver)return void(e.authError="请填写收件人");if(!e.invoice.phone)return void(e.authError="请填写联系电话");if(!e.invoice.address)return void(e.authError="请填写收货地址");var t={orderIds:o.orderIds,receiver:e.invoice.receiver,address:e.invoice.address,phone:e.invoice.phone};if(1==e.invoiceStatus&&(t.invoiceType=1,t.title=e.invoiceListPu.title),2==e.invoiceStatus){if(!i())return!1;t.invoiceType=2,t.title=e.invoiceListzhuan.title,t.licenseImgsJson=e.picture.tax+","+e.picture.bank+","+e.picture.people+","+e.picture.mes}3==e.invoiceStatus&&(t.invoiceType=3),n.saveOrderInvoice(t).then(function(n){n.data.success&&(e.$close(t),r.pushForCurrentRoute("save.success","notify.success"))})},e.saveUserInvoice=function(t){if(!e.invoice.receiver)return void(e.authError="请填写收件人");if(!e.invoice.phone)return void(e.authError="请填写联系电话");if(!e.invoice.address)return void(e.authError="请填写收货地址");var t={};if(t.invoiceDeliver={receiver:e.invoice.receiver,address:e.invoice.address,phone:e.invoice.phone},t.invoiceList=[],e.invoiceListPu.title&&t.invoiceList.push({invoiceType:e.invoiceListPu.invoiceType,title:e.invoiceListPu.title}),e.invoiceListzhuan.title){if(!e.picture.tax)return void(e.authError="请上传税务登记证");if(!e.picture.bank)return void(e.authError="请上传银行许可证");if(!e.picture.people)return void(e.authError="请上传一般纳税人资质证明");if(!e.picture.mes)return void(e.authError="请上传开票信息加盖公章");var c={invoiceType:e.invoiceListzhuan.invoiceType,title:e.invoiceListzhuan.title,licenseImgsJson:e.picture.tax+","+e.picture.bank+","+e.picture.people+","+e.picture.mes};t.invoiceList.push(c)}n.saveUserInvoice(t).then(function(n){n.data.success&&(o.view?e.editInfo.isEditable=!1:e.$close(t),r.pushForCurrentRoute("save.success","notify.success"))})},e.cancel=function(){e.$close()}}]),angular.module("usercenter.invoicelist",[]).controller("GetInvoiceListCtrl",["$scope","usercenterService","$modal","ModalService",function(e,n,t,r){e.pageNo=1,e.pageSize=5,e.obj={};var o=[],c=function(e,t){n.getInvoiceList(e,t)};c(1,5),e.$on("get.invoice.list",function(n,t){e.invoiceList=t.list||[];for(var r=0;r<t.list.length;r++)e.invoiceList[r].totalFee=e.invoiceList[r].totalFee/100,0==t.list[r].payType?e.invoiceList[r].payType="微信支付":1==t.list[r].payType&&(e.invoiceList[r].payType="支付宝支付");e.totalItems=t.map.count,e.currentPage=e.obj.toPage=t.map.pageNo}),e.pageChanged=function(t){n.getInvoiceList(t,e.pageSize)},e.cancel=function(){e.$dismiss()},e.view=!0,e.ok=function(){var n=angular.copy(o);o=[],n.length>0?t.open({windowClass:"six-contain",templateUrl:BASE_URL+"templates/usercenter.console.invoice.tpl.html",controller:"InvoiceCtrl",scope:e,resolve:{userinfo:function(){return{view:e.view,orderIds:n}}}}).result.then(function(n){c(1,5),e.switchSelectAll()},function(){}):r.openMsgDialog({msg:"请选择需要开发票的订单列表",btn:"去选择"},function(){})},e.switchSelectAll=function(n){o=[],n?$.each(e.invoiceList,function(e,n){o.push(n.id),n.selected=!0}):$.each(e.invoiceList,function(e,n){n.selected=!1})},e.switchSelect=function(e){e.selected?o.push(e.id):$.each(o,function(n,t){t==e.id&&o.splice(n,1)})}}]),angular.module("usercenter.member",[]),angular.module("usercenter.member").controller("MemberCtrl",["$scope","$modal","usercenterService","ModalService",function(e,n,t,r){e.pageNo=1,e.pageSize=10,e.setUserInfo=function(){if(1==e.currentUser.type||12==e.currentUser.type)e.userType="个人用户";if(23==e.currentUser.type)e.userType="企业免费用户";else if(2==e.currentUser.type?e.upgradeInfo="已升级":e.upgradeInfo="免费升级",3==e.currentUser.type)e.userType="高级用户";else if(21==e.currentUser.type)e.userType="企业子用户";else if(4==e.currentUser.type)e.userType="服务商用户";else if(e.userType="企业用户",e.currentUser.memberType){if(e.currentUser.expiryTime){var n=(new Date).getTime();e.currentUser.expiryTime<=n&&(e.currentUser.memberType=null)}1==e.currentUser.memberType?e.userPay="(体验版)":2==e.currentUser.memberType?e.userPay="(高级版)":3==e.currentUser.memberType?e.userPay="(专业版)":4==e.currentUser.memberType&&(e.userPay="(畅享版)")}else e.userPay=""},e.setUserInfo(),e.memberPrivileges=["拥有编辑器组件，适用于个人企业用户，提供全面便捷的推广渠道助力企业自我营销和宣传","拥有编辑器组件，适用于个人企业用户，提供全面便捷的推广渠道助力企业自我营销和宣传","拥有编辑器组件，适用于个人企业用户，提供全面便捷的推广渠道助力企业自我营销和宣传","拥有编辑器组件，适用于个人企业用户，提供全面便捷的推广渠道助力企业自我营销和宣传","拥有编辑器组件，适用于个人企业用户，提供全面便捷的推广渠道助力企业自我营销和宣传","拥有编辑器组件，适用于个人企业用户，提供全面便捷的推广渠道助力企业自我营销和宣传"],e.getXdLog=function(n,r){e.xdType=n,e.currentPage=r,t.getXdlog(n,r,e.pageSize).then(function(n){if(n.data.success){e.xdLogs=n.data.list;for(var t=0;t<e.xdLogs.length;t++)2==e.xdLogs[t].type?e.xdLogs[t].xd="-"+e.xdLogs[t].xd:e.xdLogs[t].xd="+"+e.xdLogs[t].xd;e.totalItems=n.data.map.count,e.currentPage=n.data.map.pageNo,e.toPage=n.data.map.pageNo,e.numPages=Math.ceil(e.totalItems/e.pageSize)}})},e.getXdLog(null,1),e.pageChanged=function(n,t){return 1>t||t>e.numPages&&1!=t?void alert("此页超出范围"):(e.currentPage=t,e.toPage=t,void e.getXdLog(n,t))},e.getXdStatNum=function(){t.getXdStat().then(function(n){e.getXdStat=n.data.map})},e.getXdStatNum(),e.transferXd=function(){n.open({windowClass:"six-contain",templateUrl:BASE_URL+"templates/usercenter.transfer.tpl.html",controller:"UsercentertransferCtrl",resolve:{username:function(){return e.userinfo.loginName}}}).result.then(function(){e.getUserXd(),e.getXdlog(),e.getXdStatNum()},function(){})},e.openInvoice=function(){e.openInvoiceListModal()},e.openInvoiceListModal=function(){n.open({windowClass:"console seven-contain",templateUrl:BASE_URL+"templates/usercenter.console.invoice-list.html",controller:"GetInvoiceListCtrl"}).result.then(function(){},function(){})}}]).controller("PayMentCtrl",["$modal","$scope","qrCodeUrl","type","money","usercenterService","method",function(e,n,t,r,o,c,s){n.qrCodeUrl=t,n.money=o,n.type=r,n.paymented=function(){n.$close()},n.cancel=function(){n.$dismiss()},n.getWeChatUrl=function(){n.wechatUrl||("member"==s?c.getCompanyQrCode(r,0).then(function(e){e.data.success&&(n.wechatUrl=e.data.obj)}):c.getPayXdQrCode(r,0).then(function(e){e.data.success&&(n.wechatUrl=e.data.obj)}))}}]),angular.module("usercenter.privilege",[]),
angular.module("usercenter.privilege").controller("PrivilegeCtrl",["$location","usercenterService","$scope","$modal","security","ModalService",function(e,n,t,r,o,c){t.tabid="corporateMember",t.$watch(function(){return o.currentUser},function(e){e&&(t.currentUser=e,t.changeMemberType())},!0),t.changeMemberType=function(){if(t.currentUser&&t.currentUser.expiryTime){var e=(new Date).getTime();t.currentUser.expiryTime<=e&&(t.currentUser.memberType=null)}},t.changeMemberType(),t.upgradeAccount=function(e,n){return 1!=t.currentUser.type||t.companyInfo&&0===t.companyInfo.status?1==t.currentUser.type&&t.companyInfo?void c.openMsgDialog({msg:"您不是企业会员,请先申请企业会员后再进行升级！"}):2!=t.currentUser.type?void c.openMsgDialog({msg:"尊敬的用户，您当前账号类型无法升级为企业用户！"}):void r.open({windowClass:"console",templateUrl:BASE_URL+"templates/usercenter.upgrade.tpl.html",controller:"UpgradeCtrl",resolve:{type:function(){return e},isRenew:function(){return n}}}).result.then(function(){},function(){}):void("eqs"==t.currentUser.loginName.substr(0,3)&&null==t.currentUser.email?c.openMsgDialog({msg:"第三方账号请先关联账号"}):c.openMsgDialog({msg:"尊敬的用户，请您先申请免费企业用户，通过审核后再次升级",btn:"我知道了"},function(){r.open({windowClass:"seven-contain",templateUrl:BASE_URL+"templates/usercenter.console.upgrade_company.tpl.html",controller:"UsercenterupgradeCtrl",resolve:{user:function(){return{id:t.user.id}}}}).result.then(function(){},function(){})},function(){}))},t.cancel=function(){t.$close()},t.upgradeCompany=function(){r.open({windowClass:"seven-contain",templateUrl:BASE_URL+"templates/usercenter.console.upgrade_company.tpl.html",controller:"UsercenterupgradeCtrl",resolve:{user:function(){return{id:t.user.id}}}}).result.then(function(){},function(){})}}]).controller("UpgradeCtrl",["$modal","$scope","type","usercenterService","ModalService","security","$location","isRenew",function(e,n,t,r,o,c,s,i){n.confirm=function(){r.getCompanyQrCode(t,1).then(function(s){n.$close();var a,u;if(1==t?(a=i?["99元","450元"]:["99元","499元"],u=[{name:"30天",value:1},{name:"180天",value:6}]):2==t?i?(a=["450元","800元"],u=[{name:"180天",value:1},{name:"365天",value:2}]):(a=["499元","900元"],u=[{name:"180天",value:1},{name:"365天",value:2}]):3==t?i?(a=["1.6万","3万"],u=[{name:"1年",value:1},{name:"2年",value:2}]):(a=["1.9万","3.2万"],u=[{name:"1年",value:1},{name:"2年",value:2}]):i?(a=["1800元","3200元"],u=[{name:"1年",value:1},{name:"2年",value:2}]):(a=["1999元","3600元"],u=[{name:"1年",value:1},{name:"2年",value:2}]),s.data.success){var l=s.data.obj;e.open({windowClass:"console",templateUrl:BASE_URL+"templates/usercenter.payment.tpl.html",controller:"PayMentCtrl",resolve:{qrCodeUrl:function(){return l},type:function(){return t},money:function(){return a},method:function(){return"member"},counts:function(){return u}},size:"lg"}).result.then(function(){r.getUserInfo().then(function(e){e.data.success&&(c.currentUser=e.data.obj)}),o.openMsgDialog({msg:"因网络原因，部分用户开通会有延迟",btn:"确定"},function(){n.openInvoice()})},function(){})}else o.openMsgDialog({msg:s.data.msg})})},n.openInvoice=function(){o.openConfirmDialog({msg:"是否开具发票？",confirmName:"是",cancelName:"否"},function(){n.openInvoiceListModal()},function(){s.path("/privilege")})},n.openInvoiceListModal=function(){e.open({windowClass:"console seven-contain",templateUrl:BASE_URL+"templates/usercenter.console.invoice-list.tpl.html",controller:"GetInvoiceListCtrl"}).result.then(function(){},function(){})},n.cancel=function(){n.$close()}}]).controller("PayMentCtrl",["$modal","$scope","qrCodeUrl","type","money","usercenterService","method","counts",function(e,n,t,r,o,c,s,i){n.qrCodeUrl=t,n.money=o[0],n.type=r,n.counts=i,n.payWay="alipay",i&&i.length>0&&(n.curentCount=i[0].value);var a={};a["alipay1"+n.curentCount]=t,n.paymented=function(){n.$close()},n.cancel=function(){n.$dismiss()},n.getWeChatUrl=function(e){n.payWay=e;var t=1;return"wechat"==n.payWay&&(t=0),a[n.payWay+""+t+n.curentCount]?void(n.qrCodeUrl=a[n.payWay+""+t+n.curentCount]):void("member"==s?c.getCompanyQrCode(r,t,n.curentCount).then(function(e){e.data.success&&(a[n.payWay+""+t+n.curentCount]=e.data.obj,n.qrCodeUrl=e.data.obj)}):c.getPayXdQrCode(r,t).then(function(e){e.data.success&&(a[n.payWay+""+t+n.curentCount]=e.data.obj,n.qrCodeUrl=e.data.obj)}))},n.setCount=function(e,t){n.curentCount=e,n.money=o[t];var s=1;if("wechat"==n.payWay&&(s=0),a[n.payWay+""+s+n.curentCount])return void(n.qrCodeUrl=a[n.payWay+""+s+n.curentCount]);var i=r,u=e;1==r&&6==e&&(i=2,u=1),c.getCompanyQrCode(i,s,u).then(function(e){e.data.success&&(a[n.payWay+""+s+n.curentCount]=e.data.obj,n.qrCodeUrl=e.data.obj)})}}]),angular.module("usercenter.relAccount",["services.usercenter","services.i18nNotifications"]),angular.module("usercenter.relAccount").controller("RelAccountCtrl",["$rootScope","$scope","$window","$stateParams","usercenterService","security","$modal","ModalService","$location","userinfo","i18nNotifications","$translate",function(e,n,t,r,o,c,s,i,a,u,l,d){n.user=u,n.bindAccount=function(){return n.user.email?n.user.password?void o.relAccount(u.id,n.user.email,n.user.password).then(function(e){if(200==e.data.code){l.pushForCurrentRoute("email.save.success","notify.success"),/qq/gi.test(n.user.loginName)&&(n.relType="qq"),/weixin/gi.test(n.user.loginName)&&(n.relType="weixin"),/weibo/gi.test(n.user.loginName)&&(n.relType="weibo");var t={type:n.relType,email:angular.copy(n.user.email)};n.$close(t)}else n.relErr=e.data.msg},function(e){n.$dismiss()}):(n.relErr=d.instant("usercenter.account.PASSWORD_ERROR"),void $(".third-pwd").focus()):(n.relErr=d.instant("usercenter.account.ACCOUNT_ERROR"),void $(".third-name").focus())},n.checkUpperCase=function(){/[A-Z]/g.test(n.user.email)&&(n.user.email=n.user.email.toLowerCase(),n.relErr=d.instant("usercenter.account.EMAIL_TIP"))},n.cancel=function(){n.$dismiss()}}]),angular.module("usercenter.relEmail",["services.usercenter","services.i18nNotifications"]),angular.module("usercenter.relEmail").controller("RelEmailCtrl",["$rootScope","$scope","$window","$stateParams","usercenterService","security","$modal","ModalService","$location","userinfo","i18nNotifications","$translate",function(e,n,t,r,o,c,s,i,a,u,l,d){switch(n.title=u.title,n.userinfo=u,n.title){case d.instant("usercenter.account.REL_EMAIL"):n.dec=d.instant("usercenter.account.REL_EMAIL_DESC");break;case d.instant("usercenter.account.VALIDATE_EMAIL"):n.dec=d.instant("usercenter.account.VALIDATE_EMAIL_DESC");break;case d.instant("usercenter.account.CHANGE_EMAIL"):n.dec=d.instant("usercenter.account.CHANGE_EMAIL")}n.checkEmailFormat=function(e){var t=/^([a-zA-Z0-9]+[_|\_|\.|-]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[\.|-]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;return t.test(n.userinfo.email)?(n.emailFormatErr="",!0):(n.emailFormatErr=d.instant("usercenter.account.REL_EMAIL_TIP"),!1)},n.checkPassFormat=function(e){return e.password?(n.passFormatErr="",!0):(n.passFormatErr=d.instant("usercenter.account.PASSWORD_ERROR"),$(".email-pwd").focus(),!1)},n.relEmail=function(e){n.checkEmailFormat(e)&&n.checkPassFormat(e)&&(null==n.userinfo.checkEmail?n.firstRel=!1:n.firstRel=!0,o.relEmail(n.userinfo.email,n.userinfo.password,n.firstRel).then(function(e){200==e.data.code?(n.relErr="",i.openMsgDialog({msg:"申请绑定成功,已向您的邮箱发送验证邮件,请注意查收。"},function(){n.$dismiss()})):(n.firstRel=!0,n.relErr=e.data.msg)},function(e){}))},n.checkUpperCase=function(){/[A-Z]/g.test(n.userinfo.email)&&(n.userinfo.email=n.userinfo.email.toLowerCase(),n.relErr=d.instant("usercenter.account.EMAIL_TIP"))},n.cancel=function(){n.$dismiss()}}]),angular.module("usercenter.relRegisterAccount",["services.usercenter","services.i18nNotifications"]),angular.module("usercenter.relRegisterAccount").controller("RelRegisterAccountCtrl",["$rootScope","$scope","$window","$stateParams","usercenterService","security","$modal","ModalService","$location","userinfo","i18nNotifications","localizedMessages","$translate",function(e,n,t,r,o,c,s,i,a,u,l,d,p){n.user=u,n.user.agreement=!0;var m=!1;n.cancel=function(){n.$dismiss("cancel")},n.registerAccount=function(){if(n.userNotExist&&n.checkUsername()&&n.checkPassword()&&n.checkRepeatPassword())if(n.user.password===n.user.repeatPassword&&n.user.agreement){if(m)return;m=!0,o.relAccount(u.id,n.user.email,n.user.password,!0).then(function(e){if(m=!1,200==e.data.code){l.pushForCurrentRoute("email.save.success","notify.success"),/qq/gi.test(n.user.loginName)&&(n.relType="qq"),/weixin/gi.test(n.user.loginName)&&(n.relType="weixin"),/weibo/gi.test(n.user.loginName)&&(n.relType="weibo");var t={type:n.relType,email:angular.copy(n.user.email)};n.$close(t)}else n.relErr=e.data.msg},function(e){m=!1,n.regErr=d.get("register.error.serverError",{exception:x}),n.$dismiss()})}else n.user.password!=n.user.repeatPassword?n.regErr=d.get("register.error.match"):n.regErr=d.get("register.error.agreement")},n.checkUsername=function(){if(n.user.email){if(/^[-_a-z0-9\.@]{6,40}$/g.test(n.user.email))return n.checkUniqueness(n.user.email),!0;n.usernameError=p.instant("usercenter.account.REG_ACCOUNT_ERR2")}else n.usernameError=p.instant("usercenter.account.REG_ACCOUNT_ERR1");return!1},n.checkUniqueness=function(e){c.checkUniqueness(e).success(function(e){n.userNotExist=e.success,n.userNotExist?n.usernameError=null:n.usernameError=p.instant("usercenter.account.REG_ACCOUNT_ERR3")})},n.checkPassword=function(){if(n.user.password){if(/^[a-zA-Z0-9]{6,16}$/g.test(n.user.password))return n.passError=null,!0;n.passError=p.instant("usercenter.account.REG_PWD_ERR2")}else n.passError=p.instant("usercenter.account.REG_PWD_ERR1");return!1},n.checkRepeatPassword=function(){if(n.user.repeatPassword){if(n.user.repeatPassword==n.user.password)return n.rPassError="",!0;n.rPassError=p.instant("usercenter.account.REG_PWD_ERR4")}else n.rPassError=p.instant("usercenter.account.REG_PWD_ERR3");return!1}}]),angular.module("usercenter.request",["services.usercenter","app.directives.qrcode"]),angular.module("usercenter.request").controller("UsercenterrequestCtrl",["$rootScope","$scope","$window","$stateParams","usercenterService","security","$modal","ModalService","$location",function(e,n,t,r,o,c,s,i,a){n.PREFIX_CLIENT_HOST=PREFIX_HOST,n.currentUser=c.currentUser,n.cancel=function(){n.$dismiss()}}]),angular.module("usercenter.tab",["usercenter.account","usercenter.member","usercenter.trash","usercenter.apply","usercenter.companyinfo","usercenter.invoice","usercenter.invoicelist"]),angular.module("usercenter.tab.server",["services.usercenter","services.i18nNotifications"]),angular.module("usercenter.tab.server").controller("ServerTabCtrl",["$scope","$rootScope","usercenterService","$translate",function(e,n,t,r){e.showController={},e.goStep=function(n){e.step=n},e.bindDomain=function(){e.showController.agreeBind=!0},e.reApply=function(){e.isShowBindPanel=!0,e.showController.agreeBind=!1};var o=function(){t.getDomain().then(function(n){if(n.data.success)if(e.domainInfo=n.data.obj,e.model.day=n.data.obj.typeList[0],n.data.obj.id){e.isShowBindPanel=!1,e.domainInfo.ipAddress="202.173.11.90";var t=e.status=n.data.obj.status;1===t?(e.domainMes=r.instant("usercenter.server.DOMAIN_STATUS1"),e.unbind=!1,e.domainInfo.restTime=Math.floor((e.domainInfo.endDate-e.domainInfo.startDate)/864e5)):2===t?(e.domainMes=r.instant("usercenter.server.DOMAIN_STATUS2"),e.unbind=!1):3===t?(e.domainMes=r.instant("usercenter.server.DOMAIN_STATUS3"),e.unbind=!0):4===t?e.domainMes=r.instant("usercenter.server.DOMAIN_STATUS4"):(new Date).getTime()>n.data.obj.endDate&&(e.status=5,e.domainMes=r.instant("usercenter.server.DOMAIN_STATUS5"),e.unbind=!0)}else e.isShowBindPanel=!0})};o(),e.model||(e.model={});var c=e.model;e.checkDomainFormat=function(n){return n.url?(e.domainFormatErr="",!0):(e.domainFormatErr=r.instant("usercenter.server.WRITE_DNS"),!1)},e.checkDayFormat=function(n){return n.day?(e.dayFormatErr="",!0):(e.dayFormatErr=r.instant("usercenter.server.WRITE_DATE"),!1)},e.checkAppIdAndSecret=function(n){return n.appId&&!n.secretId?(e.appIdFormatErr=r.instant("usercenter.serverWRITE_APPSECRET"),!1):!n.appId&&n.secretId?(e.appSecretErr=r.instant("usercenter.server.WRITE_APPID"),!1):(e.appIdFormatErr="",e.appSecretErr="",!0)},e.submit=function(){if(e.checkDomainFormat(c)&&e.checkDayFormat(c)&&e.checkAppIdAndSecret(c))if(e.cost=c.day.label,e.xdCounts>=parseInt(e.cost,10)){var n={url:c.url,buyTime:c.day.value,appId:c.appId,secretId:c.secretId};t.bindDomain(n).then(function(n){n.data.success?(alert(r.instant("usercenter.server.DNS_COMMIT")),e.status=2,e.isShowBindPanel=!1,e.domainInfo.ipAddress="202.173.11.90",e.domainInfo.url=c.url):e.actionerror=n.data.msg},function(){alert(r.instant("usercenter.server.SERVER_ERROR"))})}else e.xiudian=!0}}]),angular.module("usercenter.transfer",["services.usercenter"]),angular.module("usercenter.transfer").controller("UsercentertransferCtrl",["$rootScope","$scope","$window","$stateParams","usercenterService","security","$modal","ModalService","$location","username","$translate",function(e,n,t,r,o,c,s,i,a,u,l){n.transfer=!0,n.userXd={toUser:"",xdCount:""},n.submit=!1,n.getUserXd=function(){o.getUserXd().then(function(e){e.data.success&&(n.xdCount=e.data.obj)})},n.getUserXd(),n.confirm=function(){n.submit=!0,n.getgiveXd()},n.checkEmailFormat=function(e){return e.toUser?e.toUser==u?(n.mailFormatErr=l.instant("usercenter.userinfo.ACCOUNT_ERROR2"),$(".username").addClass("error"),!1):(n.mailFormatErr="",!0):(n.mailFormatErr=l.instant("usercenter.userinfo.ACCOUNT_ERROR1"),$(".username").focus(),!1)},n.checkXdFormat=function(e){return/^\+?[1-9][0-9]*$/.test(e.xdCount)?n.userXd.xdCount>n.xdCount?(n.xdFormatErr=l.instant("usercenter.userinfo.XD_ERROR2"),!1):(n.xdFormatErr="",!0):(n.xdFormatErr=l.instant("usercenter.userinfo.XD_ERROR1"),!1)},n.getgiveXd=function(){n.checkEmailFormat(n.userXd)&&n.checkXdFormat(n.userXd)&&o.getgiveXd(n.userXd).then(function(e){200==e.data.code?n.$close():1003==e.data.code?n.mailFormatErr=e.data.msg:1010==e.data.code&&(n.xdFormatErr=e.data.msg)})},n.cancel=function(){n.$close()}}]),angular.module("usercenter.trash",[]),angular.module("usercenter.trash").controller("TrashCtrl",["$location","$rootScope","$scope","usercenterService","ModalService","$translate","fileService","MineService","sceneService","dataCacheService",function(e,n,t,r,o,c,s,i,a,u){t.PREFIX_CLIENT_HOST=PREFIX_HOST;var l=n.branchid;t.scene={type:null},t.pageSize=12,t.sceneCurrent={page:"",total:""},t.imageCurrent={page:"",total:""},t.historyTab={page:{}};var d=function(e){t.sceneHistory=e,"scene"==e?t.historyTab={pages:{currentPage:t.sceneCurrent.page,totalItems:t.sceneCurrent.total,pageSize:12}}:t.historyTab={pages:{currentPage:t.imageCurrent.page,totalItems:t.imageCurrent.total,pageSize:21}}};t.getMyScenes=function(e,n){t.sceneHistory=n,i.getMyHistoryScenes(e,t.pageSize,l).then(function(e){if(e.data.list&&e.data.list.length>0){t.myScenes=e.data.list;for(var r=0;r<t.myScenes.length;r++)t.myScenes[r].time=new Date(t.myScenes[r].delTime).getTime()+2592e5,t.myScenes[r].history=Math.round((t.myScenes[r].time-(new Date).getTime())/1e3/60/60/24);t.sceneCurrent.total=e.data.map.count,t.sceneCurrent.page=e.data.map.pageNo}else t.sceneTotalItems=0,t.sceneCurrent.total=0,t.sceneCurrent.page>1?t.getMyScenes(--t.sceneCurrent.page,"scene"):t.myScenes=[];d(n)})},t.getMyScenes(1,"scene"),t.deleteScene=function(e,n){o.openConfirmDialog({msg:"确定彻底删除此微课?"},function(){a.deleteSceneById(e,n).then(function(){t.getMyScenes(t.historyTab.pages.currentPage,"scene")})})},t.revoke=function(e){a.revoke(e).then(function(){t.getMyScenes(t.historyTab.pages.currentPage,"scene")})},t.$on("images.update",function(e,n,r){t.images=n.list;for(var o=0;o<t.images.length;o++)t.images[o].time=new Date(t.images[o].delTime).getTime()+2592e5,t.images[o].history=Math.round((t.images[o].time-(new Date).getTime())/1e3/60/60/24);t.imageCurrent.total=n.map.count,t.imageCurrent.page=n.map.pageNo,d(r)}),t.getImages=function(e,r){t.sceneHistory=r,s.userRecycle(e,21).success(function(e){e.success?n.$broadcast("images.update",e,r):alert(e.msg)}).error(function(){alert("网络连接超时，请稍后重试")})},t.$on("file.delete",function(e){t.getImages(t.historyTab.pages.currentPage,"image")}),t.deleteImg=function(e,n){o.openConfirmDialog({msg:"确定彻底删除此图片?"},function(){t.deleteFile(e,n)})},t.deleteFile=function(e,t){s.deleteFile1(e,t).success(function(e){e.success?n.$broadcast("file.delete"):alert(e.msg)}).error(function(){alert("网络连接超时，请稍后重试")})},t.imageRevoke=function(e){s.fileRevoke(e).success(function(e){e.success?(t.getImages(t.historyTab.pages.currentPage,"image"),u.clear("fileService")):alert(e.msg)}).error(function(){alert("网络连接超时，请稍后重试")})},t.pageChanged=function(e){return 1>e||e>t.historyTab.pages.totalItems/10+1?void alert(c.instant("main.customer.PAGE_OVERFLOW")):void("scene"==t.sceneHistory?t.getMyScenes(e,"scene"):t.getImages(e,"image"))}}]),angular.module("usercenter.upgrade",["services.usercenter","services.i18nNotifications"]),angular.module("usercenter.upgrade").controller("UsercenterupgradeCtrl",["$rootScope","$scope","$window","$translate","usercenterService","security","$modal","ModalService","i18nNotifications","$timeout","user",function(e,n,t,r,o,c,s,i,a,u,l){function d(){0===p?(n.isCodeAccessiable=!1,n.codeTip=r.instant("usercenter.account.CODE_TIP1"),p=60):(n.isCodeAccessiable=!0,n.codeTip=r.instant("usercenter.account.CODE_TIP2")+"("+p+")",u(function(){p--,d()},1e3))}n.companyInfo={id:l.id},n.checkName=function(e){return e.name?countCharacters(e.name)>40?(n.nameError="企业名称不能超过40个字符",!1):(n.nameError="",!0):(n.nameError="请填写企业名称",!1)},n.checkEmail=function(e){var t=/^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;return e.email&&!t.test(e.email)?(n.emailError="请正确填写邮箱",!1):e.email?(n.emailError="",!0):(n.emailError="请填写企业邮箱",!1)},n.checkcontacts=function(e){return e.contacts?countCharacters(e.contacts)>30?(n.contactsError="联系人不能超过30个字符",!1):(n.contactsError="",!0):(n.contactsError="请填写联系人",!1)},n.checkCode=function(e){return e.code?(n.codeError="",!0):(n.codeError="请输入手机验证码",!1)},n.getCode=function(e){return e.mobile?(n.telError="",void o.companyMobile(e.mobile).then(function(e){e.data.success?d():n.telError=e.data.msg})):(n.telError="请填写手机号码",!1)};var p=60;n.checkFormFormat=function(e){return!!(n.checkName(e)&&n.checkEmail(e)&&n.checkcontacts(e)&&n.checkCode(e))},n.upgradeCompanyMessage=function(t){n.checkFormFormat(t)&&o.saveCompanyInfo(t).then(function(r){r.data.success?(a.pushForCurrentRoute("account.success","notify.success"),e.$broadcast("companyState"),n.$close(t.mobile)):n.codeError=r.data.msg})},n.quXiao=function(){n.$dismiss()}}]),angular.module("usercenter",["services.usercenter","services.localizedMessages","security.service","services.i18nNotifications","security.thirdparty","app.directives.addelement","services.modal","app.directives.qrcode","services.file","services.mine","services.scene","services.dataCache","usercenter.transfer","usercenter.upgrade","usercenter.request","usercenter.relAccount","usercenter.branch","usercenter.branch.reset","usercenter.checkMobil","usercenter.relRegisterAccount","userCenter.userGuide","usercenter.tab","usercenter.privilege"]),angular.module("usercenter").controller("UserCenterCtrl",["$rootScope","$scope","$window","$stateParams","usercenterService","security","$modal","ModalService","$location","$filter","fixnumFilter","i18nNotifications","thirdpartyService","$translate","$timeout",function(e,n,t,r,o,c,s,i,a,u,l,d,p,m,f){n.PREFIX_FILE_HOST=PREFIX_FILE_HOST,n.PREFIX_SERVER_HOST=PREFIX_URL,n.PREFIX_CLIENT_HOST=PREFIX_HOST,n.isActive="usercenter",n.isVendorUser=c.isVendorUser(),n.editInfo={isEditable:!1},n.isDomainAccessable=c.isAllowToAccess(c.accessDef.ACCESS_DOMAIN_BIND),n.isAllowedHistory=c.isAllowToAccess(c.accessDef.USERCENTER_HISTORY),n.isAllowedApply=c.isAllowToAccess(c.accessDef.APPLY_XIUKE),n.password={},n.pageSize=5,n.XdpageNo=1,n.XdtoPage="",n.pageNo=1,n.toPage=n.XdcurrentPage=1,n.branchToPage=1,n.viewControl={tab:r.id},n.showTab=function(e){a.path("/usercenter/"+e,!1),n.viewControl.tab=e},n.currentUser=c.currentUser,n.getUserXd=function(){o.getUserXd().then(function(e){e.data.success&&(n.xdCounts=e.data.obj)})},n.getUserXd(),n.getUserInfo=function(){o.getUserInfo().then(function(e){n.userinfo=e.data.obj,n.master=angular.copy(n.userinfo),n.url="我做的企业秀，用的是微学宝，免费好用，你试试吧：\r\n"+PREFIX_HOST+"/#/home/register?u="+n.userinfo.id;var t=/^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;"eqs"!=n.userinfo.loginName.substr(0,3)||t.test(n.userinfo.loginName)||(n.userinfo.noRel="未绑定",/(_qq)$/.test(n.userinfo.loginName)&&(n.qqRel=!0),/(_weixin)$/.test(n.userinfo.loginName)&&(n.wxRel=!0),/(_weibo)$/.test(n.userinfo.loginName)&&(n.wbRel=!0)),/qq/gi.test(n.userinfo.relType)&&(n.qqRel=!0),/weixin/gi.test(n.userinfo.relType)&&(n.wxRel=!0),/weibo/gi.test(n.userinfo.relType)&&(n.wbRel=!0),a.search().bindemail&&n.relAccount(),4==n.userinfo.type})},n.getUserInfo(),n.editMessage=function(){var e,t,r;4==n.userinfo.type?(e="/Public/eq/6.0/templates/usercenter.console.serverinfo.html",t="ApplyCtrl",r="服务会员基本信息"):(e="/Public/eq/6.0/templates/usercenter.console.companyinfo.html",t="companyInfoCtrl"),s.open({windowClass:"six-contain",templateUrl:e,controller:t,scope:n,resolve:{userinfo:function(){return{nick:n.userinfo.nick,type:n.userinfo.type,id:n.userinfo.id,title:r}}}}).result.then(function(e){4==n.userinfo.type?(n.applyInfo=e.status,n.userinfo.nick=e.applyInfoNew.nick):n.userinfo.nick=e.nick},function(){})},n.copyCode=function(){var e,n;e=$(".invitation-contain span"),n=e.html(),clipboard.setData("text/plain",n)},n.tabid=r.id,n.customerUpload=function(){s.open({windowClass:"img_console console",templateUrl:"/Public/eq/6.0/templates/scene.console.bg.tpl.html",controller:"BgConsoleCtrl",resolve:{obj:function(){return{fileType:1}}}}).result.then(function(t){if(t.width/t.height===1){n.userinfo.headImg=t.data;var r={headImg:t.data,id:n.userinfo.id};return void o.saveUserInfo(r).then(function(r){r.data.success&&(n.editInfo.isEditable=!1,e.$broadcast("headImg.change",t.data))})}s.open({windowClass:"console seven-contain",templateUrl:"/Public/eq/6.0/templates/scene.console.imageCrop.tpl.html",controller:"imageCropCtrl",backdrop:"static",resolve:{obj:function(){return{type:"square",properties:{src:t.data}}}}}).result.then(function(t){n.userinfo.headImg=t.src;var r={headImg:t.src,id:n.userinfo.id};o.saveUserInfo(r).then(function(t){t.data.success&&(n.editInfo.isEditable=!1,e.$broadcast("headImg.change",t.data.obj.headImg))})},function(e){})},function(e){})},n.domain=function(){s.open({windowClass:"six-contain",templateUrl:"/Public/eq/6.0/templates/usercenter.domain.tpl.html",controller:"UserCenterCtrl",resolve:{param:function(){return{value:n.domainMess}}}}).result.then(function(){getDomainMess()},function(){})},n.applyShow=function(){s.open({windowClass:"six-contain",templateUrl:"/Public/eq/6.0/templates/usercenter.console.serverinfo.html",controller:"ApplyCtrl",backdrop:"static",invoice:!0,resolve:{userinfo:function(){return{status:n.applyInfo,id:n.userinfo.id,title:"申请成为秀客获取服务商账号",invoice:!0}}}}).result.then(function(e){n.applyInfo=e},function(){})},f(function(){("4"==n.userinfo.type||"1"==n.userinfo.type)&&o.getUserStatus().then(function(e){n.applyInfo=e.data.map.status})},300),n.know=function(){n.xiudian=!1},n.buyXd=function(){s.open({windowClass:"console six-contain",templateUrl:"?c=pay",controller:"BuyXdController",resolve:{getUserXd:function(){return function(){n.getUserXd(),n.getXdlog(n.XdtoPage)}}}}).result.then(function(){},function(){})}}]).controller("BuyXdController",["$scope","$modal","usercenterService","ModalService","getUserXd",function(e,n,t,r,o){e.confirm=function(){t.getPayXdQrCode(10,1).then(function(t){if(e.$close(),t.data.success){var c=t.data.obj;n.open({windowClass:"console",templateUrl:"/Public/eq/6.0/templates/usercenter.payment.tpl.html",controller:"PayMentCtrl",resolve:{qrCodeUrl:function(){return c},type:function(){return 10},money:function(){return["500元"]},method:function(){return"buyXd"},counts:function(){}}}).result.then(function(){o()},function(){})}else r.openMsgDialog({msg:t.data.msg})})},e.cancel=function(){e.$close()}}]);