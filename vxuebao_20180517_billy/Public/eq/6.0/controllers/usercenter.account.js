angular.module("usercenter.account",["usercenter.relEmail"]),angular.module("usercenter.account").controller("UsercenterAccountCtrl",["$location","$rootScope","$scope","$window","usercenterService","$modal","ModalService","i18nNotifications","security","thirdpartyService","$translate","$timeout",function(e,n,r,o,t,s,c,i,a,u,l,h){function f(){r.progress="0",1==r.userinfo.checkEmail&&1==r.userinfo.checkPhone?(r.redColor=!1,h(function(){r.progress="90"},100)):1!=r.userinfo.checkEmail&&1!=r.userinfo.checkPhone?(h(function(){r.progress="20"},100),r.redColor=!0):(1!=r.userinfo.checkEmail&&1==r.userinfo.checkPhone||1==r.userinfo.checkEmail&&1!=r.userinfo.checkPhone)&&(r.redColor=!1,h(function(){r.progress="60"},100))}function d(e){e&&(e.state&&/WECHAT_STATE/.test(e.state)?(b={code:e.code,type:"weixin"},u.bindAccountCommon(b)):u.qqBindAccount(e))}r.PREFIX_CLIENT_HOST=PREFIX_HOST,r.XdpageSize=10,r.page={},r.pageChanged=function(e){return 1>e||e>r.branchesCount/10+1?void alert("此页超出范围"):(r.currentPage=e,void r.getBranches(e))},r.getBranches=function(e){t.getBranches(r.XdpageSize,e).then(function(e){e.data.success&&(r.branches=e.data.list,r.branchesCount=e.data.map.count,r.page.currentPage=e.data.map.pageNo,r.toPage=e.data.map.pageNo,r.branchesNumPages=Math.ceil(r.branchesCount/r.XdpageSize),p())},function(){})},r.getBranches(r.pageNo),r.branchName={};var p=function(){var o=e.search().branchid;if(o)for(var t=0;t<r.branches.length;t++)r.branches[t].id==o&&(r.branchName.name=r.branches[t].loginName);else n.branchid="",e.search("branchid",null)};r.$watch("branchid",function(e,n){e!=n&&p()}),r.changeCurrent=function(){n.branchid="",e.search("branchid",null)},r.selectBranch=function(r){n.branchid=r.id,e.path("main"),e.search({branchid:n.branchid})},r.$watch("userinfo",function(e){e&&f()});var m=/^EQS.*qq$/,g=/^EQS.*weixin$/;r.qqShow=!0,r.weixinShow=!0,m.test(a.currentUser.loginName)&&(r.qqShow=!1),g.test(a.currentUser.loginName)&&(r.weixinShow=!1);var w=null;r.goReset=function(){w=s.open({windowClass:"six-contain",templateUrl:BASE_URL+"templates/usercenter.tab.reset.tpl.html",controller:"UsercenterAccountCtrl",scope:r}).result.then(function(){w=null},function(){w=null})},r.checkOldPassword=function(){return r.password.old?(r.oldPassError="",!0):(r.oldPassError="原始密码不能为空",!1)},r.checkPassword=function(){if(r.password.newPw){if(/^[a-zA-Z0-9]{6,16}$/g.test(r.password.newPw))return r.passError="",!0;r.passError="密码为6~16个字符(英文字母或数字，区分大小写)"}else r.passError="新密码不能为空";return!1},r.checkRepeatPassword=function(){if(r.password.confirm){if(r.password.confirm==r.password.newPw)return r.rPassError="",!0;r.rPassError="两次密码输入不一致，请重新输入"}else r.rPassError="确认密码不能为空";return!1},r.reset=function(){if(r.checkOldPassword()&&r.checkPassword()&&r.checkRepeatPassword()){if(angular.equals(r.master,r.password))return void(r.authError="请不要重复提交！");r.oldPassError="",r.passError="",r.rPassError="",a.resetPassword(r.password.old,r.password.newPw).then(function(e){e.data.success?(i.pushForCurrentRoute("reset.psw.success","notify.success"),r.master=angular.copy(r.password),r.$close(r.master)):r.oldPassError=e.data.msg})}},r.quXiao=function(){r.$dismiss()},r.manageBranch=function(e){var n=e;if(!e)if(3==a.currentUser.memberType){if(r.branchesCount>=100)return void c.openMsgDialog({msg:"子账号数量已达到限制!"})}else if(2==a.currentUser.memberType){if(r.branchesCount>=50)return void c.openMsgDialog({msg:"子账号数量已达到限制!"})}else if(r.branchesCount>=30)return void c.openMsgDialog({msg:"子账号数量已达到限制!"});s.open({windowClass:"console six-contain branch-contain",templateUrl:BASE_URL+"templates/usercenter.console.branch.html",controller:"BranchCtrl",resolve:{branch:function(){return e}}}).result.then(function(o){e||(e={}),o.dept&&(e.deptId=o.dept.id,e.deptName=o.dept.name),e.name=o.name,e.id=o.id,e.extPermi=o.extPermi,n?r.branchesCount++:(e.loginName=o.loginName,e.status=1,e.regTime=(new Date).getTime(),r.branches.unshift(e),r.branches.length>10&&r.branches.splice(r.branches.length-1,1)),r.$emit("addBranch",e)},function(){})},r.openBranch=function(e,n){t.openBranch(e.id,n).then(function(r){r.data.success&&(n?(e.status=1,i.pushForCurrentRoute("branch.open.success","notify.success")):(e.status=2,i.pushForCurrentRoute("branch.close.success","notify.success")))},function(){alert("服务器异常")})},r.$on("rel.success",function(e,n){i.pushForCurrentRoute("mail.rel.success","notify.success"),"weixin"==n?r.wxRel=!0:"qq"==n&&(r.qqRel=!0)}),r.$watch("currentPage.branchCurrentPage",function(e,n){e!=n&&(r.getBranches(e),r.branchToPage=e)}),r.checkMobile=function(e){s.open({windowClass:"six-contain mobile-contain",templateUrl:BASE_URL+"templates/usercenter.console.checkMobile.html",controller:"CheckMobileCtrl",scope:r,resolve:{userinfo:function(){return{title:e,phone:r.userinfo.phone}}}}).result.then(function(e){r.userinfo.phone=e,r.userinfo.checkPhone=1},function(){})},r.createAccount=function(){r.emailAccount=!1,s.open({windowClass:"six-contain",templateUrl:BASE_URL+"templates/usercenter.console.register.html",controller:"RelRegisterAccountCtrl",scope:r,resolve:{userinfo:function(){return{id:r.userinfo.id}}}}).result.then(function(n){r.userinfo.noRel=null,r.userinfo.loginName=n.email,/qq/gi.test(n.type)&&(r.qqRel=!0),/weixin/gi.test(n.type)&&(r.wxRel=!0),/weibo/gi.test(n.type)&&(r.wbRel=!0),e.search("bindemail",null)},function(){e.search("bindemail",null)})},r.relAccount=function(n){r.emailAccount=!1,s.open({windowClass:"six-contain",templateUrl:BASE_URL+"templates/usercenter.console.relAccount.html",controller:"RelAccountCtrl",scope:r,resolve:{userinfo:function(){return{id:r.userinfo.id}}}}).result.then(function(n){r.userinfo.noRel=null,r.userinfo.loginName=n.email,/qq/gi.test(n.type)&&(r.qqRel=!0),/weixin/gi.test(n.type)&&(r.wxRel=!0),/weibo/gi.test(n.type)&&(r.wbRel=!0),e.search("bindemail",null)},function(){e.search("bindemail",null)})},r.relEmail=function(e){return r.userinfo.noRel?(alert("请先绑定账号"),void r.createAccount()):void s.open({windowClass:"six-contain",templateUrl:BASE_URL+"templates/usercenter.console.relEmail.html",controller:"RelEmailCtrl",scope:r,resolve:{userinfo:function(){return{id:r.userinfo.id,email:r.userinfo.email,checkEmail:r.userinfo.checkEmail,title:e}}}}).result.then(function(){},function(){})},r.verifyEmail=function(){t.verifyEmail().then(function(e){200==e.data.code&&c.openMsgDialog({msg:"申请绑定成功,已向您的邮箱发送验证邮件,请注意查收。"},function(){})},function(e){})},r.bindThirdAccount=function(e){return r.userinfo.noRel?(alert("请先绑定账号"),void r.createAccount()):void u.openThirtyPartyWindow(e)},r.unbindRelation=function(e){u.unbindRelation(e)},r.$on("mail.unbind.success",function(e,n){i.pushForCurrentRoute("mail.unbind.success","notify.success"),"weixin"==n?r.wxRel=!1:"qq"==n&&(r.qqRel=!1)});var b;o.setValue=function(e){r.bindParam=e,d(r.bindParam),r.$apply()},r.emailAccount=!1,r.upgradeCompany=function(){"eqs"==r.userinfo.loginName.substr(0,3)&&null==r.userinfo.email?r.emailAccount=!0:s.open({windowClass:"seven-contain",templateUrl:BASE_URL+"templates/usercenter.console.upgrade_company.html",controller:"UsercenterupgradeCtrl",resolve:{user:function(){return{id:r.userinfo.id}}}}).result.then(function(e){r.userinfo.phone=e,r.userinfo.checkPhone=1,a.currentUser.type=2},function(){})},r.companyMes=!0,r.$on("companyState",function(){r.companyInfo||(r.companyInfo={}),r.companyMes=!1,r.userinfo.type=2})}]);