angular.module("scene.create.longpage",[]),angular.module("scene.create.longpage").controller("CreateLongPageSceneCtrl",["$timeout","$compile","$rootScope","$scope","$stateParams","$state","$location","sceneService","pageTplService","$modal","ModalService","security","$window","i18nNotifications","historyService","selectService","continueUrl","triggerService","staticResService","dataCacheService","fileService","storageService","gridGuide","$element","$http","uploaderService","sceneViewService","$interval",function(e,t,n,a,o,s,l,p,r,c,g,d,u,m,f,h,b,y,T,v,S,w,P,C,j,A,F,H){function B(){var e=!1;return angular.forEach(a.tpl.obj.elements,function(t){6==(""+t.type).charAt(0)&&(e=!0)}),e}function E(e,t,o,i){sessionStorage.setItem("pageid",a.pages[e-1].id),a.loading=!0,a.pageId=a.pages[e-1].id,p.getSceneByPage(a.pageId,t,o).then(function(i){var s;if(a.font=i.data.obj.scene.font,!isEmpty(a.longpage)||i.data.obj.properties&&i.data.obj.properties.longpage?(a.pageHeight=isEmpty(a.longpage)?i.data.obj.properties.longpage.longpageHeight:a.longpage.longpageHeight,sessionStorage.setItem("longpageID",i.data.obj.id),sessionStorage.setItem("longpageHeight",a.pageHeight)):(a.longpage={longpageHeight:486,islongpage:!0,id:i.data.obj.id},a.pageHeight=486,s={longpage:a.longpage},sessionStorage.setItem("longpageID",a.longpage.id),sessionStorage.setItem("longpageHeight",a.longpage.longpageHeight)),a.loading=!1,a.tpl=i.data,a.tpl.obj.properties?!a.tpl.obj.properties.longpage&&(a.tpl.obj.properties.longpage=a.longpage):a.tpl.obj.properties=s,R=a.tpl.obj.properties,R&&R.trigger&&y.setTrigger(a.tpl.obj.id,I.trigger),delete a.tpl.obj.scene,a.sceneId=a.tpl.obj.sceneId,a.controlView.showBgTag=!1,angular.forEach(a.tpl.obj.elements,function(e,t){3==e.type&&(a.controlView.showBgTag=!0,a.currentBgDef=e)}),R)if(R.image||R.scratch)a.effectName="涂抹";else if(R.finger)a.effectName="指纹";else if(R.effect)switch(R.effect.name){case"money":a.effectName="数钱";break;case"snowFly":a.effectName="飘雪";break;case"fireWorks":a.effectName="烟花";break;case"none":a.effectName="无"}else R.fallingObject&&(a.effectName="环境");(t||o)&&(l.$$search={},l.search("pageId",++e),a.getPageNames()),a.pageNum=e,$("#nr").empty();var r=angular.copy(a.tpl.obj);r.elements=f.addPage(r.id,r.elements),p.templateEditor.parse({def:a.tpl.obj,appendTo:"#nr",mode:"edit"}),a.originData=JSON.stringify(a.tpl),n.$broadcast("dom.changed",a.pageHeight),a.loadTime++,a.editLoading=!1},function(){a.loading=!1})}function x(){m.pushForCurrentRoute("scene.save.success.nopublish","notify.success")}n.$on("picture.show",function(e){a.picture=!0,a.bg=!1,a.model=!1,a.tabid="template",a.pageTpl={},a.getPageTpls()}),n.$on("bg.show",function(e){a.bg=!0,a.picture=!1,a.model=!1,a.tabid="template",a.pageTpl={},a.getPageTpls()}),a.$on("model.show",function(e){a.model=!0,a.picture=!1,a.bg=!1,a.tabid="template",a.pageTpl={},a.getPageTpls()}),window.isEmpty=function(e){for(var t in e)return!1;return!0};var L,N=21,O=1,D=0,U=!1,M=1;if(a.loading=!1,a.PREFIX_FILE_HOST=PREFIX_FILE_HOST,a.tpl={},a.originData="",a.font=[],a.scale=1,a.bigger=!0,a.smaller=!0,a.longpage={},a.loadTime=0,a.picture=!1,a.picTag=[],a.showPicTag=!1,a.bg=!1,a.fileType=0,a.model=!0,a.marginTop=1==a.scale?-314:parseInt(-314-2*M),a.pageHeight=486,a.scenePicUrl="",a.templateType=1,a.controlView={},a.showSearch=!0,a.completeHtml2Canvas=null,a.editLoading=!0,a.lastPageTypes=[{name:"微学宝尾页",value:"eqFree"},{name:"微学宝底标",value:"eqLink"},{name:"去掉微学宝展示",value:"eqHide"}],a.pageTpl={},a.isAppEditor=!1,a.tabid="template",a.$watch("user",function(e){if(e)for(var t=0;t<e.roleIdList.length;t++)13==e.roleIdList[t]&&(a.isAppEditor=!0),(4==e.roleIdList[t]||12==e.roleIdList[t]||13==e.roleIdList[t])&&(a.isTplEditor=!0)},!0),a.refreshTpl=function(){D>O&&!U&&(U=!0,a.getPageTpls(++O))},a.showPhone="false",n.$broadcast("switchBox",a.showPhone),w.push("create.phoneView",a.showPhone),a.createComp=function(e,t){return a.sceneSetting.showFlag=!1,"6"==e&&B()?void g.openMsgDialog({msg:"当前页面的提交按钮已经存在，请不要重复添加。"}):void p.createComp(e,null,t)},a.$on("hisChange",function(){f.addPageHistory(a.tpl.obj.id,a.tpl.obj.elements)}),r.getPageTagLabel(11001).then(function(e){a.tplFormatList=e.data.list}),r.getPageTagLabel(11003).then(function(e){a.tplInteractionList=e.data.list}),r.getPageTagLabel(11002).then(function(e){a.tplStyleList=e.data.list}),a.getPageTplTypestemp=function(e,t,n,o){var i,s;a.picture?(a.fileType=4,s=PREFIX_URL+"index.php?c=upfile&a=getfiletype&filetype=tpType",r.getPageTplTypestempLongpage(e,t,n,o,a.fileType).then(function(e){U=!1,e.data.list&&e.data.list.length>0?(O>1?a.pageTpls=a.pageTpls.concat(e.data.list):a.pageTpls=e.data.list,D=Math.ceil(e.data.map.count/n),i=e.config.url.split("&time")[0],v.contains(i)||(v.push("pageTpl",v.getAsyncUrl(),e),v.setAsyncUrl())):(a.pageTpls=[],D=0)}),a.picture&&$.get(s,function(e){a.sysCategoryList=e}),e&&a.picture&&j({withCredentials:!0,method:"GET",url:PREFIX_URL+"index.php?c=upfile&a=systag&type=11&bizType="+e}).then(function(e){e.data.list.length>0?a.showPicTag=!0:(a.showPicTag=!1,a.picTag=[]),a.picTag=e.data.list})):a.bg?(a.fileType=3,s=PREFIX_URL+"index.php?c=upfile&a=getfiletype&filetype=bgType",r.getPageTplTypestempLongpage(e,t,n,o,a.fileType).then(function(e){U=!1,e.data.list&&e.data.list.length>0?(O>1?a.pageTpls=a.pageTpls.concat(e.data.list):a.pageTpls=e.data.list,D=Math.ceil(e.data.map.count/n),i=e.config.url.split("&time")[0],v.contains(i)||(v.push("pageTpl",v.getAsyncUrl(),e),v.setAsyncUrl())):(a.pageTpls=[],D=0)}),$.get(s,function(e){a.sysCategoryList=e}),e&&j({withCredentials:!0,method:"GET",url:PREFIX_URL+"index.php?c=upfile&a=systag&type=11&bizType="+e}).then(function(e){e.data.list.length>0?a.showPicTag=!0:(a.showPicTag=!1,a.picTag=[]),a.picTag=e.data.list})):(a.fileType=0,r.getPageTplTypestempLongpage(e,t,n,o,a.fileType).then(function(e){U=!1,e.data.list&&e.data.list.length>0?(O>1?a.pageTpls=a.pageTpls.concat(e.data.list):a.pageTpls=e.data.list,D=Math.ceil(e.data.map.count/n),i=e.config.url.split("&time")[0],v.contains(i)||(v.push("pageTpl",v.getAsyncUrl(),e),v.setAsyncUrl())):(a.pageTpls=[],D=0)}))},a.enterPress=function(e){var t=e||window.event;13==t.keyCode&&a.getPageTpls()},a.getPageTpls=function(e){var t="";e||(e=O=1);for(var n in a.pageTpl)"name"!=n&&a.pageTpl[n]&&(t+=a.pageTpl[n]+",");""!==t&&(t=t.substr(0,t.length-1)),a.pageTpl.name&&""!==a.pageTpl.name&&(a.showSearch=!1),"myCollection"==a.tabid?a.myPageTpls&&a.getPageTplsByMyType(a.fileType,t,a.pageTpl.name,N,e):a.getPageTplTypestemp(t,a.pageTpl.name,N,e)},a.getPageTpls(),a.resetTplFilter=function(){a.pageTpl.name=null,a.showSearch=!0,a.getPageTpls()},a.support=function(){return(!window.sessionStorage||"false"!==sessionStorage.getItem("checkSuport"))&&(!(navigator.userAgent.match(/Trident/)&&navigator.userAgent.match(/rv:11/)||navigator.userAgent.match(/Chrome/))&&((!navigator.userAgent.match(/iPad/)||!navigator.userAgent.match(/CriOS/))&&(b.setUrl(l.path()),l.path("scene/support"),!0)))},!a.support()){a.createCompGroup=function(e,t){a.sceneSetting.showFlag=!1,"g101"==e&&B()&&(g.openMsgDialog({msg:"当前页面的提交按钮已经存在，本操作将会删除已添加的按钮。"}),angular.forEach(a.tpl.obj.elements,function(e){6==(""+e.type).charAt(0)&&($("#nr").find("#inside_"+e.id).remove(),h.deleteElement(e.id),p.deleteElement(e.id))})),p.createCompGroup(e,null,t)},a.isRadioCheckboxRatingAccessable=d.isAllowToAccess(d.accessDef.RADIO_CHECKBOX_RATING),a.isInteractionAccessable=d.isAllowToAccess(d.accessDef.INTERACTION),a.isInteractionCounterAccessable=d.isAllowToAccess(d.accessDef.INTERACTION_COUNTER),a.updateCompPosition=p.updateCompPosition,a.updateCompAngle=p.updateCompAngle,a.updateCompSize=p.updateCompSize,a.openAudioModal=p.openAudioModal,a.openTriggerMode=p.openTriggerMode,a.$on("dom.changed",function(e,o){t($("#nr"))(a),a.container=C.find(".edit_wrapper"),a.pageHeight=o?o:a.pageHeight,!a.container.find(".eq-block-grid")[0]&&P.grid.init(a.container),!a.container.find(".eq-block-guides")[0]&&P.guide.init(a.container),n.$broadcast("boxOuter")});var k=null;a.$on("showCropPanel",function(e,o){var i=$(".content").eq(0);k?(n.$broadcast("changeElemDef",o),k.show()):k=t("<div crop-image></div>")(a),i.append(k)}),a.openPageEffectModal=function(e){var t=angular.copy(e);c.open({windowClass:"console six-contain effect-console",templateUrl:BASE_URL+"templates/scene.console.pageeffect.tpl.html",controller:"pageEffectCtrl",resolve:{properties:function(){return t}}}).result.then(function(e){a.tpl.obj.properties||(a.tpl.obj.properties={}),a.tpl.obj.properties.scratch=null,a.tpl.obj.properties.finger=null,a.tpl.obj.properties.fallingObject=null,a.tpl.obj.properties.effect=null,"无"!=e.name&&(a.tpl.obj.properties[e.value]=e.properties[e.value]),a.effectName=e.name},function(){n.$broadcast("clear.scratch.interval")})};var R,_=null;a.$on("showStylePanel",function(e,n){var o=$("#containment").eq(0);_?_.show():"style"==n.activeTab?_=t('<div style-modal active-tab="style"></div>')(a):"anim"==n.activeTab?_=t('<div style-modal active-tab="anim"></div>')(a):"trigger"==n.activeTab&&(_=t('<div style-modal active-tab="trigger"></div>')(a)),o.append(_),$(".longpageStatis").length>0&&$(".longpageStatis").hide()}),a.$on("hideStylePanel",function(e){_&&_.hide()}),a.refreshPage=function(e,t){return a.completeHtml2Canvas?void a.completeHtml2Canvas.then(function(){a.refreshPage(e,t)}):(parseInt(t,10),$("#nr").empty(),p.templateEditor.parse({def:a.tpl.obj,appendTo:"#nr",mode:"edit"}),void n.$broadcast("dom.changed"))},a.saveUsedFiles=function(e){var t=[];$.extend(t,a.tpl.obj.elements);for(var n=JSON.parse(a.originData).obj.elements,o=0;o<t.length;o++){var i=t[o];if(i.sound||i.type+""=="3"||i.type+""=="4")for(var s=0;s<n.length;s++){var l=n[s];if(i.id==l.id){i.type+""!="3"&&i.type+""!="4"?!i.sound||l.sound&&l.sound.id==i.sound.id||v.pushUsedFile(2,i.sound.id):i.properties.id!=l.properties.id&&v.pushUsedFile(1,i.properties.id);break}s==n.length-1&&(i.type+""!="3"&&i.type+""!="4"?v.pushUsedFile(2,i.sound.id):v.pushUsedFile(1,i.properties.id))}}var p=v.getUsedFiles();v.clearUsedFiles(),p?S.saveFilesHistory(p.file,p.type).then(function(){e&&e()}):e&&e()},a.stopCopy=function(){copied=!1},a.getPageNames=function(){var e=o.sceneId;p.getPageNames(e).then(function(e){a.pages=e.data.list,E(l.search().pageId?l.search().pageId:a.pages[0].num)})},a.scene=null,p.getSceneDetail(o.sceneId,n.branchid).then(function(e){a.scene=p.getCurrentScene(),a.sceneSetting.oldBgAudio=a.scene.bgAudio,a.getPageNames()}),a.removeScratch=function(e){e.stopPropagation(),a.tpl.obj.properties.scratch=null,a.tpl.obj.properties.finger=null,a.tpl.obj.properties.fallingObject=null,a.tpl.obj.properties.effect=null},a.$on("text.click",function(n,o){$("#btn-toolbar").remove(),$("body").append(t("<toolbar></toolbar>")(a));var i=$(o).offset().top;e(function(){$("#btn-toolbar").css("top",i-50),$("#btn-toolbar").show(),$("#btn-toolbar").bind("click mousedown",function(e){e.stopPropagation()}),$(o).wysiwyg_destroy(),$(o).wysiwyg(),$(o).trigger("dblclick").focus(),setTimeout(function(){if(window.getSelection){var e=window.getSelection();e.modify("move","left","documentboundary"),e.modify("extend","right","documentboundary")}})})}),a.findMultilFont=function(){var e=a.tpl.obj.elements,t=[];a.font=[];for(var n=0;n<e.length;n++)"x"==e[n].type&&t.push($(e[n].content).css("font-family"));if(t.length>0)for(var o=0;o<t.length;o++)a.font.indexOf(t[o])<0&&t[o]&&a.font.push(t[o]);return a.tpl.obj&&(a.tpl.obj.font=a.font),a.tpl.obj},Array.prototype.indexOf=function(e){for(var t=0;t<this.length;t++)if(this[t]==e)return t;return-1},Array.prototype.remove=function(e){var t=this.indexOf(e);t>-1&&this.splice(t,1)},n.$on("make.shortPic.complete",function(e,t){a.scenePicUrl=t});var q=!1;a.saveScene=function(e,t){if(n.$broadcast("make.shortPic"),!a.scene.name&&e&&!a.sceneSetting.showFlag)return void g.openMsgDialog({msg:"尚未设置标题，请设置后再执行此操作",btn:"去设置"},function(){a.sceneSetting.showFlag=!0});if(!q){if(a.findMultilFont(),a.sceneSetting.showFlag)return void a.sceneSetting.saveSceneSetting().then(function(){a.saveScene(e,t)});if(a.sceneSetting.oldBgAudio!=a.scene.bgAudio)return void p.saveSceneSettings(a.scene).then(function(){S.saveFilesHistory(a.scene.bgAudio?a.scene.bgAudio.id:0,2).then(function(){v.clear("fileService1")}),a.sceneSetting.oldBgAudio=a.scene.bgAudio,a.saveScene(e,t)});if(a.completeHtml2Canvas)return void a.completeHtml2Canvas.then(function(){a.saveScene(e,t)});if(q=!0,a.originData==JSON.stringify(a.tpl))return t&&t(),e&&(!a.scene.publishTime||a.scene.updateTime>a.scene.publishTime?x():m.pushForCurrentRoute("scene.save.success.published","notify.success")),void(q=!1);delete a.tpl.obj.scene,p.resetCss(),p.saveScene(a.tpl.obj).then(function(n){return e&&a.saveUsedFiles(),q=!1,n.data.success?(a.scene.updateTime=(new Date).getTime(),a.originData=angular.toJson(a.tpl),L&&(p.recordTplUsage(L),L=null),t&&t(),void(e&&x())):void alert("保存失败，服务器忙碌请稍后再试。")},function(){q=!1,alert("保存失败，服务器忙碌请稍后再试。")})}},a.publishScene=function(){return"true"!=n.user.company_ext.is_audit?a.scene.name||a.sceneSetting.showFlag?2!=a.scene.status||a.allowPublish?a.sceneSetting.showFlag?void a.sceneSetting.saveSceneSetting().then(function(){a.publishScene()}):a.sceneSetting.oldBgAudio!=a.scene.bgAudio?void p.saveSceneSettings(a.scene).then(function(){a.scene.bgAudio?S.saveFilesHistory(a.scene.bgAudio.id,2).then(function(){v.clear("fileService1"),a.sceneSetting.oldBgAudio=a.scene.bgAudio,a.publishScene()}):(a.sceneSetting.oldBgAudio=a.scene.bgAudio,a.publishScene())}):a.completeHtml2Canvas?void a.completeHtml2Canvas.then(function(){a.publishScene()}):!a.allowPublish&&a.scene.publishTime&&a.scene.updateTime<=a.scene.publishTime&&a.originData==angular.toJson(a.tpl)?void l.path("spread/share/"+a.sceneId+"/socialShare"):void a.saveUsedFiles(function(){a.saveScene(null,function(){p.publishSceneLongPage(a.tpl.obj.sceneId,a.scenePicUrl).then(function(e){e.data.success&&(m.pushForNextRoute("scene.publish.success","notify.success"),l.path("spread/share/"+a.sceneId+"/socialShare"))})})}):void g.openConfirmDialog({msg:"当前微课为不允许访问状态，发布微课将重新对外开放访问 ",confirmName:"坚持发布",cancelName:"保存退出"},function(){a.allowPublish=!0,a.publishScene()},function(){a.saveScene(null,function(){l.path("spread/share/"+a.sceneId+"/socialShare")})}):void g.openMsgDialog({msg:"尚未设置标题，请设置后再执行此操作",btn:"去设置"},function(){a.sceneSetting.showFlag=!0}):void g.openMsgDialog({msg:"您的课件尚未通过审核，不能发布！",btn:"确定"})},a.exitScene=function(){JSON.parse(a.originData),l.$$search={},a.originData==angular.toJson(a.tpl)?l.path("main"):g.openConfirmDialog({msg:"是否保存更改内容？",confirmName:"保存",cancelName:"不保存"},function(){a.saveScene(),l.path("main")},function(){l.path("main")})},a.duplicatePage=function(){a.saveScene(null,function(){E(a.pageNum,!1,!0)})},a.removeBG=function(e){var t,o=a.tpl.obj.elements;for(t=0;t<o.length;t++)if(3==o[t].type){o.splice(t,1);var i;for(i=t;i<o.length;i++)o[i].num--;break}n.$broadcast("remove.scene.bg")},a.triggerToModel=function(){a.$broadcast("model.show")},a.removeBGAudio=function(e){e.stopPropagation(),a.scene.bgAudio=null},$(".scene_title").on("paste",function(e){e.preventDefault();var t=(e.originalEvent||e).clipboardData.getData("text/plain")||prompt("Paste something..");document.execCommand("insertText",!1,t)}),a.myName=[{name:"我的"}],a.myCompany=[{name:"企业"}],a.creatCompanyTemplate=function(){var e=$.extend(!0,{},a.tpl.obj);if(e.islong=1,delete e.scene,n.user){var t=parseInt(n.user.companyTplId,10);t?e.sceneId=t:n.companySceneId?e.sceneId=n.companySceneId:e.sceneId=null,p.saveCompanyTpl(e).then(function(e){e.data.success&&(m.pushForCurrentRoute("companytpl.setting.success","notify.success"),n.companySceneId=e.data.obj,a.$broadcast("model.show"),a.getPageTplsByCompanyType())})}else a.myCompanyTpls=[]},n.$on("saveCompanyTemplate",function(){a.creatCompanyTemplate()});var V=null;a.getPageTplsByCompanyType=function(e){if(1!=parseInt(e)){if(a.myCompanyTpls=[],a.myCompany[0].active=!0,!V)if(n.companySceneId)V=n.companySceneId;else{var t=parseInt(n.user.companyTplId,10);t&&(V=n.companySceneId=t)}V?p.previewSceneLongpage(V).then(function(e){a.myCompanyTpls=e.data.list,a.tabid="company"}):a.tabid="company"}else a.tabid="company"},a.setTplTab=function(){a.tabid="template",a.myPageTpls=[]},a.creatMyTemplate=function(){var e=$.extend(!0,{},a.tpl.obj);if(e.islong=1,delete e.scene,n.user){var t=JSON.parse(n.user.property);t&&t.myTplId?e.sceneId=t.myTplId:n.mySceneId?e.sceneId=n.mySceneId:e.sceneId=null,p.saveMyTpl(e).then(function(e){m.pushForCurrentRoute("mytpl.setting.success","notify.success"),n.mySceneId=e.data.obj,a.$broadcast("model.show"),a.getPageTplsByMyType()})}else a.myPageTpls=[]},a.$on("saveMyTemplate",function(){a.creatMyTemplate()});var G=null;a.getPageTplsByMyType=function(e,t,o,i,s){if(e)a.tabid="myCollection",p.previewSceneLongpage(G,e,t,o,i,s).then(function(e){U=!1,e.data.list&&e.data.list.length>0?(s>1?a.myPageTpls=a.myPageTpls.concat(e.data.list):a.myPageTpls=e.data.list,D=Math.ceil(e.data.map.count/N),time=e.config.url.split("&time")[0],v.contains(time)||(v.push("MyPageTpl",v.getAsyncUrl(),e),v.setAsyncUrl())):(a.pageTpls=[],D=0)});else{if(a.myPageTpls=[],a.myName[0].active=!0,!G)if(n.mySceneId)G=n.mySceneId;else{var l=JSON.parse(n.user.property);l&&l.myTplId&&(G=n.mySceneId=l.myTplId)}G?p.previewSceneLongpage(G).then(function(e){a.myPageTpls=e.data.list,a.tabid="myCollection"}):a.tabid="myCollection"}},a.$on("myPageList.update",function(e,t,n,o){if("my-tpl"==t)for(i=0;i<a.myPageTpls.length;i++)a.myPageTpls[i].id==o&&a.myPageTpls.splice(i,1);if("company-tpl"==t)for(i=0;i<a.myCompanyTpls.length;i++)a.myCompanyTpls[i].id==o&&a.myCompanyTpls.splice(i,1)}),a.$on("myPageList.delete",function(e,t,a){"company-tpl"==t&&21==n.user.type&&(a.context.firstElementChil$scope.outerHTML="")}),a.insertPageTpl=function(e){a.loading=!0;var t=function(e){p.getSceneTpl(e).then(function(e){a.controlView.showBgTag=!1,a.loading=!1,L=e.data.obj.id,a.tpl.obj.elements=p.getElements(),$("#nr").empty(),f.addPageHistory(a.tpl.obj.id,a.tpl.obj.elements),p.templateEditor.parse({def:a.tpl.obj,appendTo:"#nr",mode:"edit"}),angular.forEach(a.tpl.obj.elements,function(e,t){3==e.type&&(a.controlView.showBgTag=!0,a.currentBgDef=e)}),n.$broadcast("dom.changed"),n.$broadcast("switchBox","longpage"),a.$broadcast("boxOuter",parseInt(e.data.properties_text.longpage.longpageHeight))},function(){a.loading=!1})};a.tpl.obj.elements&&a.tpl.obj.elements.length>0?g.openConfirmDialog({msg:"页面模板会覆盖编辑区域已有组件，是否继续？",confirmName:"是",cancelName:"取消"},function(){t(e)}):t(e)},a.$on("history.changed",function(){a.canBack=f.canBack(a.tpl.obj.id),a.canForward=f.canForward(a.tpl.obj.id)}),a.back=function(){return a.completeHtml2Canvas?void a.completeHtml2Canvas.then(function(){a.back()}):(a.controlView.showBgTag=!1,void p.historyBack())},a.forward=function(){return a.completeHtml2Canvas?void a.completeHtml2Canvas.then(function(){a.forward()}):void p.historyForward()},a.openEffects=function(){a.tpl.obj.properties&&(a.tpl.obj.properties.scratch||a.tpl.obj.properties.finger||a.tpl.obj.properties.fallingObject||a.tpl.obj.properties.effect)||a.openPageEffectModal(a.tpl.obj.properties)},a.openBgPanel=function(){a.controlView.showBgTag||a.createComp("3")},a.openAudioPanel=function(){a.scene.bgAudio||a.openAudioModal()},a.closeOtherPanel=function(e){var t=!a.$eval(e);a.showBackgroundPanel=!1,a.showMusicPanel=!1,a.showEffectsPanel=!1,a.gridGuideSetting.showFlag=!1,a.$broadcast("hideBgOption"),a.showBgOptionPanel=!1,a.$eval(e+"="+t)},a.removeAudio=function(e){a.scene.bgAudio=null},a.sceneSetting={showFlag:!1,oldBgAudio:null},a.settingScene=function(){a.sceneSetting.showFlag=!0},"show"==l.search().openSetting&&e(function(){a.sceneSetting.showFlag=!0},100),a.$on("show.edit.bg",function(e,t){a.controlView.showBgTag=!0,a.currBgSrc=t}),a.gridGuideSetting={showFlag:!1},a.replaceBg=function(e){p.openBgModal(e),$("#nr").find(".wrapper-background").css({animation:"","animation-fill-mode":""})},a.changeEditorScaling=function(e){$(".scaleBox").fadeIn(300);var t,n=a.tpl.obj.id==sessionStorage.getItem("longpageID")?sessionStorage.getItem("longpageHeight"):486;"big"==e?(M=0==M?1:M,a.scale<1.5?(t=parseFloat(a.scale),t+=.1,a.scale=parseFloat(t).toFixed(1),M++,a.smaller=!0):(a.bigger=!1,M=6),M<=6&&(a.marginTop=-314-2*M),$(".edit_area").css({height:n,transformOrigin:"top center",transform:"scale("+a.scale+")",top:-2}),$(".box").css({transformOrigin:"top center",transform:"scale("+a.scale+")",marginTop:a.marginTop}),$(".wrapper-background").css({transformOrigin:"top center",transform:"scale("+a.scale+")",marginTop:-297})):(a.scale>1?(t=parseFloat(a.scale),t-=.1,a.scale=parseFloat(t).toFixed(1),M--,a.bigger=!0):(a.smaller=!1,M=0),M>0&&(a.marginTop+=a.scale>=1?2:-M),$(".edit_area").css({height:n,transformOrigin:"top center",transform:"scale("+a.scale+")",top:-2}),$(".box").css({transformOrigin:"top center",transform:"scale("+a.scale+")",marginTop:a.marginTop}),$(".wrapper-background").css({transformOrigin:"top center",transform:"scale("+a.scale+")",marginTop:-297})),P.grid.paint(P.grid.boxWidth,Math.floor(n*a.scale),a.scale)},a.$watch("scale",function(t,n){e(function(){$(".scaleBox").fadeOut(300)},500)}),a.preview=function(){c.open({windowClass:"console preview_console",templateUrl:BASE_URL+"templates/scene.console.longpage.preview.tpl.html",controller:"longPagePreview",resolve:{obj:function(){return{scene:a.scene,height:a.tpl.obj.properties.longpage.longpageHeight}}}}).result.then(function(e){})},a.replaceByClick=function(e,t,n){e.shape||(e.shape={},e.shape.width=n.target.naturalWidth,e.shape.height=n.target.naturalHeight);var a=(e.path||e.tmbPath)&&{type:t,id:e.id,data:e.path||e.tmbPath,width:e.shape.width,height:e.shape.height};4==t?p.addImg(p.getElementData(a.type),a):p.addBg(p.getElementData(a.type),a)},a.uploader=A.uploader(1),a.$on("uploadfiles.add",function(e){v.clear("fileService"),a.myPageTpls.length==N&&a.myPageTpls.splice(a.myPageTpls.length-a.uploader.queue.length-1,a.uploader.queue.length)});var J;a.$on("thumbnailList.update",function(e,t){for(var n=0;n<a.uploader.queue.length;n++)100==a.uploader.queue[n].progress&&(a.uploader.queue.splice(n,1),J=t,a.myPageTpls.unshift(J));v.clear("fileService")}),a.$watch("fileType",function(e,t){var n=3==e?0:1;a.uploader=A.uploader(n);var o=PREFIX_URL+"index.php?c=upfile&a=upload&bizType=0&fileType="+n;a.uploader&&(a.uploader.url=o)}),a.$on("boxOuter",function(e,t,n){var o=t?t:parseInt(sessionStorage.getItem("longpageHeight"))?parseInt(sessionStorage.getItem("longpageHeight")):a.longpage.longpageHeight;a.pageHeight=o,(!n||n&&"DIV"==n)&&($(".box").height(o+34),$(".internal-box").height(o),$(".eq-block-guides").height(o),$(".edit_area").height(o),$(".edit_areaBox").height(o),$(".wrapper-background").height(o),P.grid.paint(P.grid.boxWidth,o),t&&o!=a.tpl.obj.properties.longpage.longpageHeight&&(a.tpl.obj.properties.longpage.longpageHeight=o))}),a.$watch("pageHeight",function(e,t){a.loadTime&&e>=486&&(sessionStorage.setItem("longpageHeight",a.pageHeight),a.$broadcast("boxOuter",parseInt(e)))}),a.addPageLength=function(e){a.pageHeight+=parseInt(e)},a.dePageLength=function(e){a.pageHeight=a.pageHeight-parseInt(e)>486?a.pageHeight-parseInt(e):486}}}]);