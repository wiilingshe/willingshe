angular.module("usercenter.branch",["services.usercenter","services.i18nNotifications"]),angular.module("usercenter.branch").controller("BranchCtrl",["$rootScope","$scope","$window","$stateParams","usercenterService","security","$modal","ModalService","$location","branch","i18nNotifications","$translate",function(e,t,a,r,n,c,i,s,o,d,u,m){t.originData=t.branch=angular.copy(d),t.dept={},t.depts=[],t.resetDefalt=!1,d?t.resetDefalt=!0:(t.resetDefalt=!1,setTimeout(function(){$("button").css("background-color","#ccc")},0),t.branch={}),t.openResetModal=function(e){i.open({windowClass:"console six-contain",templateUrl:BASE_URL+"templates/usercenter_console_resetbranchpass.html",controller:"ResetBranchPassCtrl",resolve:{branch:function(){return e}}}).result.then(function(){u.pushForCurrentRoute("branch.reset.success","notify.success")},function(){})},t.getDepts=function(){t.branch.id&&n.getDepts(t.branch.id).then(function(e){if("false"==e.data.company_ext.is_audit?e.data.company_ext.is_audit=!1:"true"==e.data.company_ext.is_audit&&(e.data.company_ext.is_audit=!0),"false"==e.data.company_ext.is_integral?e.data.company_ext.is_integral=!1:"true"==e.data.company_ext.is_integral&&(e.data.company_ext.is_integral=!0),t.branchPermi.edit="false"!=e.data.company_ext.data_permiss[0]&&0!=e.data.company_ext.data_permiss[0],t.branchPermi.delete="false"!=e.data.company_ext.data_permiss[1]&&0!=e.data.company_ext.data_permiss[1],t.branchPermi.export="false"!=e.data.company_ext.data_permiss[2]&&0!=e.data.company_ext.data_permiss[2],t.branchPermi.audit=e.data.company_ext.is_audit,t.branchPermi.integral=e.data.company_ext.is_integral,t.branchPermi.integralCore=e.data.company_ext.integral_num,t.depts=e.data.list,t.branch.deptName||t.branch.deptId)for(var a=0;a<t.depts.length;a++)if(t.depts[a].id==t.branch.deptId)return void(t.branch.dept=t.depts[a])},function(){})},t.getDepts(),t.authError="",t.checkDeptFormat=function(e){return e.name?countCharacters(e.name)>30?($(".dept-name").addClass("error"),$(".dept-name").change(function(){$(this).removeClass("error")}),t.deptFormatError=m.instant("usercenter.account.DEPT_ERR2"),!1):(t.deptFormatError="",!0):(t.deptFormatError=m.instant("usercenter.account.DEPT_ERR1"),$(".dept-name").focus(),deptF={},!1)},t.addDept=function(){t.checkDeptFormat(t.dept)&&n.addDept(t.dept).then(function(e){e.data.success&&(t.showAddSec=!1,t.depts.unshift({id:e.data.obj,name:t.dept.name}),u.pushForCurrentRoute("dept.create.success","notify.success"),t.dept={})},function(){t.authError=m.instant("usercenter.account.SERVER_ERROR")})},t.branchPermi={edit:!1,delete:!1,export:!1,audit:!1,integral:!1,integralCore:0},t.branch.extPermi&&(/^([\d,]+,)?1(,[\d,]*)?$/.test(t.branch.extPermi)&&(t.branchPermi.edit=!0),/^([\d,]+,)?2(,[\d,]*)?$/.test(t.branch.extPermi)&&(t.branchPermi.delete=!0),/^([\d,]+,)?3(,[\d,]*)?$/.test(t.branch.extPermi)&&(t.branchPermi.export=!0)),t.checkEmailFormat=function(e){return!0},t.checkNameFormat=function(e){return e.name?countCharacters(e.name)>30?(t.nameFormatErr=m.instant("usercenter.account.LOGIN_NAME_ERR2"),!1):(t.nameFormatErr="",!0):($(".branch-name").focus(),t.nameFormatErr=m.instant("usercenter.account.LOGIN_NAME_ERR1"),!1)},t.confirm=function(){if(t.checkEmailFormat(t.branch)&&t.checkNameFormat(t.branch)){var e={};t.branch.dept&&(t.branch.deptName=t.branch.dept.name,t.branch.dept.id&&(e.deptId=t.branch.deptId=t.branch.dept.id));var a=[];$.each(t.branchPermi,function(e,t){"edit"==e&&t?a.push("1"):"export"==e&&t?a.push("3"):"delete"==e&&t&&a.push("2")}),t.branch.extPermi=a.join(","),t.branchPermi.integral||(t.branchPermi.integralCore=0),d?($.extend(e,{id:t.branch.id,name:t.branch.name,data_permissions:t.branch.extPermi,is_audit:t.branchPermi.audit,is_integral:t.branchPermi.integral,integral_num:t.branchPermi.integralCore}),n.updateBranch(e).then(function(e){e.data.success&&(t.$close(t.branch),u.pushForCurrentRoute("branch.update.success","notify.success"))},function(e){t.serverError=m.instant("usercenter.account.SERVER_ERROR")})):($.extend(e,{loginName:t.branch.loginName,name:t.branch.name,data_permissions:t.branch.extPermi,is_audit:t.branchPermi.audit,is_integral:t.branchPermi.integral,integral_num:t.branchPermi.integralCore}),n.createBranch(e).then(function(e){e.data.success?(t.branch.id=e.data.obj.id,u.pushForCurrentRoute("branch.create.success","notify.success"),t.$close(t.branch)):t.serverError=e.data.msg},function(e){t.serverError=m.instant("usercenter.account.SERVER_ERROR")}))}},t.cancel=function(){t.$dismiss()}}]);