angular.module("scene.create.console.setting.anim",["app.directives.uislider","app.directives.limitInput"]),angular.module("scene.create.console.setting.anim").controller("AnimConsoleCtrl",["$scope","$rootScope","sceneService","security",function(e,r,t,i){function n(t,i){var n={anim:t,animClasses:l,count:i,elemId:e.elemDef.id};r.$broadcast("previewCurrentChange",n)}function o(t,i){var n={animations:t,animClasses:i,count:s,elemId:e.elemDef.id};r.$broadcast("previewAllChanges",n)}var a=e.elemDef=t.currentElemDef;e.animations=[],e.types=[],e.directions=[];var d,s,l=[];e.animTypeEnum=[{id:-1,name:"无"},{id:0,name:"淡入",cat:"进入"},{id:1,name:"移入",cat:"进入"},{id:2,name:"弹入",cat:"进入"},{id:20,name:"翻转进入",cat:"进入"},{id:3,name:"中心弹入",cat:"进入"},{id:4,name:"中心放大",cat:"进入"},{id:12,name:"翻滚进入",cat:"进入"},{id:24,name:"翻开进入",cat:"进入"},{id:13,name:"光速进入",cat:"进入"},{id:6,name:"摇摆",cat:"强调"},{id:5,name:"抖动",cat:"强调"},{id:7,name:"旋转",cat:"强调"},{id:8,name:"翻转",cat:"强调"},{id:9,name:"悬摆",cat:"强调"},{id:23,name:"闪烁",cat:"强调"},{id:21,name:"放大抖动",cat:"强调"},{id:22,name:"倾斜摆动",cat:"强调"},{id:10,name:"淡出",cat:"退出"},{id:17,name:"移出",cat:"退出"},{id:19,name:"弹出",cat:"退出"},{id:11,name:"翻转消失",cat:"退出"},{id:14,name:"中心消失",cat:"退出"},{id:18,name:"中心缩小",cat:"退出"},{id:15,name:"翻滚退出",cat:"退出"},{id:25,name:"翻开消失",cat:"退出"},{id:16,name:"光速退出",cat:"退出"}];var c,g,m=[26,27,28];if(!i.isAllowToAccess(i.accessDef.COMP_ANIMATION))for(c=0;c<e.animTypeEnum.length;c++)for(g=0;g<m.length;g++)e.animTypeEnum[c].id==m[g]&&(e.animTypeEnum.splice(c,1),c--);if(e.animDirectionEnum=[{id:0,name:"从左向右"},{id:1,name:"从上到下"},{id:2,name:"从右向左"},{id:3,name:"从下到上"}],a.properties.anim)if(a.properties.anim instanceof Array)if(a.properties.anim.length){for(c=0;c<a.properties.anim.length;c++)if(null!=a.properties.anim[c].type&&-1!=a.properties.anim[c].type){for(e.animations.push(a.properties.anim[c]),g=0,tlen=e.animTypeEnum.length;g<tlen;g++)e.animations[c].type==e.animTypeEnum[g].id&&(e.types[c]=e.animTypeEnum[g]);for(g=0,tlen=e.animDirectionEnum.length;g<tlen;g++)e.animations[c].direction==e.animDirectionEnum[g].id&&(e.directions[c]=e.animDirectionEnum[g])}}else a.properties.anim.splice(c,1),c--;else{for(c=0;c<e.animTypeEnum.length;c++)e.animTypeEnum[c].id==a.properties.anim.type&&(e.types[0]=e.animTypeEnum[c]);null!=a.properties.anim.direction?e.directions[0]=e.animDirectionEnum[a.properties.anim.direction]:e.directions[0]=e.animDirectionEnum[0],a.properties.anim.duration=parseFloat(a.properties.anim.duration),a.properties.anim.delay=parseFloat(a.properties.anim.delay),a.properties.anim.countNum=parseInt(a.properties.anim.countNum,10)||1,e.animations.push(a.properties.anim)}a.properties||(a.properties={});var p={type:null,direction:null,duration:2,delay:0,countNum:1,count:null};e.addAnim=function(r){if(!r.originalEvent._constructed){var t=angular.copy(p);t.type=e.animTypeEnum[0].id,t.direction=e.animDirectionEnum[0].id,e.animations.push(t);var i=e.animations.length;e.types[i-1]=e.animTypeEnum[0],e.directions[i-1]=e.animDirectionEnum[0]}},e.removeAnim=function(r,t){t.stopPropagation(),e.animations.splice(r,1),e.types.splice(r,1),e.directions.splice(r,1)},e.clear=function(){e.animations=[]},e.$watch("animations",function(r,t){r!=t&&(a.properties.anim=e.animations)},!0),e.$watch("types",function(r,t){if(r&&r!=t)for(var i=0;i<r.length;i++)t[i]&&r[i].id!=t[i].id&&n(e.animations[i],i)},!0),e.$watch("directions",function(r,t){if(r&&r!=t)for(var i=0;i<r.length;i++)t[i]&&r[i].id!=t[i].id&&n(e.animations[i],i)},!0),e.previewAnim=function(r){if(!r.originalEvent._constructed){for(var t=angular.copy(e.animations),i=[],n=[],a=0;a<t.length;a++)null!=t[a].type&&-1!=t[a].type?(i.push(t[a]),n[a]=eqxCommon.convertType(t[a])):(t.splice(a,1),a--);s=0,o(i,n)}},e.changeAnimation=function(e,r){d=eqxCommon.convertType(e),l[r]=d}}]),angular.module("scene.create.console.setting.style",["colorpicker.module","app.directives.style","app.directives.uislider","app.directives.limitInput","services.history"]),angular.module("scene.create.console.setting.style").controller("StyleConsoleCtrl",["$scope","sceneService",function(e,r){var t=e.elemDef=r.currentElemDef;delete t.css.borderTopLeftRadius,delete t.css.borderTopRightRadius,delete t.css.borderBottomLeftRadius,delete t.css.borderBottomRightRadius,delete t.css.border;var i=t.css,n=$("#inside_"+e.elemDef.id+" > .element-box");if(e.model={backgroundColor:i.backgroundColor||"",opacity:100-100*i.opacity||0,color:i.color||"#676767",borderWidth:parseInt(i.borderWidth,10)||0,borderStyle:i.borderStyle||"solid",borderColor:i.borderColor||"rgba(0,0,0,1)",paddingBottom:parseInt(i.paddingBottom,10)||0,paddingTop:parseInt(i.paddingTop,10)||0,lineHeight:+i.lineHeight||1,borderRadius:parseInt(i.borderRadius,10)||0,transform:i.transform&&parseInt(i.transform.replace("rotateZ(","").replace("deg)",""),10)||0},e.maxRadius=Math.min(n.outerWidth(),n.outerHeight())/2+10,i.borderRadiusPerc?e.model.borderRadiusPerc=parseInt(i.borderRadiusPerc,10):i.borderRadius?"999px"==i.borderRadius?e.model.borderRadiusPerc=100:(e.model.borderRadiusPerc=parseInt(100*parseInt(i.borderRadius,10)*2/Math.min(n.outerWidth(),n.outerHeight()),10),e.model.borderRadiusPerc>100&&(e.model.borderRadiusPerc=100)):e.model.borderRadiusPerc=0,e.tmpModel={boxShadowDirection:0,boxShadowX:0,boxShadowY:0,boxShadowBlur:0,boxShadowSize:0,boxShadowColor:"rgba(0,0,0,0.5)"},i.boxShadow){var o=i.boxShadow.split(" ");e.tmpModel.boxShadowX=parseInt(o[0],10),e.tmpModel.boxShadowY=parseInt(o[1],10),e.tmpModel.boxShadowDirection=parseInt(i.boxShadowDirection,10)||0,e.tmpModel.boxShadowBlur=parseInt(o[2],10),e.tmpModel.boxShadowColor=o[3],e.tmpModel.boxShadowSize=parseInt(i.boxShadowSize,10)||0}e.clear=function(){e.model={backgroundColor:"#ffffff",opacity:0,color:"#676767",borderWidth:0,borderStyle:"solid",borderColor:"rgba(0,0,0,1)",paddingBottom:0,paddingTop:0,lineHeight:1,borderRadius:0,transform:0},e.tmpModel={boxShadowDirection:0,boxShadowX:0,boxShadowY:0,boxShadowBlur:0,boxShadowSize:0,boxShadowColor:(i.boxShadowSize,"rgba(0,0,0,0.5)")}},e.$watch("tmpModel",function(r,i){var n={};$.extend(!0,n,e.model),n.borderRadius+="px",n.borderTopLeftRadius=n.borderTopRightRadius=n.borderBottomLeftRadius=n.borderBottomRightRadius=n.borderRadius,n.opacity=(100-e.model.opacity)/100,n.boxShadow=Math.round(e.tmpModel.boxShadowX)+"px "+Math.round(e.tmpModel.boxShadowY)+"px "+e.tmpModel.boxShadowBlur+"px "+e.tmpModel.boxShadowColor,n.boxShadowDirection=e.tmpModel.boxShadowDirection,n.boxShadowSize=e.tmpModel.boxShadowSize,n.transform="rotateZ("+e.model.transform+"deg)",$.extend(!0,t.css,n)},!0),e.$watch("model",function(r,i){e.elemDef.properties instanceof Array&&(e.elemDef.properties={});var n={};elemId=e.elemDef.id,e.elemDef.css.color=r.color;var o=document.getElementById(""+elemId).getAttribute("ctype");if(document.getElementById(""+elemId).children[0]&&""!=document.getElementById(""+elemId).children[0].style.color&&2==parseInt(o)){var a=r.color;if(e.elemDef.content.split("color:")[1])var d=e.elemDef.content.split("color:")[1].split(";")[0];a&&"#676767"!=a&&(e.elemDef.content=e.elemDef.content.replace(d,a)),e.elemDef.css.color=a,document.getElementById(""+elemId).children[0].style.color=a}$.extend(!0,n,e.model),n.borderRadius+="px",n.borderTopLeftRadius=n.borderTopRightRadius=n.borderBottomLeftRadius=n.borderBottomRightRadius=n.borderRadius,n.opacity=(100-e.model.opacity)/100,n.boxShadow=Math.round(e.tmpModel.boxShadowX)+"px "+Math.round(e.tmpModel.boxShadowY)+"px "+e.tmpModel.boxShadowBlur+"px "+e.tmpModel.boxShadowColor,n.boxShadowDirection=e.tmpModel.boxShadowDirection,n.boxShadowSize=e.tmpModel.boxShadowSize,n.transform="rotateZ("+e.model.transform+"deg)",$.extend(!0,t.css,n)},!0)}]).directive("styleInput",["multiCompResize","$rootScope",function(e,r){return{restrict:"AE",link:function(e,t,i){var n=$("#inside_"+e.elemDef.id+" > .element-box");$("#inside_"+e.elemDef.id,"#nr"),e.$watch(function(){return $(t).val()},function(o,a){if(o!=a){if("borderWidth"==i.cssItem){n.css({borderStyle:e.model.borderStyle,borderWidth:$(t).val()});var d={width:n.width(),height:n.height()};if(4==e.elemDef.type){var s=n.find("img"),l=s.width()/s.height(),c=d.width/d.height;l>=c?(s.outerHeight(d.height),s.outerWidth(d.height*l),s.css("marginLeft",-(s.outerWidth()-d.width)/2),s.css("marginTop",0)):(s.outerWidth(d.width),s.outerHeight(d.width/l),s.css("marginTop",-(s.outerHeight()-d.height)/2),s.css("marginLeft",0)),e.elemDef.properties.imgStyle.marginTop=s.css("marginTop"),e.elemDef.properties.imgStyle.marginLeft=s.css("marginLeft"),e.elemDef.properties.imgStyle.width=s.outerWidth(),e.elemDef.properties.imgStyle.height=s.outerHeight()}}if("borderRadius"==i.cssItem&&n.css({borderRadius:e.model.borderRadius}),"opacity"==i.cssItem&&n.css({opacity:(100-$(t).val())/100}),"backgroundColor"==i.cssItem&&n.css({backgroundColor:$(t).val()}),"color"==i.cssItem&&(n.css({color:$(t).val()}),"h"==e.elemDef.type)){var g=n.find("svg");g.find("g").length?g.find("g").attr("fill",$(t).val()):g.children().attr("fill",$(t).val())}"borderStyle"==i.cssItem&&(n.css({borderStyle:e.model.borderStyle}),r.$broadcast("hisChange")),"borderColor"==i.cssItem&&n.css({borderColor:e.model.borderColor}),"padding"==i.cssItem&&n.css({paddingTop:e.model.paddingTop,marginTop:-e.model.paddingBottom}),"lineHeight"==i.cssItem&&n.css({lineHeight:e.model.lineHeight}),"transform"==i.cssItem&&(n.parents("li").css({transform:"rotateZ("+e.model.transform+"deg)"}),r.$broadcast("boxOuter")),"boxShadow"==i.cssItem&&(e.tmpModel.boxShadowX=-Math.sin(e.tmpModel.boxShadowDirection*Math.PI/180)*e.tmpModel.boxShadowSize,e.tmpModel.boxShadowY=Math.cos(e.tmpModel.boxShadowDirection*Math.PI/180)*e.tmpModel.boxShadowSize,n.css({boxShadow:Math.round(e.tmpModel.boxShadowX)+"px "+Math.round(e.tmpModel.boxShadowY)+"px "+e.tmpModel.boxShadowBlur+"px "+e.tmpModel.boxShadowColor}))}})}}}]),angular.module("scene.create.console.setting.trigger",["colorpicker.module","app.directives.style","app.directives.uislider","app.directives.limitInput","scene.edit.trigger","scene.create.console.setting.trigger"]),angular.module("scene.create.console.setting.trigger").controller("TriggerConsoleCtrl",["$scope","$rootScope","$translate","sceneService","triggerService","$modal","ModalService","i18nNotifications","security",function(e,r,t,n,o,a,d,s,l){function c(){var r=o.getTrigger(u.id);if(r&&r.sends.length)for(m(r.sends),i=0;i<r.sends.length&&e.triggerEvents[i];i++)i>0?r.sends[i].delay=r.sends[i-1].delay+e.triggerEvents[i].delay:r.sends[i].delay=e.triggerEvents[i].delay;var t;$.each(h,function(e,r){o.clearTrigger(e),t=o.getTrigger(e),t&&t.sends.length&&m(t.sends),t?r.trigger=t:delete r.trigger}),2==e.sendType.value&&(t=o.getTrigger(e.elemDef.id),t&&t.sends.length&&m(t.sends),e.elemDef.properties||(e.elemDef.properties={}),e.elemDef.properties.trigger=t)}function g(){if(!u)return void(e.triggerEvents=[]);var r=o.getTrigger(u.id);if(r&&r.sends.length){m(r.sends),e.triggerEvents=[];var t=angular.copy(r.sends);angular.forEach(t,function(r,n){if(e.triggerEvents.push({}),angular.forEach(r.handles,function(r,t){1!=r.type&&2!=r.type||!r.ids.length?3==r.type&&r.ids.length&&(e.triggerEvents[n]=angular.copy(e.eventTypes[1]),e.triggerEvents[n].type=2):(e.triggerEvents[n]=angular.copy(e.eventTypes[0]),e.triggerEvents[n].type=1)}),n>0)for(i=0;n>i;i++)r.delay-=t[i].delay;e.triggerEvents[n].handles=r.handles,r.delay?e.triggerEvents[n].delay=r.delay:e.triggerEvents[n].delay=0})}e.triggerEvents.length&&$.each(e.triggerEvents,function(e,r){r.triggerElements=[],r.handles&&r.handles.length&&$.each(r.handles,function(e,t){t.ids.length&&$.each(t.ids,function(e,i){r.triggerElements.push({id:i,handleType:t})})})})}function m(r){for(var t=0;t<r.length;t++)"undefined"==typeof r[t].sendIndex&&r[t].hasOwnProperty("sendIndex")&&(e.splice(t,1),t--)}var p=utilTrigger.getSendType();l.isAllowToAccess(l.accessDef.SHAKE_TRIGGER)||delete p.SHAKE,e.sendTypes=p,e.sendType=e.sendTypes.CLICK;var u=e.elemDef=n.currentElemDef,h=n.getElementsMap(),f=(utilTrigger.getHandleType(),n.getSceneObj().obj);if(f&&f.elements.length){e.triggerSources=[];var v=angular.copy(f.elements);$.each(v,function(r,t){if("2"==t.type||"4"==t.type||"h"==t.type||"x"==t.type){switch(t.type+""){case"2":t.name="文字";break;case"4":t.name="图片";break;case"h":t.name="形状";break;case"x":t.name="多字体"}e.triggerSources.push(t)}}),$.each(e.triggerSources,function(e,r){r.name+=e+1})}if(e.$watch("elemDef",function(r,t){r&&(u=r,$.each(e.triggerSources,function(t,i){i.id==r.id&&(e.sourceElem=i)}))},!0),e.$watch("sendType",function(r){e.triggerEvents=[],1==r.value?u=e.elemDef=n.currentElemDef:2==r.value&&(u=e.elemDef=q),g()},!0),e.eventTypes=[{name:"existElement",value:1,title:"选择界面已有元素",children:[{type:"SHOW",title:"显示"},{type:"HIDE",title:"隐藏"}]},{name:"randomEvent",value:2,title:"随机图片"}],u&&1==e.sendType.value)switch(u.type+""){case"2":e.triggerOriginal="文字1";break;case 4:e.triggerOriginal="图片1";break;case"h":e.triggerOriginal="形状1";break;case"x":e.triggerOriginal="多字体1"}e.selectTriggerOriginal=function(){r.$broadcast("select.trigger.original")},e.triggerEvents=[],e.addTriggerEvent=function(r,t){if(0==$(".trigger-elem-list").length)return e.sourceElem||1!=e.sendType.value?(e.triggerEvents.push({title:r.title,value:r.value,delay:0}),e.triggerEvents.length,1==r.value?e.addTriggerItem(e.triggerEvents[t],t):2==r.value&&e.addRandomImg(e.triggerEvents[t],t),void 0):void s.pushForCurrentRoute("select.trigger.source","notify.success")},e.addTriggerItem=function(t,i,n){e.currentTriggerEvent=t,e.currentIndex=i,r.$broadcast("element.triggered.add",t,i)},e.addRandomImg=function(r,t){e.currentTriggerEvent=r,e.currentIndex=t,n.createComp("n")},e.$on("create.randomevent.trigger",function(t,i){r.$broadcast("show.random.trigger",u,i,e.currentIndex)}),e.$on("receive.element.update",function(r,t,i,n,a){e.triggeredElements=[],e.currentTriggerEvent?e.currentTriggerEvent.handles=[]:e.triggerEvents&&(e.triggerEvents[a].handles=[]);var d=o.getTrigger(u.id).sends;d.length&&m(d),angular.forEach(d,function(r,t){e.triggerEvents[a].handles=r.handles}),c(),g()}),e.switchShow=function(e,t){if(e.triggerType)if(1==e.triggerType)var i=e.triggerType=2,n=!1;else var i=e.triggerType=1,n=!0;else if(1==e.handleType.type)var i=e.handleType.type=2,n=!1;else var i=e.handleType.type=1,n=!0;r.$broadcast("switch.triggered.state",n,i,e.id,t)},e.removeTrigger=function(r,t){var i=u.id,n=o.getTrigger(i);if(n&&n.sends){if(m(n.sends),!n.sends[r])return void e.triggerEvents.splice(r,1);o.deleteTriggerBySendIndex(r,i),$.each(n.sends,function(e,r){r.sendIndex=e})}e.triggerEvents.splice(r,1)},e.getTriggerSources=function(r){e.triggerEvents=[],r&&($("#nr").find("#inside_"+r.id).trigger("mousedown"),u=e.elemDef=h[r.id],g())},g(),e.confirm=function(){c(),r.$broadcast("close.style.panel")},e.cancelTriggerElem=function(e,t){var i=u.id;r.$broadcast("cancel.element.trigger",e,i,t),g()},e.editRandomElem=function(){},e.clear=function(){o.resetTrigger(u.id),e.triggerEvents=[]}}]).directive("eqxTrigger",["$compile","$translate","sceneService","triggerService",function(e,r,t,i){function n(e,r,n){var u=t.currentElemDef;e.$watch("sendType",function(r){1==r.value?u=e.elemDef=t.currentElemDef:2==r.value&&(u=e.elemDef=t.getSceneObj().obj)},!0);var h,f=$("#nr");f.find(".edit_area").find("li"),e.$on("element.triggered.add",function(r,t,i){$(".switch-original").remove(),h=$("#inside_"+e.elemDef.id);var n=$('<div class="switch-original">');h.append(n).children(".bar").hide(),o(e,e.elemDef,t,i)}),e.$on("create.trigger.menu",function(r,t,i){if(!t.find(".switch-original").length){var n=a(e,t);g(n,"triggerMenu",i)}}),e.$on("switch.triggered.state",function(r,t,i,n,o){var a=$("#inside_"+n);i.type,t?d(a,e.sendType,m,u.id,n,o):s(a,e.sendType,m,u.id,n,o)}),e.$on("show.random.trigger",function(r,t,n,o){i.getSendIds(m.RANDOMEVENT.value,t.id);var a=utilTrigger.getHandleType().RANDOMEVENT.value;c(e.sendType,a,t.id,n.id,o),i.getTrigger(t.id)}),e.$on("cancel.element.trigger",function(r,i,n,o){if(h=$("#inside_"+i),l(h,e.sendType,m,n,i,o),"n"==p[i].type&&($("#nr").find("#inside_"+i).remove(),t.deleteElement(i)),e.triggerEvents.length)for(var a=0;a<e.triggerEvents.length;a++){var d=!0;if(e.triggerEvents[a].handles)for(var s=0;s<e.triggerEvents[a].handles.length;s++)e.triggerEvents[a].handles[s].ids.length&&(d=!1);d&&(e.triggerEvents.splice(a,1),a--)}}),e.$on("select.trigger.original",function(r){var i=f.find(".edit_area").children("li");$('<div class="mask-trigger">').insertAfter(".edit_area").click(function(){$(this).remove(),i.each(function(){var e=$(this),r=e.attr("ctype"),t=parseInt(e.attr("id").replace("inside_",""),10);(2==r||4==r||"h"==r||"x"==r)&&e.css({"background-color":"","z-index":p[t].css.zIndex})});var r=parseInt($(".switch-original").parent().attr("id").replace("inside_",""),10);switch(u=e.elemDef=t.currentElemDef=p[r],u.type+""){case"2":$scope.triggerOriginal="文字1";break;case"4":$scope.triggerOriginal="图片1";break;case"h":$scope.triggerOriginal="形状1";break;case"x":$scope.triggerOriginal="多字体1"}e.$apply()}),i.each(function(){var e=$(this),r=e.attr("ctype");(2==r||4==r||"h"==r||"x"==r)&&e.css({"background-color":"rgba(255,255,255,0.9)","z-index":10001})})})}function o(r,t,n,o){var a=$("#nr"),d=a.find(".edit_area").children("li");a.find(".mask-trigger").remove(),e('<div class="trigger-elem-list" trigger-elem-list panel-draggable></div>')(r).appendTo(".content"),$('<div class="mask-trigger">').insertAfter("#nr .edit_area");var s;if(i.getTrigger(t.id)&&(s=i.getTrigger(t.id).sends),d.each(function(){var e=$(this),r=e.attr("ctype");2!=r&&4!=r&&"h"!=r&&"x"!=r||(e.css({"background-color":"rgba(255,255,255,0.9)","z-index":10001}),s&&s.length&&$.each(s,function(r,t){r!=o&&$.each(t.handles,function(r,t){t.ids.length&&$.each(t.ids,function(r,t){e.attr("id")=="inside_"+t&&e.css({"background-color":"","z-index":""})})})}))}),t){var l=[];$.each(m,function(e,r){if(2!=r.value){var n=i.getSendIds(r.value,t.id);$.each(n,function(e,r){l.push(r)})}}),$.each(l,function(e,r){var t=a.find("#inside_"+r);t.css({"background-color":"","z-index":""})}),$("#comp_setting").css({zIndex:"1100"})}}function a(e,r){var t=e.currentIndex,i=$('<ul id="triggerMenu" class="dropdown-menu" style="min-width: 100px; display: block;" role="menu" aria-labelledby="dropdownMenu1"><li class="trigger-show" role="presentation"><a role="menuitem" tabindex="-1"><div class="eqf-dengpao1"></div>显示</a></li><li class="trigger-hide" role="presentation"><a role="menuitem" tabindex="-1"><div class="eqf-dengpao1" style="color: #5F5F5F;"></div>隐藏</a></li><li class="trigger-none" role="presentation"><a role="menuitem" tabindex="-1"><div style="width: 21px;"></div>取消</a></li></ul>').css({position:"fixed","user-select":"none"}),n=$(".edit_area").find(".switch-original"),o=parseInt(n.parent().attr("id").replace("inside_",""),10),a=parseInt(r.attr("id").replace("inside_",""),10);return i.children(".trigger-show").click(function(){d(r,e.sendType,m,o,a,t),i.hide(),e.$apply()}),i.children(".trigger-hide").click(function(){s(r,e.sendType,m,o,a,t),i.hide(),e.$apply()}),i.children(".trigger-none").click(function(){l(r,e.sendType,m,o,a,t),i.hide(),$.each(e.triggerElements,function(e,r){a==r.id&&(r.checked=!1,r.triggerType="")}),e.$apply()}),i}function d(e,r,t,n,o,a){e.children(".boom").length||(e.children(".boom1").remove(),$('<div class="boom">').appendTo(e),i.deleteTrigger(r.value,t.HIDE.value,n,o,a),i.addTrigger(r.value,t.SHOW.value,n,o,a))}function s(e,r,t,n,o,a){e.children(".boom1").length||(e.children(".boom").remove(),$('<div class="boom1">').appendTo(e),i.deleteTrigger(r.value,t.SHOW.value,n,o,a),i.addTrigger(r.value,t.HIDE.value,n,o,a))}function l(e,r,t,n,o,a){e.children(".boom, .boom1").remove(),i.deleteTrigger(r.value,t.SHOW.value,n,o,a),i.deleteTrigger(r.value,t.HIDE.value,n,o,a),i.deleteTrigger(r.value,t.RANDOMEVENT.value,n,o,a)}function c(e,r,t,n,o){i.deleteTrigger(e.value,r,t,n,o),i.addTrigger(e.value,r,t,n,o)}function g(e,r,t){var i=$("#eq_main");$("#"+r).remove(),e.css({left:t.pageX+i.scrollLeft()+15,top:t.pageY+i.scrollTop(),zIndex:10001}).appendTo(i),i.mousemove(function(t){e=$("#"+r),(t.pageX<e.offset().left-20||t.pageX>e.offset().left+e.width()+20||t.pageY<e.offset().top-20||t.pageY>e.offset().top+e.height()+20)&&(e.hide(),$(this).unbind("mousemove"))})}var m=(utilTrigger.getSendType(),utilTrigger.getHandleType()),p=t.getElementsMap();return{restrict:"EA",link:n}}]).directive("leavePanel",function(){function e(e,r,t){r.hover(function(){},function(){e.obj={showTriggerPanel:!1},e.$apply()})}return{restrict:"EA",link:e}}).directive("triggerElemList",["$translate","sceneService","triggerService",function(e,r,t){function i(e,i,o){var a=angular.copy(r.getSceneObj().obj.elements),d=r.getElementsMap(),s={};e.triggerElements=[];var l;1==e.sendType.value?l=e.elemDef.trigger:2==e.sendType.value&&(e.elemDef.properties||(e.elemDef.properties={}),l=e.elemDef.properties.trigger);var c=$("#nr").find(".edit_area").children("li");$.each(a,function(e,r){"2"!=r.type&&"4"!=r.type&&"h"!=r.type&&"x"!=r.type||(s[r.type]||(s[r.type]=[]),s[r.type].push(r))}),$.each(s,function(r,t){$.each(t,function(r,t){switch(t.type+""){case"2":t.name="文字";break;case"4":t.name="图片";break;case"h":t.name="形状";break;case"x":t.name="多字体"}t.name+=r+1,t.id!=e.elemDef.id&&e.triggerElements.push(t)})}),l&&l.sends&&$.each(l.sends,function(r,t){r!=e.currentIndex&&$.each(t.handles,function(r,t){t.ids.length&&$.each(t.ids,function(r,t){for(var i=0;i<e.triggerElements.length;i++)e.triggerElements[i].id==t&&(e.triggerElements.splice(i,1),i--)})})}),e.changed=function(r){r.checked?(t.deleteTrigger(e.sendType.value,n.HIDE.value,e.elemDef.id,r.id,e.currentIndex),t.addTrigger(e.sendType.value,n.SHOW.value,e.elemDef.id,r.id,e.currentIndex)):(t.deleteTrigger(e.sendType.value,n.SHOW.value,e.elemDef.id,r.id,e.currentIndex),t.deleteTrigger(e.sendType.value,n.HIDE.value,e.elemDef.id,r.id,e.currentIndex))},e.confirmList=function(){$(".mask-trigger").remove(),$(".trigger-list").remove(),$(".trigger-elem-list").remove(),e.elemDef&&($(".switch-original").remove(),$("#triggerMenu").hide(),$(".edit_area").find(".boom, .boom1").remove()),c.each(function(){var e=$(this),r=e.attr("ctype"),t=parseInt(e.attr("id").replace("inside_",""),10);(2==r||4==r||"h"==r||"x"==r)&&e.css({"background-color":"","z-index":d[t].css.zIndex})});var r,t=!1;1==e.sendType.value?r=e.elemDef.trigger:2==e.sendType.value&&(e.elemDef.properties||(e.elemDef.properties={}),r=e.elemDef.properties.trigger),r&&r.sends&&r.sends[e.currentIndex]?($.each(r.sends[e.currentIndex].handles,function(e,r){r.ids.length&&(t=!0)}),t||e.triggerEvents.splice(e.currentIndex,1)):e.triggerEvents.splice(e.currentIndex,1)},e.$watch("elemDef",function(r){var t;1==e.sendType.value?t=r.trigger:2==e.sendType.value&&(r.properties||(r.properties={}),t=r.properties.trigger),t&&t.sends&&$.each(t.sends,function(r,t){$.each(t.handles,function(r,t){$.each(t.ids,function(r,i){$.each(e.triggerElements,function(e,r){r.id==i&&(r.checked=!0,r.triggerType=t.type)})})})})},!0)}var n=(utilTrigger.getSendType(),utilTrigger.getHandleType());return{restrict:"EA",templateUrl:BASE_URL+"templates/scene.console.triggerelemlist.tpl.html",replace:!1,link:i}}]).directive("highlightElement",function(){function e(e,r,t){var i,n=$("#nr").find("li");setTimeout(function(){r.find(".trigger-elem").hover(function(r){i=$(this).attr("id").substring(8),$.each(n,function(r,t){"inside_"+e.elemDef.id!=$(t).attr("id")&&$(t).css({zIndex:"","background-color":""})}),$("#inside_"+i).css({"z-index":10001,"background-color":"rgba(255,255,255,0.9)"})},function(){$.each(e.triggerElements,function(e,r){$("#inside_"+r.id).css({"z-index":10001,"background-color":"rgba(255,255,255,0.9)"})})})},0)}return{restrict:"EA",link:e}});