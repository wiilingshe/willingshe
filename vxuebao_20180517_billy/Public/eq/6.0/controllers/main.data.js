angular.module("main.data",["app.directives.dataDraggable","customer.group","services.i18nNotifications","app.directives.customer","services.modal","security.login.toolbar","ui.bootstrap"]),angular.module("main.data").controller("CustomerCtrl",["$translate","$rootScope","$scope","$state","$location","$timeout","dataService","$modal","ModalService","i18nNotifications","security",function(e,t,a,n,o,s,i,c,r,u,m){a.PREFIX_URL=PREFIX_URL,a.isActive="customer",a.select=0,a.showBranchSelect=!0;var l=t.branchid;a.toPage=1,a.model={},a.dataShow="message",i.getCustomDatas(l),a.$on("customDatas",function(e,t){a.customCount=t}),a.customer={group:null,origin:null},a.branchEdit=!0,a.branchDelete=!0,a.branchExport=!0,s(function(){21==a.user.type&&(a.user.extPermi?(/^([\d,]+,)?1(,[\d,]*)?$/.test(a.user.extPermi)?a.branchEdit=!0:a.branchEdit=!1,/^([\d,]+,)?2(,[\d,]*)?$/.test(a.user.extPermi)?a.branchDelete=!0:a.branchDelete=!1,/^([\d,]+,)?3(,[\d,]*)?$/.test(a.user.extPermi)?a.branchExport=!0:a.branchExport=!1):(a.branchEdit=!1,a.branchDelete=!1,a.branchExport=!1))},100),a.downLoad=function(e,t){var a;a=PREFIX_S3_URL+"index.php?c=custom&a=exp"+(l?"?user="+l:""),t&&(a+=(/\?/.test(a)?"&":"?")+"origin="+t),e&&(a+=(/\?/.test(a)?"&":"?")+"groupId="+e),location.href=a},a.staticFileds=[],e(["main.customer.CUSTOMER_NAME","main.customer.CUSTOMER_MOBILE","main.customer.CUSTOMER_EMAIL","main.customer.CUSTOMER_SEX","main.customer.CUSTOMER_COMPANY","main.customer.CUSTOMER_JOB","main.customer.CUSTOMER_ADDRESS","main.customer.CUSTOMER_TELEPHONE","main.customer.CUSTOMER_WEBSITE","main.customer.CUSTOMER_QQ","main.customer.CUSTOMER_WECHAT","main.customer.CUSTOMER_REMARK"]).then(function(e){a.staticFileds=[{id:"name",name:e["main.customer.CUSTOMER_NAME"]},{id:"mobile",name:e["main.customer.CUSTOMER_MOBILE"]},{id:"email",name:e["main.customer.CUSTOMER_EMAIL"]},{id:"sex",name:e["main.customer.CUSTOMER_SEX"]},{id:"company",name:e["main.customer.CUSTOMER_COMPANY"]},{id:"job",name:e["main.customer.CUSTOMER_JOB"]},{id:"address",name:e["main.customer.CUSTOMER_ADDRESS"]},{id:"tel",name:e["main.customer.CUSTOMER_TELEPHONE"]},{id:"website",name:e["main.customer.CUSTOMER_WEBSITE"]},{id:"qq",name:e["main.customer.CUSTOMER_QQ"]},{id:"weixin",name:e["main.customer.CUSTOMER_WECHAT"]},{id:"remark",name:e["main.customer.CUSTOMER_REMARK"]}]}),a.selectScene=function(t,n){a.selectedSceneId=t,i.getSceneField(t).then(function(t){a.fields=t.data.list,a.select=n,$(".list_attribute").html(e.instant("main.customer.DRAG_HERE"))})},a.clickScene=function(){o.path("main")},a.clickSpread=function(){o.path("main/spread")},a.clickCustomer=function(){o.path("main/customer")},a.editCustomer=function(e){a.getDataDetail(e.id),a.editData=!0},a.removeCustomer=function(t){r.openConfirmDialog({msg:e.instant("main.customer.CONFIRM_TO_DELETE_DATA")},function(){i.deleteDataById(t.id).then(function(e){200==e.data.code&&u.pushForCurrentRoute("custom.data.delete","notify.success"),1===a.customerDatas.length&&a.model.currentPage>1?a.getDataBySceneId(a.model.currentPage-1,l,a.groupId,a.origin):a.getDataBySceneId(a.model.currentPage,l,a.groupId,a.origin),i.getCustomDatas(l)})})},a.addColor=function(e){a.trIndex=e},a.removeColor=function(){a.trIndex=-1},a.totalItems=0,a.model.currentPage=0,a.toPage="",a.pageChanged=function(t,n,o,s){return 1>t||t>a.totalItems/10+1?void alert(e.instant("main.customer.PAGE_OVERFLOW")):(a.model.currentPage=t,void a.getDataBySceneId(t,n,o,s))},a.getDataBySceneId=function(e,t,n,o){e||(e=1),n&&(a.groupId=n),o&&(a.origin=o),i.getAllData(e,t,n,o).then(function(e){a.customerDatas=e.data.list,a.totalItems=e.data.map.count,a.model.currentPage=e.data.map.pageNo,a.toPage="",a.totalNum=Math.ceil(a.totalItems/e.data.map.pageSize)})},a.getDataBySceneId(1,l,null,null),a.editCustom=function(e,t){o.path("/main/customer/"+e.id)};var d=function(){i.getDataMessage(l).then(function(e){a.dataMessage=e.data.list})};d(),a.sceneLoad=function(e){var t=PREFIX_S3_URL+"index.php?c=scenedata&a=excel&flag=noheader&id="+e+(l?"&user="+l:"");location.href=t},a.importDatas=function(){i.getPremergeScenes(l).then(function(e){a.importDatas=e.data.list,e.data.list.length>0&&a.selectScene(e.data.list[0].ID,0)})},a.associateData={};var g=!0;if(a.confirm=function(){g?jQuery.isEmptyObject(a.associateData,{})?(alert(e.instant("main.customer.PLEASE_IMPORT_DATA")),g=!0):(i.mergeSceneData(a.selectedSceneId,a.associateData).then(function(){alert(e.instant("main.customer.IMPORT_CUSTOMER_SUCCESS")),n.reload()},function(){}),g=!1):alert(e.instant("main.customer.DUPLICATE_CONFIRM"))},a.importDatas(),a.isAllowedToAccessGrouping=m.isAllowToAccess(m.accessDef.GROUP_CUSTOMER),a.isAllowedToAccessGrouping){a.allImages={selected:!1},a.selectAll=function(){for(var e=0,t=a.customerDatas.length;t>e;e++)a.customerDatas[e].selected=a.allImages.selected},a.selectCustomer=function(e){e.selected||(a.allImages.selected=!1)},a.groups=[],a.getGroups=function(){a.groups.length>0||i.getGroups(l).then(function(e,t){a.groups=e.data.list},function(e){})},a.getGroups(),a.getOrigins=function(){i.getOrigin(l).then(function(e){a.origins=e.data.list},function(t){alert(e.instant("main.customer.SERVER_ERROR"))})},a.getOrigins(),a.addGroup=function(){c.open({windowClass:"group-console console",templateUrl:BASE_URL+"templates/main.console.group.tpl.html",controller:"AddGroupCtrl"}).result.then(function(e){a.groups.push(e),R(),u.pushForCurrentRoute("group.create.success","notify.success")},function(){})};var E=[],p=[];a.assignGroup=function(){E=[],p=[];for(var t=0,n=a.customerDatas.length;n>t;t++)a.customerDatas[t].selected&&E.push(a.customerDatas[t].id);for(t=0,n=a.groups.length;n>t;t++)a.groups[t].selected&&p.push(a.groups[t].id);if(!E.length)return void alert(e.instant("main.customer.NO_CUSTOMER_SELECTED"));if(!p.length)return void alert(e.instant("main.customer.NO_GROUP_SELECTED"));var o={cIds:E,gIds:p};i.assignGroup(o).then(function(e){e.data.success&&(R(),a.allImages.selected=!1,f(),u.pushForCurrentRoute("data.assign.success","notify.success"))},function(){})},a.deleteCustomer=function(t){E=[];var n,o;if(t)n={ids:t.id},o=e.instant("main.customer.CONFIRM_TO_DELETE_DATA");else{for(var s=0,c=a.customerDatas.length;c>s;s++)a.customerDatas[s].selected&&E.push(a.customerDatas[s].id);if(!E.length)return void alert(e.instant("main.customer.NO_CUSTOMER_SELECTED"));n={ids:E},o=e.instant("main.customer.CONFIRM_TO_DELETE_DATA")}r.openConfirmDialog({msg:o},function(){i.deleteCustomer(n).then(function(e){e.data.success&&(a.allImages.selected=!1,f(),R(),u.pushForCurrentRoute("data.delete.success","notify.success"))},function(t){alert(e.instant("main.customer.SERVER_ERROR"))})})},a.deleteGroup=function(t,n){r.openConfirmDialog({msg:e.instant("main.customer.CONFIRM_TO_DELETE_GROUP")},function(){i.deleteGroup(t.id).then(function(e){e.data.success&&(a.groups.splice(n,1),R(),u.pushForCurrentRoute("group.delete.success","notify.success"))},function(t){alert(e.instant("main.customer.SERVER_ERROR"))})})};var f=function(){1===a.customerDatas.length&&a.model.currentPage>1?a.getDataBySceneId(a.model.currentPage-1):a.getDataBySceneId(a.model.currentPage)},R=function(){for(var e=0,t=a.groups.length;t>e;e++)a.groups[e].selected=!1}}a.createData=function(){o.path("main/customer/create")},a.sceneData=function(){a.dataShow="dataIn"},a.$watch("model.currentPage",function(e,t){e&&e!=t&&(a.model.toPage=e)},!0)}]);