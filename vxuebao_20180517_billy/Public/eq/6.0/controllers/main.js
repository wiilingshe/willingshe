angular.module("main",["services.mine","services.data","app.directives.pageTplTypes","services.staticRes","app.directives.addelement","services.usercenter","services.i18nNotifications","common.directives.scroll","services.modal","services.configSer","security.login.toolbar","ui.bootstrap"]),angular.module("main").controller("MainCtrl",["$rootScope","$scope","$location","$translate","security","MineService","dataService","sceneService","ModalService","$modal","usercenterService","i18nNotifications","configSerService","SpreadService","$filter","staticResService","$timeout","$ocLazyLoad",function(e,n,t,c,s,a,o,i,r,l,u,p,g,d,f,m,h,S){n.PREFIX_URL=PREFIX_URL,n.PREFIX_CLIENT_HOST=PREFIX_HOST,n.client_cdn=CLIENT_CDN,n.scene={type:null},n.pageSize=12;var y=1;n.isAllowedHistory=s.isAllowToAccess(s.accessDef.USERCENTER_HISTORY),n.showCloseStatus=[],n.showOpenStatus=[],n.isActive="main",n.loginSuccess=s.isLoginSuccess,n.myScene=!0,n.showBranchSelect=!0;var v=e.branchid;n.XdpageSize=100,n.getBranches=function(e){u.getBranches(n.XdpageSize,e).then(function(e){e.data.success&&(n.branches=e.data.list)},function(){})},n.getBranches(1),n.selectBranch=function(c){c?(n.branchCurrent=c,e.branchid=c.id,t.search({branchid:c.id})):(e.branchid="",t.search("branchid",null))};var T=t.search().branchid;h(function(){if(T)for(var e=0;e<n.branches.length;e++)n.branches[e].id==T&&(n.branchCurrent=n.branches[e])},300),n.showSceneList=function(){n.initShowGuide=!1,e.$broadcast("eqmain.overflow.visible")},n.$watch("user.loginName",function(e,t){if(e){var c=/^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;n.loginSuccess&&"eqs"==e.substr(0,3)&&!c.test(e)&&p.pushForCurrentRoute("rel.tip","notify.tip")}}),n.editScene=function(e,n){e&&e.stopPropagation(),t.path("scene/create/"+n).search("pageId",1)},n.visitSceneAction=function(){r.openMsgDialog({msg:"分别可在设置微课-分享设置中、微课详情页中设置微课状态为不允许访问",btn:"知道了"},function(){})},n.showPreview=function(e,t){if(t.publishTime)if(t.publishTime&&t.updateTime>t.publishTime)r.openConfirmDialog({msg:"微课有更新需要再次发布才能预览最新内容，坚持预览会看到修改之前的微课",confirmName:"发布",cancelName:"坚持预览"},function(){n.publishScene(e,t)},function(){e&&e.stopPropagation();var c=n.canvasUrl+("/v-"+t.code);window.open(c)});else{e&&e.stopPropagation();var c=n.canvasUrl+("/v-"+t.code);window.open(c)}else r.openConfirmDialog({msg:"尚未发布微课无法预览，请先发布",confirmName:"发布",cancelName:"取消"},function(){n.publishScene(e,t)})},window.localStorage&&"false"==localStorage.getItem("myScenesListType")?n.listType=!1:n.listType=!0,n.listToggle=function(){n.listType=!n.listType,window.localStorage&&localStorage.setItem("myScenesListType",n.listType)},n.addColor=function(e){n.trIndex=e},n.removeColor=function(){n.trIndex=-1},n.sceneSettings=function(e,n){e&&e.stopPropagation(),t.path("scene/create/"+n).search({pageId:1,openSetting:"show"})},n.clickScene=function(){t.path("main")},n.clickSpread=function(){t.path("main/spread")},n.creatCompanyTpl=function(e,t,c){e&&e.stopPropagation(),i.createCompanyTpls(t).then(function(e){e.data.success&&(n.myScenes[c].isTpl=3,p.pushForCurrentRoute("scene.save.success.companyTpl","notify.success"))})},n.clearCompanyTpl=function(e,t,c){e&&e.stopPropagation(),i.clearCompanyTpls(t).then(function(e){e.data.success&&(n.myScenes[c].isTpl=0,p.pushForCurrentRoute("scene.clear.success.companyTpl","notify.success"))})},n.clickCustomer=function(){t.path("main/customer")},n.register=s.getRegisterInfo(),n.logout=function(){s.logout()},n.copyScene=function(e,n){e&&e.stopPropagation(),r.openConfirmDialog({msg:"确定复制此微课?"},function(){i.copySceneById(n).then(function(e){t.path("scene/create/"+e.data.obj).search("pageId",1)})})},n.isAllowedToAccessTransfer=s.isAllowToAccess(s.accessDef.TRANSFER_SCENE),n.isAllowedToAccessTransfer&&(n.transferScene=function(t,c){t&&t.stopPropagation(),"eqs"==e.user.loginName.substr(0,3)&&null==e.user.email?r.openBindEmailDialog():S.load("controllers/main.transferScene",function(){l.open({windowClass:"six-contain",templateUrl:"/Public/eq/6.0/template/main.transferscene.tpl.html",controller:"TransferSceneCtrl",resolve:{sceneId:function(){return{sceneId:c}}}}).result.then(function(){n.getMyScenes()},function(){})})}),n.color_arry=["#eac8c1","#c1ead4","#d1bce2","#b8dee8","#e8e1af","#a7addb"],n.getStyle=function(e,t){t=t||0,t%=6;var c=n.color_arry[t];return{"background-image":"url("+PREFIX_FILE_HOST+e+")","background-size":"cover","background-color":c}},n.totalItems=0,n.page={currentPage:1},n.toPage="",n.name=null,n.EnterPress=function(e,t){var c=e||window.event;13==c.keyCode&&n.submit(t)},n.searchButton=!0;var b={};n.submit=function(e){n.name=e,a.getMyScenes(n.scene.type?n.scene.type.value:null,y,n.pageSize,v,null,e),e&&(n.searchButton=!1),b.refresh=!0},n.changeName=function(e){n.searchButton=!0,""==e&&b.refresh&&a.getMyScenes(n.scene.type?n.scene.type.value:null,y,n.pageSize,v,null,e)},n.clearSearch=function(){n.searchButton=!0,n.name="",a.getMyScenes(n.scene.type?n.scene.type.value:null,y,n.pageSize,v)},n.getMyScenes=function(e){a.getMyScenes(n.scene.type?n.scene.type.value:null,e,n.pageSize,v)},n.getMyScenes(),n.$on("get.my.scene.list",function(t){var c=a.scenes;c.list&&c.list.length>0?(n.myScenes=c.list,n.totalItems=c.map.count,n.page.currentPage=c.map.pageNo,n.allPageCount=c.map.count,n.toPage=c.map.pageNo,e.user&&e.user.domain?(n.url=e.user.domain,n.canvasUrl="http://"+n.url):(n.url=n.PREFIX_CLIENT_HOST,n.canvasUrl=n.url)):(n.totalItems=0,n.currentPage>1?n.getMyScenes(--n.currentPage):(n.myScenes=[],n.allPageCount=0))}),n.deleteScene=function(e,t){e&&e.stopPropagation();var c=n.isAllowedHistory?"确定删除此微课?删除后，该微课将在回收站保留3天":"确定删除此微课?";r.openConfirmDialog({msg:c},function(){a.deleteSceneById(t).then(function(){1==n.myScenes.length&&n.currentPage>1&&n.currentPage--,n.getMyScenes(n.currentPage)})})},n.pageChanged=function(e){return 1>e||e>n.totalItems/10+1?void alert("此页超出范围"):(n.page.currentPage=e,void n.getMyScenes(e))},n.getTdStyle=function(e){var n=$(".header_table td:eq("+e+")").outerWidth();return{width:n+"px",maxWidth:n+"px"}},n.scene.types=m.getSceneType(),n.dataDetail={},o.getDatas(v),o.getCustomDatas(v),n.$on("sceneDatas",function(e,t){n.datasCount=t}),n.$on("customDatas",function(e,t){n.customCount=t}),n.showDetail=function(e){t.path("spread/share/"+e+"/socialShare")},n.$on("$destroy",function(){s.setLoginSuccess(!1)}),n.publishScene=function(e,t){if(e&&e.stopPropagation(),!t.name)return void r.openMsgDialog({msg:"尚未设置标题，请设置后再执行此操作",btn:"去设置"},function(){n.sceneSettings(e,t.id)});var c=window.open();i.publishScene(t.id).then(function(e){if(e.data.success){t.publishTime=(new Date).getTime(),p.pushForCurrentRoute("scene.publish.success","notify.success");var s=n.canvasUrl+("/v-"+t.code);c.location=s}})},n.getRejectDetail=function(e){e.stopPropagation(),t.path("/usercenter/message")},n.viewDetail=function(c){e.showSpreadTable=!1,n.$parent.showBranchSelect=!1,t.path("/main/spread/statistics/"+c),d.getSceneDetail(c,v),d.getSceneData(c,-6,1,v);var s=new Date;s=new Date(s.getTime()-864e5)}}]).directive("sysMsgAdjust",function(){return{restrict:"EA",link:function(e,n,t){e.isSysMsgVeryShort=!1;var c=e.$watch(function(){return $(".messages",n).css("height")},function(n){"44px"===n&&(e.isSysMsgVeryShort=!0)});n.bind("$destroy",function(){c()})}}}).directive("selectPicker",function(){return{restrict:"EA",link:function(e,n,t){n.selectpicker()}}});