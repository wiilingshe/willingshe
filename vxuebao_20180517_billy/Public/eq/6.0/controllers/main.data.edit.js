angular.module("data.edit",["services.usercenter","services.i18nNotifications"]),angular.module("data.edit").controller("EditDataCtrl",["$rootScope","$scope","$window","$stateParams","usercenterService","security","$modal","ModalService","$location","dataService","i18nNotifications","$translate",function(e,t,a,s,n,o,i,r,u,l,c,d){t.sceneId=s.sceneId,t.sexOptions=[{id:1,name:"男"},{id:2,name:"女"}],t.sex=t.sexOptions[0],t.isAllowedToAccessGrouping=o.isAllowToAccess(o.accessDef.GROUP_CUSTOMER);var p=e.branchid,m={};t.getDataDetail=function(e){l.getDataDetail(t.sceneId,p).then(function(e){t.dataDetail=e.data.obj,m=e.data.obj,t.groupNames=t.dataDetail.group;var a=t.dataDetail.email,s=t.dataDetail.sex,n=t.dataDetail.mobile,o=t.dataDetail.tel;a?t.formEmails=a.split(","):t.formEmails=[""],n?t.formMobiles=n.split(","):t.formMobiles=[""],o?t.formTels=o.split(","):t.formTels=[""],s&&("男"==s?t.sex=t.sexOptions[0]:t.sex=t.sexOptions[1])})},"create"!=t.sceneId&&t.getDataDetail(t.sceneId),t.dataDetail||(t.dataDetail={},t.sex=null,t.formEmails=[""],t.formMobiles=[""],t.formTels=[""]),t.updateData=function(e,a,s){var n=e.name,o={};if("email"==n||"mobile"==n||"tel"==n){o[n]="";var i,r=[];for(i=0;i<a.length;i++)a[i]&&r.push(a[i]);for(i=0;i<r.length-1;i++)o[n]+=r[i]+",";o[n]+=r[i]}else o[n]=t.dataDetail[n];m[n]=o[n]},t.updateSex=function(e){var a={};a.id=t.sceneId,0!==e.id?a.sex=e.name:a.sex="",m.sex=a.sex},t.formEmails=[""],t.formMobiles=[""],t.formTels=[""],t.removeInputs=function(e,a,s){if(s.length>1){if(!s[e])return void s.splice(e,1);s.splice(e,1),t.updateData({name:a},s)}else 1===s.length&&""!==s[0]&&(s[e]="",t.updateData({name:a},s))},t.addInputs=function(e){e.push("")},t.saveData=function(){if(countCharacters(m.name)>50)return void c.pushForCurrentRoute("customer.name.overflow","notify.success");delete m.group,m&&$.each(m,function(e,t){"undefined"==t&&(m[e]=null)});var e="create"==t.sceneId;"create"==t.sceneId&&delete m.id,l.saveData($.param(m),e).then(function(e){e.data.success&&(alert(d.instant("main.customer.SAVE_SUCCESS")),u.path("/main/customer"))})},t.cancel=function(){u.path("/main/customer")},t.groups=[],t.getGroups=function(){t.groups.length>0||l.getGroups().then(function(e){t.groups=e.data.list},function(e){alert(d.instant("main.customer.SERVER_ERROR"))})},t.getGroups(),t.deleteAssociation=function(e,a,s){var n={cId:e,gId:a};r.openConfirmDialog({msg:d.instant("main.customer.ENSURE_RELIEVE")},function(){l.deleteAssociation(n).then(function(e){if(e.data.success)for(var s=0;s<t.groupNames.length;s++)t.groupNames[s].id==a&&t.groupNames.splice(s,1)},function(e){alert(d.instant("main.customer.SERVER_ERROR"))})})},t.addGroup=function(){i.open({windowClass:"group-console",templateUrl:BASE_URL+"templates/main.console.group.tpl.html",controller:"AddGroupCtrl"}).result.then(function(e){t.groups.push(e)},function(){})};var f=[];t.assignGroup=function(){for(var e=[],a=0,s=t.groups.length;s>a;a++)if(t.groups[a].selected){f.push(t.groups[a].id);var n={id:t.groups[a].id,name:t.groups[a].name};e.push(n)}if(!f.length)return void alert(d.instant("main.customer.SELECT_GROUP"));var o={cIds:t.dataDetail.id,gIds:f};l.assignGroup(o).then(function(a){if(a.data.success){g();for(var s=0;s<e.length;s++)if(t.groupNames.length>0)for(var n=0;n<t.groupNames.length&&t.groupNames[n].id!=e[s].id;n++)n==t.groupNames.length-1&&t.groupNames.push(e[s]);else t.groupNames.push(e[s]);c.pushForCurrentRoute("data.assign.success","notify.success")}},function(){})},t.deleteGroup=function(e,a){r.openConfirmDialog({msg:d.instant("main.customer.ENSURE_DEL")},function(){l.deleteGroup(e.id).then(function(s){if(s.data.success){g(),t.groups.splice(a,1);for(var n=0;n<t.groupNames.length;n++)t.groupNames[n].id==e.id&&t.groupNames.splice(n,1)}},function(e){alert(d.instant("main.customer.SERVER_ERROR"))})})};var g=function(){for(var e=0,a=t.groups.length;a>e;e++)t.groups[e].selected=!1}}]);