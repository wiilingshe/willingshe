angular.module("usercenter.invoice",["services.usercenter","services.i18nNotifications"]),angular.module("usercenter.invoice").controller("InvoiceCtrl",["$scope","usercenterService","$modal","i18nNotifications","userinfo",function(e,i,t,r,o){e.invoiceStatus="",e.changeType=function(i){e.invoiceStatus=i},e.editInfo={isEditable:!0},o.view&&(e.view=o.view,e.editInfo.isEditable=!1,o.orderIds=o.orderIds.join(","));var n=[];e.authError="",e.picture={},e.invoice={receiver:"",phone:"",address:""},e.reset=function(){e.editInfo.isEditable=!0},e.invoiceListPu={invoiceType:1},e.invoiceListzhuan={invoiceType:2};var c=function(){i.getUserInvoice().then(function(i){if(200==i.data.code){i.data.obj&&(e.invoice=i.data.obj),e.invoiceStatus=i.data.map.invoiceType?i.data.map.invoiceType:1;for(var t=i.data.list,r=0;r<t.length;r++)1==t[r].invoiceType?e.invoiceListPu=t[0]:2==t[r].invoiceType&&(e.invoiceListzhuan=t[1],n=t[1].licenseImgsJson.split(","),e.picture={tax:n[0],bank:n[1],people:n[2],mes:n[3]})}})};c(),e.addPictures=function(i){t.open({windowClass:"console img_console",templateUrl:BASE_URL+"templates/scene.console.bg.tpl.html",controller:"BgConsoleCtrl",resolve:{obj:function(){return{fileType:1,count:1}}}}).result.then(function(t){switch(i){case"tax":e.picture.tax=t.data;break;case"bank":e.picture.bank=t.data;break;case"people":e.picture.people=t.data;break;case"mes":e.picture.mes=t.data}r.pushForCurrentRoute("upload.success","notify.success")})};var s=function(){return e.picture.tax?e.picture.bank?e.picture.people?!!e.picture.mes||(e.authError="请上传开票信息加盖公章",!1):(e.authError="请上传一般纳税人资质证明",!1):(e.authError="请上传银行许可证",!1):(e.authError="请上传税务登记证",!1)};e.submit=function(t){if(!e.invoice.receiver)return void(e.authError="请填写收件人");if(!e.invoice.phone)return void(e.authError="请填写联系电话");if(!e.invoice.address)return void(e.authError="请填写收货地址");var t={orderIds:o.orderIds,receiver:e.invoice.receiver,address:e.invoice.address,phone:e.invoice.phone};if(1==e.invoiceStatus)t.invoiceType=1,t.title=e.invoiceListPu.title;else if(2==e.invoiceStatus){if(!s())return!1;t.invoiceType=2,t.title=e.invoiceListzhuan.title,t.licenseImgsJson=e.picture.tax+","+e.picture.bank+","+e.picture.people+","+e.picture.mes}else 3==e.invoiceStatus&&(t.invoiceType=3);i.saveOrderInvoice(t).then(function(i){i.data.success&&(e.$close(t),r.pushForCurrentRoute("save.success","notify.success"))})},e.saveUserInvoice=function(t){if(!e.invoice.receiver)return void(e.authError="请填写收件人");if(!e.invoice.phone)return void(e.authError="请填写联系电话");if(!e.invoice.address)return void(e.authError="请填写收货地址");var t={};if(t.invoiceDeliver={receiver:e.invoice.receiver,address:e.invoice.address,phone:e.invoice.phone},t.invoiceList=[],e.invoiceListPu.title&&t.invoiceList.push({invoiceType:e.invoiceListPu.invoiceType,title:e.invoiceListPu.title}),e.invoiceListzhuan.title){if(!e.picture.tax)return void(e.authError="请上传税务登记证");if(!e.picture.bank)return void(e.authError="请上传银行许可证");if(!e.picture.people)return void(e.authError="请上传一般纳税人资质证明");if(!e.picture.mes)return void(e.authError="请上传开票信息加盖公章");var n={invoiceType:e.invoiceListzhuan.invoiceType,title:e.invoiceListzhuan.title,licenseImgsJson:e.picture.tax+","+e.picture.bank+","+e.picture.people+","+e.picture.mes};t.invoiceList.push(n)}i.saveUserInvoice(t).then(function(i){i.data.success&&(o.view?e.editInfo.isEditable=!1:e.$close(t),r.pushForCurrentRoute("save.success","notify.success"))})},e.cancel=function(){e.$close()}}]);