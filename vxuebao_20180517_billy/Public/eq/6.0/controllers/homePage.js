angular.module("main",["services.mine","services.data","app.directives.pageTplTypes","services.staticRes","app.directives.addelement","services.usercenter","services.i18nNotifications","common.directives.scroll","services.modal","services.configSer","security.login.toolbar","ui.bootstrap"]),angular.module("main").controller("MainCtrl",["$rootScope","$scope","$location","$translate","security","MineService","dataService","sceneService","ModalService","$modal","usercenterService","i18nNotifications","configSerService","SpreadService","$filter","staticResService","$timeout","$http","$state","$interval","$location",function(e,t,n,a,o,s,i,c,r,l,u,p,d,g,m,f,h,y,v,S,w){t.createForm=function(){return 1==e.user.type||12==e.user.type?!!window.confirm("您好！该功能目前只向企业用户开放，点击确定申请成为企业用户")&&window.open("https://wetool.im/f/0viuuz"):void w.path("form")},t.myForm=function(){return 1==e.user.type||12==e.user.type?!!window.confirm("您好！该功能目前只向企业用户开放，点击确定申请成为企业用户")&&window.open("https://wetool.im/f/0viuuz"):void w.path("form/myForm")},t.myTest=function(){return 1==e.user.type||12==e.user.type?!!window.confirm("您好！该功能目前只向企业用户开放，点击确定申请成为企业用户")&&window.open("https://wetool.im/f/0viuuz"):void w.path("form/myForm")},t.PREFIX_URL=PREFIX_URL,t.PREFIX_CLIENT_HOST=PREFIX_HOST,t.client_cdn=CLIENT_CDN,t.scene={type:null},t.pageSize=11,t.editInfo={isEditable:!1};var b=1;t.lists=[{title:"我的微课"},{title:"模板中心"},{title:"PPT导入"},{title:"长图文"}],t.changing=function(){alert("转换中，请稍后...")},t.urlPpt=PREFIX_HOST,t.upgrade=function(){l.open({windowClass:"console six-contain",templateUrl:BASE_URL+"templates/scene.console.upgrade.tpl.html",controller:"MainCtrl"})},t.getPpt=function(t){if(1==e.user.type||12==e.user.type)return window.confirm("您好！该功能目前只向企业用户开放，点击确定申请成为企业用户")?window.open("https://wetool.im/f/0viuuz"):void 0;if(2==e.user.type||21==e.user.type||23==e.user.type){l.open({templateUrl:"myModelContent.html",controller:"MainCtrl",size:t})}},t.cancel=function(){t.$dismiss()},t.successPpt=function(){function e(e){if(e.lengthComputable){var t=Math.round(100*e.loaded/e.total);document.getElementById("baifenbi").innerHTML=t.toString()+"%","100%"==document.getElementById("baifenbi").innerHTML&&(document.getElementById("baifenbi").innerHTML="请稍后...")}else document.getElementById("progressNumber").innerHTML="unable to compute"}function t(e){var t=$.parseJSON(e.target.responseText);console.log(t.obj),"200"==t.code&&(document.getElementById("baifenbi").innerHTML="",document.getElementById("successtopost").innerHTML='PPT上传成功，请点击"开始转换"进行转换。'),document.getElementById("pptPath").innerHTML=t.obj}function n(e){$.parseJSON(e.target.responseText);alert("上传文件后缀不允许")}function a(e){$.parseJSON(e.target.responseText);alert("上传文件后缀不允许")}var o=document.getElementById("f").files[0];console.log(o);var s=document.getElementById("f"),i=/\.(pptx|ppt)$/i.test(s.value);if(0==i)return alert("PPT文档后缀名必须是.PPTX");var c=PREFIX_URL+"index.php?c=Ppt&a=upload",r=new FormData;r.append("photo",o),console.log(r);var l=new XMLHttpRequest;l.upload.addEventListener("progress",e,!1),l.addEventListener("load",t,!1),l.addEventListener("error",n,!1),l.addEventListener("abort",a,!1),l.open("post",c,!0),l.send(r)},t.reload=function(){l.open({windowClass:"console six-contain",templateUrl:"myModelContent2.html",controller:"MainCtrl"})},t.postPpt=function(){var n=document.getElementById("title").value,a=document.getElementById("desc").value,o=document.getElementById("pptPath").innerHTML,s=document.getElementById("picturePath").innerHTML;document.getElementById("f").files[0];if(console.log(o),""==n||null==n)return alert("标题不能为空");if(""==o||null==o||void 0==o){if(""==document.getElementById("baifenbi").innerHTML)return alert("PPT不能为空");if(""==document.getElementById("successtopost").innerHTML)return alert("文件正在上传，请稍后")}else""!=s&&null!=s||(s="pptmorenfengmian/ppt.jpg");document.getElementById("transform").style.display="block";var i={title:n,desc:a,ppturl:o,photo:s};y({method:"POST",url:PREFIX_URL+"index.php?c=Ppt&a=change",data:$.param(i),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(n){if(n.code="200"){t.$dismiss(),e.$broadcast("search.ppt");var a=new Date,o=S(function(){console.log("返回ppt状态"),$.ajax({type:"GET",url:PREFIX_URL+"index.php?c=Ppt&a=pptlist&pageNo=1&pageSize=11&time="+a.getTime(),success:function(e){var t=e.list[0].is_del,n=e.list[0].pptlink;if("0"==t){S.cancel(o);var a=window.location.href;a.indexOf("ttp")>0&&$.ajax({type:"POST",url:PREFIX_URL+"index.php?c=Ppt&a=wxshare",data:{ppturl:n},success:function(e){console.log(e)}})}}}),e.$broadcast("search.ppt")},5e3)}})},t.listType=0,t.ifCompany=0,t.sceneLoading=!0,t.navChange=function(n){switch(t.sceneLoading=!0,n){case 0:t.$broadcast("search.myScene");break;case 1:t.sceneLoading=!1;break;case 2:e.$broadcast("search.ppt");break;case 3:t.$broadcast("search.longpage");break;default:alert("出错；请刷新页面")}t.listType=n,t.ifCompany=e.user.type},t.isAllowedHistory=o.isAllowToAccess(o.accessDef.USERCENTER_HISTORY),t.showCloseStatus=[],t.showOpenStatus=[],t.isActive="main",t.loginSuccess=o.isLoginSuccess,t.myScene=!0,t.showBranchSelect=!0;var P=e.branchid;t.XdpageSize=100,t.getBranches=function(e){u.getBranches(t.XdpageSize,e).then(function(e){e.data.success&&(t.branches=e.data.list)},function(){})},t.getBranches(1),t.selectBranch=function(a){a?(t.branchCurrent=a,e.branchid=a.id,n.search({branchid:a.id})):(e.branchid="",n.search("branchid",null)),t.reload()};var I=n.search().branchid;h(function(){if(I)for(var e=0;e<t.branches.length;e++)t.branches[e].id==I&&(t.branchCurrent=t.branches[e])},300),t.showSceneList=function(){t.initShowGuide=!1,e.$broadcast("eqmain.overflow.visible")},t.getUserInfo=function(){u.getUserInfo().then(function(e){t.userinfo=e.data.obj})},t.getUserInfo(),t.userXd=0,t.getUserXd=function(){u.getUserXd().then(function(e){e.data.success&&(t.xdCounts=e.data.obj,t.userXd=e.data.obj||0)})},t.getUserXd(),t.showSceneList=function(){t.initShowGuide=!1,e.$broadcast("eqmain.overflow.visible")},t.customerUpload=function(){l.open({windowClass:"img_console console",templateUrl:"/Public/eq/6.0/templates/scene.console.bg.tpl.html",controller:"BgConsoleCtrl",resolve:{obj:function(){return{fileType:1}}}}).result.then(function(n){if(n.width/n.height===1){t.userinfo.headImg=n.data;var a={headImg:n.data,id:t.userinfo.id};return void u.saveUserInfo(a).then(function(a){a.data.success&&(t.editInfo.isEditable=!1,e.$broadcast("headImg.change",n.data))})}l.open({windowClass:"console seven-contain",templateUrl:"/Public/eq/6.0/templates/scene.console.imageCrop.tpl.html",controller:"imageCropCtrl",backdrop:"static",resolve:{obj:function(){return{type:"square",properties:{src:n.data}}}}}).result.then(function(n){t.userinfo.headImg=n.src;var a={headImg:n.src,id:t.userinfo.id};u.saveUserInfo(a).then(function(n){n.data.success&&(t.editInfo.isEditable=!1,e.$broadcast("headImg.change",n.data.obj.headImg))})},function(e){})},function(e){})},t.createScene=function(t,n){if(3==parseInt(t)){if(1==e.user.type||12==e.user.type)return window.confirm("您好！该功能目前只向企业用户开放，点击确定申请成为企业用户")?window.open("https://wetool.im/f/0viuuz"):void 0;2!=e.user.type&&21!=e.user.type&&23!=e.user.type||l.open({windowClass:"login-container seven-contain",templateUrl:"/Public/eq/6.0/templates/scene.createNew.tpl.html",controller:"SceneNewCtrl",resolve:{items:function(){return{fileType:t}}}})}else 0==parseInt(t)&&l.open({windowClass:"login-container seven-contain",templateUrl:"/Public/eq/6.0/templates/scene.createNew.tpl.html",controller:"SceneNewCtrl",resolve:{items:function(){return{fileType:t}}}})},t.buyXd=function(){l.open({windowClass:"console six-contain",templateUrl:"?c=pay",controller:"BuyXdController",resolve:{getUserXd:function(){return function(){t.getUserXd(),t.getXdlog(t.XdtoPage)}}}}).result.then(function(){},function(){})},t.transferXd=function(){l.open({windowClass:"six-contain",templateUrl:"/Public/eq/6.0/templates/usercenter.transfer.tpl.html",controller:"UsercentertransferCtrl",resolve:{username:function(){return t.userinfo.loginName}}}).result.then(function(){t.getUserXd(),t.getXdlog(),t.getXdStatNum()},function(){})},t.$watch("user.loginName",function(e,n){if(e){var a=/^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;t.loginSuccess&&"eqs"==e.substr(0,3)&&!a.test(e)&&p.pushForCurrentRoute("rel.tip","notify.tip")}}),t.editScene=function(e,t,a){if(3==a){var o=1;e&&e.stopPropagation(),n.path("scene/create/"+t+"/"+o).search("pageId",1)}else e&&e.stopPropagation(),n.path("scene/create/"+t).search("pageId",1)},t.visitSceneAction=function(){r.openMsgDialog({msg:"分别可在设置微课-分享设置中、微课详情页中设置微课状态为不允许访问",btn:"知道了"},function(){})},t.showPreview=function(e,n,a){if("true"==n.company_ext.is_audit){e&&e.stopPropagation();var o=t.canvasUrl+("/v-"+n.code);window.open(o)}else if(n.publishTime)if(n.publishTime&&n.updateTime>n.publishTime)r.openConfirmDialog({msg:"微课有更新需要再次发布才能预览最新内容，坚持预览会看到修改之前的微课",confirmName:"发布",cancelName:"坚持预览"},function(){t.publishScene(e,n,a)},function(){e&&e.stopPropagation();var a=t.canvasUrl+("/v-"+n.code);window.open(a)});else{e&&e.stopPropagation();var o=t.canvasUrl+("/v-"+n.code);window.open(o)}else r.openConfirmDialog({msg:"尚未发布微课无法预览，请先发布",confirmName:"发布",cancelName:"取消"},function(){t.publishScene(e,n,a)})},window.localStorage&&"false"==localStorage.getItem("myScenesListType")?t.listType=!1:t.listType=!0,t.listToggle=function(){t.listType=!t.listType,window.localStorage&&localStorage.setItem("myScenesListType",t.listType)},t.addColor=function(e){t.trIndex=e},t.removeColor=function(){t.trIndex=-1},t.sceneSettings=function(e,t,a){if(3==a){var o=1;e&&e.stopPropagation(),n.path("scene/create/"+t+"/"+o).search({pageId:1,openSetting:"show"})}else e&&e.stopPropagation(),n.path("scene/create/"+t).search({pageId:1,openSetting:"show"})},t.clickScene=function(){n.path("main")},t.clickSpread=function(){n.path("main/spread")},t.creatCompanyTpl=function(e,n,a){e&&e.stopPropagation(),c.createCompanyTpls(n).then(function(e){e.data.success&&(t.myScenes[a].isTpl=3,p.pushForCurrentRoute("scene.save.success.companyTpl","notify.success"))})},t.clearCompanyTpl=function(e,n,a){e&&e.stopPropagation(),c.clearCompanyTpls(n).then(function(e){e.data.success&&(t.myScenes[a].isTpl=0,p.pushForCurrentRoute("scene.clear.success.companyTpl","notify.success"))})},t.clickCustomer=function(){n.path("main/customer")},t.register=o.getRegisterInfo(),t.logout=function(){o.logout()},t.copyScene=function(e,t,a){e&&e.stopPropagation(),r.openConfirmDialog({msg:"确定复制此微课?"},function(){c.copySceneById(t).then(function(e){if(3==a){var t=1;n.path("scene/create/"+e.data.obj+"/"+t).search("pageId",1)}else n.path("scene/create/"+e.data.obj).search("pageId",1)})})},t.isAllowedToAccessTransfer=o.isAllowToAccess(o.accessDef.TRANSFER_SCENE),t.isAllowedToAccessTransfer&&(t.transferScene=function(n,a){n&&n.stopPropagation(),"eqs"==e.user.loginName.substr(0,3)&&null==e.user.email?r.openBindEmailDialog():l.open({windowClass:"six-contain",templateUrl:"/Public/eq/6.0/templates/main.transferscene.tpl.html",controller:"TransferSceneCtrl",resolve:{sceneId:function(){return{sceneId:a}}}}).result.then(function(){t.getMyScenes()},function(){})}),t.color_arry=["#eac8c1","#c1ead4","#d1bce2","#b8dee8","#e8e1af","#a7addb"],t.getStyle=function(e,n){n=n||0,n%=6;var a=t.color_arry[n];return{"background-image":"url("+PREFIX_FILE_HOST+e+")","background-size":"cover","background-color":a}},t.getLongStyle=function(e,n,a){n=n||0,n%=6;t.color_arry[n];return e=a&&a.temp?a.temp:"assets/images/default_thum_longpage.jpg",{"background-image":"url("+PREFIX_URL+e+")","background-size":"cover"}},t.getImageStyle=function(e,n){n=n||0,n%=6;var a=t.color_arry[n];return{"background-image":"url("+PREFIX_FILE_HOST+e+")","background-size":"cover","background-color":a}},t.totalItems=0,t.totalItems2=0,t.page={currentPage:1},t.toPage="",t.toPage3="",t.name=null,t.EnterPress=function(e,n,a){var o=e||window.event;13==o.keyCode&&t.submit(n,a)},t.searchButton=!0;var T={};t.submit=function(e,n){switch(t.name=e,n){case 0:s.getMyScenes(t.scene.type?t.scene.type.value:null,b,t.pageSize,P,null,e);break;case 1:c.getPageTpls(1,null,null,0,12,p.orderby,null,e);break;case 3:t.getMyLongScenes(t.page.currentPage3,t.pageSize3)}e&&(t.searchButton=!1),T.refresh=!0},t.changeName=function(e){t.searchButton=!0,""==e&&T.refresh&&s.getMyScenes(t.scene.type?t.scene.type.value:null,b,t.pageSize,P,null,e)},t.clearSearch=function(e){switch(t.searchButton=!0,t.name="",e){case 0:s.getMyScenes(t.scene.type?t.scene.type.value:null,b,t.pageSize,P);break;case 1:c.getPageTpls(1,null,null,1,12);break;case 3:t.getMyLongScenes(t.page.currentPage3,t.pageSize3)}},t.getMyScenes=function(e){s.getMyScenes(t.scene.type?t.scene.type.value:null,e,t.pageSize,P)},t.getMyScenes(),t.$on("search.myScene",function(e){t.getMyScenes()}),t.$on("get.my.scene.list",function(n){var a=s.scenes;a.list&&a.list.length>0?(t.myScenes=a.list,t.totalItems=a.map.count,t.page.currentPage=a.map.pageNo,t.allPageCount=a.map.count,t.toPage=a.map.pageNo,e.user&&e.user.domain?(t.url=e.user.domain,t.canvasUrl="http://"+t.url):t.canvasUrl=t.PREFIX_CLIENT_HOST):(t.canvasUrl=t.PREFIX_CLIENT_HOST,t.totalItems=0,t.currentPage>1?t.getMyScenes(--t.currentPage):(t.myScenes=[],t.allPageCount=0)),t.sceneLoading=!1}),t.getMyLongScenes=function(e,n){e=e?e:1,n=n?n:9,s.getLongPage(t.scene.type?t.scene.type.value:null,t.name?t.name:null,e,n).then(function(e){t.longLists=e.data.list,t.totalItems3=e.data.map.count,t.page.currentPage3=e.data.map.pageNo,t.toPage3=e.data.map.pageNo,t.pageSize3=1==e.data.map.pageNo?9:10,t.sceneLoading=!1})},t.$on("search.longpage",function(e){t.getMyLongScenes(1,9)}),e.$on("search.ppt",function(e){s.getPPT().then(function(e){t.ppt=e.data,t.ppts=e.data.list,t.totalItems2=t.ppt.map.count,t.sceneLoading=!1})}),t.deleteScene=function(e,n,a){e&&e.stopPropagation();var o=t.isAllowedHistory?"确定删除此微课?":"确定删除此微课?";r.openConfirmDialog({msg:o},function(){s.deleteSceneById(n).then(function(){0==a?(1==t.myScenes.length&&t.currentPage>1&&t.currentPage--,t.getMyScenes(t.currentPage)):(1==t.longLists.length&&t.page.currentPage3>1&&t.page.currentPage3--,t.getMyLongScenes(t.page.currentPage3))})})},t.deleteScene2=function(e){var t=PREFIX_URL+"index.php?c=Ppt&a=pptdel",n={id:e},a=confirm("是否删除此课件？");1==a&&y({method:"POST",url:t,data:$.param(n),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){alert(e.msg);var t="ppt"+n.id;document.getElementById(t).style.display="none"})},t.pageChanged=function(e){return t.sceneLoading=!0,1==e?t.pageSize=11:t.pageSize=12,1>e||e>t.totalItems/10+1?void alert("此页超出范围"):(t.page.currentPage=e,void t.getMyScenes(e,t.pageSize))},t.pageChanged2=function(e){t.sceneLoading=!0,t.pageSize=11;var n=new Date,a=PREFIX_URL+"index.php?c=Ppt&a=pptlist&pageNo="+e+"&pageSize="+t.pageSize+"&time="+n.getTime();y.get(a).success(function(e){t.ppt=e,t.ppts=e.list,console.log(t.ppt),t.totalItems2=t.ppt.map.count,console.log(t.totalItems2),t.page.currentPage2=t.ppt.map.pageNo,console.log(t.page.currentPage2)})},t.pageChanged3=function(e){t.sceneLoading=!0,1==e?t.pageSize3=9:e>1&&(t.pageSize3=10),t.getMyLongScenes(e,t.pageSize3)},t.getTdStyle=function(e){var t=$(".header_table td:eq("+e+")").outerWidth();return{width:t+"px",maxWidth:t+"px"}},t.scene.types=f.getSceneType(),t.dataDetail={},i.getDatas(P),i.getCustomDatas(P),t.$on("sceneDatas",function(e,n){t.datasCount=n}),t.$on("customDatas",function(e,n){t.customCount=n}),t.showDetail=function(e){n.path("spread/share/"+e+"/socialShare")},t.$on("$destroy",function(){o.setLoginSuccess(!1)}),t.publishScene=function(e,n,a){if(e&&e.stopPropagation(),!n.name)return void r.openMsgDialog({msg:"尚未设置标题，请设置后再执行此操作",btn:"去设置"},function(){t.sceneSettings(e,n.id,a)});var o=window.open();c.publishScene(n.id).then(function(e){if(e.data.success){n.publishTime=(new Date).getTime(),p.pushForCurrentRoute("scene.publish.success","notify.success");var a=t.canvasUrl+("/v-"+n.code);o.location=a}})},t.getRejectDetail=function(e){e.stopPropagation(),n.path("/usercenter/message")},t.viewDetail=function(a){e.showSpreadTable=!1,t.$parent.showBranchSelect=!1,n.path("/main/spread/statistics/"+a),g.getSceneDetail(a,P),g.getSceneData(a,-6,1,P);var o=new Date;o=new Date(o.getTime()-864e5)},t.audit=function(e,n){21==parseInt(e)?r.openConfirmDialog({msg:"请选择是否提交审核？",confirmName:"确定",cancelName:"取消"},function(){var e=1;s.subAudit(n,e,t.userinfo.id).then(function(e){200==e.data.code&&($("#scene_"+n+" .audit").removeClass("not-audit").addClass("is-audit").children("span").text("待审核"),$("#scene_"+n+" .icon_list .audit-scene").remove())})},function(){}):2==parseInt(e)&&r.openConfirmDialog({msg:"是否通过审核？",confirmName:"通过",cancelName:"拒绝"},function(){var e=1;s.saveAudit(n,e,t.userinfo.id).then(function(e){200==e.data.code&&($("#scene_"+n+" .audit").removeClass("is-audit").addClass("pass-audit").children("span").text("已通过"),$("#scene_"+n+" .icon_list .audit-scene-company").remove())})},function(){var e=3;s.saveAudit(n,e,t.userinfo.id).then(function(e){200==e.data.code&&($("#scene_"+n+" .audit").removeClass("is-audit").addClass("refuse-audit").children("span").text("已拒绝"),$("#scene_"+n+" .icon_list .audit-scene-company").remove())})})}}]).directive("sysMsgAdjust",function(){return{restrict:"EA",link:function(e,t,n){e.isSysMsgVeryShort=!1;var a=e.$watch(function(){return $(".messages",t).css("height")},function(t){"44px"===t&&(e.isSysMsgVeryShort=!0)});t.bind("$destroy",function(){a()})}}}).directive("selectPicker",function(){return{restrict:"EA",link:function(e,t,n){t.selectpicker()}}});