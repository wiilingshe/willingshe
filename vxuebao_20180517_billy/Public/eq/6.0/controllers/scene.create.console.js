angular.module("scene.create.console.adr",[]),angular.module("scene.create.console.adr").controller("AdrConsoleCtrl",["$scope",function(e){e.replaceImage=function(t){if(e.position=$("#position").val(),!e.position)return void(e.authError="请输入地址");var o=e.position.indexOf("zoom"),n=e.position.indexOf("markers"),i=e.position.lastIndexOf(","),r=Number(e.position.slice(n+8,i)),s=Number(e.position.slice(i+1)),l=Number(e.position.slice(o+5,n-1)),c=[];c.push({zoom:l,pointX:r,pointY:s,src:e.position}),$("#position").focus()&&(e.authError=null),e.$close(c)},e.cancel=function(){e.$dismiss()}}]),angular.module("scene.create.console.bg",["services.file","app.directives.responsiveImage","app.directives.rightclick","services.file.upload","services.i18nNotifications","app.directives.autoclose"]),angular.module("scene.create.console.bg").controller("BgConsoleCtrl",["$scope","$modal","ModalService","sceneService","fileService","localizedMessages","obj","uploaderService","i18nNotifications","security","dataCacheService",function(e,t,o,n,r,s,l,c,a,d,p){function u(){e.$watch("imgList",function(t){for(var o=0;o<t.length;o++){if(t[o].selected)return void(e.mangeObj.manageAll=!0);e.mangeObj.manageAll=!1}},!0)}function g(){e.systemImages=!1,e.userTagId="",e.sysCatId="",r.getUserFiles1(1,m,h,null,e.userTagId)}e.mobileUploads=function(){var e=document.location.href,t=e.indexOf("?"),o=e.substring(38,t);$("#codeKuang").css("background",'url("/assets/images/re-design/bg_code.jpg") no-repeat'),$.ajax({type:"GET",url:"http://"+window.location.host+"/index.php?c=scene&a=detail&id="+o,success:function(e){console.log(e.token),$("#codePic").qrcode({text:"http://"+window.location.host+"/index.php?c=Mobile&token="+e.token+"&type=0",width:125,height:125}),window.ww=setInterval(function(){$.ajax({type:"GET",url:"http://"+window.location.host+"/index.php?c=Scene&a=mobfile&type=1",success:function(e){if("200"==e.code){console.log("success"),document.getElementById("codeUpload").style.display="none",document.getElementById("codeKuang").style.display="none",document.getElementById("codePic").children[0].remove(),sessionStorage.setItem("fileService","");r.getUserFiles1(1,18,1)}else"400"==e.code&&console.log("false")}})},5e3)}}),$("#codeKuang").css("display","block"),$("#codeUpload").css("display","block"),$("#codeSound").css("display","none"),$("#soundCode").css("display","none"),$("#picCode").css("display","block"),$("#codePic").css("display","block")};var m,h=e.fileType=l.fileType,f=1;if(e.type=l.type,e.currentPage=1,e.systemImages=!0,e.isAllowedHistory=d.isAllowToAccess(d.accessDef.USERCENTER_HISTORY),e.toPage=1,e.mangeObj={manageAll:!1},e.showObj={showGroup:!1},m=e.pageSize=21,("p"==e.type||"n"==e.type)&&(e.mangeObj.manageAll=!0),e.showOld={showOG:!1},e.switchToSystemImages=function(t){e.systemImages="true"===t},e.getSysCategory=function(e){r.getSysCategory(e)},e.getSystemFiles1=function(e,t,o,n,i){r.getSystemFiles1(e,t,o,n,i)},e.getSystemFiles=function(){"0"!=e.sysCatId&&(e.mangeObj.manageAll=!1,window.localStorage&&("1"==e.fileType?localStorage.setItem("photoTag",""):localStorage.setItem("backgroundTag","")),e.userTagId="",e.sysCatId="0",e.sysTagList=[],e.sysTagId="",S=[],e.getSystemFiles1(f,m,h))},e.getHistory=function(){e.userTagId="history",r.getFilesHistory(1).then(function(t){t.data.success&&(e.imgList=t.data.list)})},e.$on("sysCategory.update",function(t){$.get(categoryUrl,function(t){e.sysCategoryList=t})}),e.getSysCatAndList=function(t){searchVal="",S=[],e.sysCatId=t,"0"!=t&&"pure"!=t?r.getSysTagByCatId(t):(e.sysTagList=[],e.sysTagId="",angular.forEach(e.imgList,function(e,t){e.selected=!1})),e.getSystemFiles1(f,m,h,t)},e.$on("sysTag.update",function(t){e.sysTagList=r.sysTagList}),e.getSysImgByTag=function(t){S=[],e.sysTagId=t,e.getSystemFiles1(f,m,h,e.sysCatId,t)},e.$watch("currentPage",function(t,o){t!=o&&(e.toPage=t,S=[],e.systemImages?e.getSystemFiles1(t,m,h,e.sysCatId,e.sysTagId):r.getUserFiles1(t,m,h,null,e.userTagId))}),e.getImgByPage=function(){e.currentPage=e.toPage},e.getUserFiles=function(t,o){t!==e.userTagId&&(e.mangeObj.manageAll=!1,window.localStorage&&("1"==e.fileType?localStorage.setItem("photoTag",t):localStorage.setItem("backgroundTag",t)),e.thumbnailList=[],S=[],e.userTagId=t,e.sysCatId="",r.getUserFiles1(o,m,h,null,t))},e.$on("imgList.update",function(t){e.imgList=r.imgList,e.totalItems=r.totalItems,e.currentPage=r.pageNo}),window.localStorage){var y="1"==e.fileType?localStorage.getItem("photoTag"):localStorage.getItem("backgroundTag");y?(e.getUserFiles(parseInt(y,10)),e.switchToSystemImages(!1),e.sysCatId=""):(e.getSystemFiles1(f,m,h),e.sysCatId="0")}else e.getSystemFiles1(f,m,h);e.getSysCategory(h);var b=null;e.createTag=function(){return e.tagList.length>=8?void(e.authError="最多能创建8个自定义分组！"):void(b=t.open({windowClass:"console",templateUrl:BASE_URL+"templates/scene.console.category.tpl.html",controller:"CategoryConsoleCtrl"}))},e.getTagList=function(){r.getTagList()},e.getTagList(),e.deleteTag=function(e,t){o.openConfirmDialog({msg:"确定删除此分组?"},function(){r.deleteTag(e,t)})},e.$on("tagList.update",function(t){e.tagList=r.tagList}),e.$on("tagList.delete",function(e){g()});var S=[];e.switchSelect=function(t,o,n,i){if(e.mangeObj.manageAll||!i)if(n.stopPropagation(),t.selected=!t.selected,e.systemImages&&"p"!=l.type&&"n"!=l.type)if(angular.forEach(e.imgList,function(e,o){!e.selected||e.id==t.id&&e.color==t.color||(e.selected=!1)}),t.selected){var r;S=[],t.path?r={id:t.id,src:t.path,shape:t.shape}:t.color&&(r={color:t.color}),S.push(r)}else S=[];else if(t.selected)e.mangeObj.manageAll=!0,S.push({id:t.id,src:t.path||t.tmbPath,shape:t.shape});else for(var s in S)S[s].id==t.id&&S.splice(s,1);else{u();for(var s in S)S[s].id==t.id&&S.splice(s,1)}},e.cancelSelect=function(){for(var t in e.imgList)e.imgList[t].selected&&(e.imgList[t].selected=!1);S=[]},e.assignTag=function(t){var o=[];e.showObj.showGroup=!1;for(var n=0;n<S.length;n++)o.push(S[n].id);if(!o.length)return void(e.authError="请先点击管理选择一张图片再进行分组");angular.forEach(e.imgList,function(e,t){e.selected=!1});var i=o.join(",");p.clear("fileService"),r.assignTag(t,i),S=[]},e.$on("tag.assign",function(){a.pushForCurrentRoute("data.assign.success","notify.success")}),e.unbindTag=function(t){for(var o=[],n=0;n<S.length;n++)o.push(S[n].id);if(!o.length)return void(e.authError="请先选择一张图片再解除分组");var i=o.join(",");p.clear("fileService"),r.unbindTag(t,i)},e.$on("tag.unbind",function(){a.pushForCurrentRoute("group.delete.data","notify.success"),r.getUserFiles1(e.currentPage,m,h,null,e.userTagId)}),e.deleteFile=function(t){var n=[];if(!t&&0===S.length)return void(e.authError="请您选中图片后再进行删除操作！");for(var i=0;i<S.length;i++)n.push(S[i].id);var s="";s=e.isAllowedHistory?t?"确定删除此图片？删除后，该图片将在回收站保留3天":"确定删除所选图片？删除后，该图片将在回收站中保留3天":t?"确定删除此图片？":"确定删除所选图片？";var l=t?t:n.join(",");o.openConfirmDialog({msg:s},function(){r.deleteFile(l),p.clear("fileService")})},e.delAll=function(e){var t=$("#del_this_page").val(),o=[],n=new Date;$.ajax({type:"GET",url:PREFIX_URL+"index.php?c=upfile&a=userList&pageNo="+t+"&pageSize=18&fileType="+e+"&time="+n.getTime(),success:function(e){for(console.log(e.list.length),i=0;i<e.list.length;i++)o.push(e.list[i].id);var t=o.join();console.log(o),r.deleteFile(t),p.clear("fileService")}})},e.$on("files.delete",function(t){e.sysCatId="",S=[],r.getUserFiles1(e.currentPage,m,h,null,e.userTagId)}),e.replaceImage=function(){if(!S.length)return void(e.authError="请您先选择图片！");var t;if("p"!=l.type&&"n"!=l.type){if(S.length>1)return void(e.authError="只能选择一张图片进行替换！");t=S[0]}else{var o=l.count+S.length,n="p"==l.type?6:10;if(o>n)return e.authError="最多可选择"+(n-l.count)+"张图片",!1;e.picObj=[];for(var i=0;i<S.length;i++)e.picObj.push({width:S[i].shape.width,height:S[i].shape.height,src:S[i].src})}var r={};t&&t.src&&(r={type:"imgSrc",data:t.src,width:t.shape.width,height:t.shape.height,id:t.id}),"0"==h?t.src?e.$close(r):e.$close({type:"backgroundColor",data:{color:t.color}}):(("p"==l.type||"n"==l.type)&&(r.selectedImages=e.picObj),e.$close(r))},e.replaceByClick=function(t,o,n){if(!e.mangeObj.manageAll){if("p"==l.type||"n"==l.type)return void e.switchSelect(t,o,n,!0);S=[],(!S.length&&!e.mangeObj.manageAll||e.systemImages)&&(t.path||t.tmbPath?S.push({id:t.id,src:t.path||t.tmbPath,shape:t.shape}):t.color&&S.push({color:t.color}),e.replaceImage())}},e.uploader=c.uploader(h),e.$on("uploadfiles.add",function(t){e.systemImages&&g(),p.clear("fileService"),e.imgList.length==m&&e.imgList.splice(e.imgList.length-e.uploader.queue.length-1,e.uploader.queue.length)});var v;e.$on("thumbnailList.update",function(t,o){for(var n=0;n<e.uploader.queue.length;n++)100==e.uploader.queue[n].progress&&(e.uploader.queue.splice(n,1),v=o,e.imgList.unshift(v));p.clear("fileService")}),e.$on("upload.bg.complete",function(t,o){r.deleteFile(z.id),n.openCropModal(o,function(t){z.tmbPath=t.src,z.id=t.id,e.imgList.unshift(z)},function(e){})}),e.cancel=function(){e.$dismiss()},e.search=function(){searchVal=document.getElementById("search-value").value,searchUrl="/index.php?c=upfile&a=syslist&pageNo=1&pageSize=21&fileType="+h+"&bizType=0&key="+searchVal,r.getPictures(0,1,21,0,"0",0)},window.enterSearchPic=function(){var e=event||window.event||arguments.callee.caller.arguments[0];e&&13==e.keyCode&&(searchVal=document.getElementById("search-value").value,searchUrl="/index.php?c=upfile&a=syslist&pageNo=1&pageSize=21&fileType="+h+"&bizType=0&key="+searchVal,r.getPictures(0,1,21,0,"0",0))},e.$watch("userTagId",function(t,o){var n=PREFIX_URL+"index.php?c=upfile&a=upload&bizType=0&fileType="+h;t&&(n+="&tagId="+t),e.uploader.url=n})}]),angular.module("scene.create.console.button",[]),angular.module("scene.create.console.button").controller("ButtonConsoleCtrl",["$scope","obj",function(e,t){e.btnIndex=0,e.model={title:t.properties.title},e.authError="",e.buttons=[{id:1,text:"点击提交",btnStyle:{backgroundColor:"#08a1ef",height:"30px","text-align":"center","line-height":"30px",color:"rgb(255, 255, 255)"}},{id:2,text:"立即提交",btnStyle:{backgroundColor:"rgb(255, 255, 255)",height:"30px","text-align":"center","line-height":"30px",color:"rgb(0, 0, 0)"}},{id:3,text:"提交信息",btnStyle:{backgroundColor:"#f6b223",height:"30px","text-align":"center","line-height":"30px",color:"rgb(255, 255, 255)"}},{id:4,text:"立即参加",btnStyle:{height:"30px",backgroundColor:"#333333","text-align":"center","line-height":"30px",color:"rgb(255, 255, 255)"}},{id:5,text:"提交表单",btnStyle:{height:"30px",backgroundColor:"#a0d86b","text-align":"center","line-height":"30px",color:"rgb(255, 255, 255)"}},{id:6,text:"马上订购",btnStyle:{height:"30px",backgroundColor:"#ff6666","text-align":"center","line-height":"30px",color:"rgb(255, 255, 255)"}}],angular.forEach(e.buttons,function(o,n){""!==e.model.title&&t.css.backgroundColor&&t.css.backgroundColor==o.btnStyle.backgroundColor&&(e.btnIndex=n)}),e.confirm=function(){return e.model.title&&0!==e.model.title.length?void e.$close(e.model):(e.authError="按钮名称不能为空",void $('.bg_console input[type="text"]').focus())},e.cancel=function(){e.$dismiss()},e.chooseTabButton=function(t,o){e.model.title=t.text,e.model.btnStyle=t.btnStyle,e.btnIndex=o}}]),angular.module("scene.create.console.turnTo",[]),angular.module("scene.create.console.turnTo").controller("TurnToConsoleCtrl",["$scope","obj",function(e,t){e.model={title:"next"==t.mType?"下一页":"上一页"},e.authError="",e.buttons=[{id:"next",text:"下一页",btnStyle:{backgroundColor:"#08a1ef",height:"30px","text-align":"center",lineHeight:"30px",color:"rgb(255, 255, 255)"}},{id:"pre",text:"上一页",btnStyle:{backgroundColor:"#08a1ef",height:"30px","text-align":"center",lineHeight:"30px",color:"rgb(255, 255, 255)"}}],angular.forEach(e.buttons,function(o,n){""!==e.model.title&&t.mType&&t.mType==o.id&&(e.btnIndex=n)}),e.confirm=function(){return e.model.title&&0!==e.model.title.length?void e.$close(e.model):(e.authError="按钮名称不能为空",void $('.bg_console input[type="text"]').focus())},e.cancel=function(){e.$dismiss()},e.chooseTabButton=function(t,o){e.model.title=t.text,e.btnIndex=o}}]),angular.module("scene.create.console.category",["services.file"]),angular.module("scene.create.console.category").controller("CategoryConsoleCtrl",["$scope","$timeout","localizedMessages","fileService",function(e,t,o,n){e.category={},e.authError="",e.confirm=function(){return e.category.name&&e.category.name.trim()?countCharacters(e.category.name)>16?void(e.authError="分类名称不能超过16个字符"):(n.createTag(e.category.name),void e.$close()):void(e.authError="请输入分类名称！")},e.cancel=function(){e.$dismiss()}}]),angular.module("scene.create.console.counter",[]),angular.module("scene.create.console.counter").controller("CounterConsoleCtrl",["$scope","obj","$modal",function(e,t,o){e.model={title:t.title,properties:{layout:t.properties.layout,size:t.properties.size,color:t.properties.color,icon:t.properties.icon,imgSrc:t.properties.imgSrc}},e.authError="",e.openImageModal=function(){o.open({windowClass:"img_console console",templateUrl:BASE_URL+"templates/scene.console.bg.tpl.html",controller:"BgConsoleCtrl",resolve:{obj:function(){return{fileType:1}}}}).result.then(function(o){e.model.properties.icon="",e.model.properties.imgSrc=t.properties.imgSrc=o.data},function(e){})},e.confirm=function(){angular.extend(t,e.model);var o=parseInt(t.css.height,10)||0;e.model.properties.imgSrc&&115>o&&(e.model.btnStyle={width:"320px",height:"115px",lineHeight:"115px",backgroundColor:"transparent"}),"counter-lr"===e.model.properties.layout&&(!e.model.properties.imgSrc&&80>o&&(e.model.btnStyle={height:"40px",lineHeight:"40px",width:"80px"}),e.model.properties.imgSrc&&155>o&&(e.model.btnStyle=e.model.btnStyle||{},e.model.btnStyle.height=e.model.btnStyle.lineHeight="155px")),e.$close(e.model)},e.cancel=function(){e.$dismiss()},e.chooseEqfont=function(t){e.model.properties.icon=t,e.model.properties.imgSrc=null}}]),angular.module("scene.create.console.cropImage",["services.file"]).directive("cropImage",["sceneService","fileService","$compile",function(e,t,o){return{restrict:"EAC",scope:{},replace:!0,templateUrl:BASE_URL+"templates/scene.console.cropimage.tpl.html",link:function(o,n,i){function r(){m.css.width/m.css.height>u/g?(d=parseInt(m.css.width*u/m.css.width,10),p=parseInt(m.css.height*u/m.css.width,10)):(d=parseInt(m.css.width*g/m.css.height,10),p=parseInt(m.css.height*g/m.css.height,10));var e=(u-d)/2,t=(g-p)/2,o=(u-d)/2+d,n=(g-p)/2+p;a=[0,0,u,g],y=m.css.width/m.css.height,c=[e,t,o,n]}function s(e){$(".cropWidth").html(parseInt(e.w,10)),$(".cropHeight").html(parseInt(e.h,10))}o.PREFIX_FILE_HOST=PREFIX_FILE_HOST;var l,c,a,d,p,u,g,m=e.currentElemDef,h=e.currentElemDef.properties.src,f=$("#target"),y=m.css.width/m.css.height;o.fit=!0,o.lockRatio=!1,o.$on("changeElemDef",function(e,t){m=t,o.fit=!0,o.lockRatio=!1,m.properties.src!=h?(h=m.properties.src,l.setImage(PREFIX_FILE_HOST+h),f.unbind("load").attr("src",PREFIX_FILE_HOST+h).load(function(){u=this.width,g=this.height,o.preSelectImage(h),o.$apply()})):(o.preSelectImage(h),o.$apply())}),o.preSelectImage=function(e){l?(r(),l.setOptions({aspectRatio:y,setSelect:c})):f.attr("src",PREFIX_FILE_HOST+e).load(function(){u=this.width,g=this.height,f.Jcrop({onChange:s,keySupport:!1,setSelect:[0,0,100,100],boxHeight:320,boxWidth:680},function(){l=this}),e&&(r(),l.setOptions({aspectRatio:y,setSelect:c}))})},o.preSelectImage(h),o.$watch("lockRatio",function(e,t){if(l){var o=l.tellSelect();o.w=parseInt(o.w,10),o.h=parseInt(o.h,10),e?l.setOptions({aspectRatio:o.w/o.h}):l.setOptions({aspectRatio:null})}}),o.$watch("fit",function(e,t){if(l)if(e){var o=l.tellSelect();o.x=parseInt(o.x,10),o.y=parseInt(o.y,10),o.x2=parseInt(o.x2,10),o.y2=parseInt(o.y2,10),a=[o.x,o.y,o.x2,o.y2],l.setOptions({aspectRatio:y,setSelect:c})}else l.setOptions({aspectRatio:null,setSelect:a})}),o.crop=function(){var o=e.currentElemDef,i=l.tellSelect();return 0===i.w||0===i.h?void $(n).hide():(i.x=parseInt(i.x,10),i.y=parseInt(i.y,10),i.w=parseInt(i.w,10),i.h=parseInt(i.h,10),i.x2=parseInt(i.x2,10),i.y2=parseInt(i.y2,10),i.src=$("#target").attr("src").split(PREFIX_FILE_HOST)[1],void t.cropImage(i).then(function(e){var t={type:"imgSrc",data:e.data.obj,width:i.w,height:i.h};o.properties.src=t.data;var r=t.width/t.height,s=$("#"+o.id),l=$("#inside_"+o.id).width(),c=$("#inside_"+o.id).height(),a=l/c;r>=a?(c=l/r,$("#inside_"+o.id).height(c),o.css.height=c,o.properties.height=c,s.outerHeight(c),s.outerWidth(l),s.css("marginLeft",0),s.css("marginTop",0)):(l=c*r,$("#inside_"+o.id).width(l),o.css.width=l,o.properties.width=l,s.outerWidth(l),s.outerHeight(c),s.css("marginTop",0),s.css("marginLeft",0)),s.attr("src",PREFIX_FILE_HOST+t.data),o.properties.imgStyle={},o.properties.imgStyle.width=s.outerWidth(),o.properties.imgStyle.height=s.outerHeight(),o.properties.imgStyle.marginTop=s.css("marginTop"),o.properties.imgStyle.marginLeft=s.css("marginLeft"),$(n).hide()},function(t){o.properties.src||e.deleteElement(o.id)}))},o.cancel=function(){$(n).hide()}}}}]),angular.module("scene.create.console.fake",[]),angular.module("scene.create.console.fake").controller("FakeConsoleCtrl",["$scope","type",function(e,t){e.type=t}]),angular.module("scene.create.console.imageCrop").controller("imageCropCtrl",["$translate","$rootScope","$scope","imageCropService","obj","dataCacheService",function(e,t,o,n,i,r){var s;"square"==i.type?s=o.cropOption={type:i.type,title:"图片裁切",desc:"图片将按照要求的比例进行裁切",showItems:!1,imgSrc:i.properties.src,cropItems:[{ratio:1,desc:"正方形比例"}]}:3==i.type?s=o.cropOption={type:i.type,title:"背景裁切",desc:"背景图将按照要求的比例进行裁切",showItems:!1,imgSrc:i.properties.src,cropItems:[{ratio:640/1008,desc:"背景图比例"}]}:4==i.type&&(s=o.cropOption={type:i.type,title:"图片裁切",desc:"请根据你的需求，点击右侧常用比例进行裁切",showItems:!0,imgSrc:i.properties.src,cropItems:[{value:1,ratio:0,desc:"原图比例"},{value:2,ratio:1,desc:"1:1"},{value:3,ratio:4/3,desc:"4:3"},{value:4,ratio:.75,desc:"3:4"},{value:5,ratio:320/486,desc:"标准屏比例"},{value:6,ratio:320/243,desc:"1/2屏比例"},{value:7,ratio:320/162,desc:"1/3屏比例"},{value:8,ratio:-1,desc:"自定义",lock:!1}]}),s.currentItem=s.cropItems[0],o.cropItemChange=function(e){null==e.lock&&(s.cropItems[7].lock=!1),s.currentItem=e,t.$broadcast("cropItem.change",e)},o.ok=function(){t.$broadcast("cropImage.ok",i)},o.cancel=function(){o.$dismiss(i.properties.src)}}]),angular.module("scene.create.console.input",[]),angular.module("scene.create.console.input").controller("InputConsoleCtrl",["$scope","obj",function(e,t){e.btnIndex=0;var o="输入框";e.buttons=[{id:1,text:o,btnStyle:{backgroundColor:"#fff","text-align":"center",borderWidth:"1",borderStyle:"solid",borderColor:"#08a1ef",color:"#08a1ef"}},{id:2,text:o,btnStyle:{backgroundColor:"#fff","text-align":"center",borderWidth:"1",borderStyle:"solid",borderColor:"#666",color:"#666"}},{id:3,text:o,btnStyle:{backgroundColor:"#fff","text-align":"center",borderWidth:"1",borderStyle:"solid",borderColor:"#f6b223",color:"#f6b223"}},{id:4,text:o,btnStyle:{backgroundColor:"#fff","text-align":"center",borderWidth:"1",borderStyle:"solid",borderColor:"#000",color:"#000"}},{id:5,text:o,btnStyle:{backgroundColor:"#fff","text-align":"center",borderWidth:"1",borderStyle:"solid",borderColor:"#a0d86b",color:"#a0d86b"}},{id:6,text:o,btnStyle:{backgroundColor:"#fff","text-align":"center",borderWidth:"1",borderStyle:"solid",borderColor:"#f66",color:"#f66"}}],e.model={title:t.title,type:t.type,required:t.properties.required,btnStyle:e.buttons[0].btnStyle},e.authError="",angular.forEach(e.buttons,function(o,n){""!==e.model.title&&t.css.borderColor&&t.css.borderColor==o.btnStyle.borderColor&&(e.btnIndex=n)}),e.confirm=function(){return e.model.title&&0!==e.model.title.length?void e.$close(e.model):(e.authError="输入框名称不能为空",void $('input[type="text"]').focus())},e.cancel=function(){e.$dismiss()},e.chooseTabButton=function(t,o){e.model.btnStyle=t.btnStyle,e.btnIndex=o}}]),angular.module("scene.create.console.link").controller("LinkConsoleCtrl",["$scope","obj","sceneService",function(e,t,o){e.url={},e.url.externalLink="http://";var n;e.confirm=function(){"external"==e.url.link?n=e.url.externalLink:"internal"==e.url.link&&(n=e.url.internalLink.id),e.$close(n)},e.cancel=function(){e.$dismiss()},e.removeLink=function(t){"external"==t?e.url.externalLink="http://":"internal"==t&&(e.url.internalLink=e.pageList[0]),e.url.link=""},e.changed=function(){"external"==e.url.link?e.url.internalLink=e.pageList[0]:e.url.externalLink="http://"},e.selectRadio=function(t){e.url.link||("external"==t?e.url.link="external":"internal"==t&&(e.url.link="internal"))},e.getPageNames=function(){var n=t.sceneId;o.getPageNames(n).then(function(o){e.pageList=o.data.list,e.pageList.unshift({id:0,name:"无"}),e.url.internalLink=e.pageList[0],angular.forEach(e.pageList,function(o,n){o.name||(o.name="第"+o.num+"页"),t.properties.url&&t.properties.url==o.id&&(e.url.link="internal",e.url.internalLink=o)}),t.properties.url&&isNaN(t.properties.url)&&(e.url.link="external",e.url.externalLink=decodeURIComponent(t.properties.url.split("=")[2]))})},e.getPageNames()}]),angular.module("scene.create.console.linkComponent",[]),angular.module("scene.create.console.linkComponent").controller("LinkComponentConsoleCtrl",["$scope","obj","$modal","sceneService",function(e,t,o,n){e.btnIndex=0,e.model={title:t.properties.title,imgSrc:t.properties.imgSrc,url:{link:"external",externalLink:"http://"}},t.properties.url&&(angular.isNumber(t.properties.url)?(e.model.url.link="internal",e.model.url.internalLink=t.properties.url):(e.model.url.link="external",e.model.url.externalLink=decodeURIComponent(t.properties.url.split("=")[2]))),e.authError="",e.buttons=[{id:1,text:"点我购买",btnStyle:{width:"80px",backgroundColor:"rgb(250, 188, 61)",height:"30px","text-align":"center","line-height":"30px",color:"rgb(255, 255, 255)"}},{id:2,text:"点开链接",btnStyle:{width:"80px",backgroundColor:"rgb(50, 190, 166)",height:"30px","text-align":"center","line-height":"30px",color:"rgb(255, 255, 255)"}},{id:3,text:"马上购买",btnStyle:{width:"80px",backgroundColor:"rgb(224, 79, 95)",height:"30px","text-align":"center","line-height":"30px",color:"rgb(255, 255, 255)"}},{id:4,text:"关注我们",btnStyle:{width:"80px",height:"30px",backgroundColor:"rgb(37, 183, 211)","text-align":"center","line-height":"30px",color:"rgb(255, 255, 255)"}}],e.openImageModal=function(){o.open({windowClass:"img_console console",templateUrl:BASE_URL+"templates/scene.console.bg.tpl.html",controller:"BgConsoleCtrl",resolve:{obj:function(){return{fileType:1}}}}).result.then(function(o){e.model.title="",e.btnIndex=-1,e.model.btnStyle={width:"115px",height:"115px","line-height":"1",backgroundColor:"transparent"},e.model.imgSrc=t.properties.imgSrc=o.data},function(e){})},angular.forEach(e.buttons,function(o,n){""!==e.model.title&&t.css.backgroundColor&&t.css.backgroundColor==o.btnStyle.backgroundColor&&(e.btnIndex=n)}),e.confirm=function(){return null!=e.model.imgSrc||e.model.title&&0!==e.model.title.length?e.model.url.internalLink||e.model.url.externalLink?("internal"===e.model.url.link?t.properties.url=e.model.url.internalLink:t.properties.url=e.model.url.externalLink,t.properties.title=e.model.title,void e.$close(e.model)):void(e.authError="链接不能为空"):(e.authError="按钮名称不能为空",void $("#buttonName").focus())},e.cancel=function(){e.$dismiss()},e.chooseTabButton=function(o,n){e.model.title=o.text,e.model.btnStyle=o.btnStyle,e.btnIndex=n,e.model.imgSrc=t.properties.imgSrc=null},e.removeLink=function(t){"external"==t?e.model.url.externalLink=null:"internal"==t&&(e.model.url.internalLink=0),e.model.url.link=""},e.changed=function(){"external"==e.model.url.link?e.model.url.internalLink=0:e.model.url.externalLink="http://"},e.selectRadio=function(t){"external"==t?e.model.url.link="external":"internal"==t&&(e.model.url.link="internal"),e.changed()},e.getPageNames=function(){var o=t.sceneId;n.getPageNames(o).then(function(o){e.pageList=o.data.list,e.pageList.unshift({id:0,name:"无"}),angular.forEach(e.pageList,function(e,t){e.name||(e.name="第"+e.num+"页")}),t.properties.url&&angular.isNumber(t.properties.url)&&(e.model.url.link="internal",e.model.url.internalLink=t.properties.url)})},e.getPageNames()}]),angular.module("scene.create.console.pictures1").controller("pictures1Ctrl",["$translate","$rootScope","$scope","$modal","picturesCropService","obj",function(e,t,o,n,i,r){function s(e){c.currentImage={index:e,src:u.children[e].src+"?t="+Date.now()}}function l(e,t){$("<img>").attr("src",PREFIX_FILE_HOST+t).load(function(){$.extend(m.items[e],{coordinate:{x:0,y:0,x2:this.width,y2:this.height,w:this.width,h:this.height,src:t,fileType:1,index:e},realSize:{width:this.width,height:this.height}})})}var c=o.imageOption={title:"图集组件",desc:"通过图片裁切可制作超酷图集",showCrop:!1,showLoading:!1,currentImage:{index:-1,src:""}},a=o.cropOption={showItems:!0,imgSrc:r.properties.src,cropItems:[{value:2,ratio:1,desc:"1:1"},{value:3,ratio:4/3,desc:"4:3"},{value:4,ratio:.75,desc:"3:4"},{value:5,ratio:320/486,desc:"标准屏比例"},{value:6,ratio:320/243,desc:"1/2屏比例"},{value:7,ratio:320/162,desc:"1/3屏比例"},{value:8,ratio:-1,desc:"自定义",lock:!1}]};a.currentItem=a.cropItems[0];var d=o.picStyles=utilPictures.getPicStyle(),p=angular.copy(r),u=o.properties=p.properties;u.autoPlay=null==u.autoPlay||u.autoPlay,u.interval=null==u.interval?2e3:u.interval,u.picStyle=null==u.picStyle?d[0]:utilPictures.getPicStyle(u.picStyle),u.bgColor=null==u.bgColor?"rgba(255,255,255,0)":u.bgColor,u.children=null==u.children?[]:u.children,u.children.length>0&&(c.showCrop=!0,s(0));for(var g=0;6>g;g++)u.children[g]?l(g,u.children[g].src):u.children.push({});var m=i.getCoordinateObj();o.cropItemChange=function(e){null==e.lock&&(a.cropItems[6].lock=!1),a.currentItem=e,t.$broadcast("cropItem.change",e)},o.addPictures=function(e,t,o){e.stopPropagation();var i=0;o?$.each(u.children,function(e,t){t.src&&i++}):i=5,n.open({windowClass:"console img_console",templateUrl:BASE_URL+"templates/scene.console.bg.tpl.html",controller:"BgConsoleCtrl",resolve:{obj:function(){return{fileType:1,type:"p",count:i,elemDef:r}}}}).result.then(function(e){c.showCrop=!0;var n=t,i=0,r=u.children.length;if(o)for(;r>n;){if(!u.children[n++].src){var a=e.selectedImages[i++];u.children[n-1]={src:a.src,desc:"",height:a.height,width:a.width},l(n-1,a.src),s(t)}if(i===e.selectedImages.length)break;n===r&&(n=0)}else{var d=e.selectedImages[0];u.children[t]={src:d.src,desc:"",height:d.height,width:d.width},l(t,d.src),s(t)}})},o.setPicturesSize=function(e){var t,o,n,i=e.children[0],s=i.width/i.height;p.css.width||p.css.height?(t=p.css.width/p.css.height,s>t?(o=p.css.width,n=o/s):(n=p.css.height,o=n*s)):(t=2,s>t?(o=320,n=o/s):(n=160,o=n*s)),r.css.width=o,r.css.height=n},o.delPicture=function(e){u.children[e]={},m.items[e]={},e===c.currentImage.index&&(c.currentImage.index=-1,t.$broadcast("image.delete",e))},o.changePicture=function(e){c.currentImage.index!==e&&s(e)},o.ok=function(){return 0===u.children.length?void(c.desc="请选择图片，最多添加6张"):void(i.getCropping()||(c.showLoading=!0,t.$broadcast("cropImage.ok",u)))},o.cancel=function(){o.$dismiss()},o.$on("crop.complete.all",function(e,t){u.picStyle=u.picStyle.value,$.each(t,function(e,t){u.children[t.index]=t});for(var n=angular.copy(u),i=n.children,r=5;r>=0;r--)i[r].src||i.splice(r,1);o.setPicturesSize(n),o.$close(n)}),o.$on("crop.fail",function(){i.setCropping(!1),c.showLoading=!1})}]),angular.module("scene.create.console.ppt",["angularFileUpload"]),angular.module("scene.create.console.ppt").controller("PptCtrl",["$scope","$stateParams","$http","FileUploader","i18nNotifications","$state","$location",function(e,t,o,n,i,r,s){var l=e.vm={};l.values=[{value:"竖屏导入",way:"0"},{value:"横屏导入",way:"1"}],l.selection=l.values[0];var c=0;l.change=function(e){c=e};var a="index.php?c=upfile&a=upload&bizType=0&fileType=0",d=e.uploader=new n({url:PREFIX_URL+a});d.filters.push({name:"imageFilter",fn:function(e,t){var o="|"+e.type.slice(e.type.lastIndexOf("/")+1)+"|";return"|jpg|png|jpeg|bmp|gif|".indexOf(o)!==-1}}),d.onWhenAddingFileFailed=function(e,t,o){console.info("onWhenAddingFileFailed",e,t,o)},d.onAfterAddingFile=function(e){console.info("onAfterAddingFile",e)},d.onAfterAddingAll=function(e){console.info("onAfterAddingAll",e)},d.onBeforeUploadItem=function(e){console.info("onBeforeUploadItem",e)},d.onProgressItem=function(e,t){console.info("onProgressItem",e,t)},d.onProgressAll=function(e){console.info("onProgressAll",e)},d.onSuccessItem=function(e,t,o,n){console.info("onSuccessItem",e,t,o,n),console.log(t)},d.onErrorItem=function(e,t,o,n){console.info("onErrorItem",e,t,o,n)},d.onCancelItem=function(e,t,o,n){console.info("onCancelItem",e,t,o,n)},d.onCompleteItem=function(e,t,o,n){console.info("onCompleteItem",e,t,o,n)},d.onCompleteAll=function(){console.info("onCompleteAll")},e.submitImages=function(){for(var n=[],s=[],l=0;l<d.queue.length;l++)s[l]=JSON.parse(d.queue[l]._xhr.response),n.push({url:s[l].obj.path});var a={seceneId:t.sceneId,way:c,obj:n},p=PREFIX_URL+"index.php?c=scene&a=pptsave";return o({withCredentials:!0,method:"POST",url:p,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:a}).then(function(t){200==t.data.code&&(i.pushForCurrentRoute("scene.create.console.ppt.success","notify.success"),d.queue.length=0,e.$dismiss(),r.go(r.current,{},{reload:!0,location:!1})),400==t.data.code&&i.pushForCurrentRoute("scene.create.console.ppt.error","notify.warning")})},e.cancel=function(){$("console ppt_console").on("hide.bs.modal",function(e){console.log("123245")}),e.$dismiss()}}]),angular.module("scene.create.console.psd",[]),angular.module("scene.create.console.psd").controller("PsdCtrl",["$scope","$stateParams","$http","FileUploader","i18nNotifications","$state","$location","$timeout","$rootScope","obj","ModalService",function(e,t,o,n,i,r,s,l,c,a,d){e.uploadFile=!1,e.title="z"==a.type?"PSD导入":"视频上传","z"==a.type?e.info="文件最大不能超过40M!":e.info="文件最大不能超过20M! 支持格式：.mp4";var p,u;e.infoChange=function(){u=document.getElementById("xinxi"),p=document.getElementById("file-7").files[0].name,u.innerHTML=p},e.cancel=function(){$("console ppt_console").on("hide.bs.modal",function(e){}),e.$dismiss()},e.submitImages=function(){function o(e){if(e.lengthComputable){var t=Math.round(100*e.loaded/e.total);document.getElementById("progressNumber").innerHTML=t.toString()+"%",document.getElementById("progressStick").style.width=t.toString()+"%";var o=document.getElementById("progressNumber").innerHTML;"100%"==o&&(p.indexOf(".psd")>=0?document.getElementById("jiema").innerHTML="上传成功，解码中，请稍后...":document.getElementById("jiema").innerHTML="保存中...")}else document.getElementById("progressNumber").innerHTML="unable to compute"}function n(t){if(p.indexOf(".psd")>=0){var o=$.parseJSON(t.target.responseText);e.$close(),"z"==a.type&&$("#psd_transformation").css("display","block"),"z"==a.type&&$(".psd_transformation").eq(0).css("display","block");var n=setInterval(function(){$.ajax({type:"GET",url:"index.php?c=Scene&a=psdchange&psdid="+o.obj.psdid,success:function(e){200==e.code&&(clearInterval(n),"z"==a.type&&$("#psd_transformation").css("display","none"),"z"==a.type&&$(".psd_transformation").eq(0).css("display","none"),r.go(r.current,{},{reload:!0,location:!1}))}})},3e3)}else p.indexOf(".mp4")>=0&&d.openActionResultDialog({msg:"上传视频成功！",success:!0,bgStyle:{backgroundColor:"rgba(0,0,0,.3)",position:"fixed",top:0,bottom:"79px",left:"-180px",right:"-180px"}},function(){e.$close()})}function i(e){var t=$.parseJSON(e.target.responseText);alert(t.msg)}function s(e){var t=$.parseJSON(e.target.responseText);alert(t.msg)}if(e.uploadFile=!0,p.indexOf(".psd")<0&&p.indexOf(".mp4")<0)return"z"==a.type?alert("您上传的文件格式不支持，支持格式：.psd"):alert("您上传的文件格式不支持，支持格式：.mp4");var l=document.getElementById("file-7").files[0],c=p.indexOf(".psd")>=0?"index.php?c=scene&a=psd":"index.php?c=upfile&a=upload&bizType=0&fileType=5",u=new FormData;u.append("sceneid",t.sceneId),u.append("pageid",sessionStorage.getItem("pageid")),u.append("file",l),sessionStorage.setItem("pageid","");var g=new XMLHttpRequest;g.upload.addEventListener("progress",o,!1),g.addEventListener("load",n,!1),g.addEventListener("error",i,!1),g.addEventListener("abort",s,!1),
g.open("post",c,!0),g.send(u)}}]),angular.module("scene.create.console.radio.checkbox",[]).controller("RadioCheckboxConsoleCtrl",["$translate","$scope","obj","ModalService",function(e,t,o,n){function i(e){var t=$("#optionGroupContainer"),o=t.find(".option-group").eq(e),n=72,i=o.position().top;i>n&&t.scrollTop(t.scrollTop()+(i-n))}var r=JSON.parse(o.choices);t.model={title:o.title,type:o.type,options:r.options,required:o.properties.required},t.buttons=[{id:1,btnStyle:{backgroundColor:"#08a1ef",height:"30px","line-height":"30px",borderWidth:"1px",borderStyle:"solid",borderColor:"#08a1ef",color:"rgb(255, 255, 255)"},properties:{titleStyle:{backgroundColor:"#08a1ef",color:"#ffffff"},optionStyle:{borderBottomWidth:"1px",borderBottomStyle:"solid",borderBottomColor:"#08a1ef"}}},{id:2,btnStyle:{backgroundColor:"#fff",height:"30px","line-height":"30px",borderWidth:"1px",borderStyle:"solid",borderColor:"#fff",color:"rgb(0, 0, 0)"},properties:{titleStyle:{backgroundColor:"#fff",color:"#000"},optionStyle:{borderBottomWidth:"1px",borderBottomStyle:"solid",borderBottomColor:"#fff"}}},{id:3,btnStyle:{backgroundColor:"#f6b223",height:"30px","line-height":"30px",borderWidth:"1px",borderStyle:"solid",borderColor:"#f6b223",color:"rgb(255, 255, 255)"},properties:{titleStyle:{backgroundColor:"#f6b223",color:"#ffffff"},optionStyle:{borderBottomWidth:"1px",borderBottomStyle:"solid",borderBottomColor:"#f6b223"}}},{id:4,btnStyle:{backgroundColor:"#333",height:"30px","line-height":"30px",borderWidth:"1px",borderStyle:"solid",borderColor:"#333",color:"rgb(255, 255, 255)"},properties:{titleStyle:{backgroundColor:"#333",color:"#ffffff"},optionStyle:{borderBottomWidth:"1px",borderBottomStyle:"solid",borderBottomColor:"#333"}}},{id:5,btnStyle:{backgroundColor:"#a0d86b",height:"30px","line-height":"30px",borderWidth:"1px",borderStyle:"solid",borderColor:"#a0d86b",color:"rgb(255, 255, 255)"},properties:{titleStyle:{backgroundColor:"#a0d86b",color:"#ffffff"},optionStyle:{borderBottomWidth:"1px",borderBottomStyle:"solid",borderBottomColor:"#a0d86b"}}},{id:6,btnStyle:{backgroundColor:"#ff6666",height:"30px","line-height":"30px",borderWidth:"1px",borderStyle:"solid",borderColor:"#ff6666",color:"rgb(255, 255, 255)"},properties:{titleStyle:{backgroundColor:"#ff6666",color:"#ffffff"},optionStyle:{borderBottomWidth:"1px",borderBottomStyle:"solid",borderBottomColor:"#ff6666"}}}],angular.forEach(t.buttons,function(e,n){o.properties.titleStyle&&o.properties.titleStyle.backgroundColor==e.properties.titleStyle.backgroundColor&&(t.btnIndex=n)}),t.chooseTabButton=function(e,n){t.model.btnStyle=e.btnStyle,t.btnIndex=n,$.extend(o.css,{borderStyle:e.btnStyle.borderStyle,borderColor:e.btnStyle.borderColor})},t.authError="",t.addNewOption=function(e){t.model.options.length<8?(++r.seq,t.model.options.splice(e+1,0,{id:r.seq,label:"选项"+r.seq}),setTimeout(function(){i(e)})):n.openMsgDialog({msg:"（您可以添加八个选项，每个选项最多请不要超过41字）",bgStyle:{position:"fixed",top:0,backgroundColor:"rgba(0,0,0,.3)",bottom:"-109px",left:"-121px",right:"-121px"}})},t.deleteTheOption=function(e){t.model.options.length>1&&n.openConfirmDialog({msg:"您确定要删除内容为“"+t.model.options[e].label+"”的选项？<br/>删除选项后，将导致该选项已收集的数据无法正确地显示。",bgStyle:{position:"fixed",top:0,backgroundColor:"rgba(0,0,0,.3)",bottom:"-109px",left:"-121px",right:"-121px"}},function(){t.model.options.splice(e,1)})},t.confirm=function(){return t.model.title&&0!==t.model.title.length?(angular.forEach(t.model.options,function(e){delete e.$$hashKey}),o.choices=JSON.stringify(r),o.properties.required=t.model.required,(t.btnIndex||0===t.btnIndex)&&$.extend(o.properties,t.buttons[t.btnIndex].properties),void t.$close(t.model)):(t.authError="输入框名称不能为空",void $("#radioTitle").focus())},t.cancel=function(){t.$dismiss()}}]),angular.module("scene.create.console.randomevent",["app.directives.responsiveImage"]),angular.module("scene.create.console.randomevent").controller("RandomEventCtrl",["$scope","$modal","obj",function(e,t,o){o.properties.pics.length?e.picList=o.properties.pics:e.picList=[],e.delImage=function(t){e.picList.splice(t,1)},e.replaceImage=function(n){t.open({windowClass:"console img_console",templateUrl:BASE_URL+"templates/scene.console.bg.tpl.html",controller:"BgConsoleCtrl",resolve:{obj:function(){return{fileType:1,type:"n",count:9,elemDef:o}}}}).result.then(function(t){e.picList[n]=t.selectedImages[0]},function(){})},e.choosePic=function(){return e.picList.length>=10?void(e.authError="最多可选择10张图片"):void t.open({windowClass:"console img_console",templateUrl:BASE_URL+"templates/scene.console.bg.tpl.html",controller:"BgConsoleCtrl",resolve:{obj:function(){return{fileType:1,type:"n",count:e.picList.length,elemDef:o}}}}).result.then(function(t){$.each(t.selectedImages,function(t,o){e.picList.unshift(o)})},function(){})},e.confirm=function(){e.$close(e.picList)},e.cancel=function(){e.$dismiss()}}]).factory("randomEventService",["$rootScope",function(e){var t={};return t}]),angular.module("scene.create.console.rating",["common.directives.inputColor"]),angular.module("scene.create.console.rating").controller("RatingConsoleCtrl",["$scope","obj",function(e,t){e.model={title:t.title,properties:{icon:t.properties.icon,size:t.properties.size,color:t.properties.color,required:t.properties.required}},e.authError="",e.confirm=function(){return e.model.title&&0!==e.model.title.length?($.extend(!0,t,e.model),void e.$close(e.model)):(e.authError="标题名称不能为空",void $("#ratingTitle").focus())},e.chooseEqfont=function(t){e.model.properties.icon=t},e.cancel=function(){e.$dismiss()}}]),angular.module("scene.create.console.scene-setting-component").controller("SceneSettingComponentController",["$q","$stateParams","$rootScope","$scope","sceneService","$modal","usercenterService","security","pageTplService","i18nNotifications","ModalService","sceneSettingCache","memberHandler","eqADTypeChoice","staticResService","sceneDataParseService","dataCacheService","fileService","storageService","$location",function(e,t,o,n,i,r,s,l,c,a,d,p,u,g,m,h,f,y,b,S){function v(e,t){switch(e){case g.HIDE:n.eqShowType=T.EQHIDE,n.scene.property.eqAdType=g.HIDE,n.scene.property.hideEqAd=!0;break;case g.DEFAULT_BOTTOM:n.eqShowType=T.EQLINK,n.scene.property.eqAdType=g.DEFAULT_BOTTOM,n.scene.property.hideEqAd=!1;break;case g.CUSTOM_BOTTOM:n.eqShowType=T.EQLINK,n.scene.property.eqAdType=g.CUSTOM_BOTTOM,n.scene.property.hideEqAd=!1;break;default:case g.FREEPAGE:n.eqShowType=T.EQFREE,n.scene.property&&(n.scene.property.eqAdType=g.FREEPAGE,n.scene.property.hideEqAd=!1)}t&&(n.$broadcast("changeView",!1,n.isShowSetting),h.changeBottomType(n.eqShowType,n.scene.property.lastPageId,n.scene.property.bottomLabel,n.scene.property.eqAdType))}function x(e){n.isFormerScene&&n.adSpend==u.getPriceByADType(n.scene.property.eqAdType)&&delete n.scene.property.eqAdType,angular.isObject(n.scene.property)&&(n.scene.property=angular.toJson(n.scene.property)),angular.isString(n.scene.type)&&(n.scene.type=parseInt(n.scene.type,10)),n.scene.loadingLogo===!1&&delete n.scene.loadingLogo,n.$parent.scene.bgAudio&&(angular.isObject(n.$parent.scene.bgAudio)?n.scene.bgAudio=JSON.stringify(n.$parent.scene.bgAudio):n.scene.bgAudio=n.$parent.scene.bgAudio),i.saveSceneSettings(n.scene).then(function(e){200==e.data.code?(a.pushForCurrentRoute("scene.setting.success","notify.success"),n.$parent.sceneSetting.showFlag=!1,n.$parent.sceneSetting.oldBgAudio!=n.scene.bgAudio&&y.saveFilesHistory(JSON.parse(n.scene.bgAudio).id,2).then(function(){f.clear("fileService1")}),n.$parent.sceneSetting.oldBgAudio=n.scene.bgAudio,e.data.obj?angular.copy(e.data.obj,i.getCurrentScene()):angular.copy(n.scene,i.getCurrentScene()),C.resolve(e)):(d.openMsgDialog({msg:e.data.msg},function(){}),angular.isString(n.scene.property)&&(n.scene.property=JSON.parse(n.scene.property)),n.scene.type=""+n.scene.type,C.reject(e))},function(e){n.invalidText=e,C.reject(e)})}n.islongpage=!!t.islongpage,n.isShowSetting=!!("show"==S.search().openSetting||t.islongpage&&S.path().indexOf("openSetting=show")>=0),n.isVipUser=u.isVipUser,n.oriSceneState=!1,n.sceneState=!1;var C=e.defer();n.setPhoneCtrl=function(){var e=n.scene.pageMode;0===e||1==e||2==e||6==e||7==e||8==e||11==e||12==e?n.phonePageMode="NS":n.phonePageMode="EW"};var I=["101","102","103","104","105","106"];n.scene?(n.scene.accessCode?n.sceneStatue=3:n.sceneStatue=n.scene.status,n.appendActive=!!n.scene.promIds,n.loadingLogo=!!n.scene.loadingLogo,-1==I.indexOf(n.scene.type+"")&&(n.scene.type="101"),n.setPhoneCtrl()):n.$watch("sceneId",function(e,t){e!=t&&(n.scene.accessCode?n.sceneStatue=3:n.sceneStatue=n.scene.status,n.loadingLogo=!!n.scene.loadingLogo,n.appendActive=!!n.scene.promIds,-1==I.indexOf(n.scene.type+"")&&(n.scene.type="101"),n.setPhoneCtrl())}),n.$watch("scene",function(e,t){e!=t&&(n.oldScene=JSON.stringify(n.scene))}),n.closeSetting=function(){JSON.stringify(n.scene)!=n.oldScene?d.openConfirmDialog({msg:"设置内容有变化，是否确认修改"},function(){n.saveSceneSettings(n.scene)},function(){n.sceneSetting.showFlag=!1}):n.sceneSetting.showFlag=!1,eqShow.stopSnowFly&&clearInterval(eqShow.stopSnowFly),eqShow.stopFallingObject&&clearInterval(eqShow.stopFallingObject),eqShow.stopFireworkEffect&&eqShow.stopFireworkEffect()},n.sceneSetting.saveSceneSetting=function(){return C=e.defer(),n.saveSceneSettings(n.scene),C.promise},n.isAllowToAccessLastPageSetting=l.isAllowToAccess(l.accessDef.SCENE_HIDE_LASTPAGE_SETTING),n.isAllowedToAccessNewPageFlip=l.isAllowToAccess(l.accessDef.ACCESS_NEW_PAGEFLIP),(2===l.currentUser.type||21===l.currentUser.type)&&u.initUserMemberDetail();var w={SHARE_SCENE:"shareScene",LOADING_LOGO:"loadingLogo",EQSHOW:"eqShow"},T={EQFREE:"eqFree",EQLINK:"eqLink",EQHIDE:"eqHide"};n.eqSceneSettingTabs=w,n.eqSceneSettingCurrent=w.SHARE_SCENE,n.eqShowType=T.EQFREE,n.eqADTypeChoice=g,n.switchToAdState=v,n.adSpend=0,n.isFormerScene=!1,n.nextPage=function(){h.app.nextPage(),o.$broadcast("changeView",!1,n.isShowSetting)},n.prePage=function(){h.app.prePage(),o.$broadcast("changeView",!1,n.isShowSetting)},n.showPhoneTitle=!0,n.changeSceneName=function(){h.changeSceneName(n.scene.name)},n.$on("changeView",function(e,t){n.showPhoneTitle=!t}),n.PREFIX_FILE_HOST=PREFIX_FILE_HOST,n.alwaysOpen=!0,n.changeView=function(){o.$broadcast("changeView",!0,n.isShowSetting)},n.changeTagId=function(){n.$parent.scene.tagId&&(n.scene.tagId=n.$parent.scene.tagId,a.pushForCurrentRoute("already.apply.discovery","notify.success"))},n.changeLoop=function(){o.$broadcast("changeView",!1,n.isShowSetting),h.app.setTriggerLoop(n.scene.property.triggerLoop)},n.changetanmu=function(){o.$broadcast("changeView",!1,n.isShowSetting),h.app.setTriggerLoop(n.scene.property.iftanmu)},n.changePageMode=function(){o.$broadcast("changeView",!1,n.isShowSetting),n.setPhoneCtrl(),h.changeScrollMode(n.scene.pageMode)},n.changeProgess=function(){o.$broadcast("changeView",!1,n.isShowSetting),o.$broadcast("processBar",n.scene.property.slideNumber)},n.changeCode=function(){o.$broadcast("changeView",!1,n.isShowSetting),o.$broadcast("passPanelSwitch",n.scene.isAccessCode)},n.changeLogo=function(){n.loadingLogo=!n.loadingLogo,n.loadingLogo||delete n.scene.loadingLogo,o.$broadcast("showLoading",n.loadingLogo,n.scene.loadingLogo)},n.changeBottomLabel=function(){h.changeBottomType(n.eqShowType,n.scene.property.lastPageId,n.scene.property.bottomLabel,n.scene.property.eqAdType)},n.changeAutoFlip=function(){o.$broadcast("changeView",!1,n.isShowSetting),n.scene.property.autoFlip?h.app.startAutoFlip(n.scene.property.autoFlipTime):h.app.pauseAutoFlip()},n.changeEqshowType=function(){"eqHide"==n.eqShowType&&h.removeLastPage()},n.changeSceneState=function(){return n.oldSceneApplyState.promIds?(1!=n.sceneStatue&&d.openMsgDialog({msg:"该微课已经参与活动，不可以关闭或加密!"}),void(n.sceneStatue=1)):(3==n.sceneStatue?(n.scene.status=1,n.scene.isAccessCode=!0,o.$broadcast("changeView",!1,n.isShowSetting),o.$broadcast("passPanelSwitch",!0)):(n.scene.status=n.sceneStatue,delete n.scene.isAccessCode,delete n.scene.accessCode,o.$broadcast("changeView",!1,n.isShowSetting),o.$broadcast("passPanelSwitch",!1)),void(1!=n.sceneStatue&&(n.scene.isShow=0,n.scene.applyTemplate=0,n.appendActive=!1,n.scene.isTpl=0,n.scene.promIds=null)))},n.$watch("scene.bgAudio",function(e,t){angular.isObject(e)&&angular.isObject(t)?e.url!=t.url&&h.playVideo(e):e!=t&&h.playVideo(e),o.$broadcast("changeView",!1,n.isShowSetting)}),n.openImageModal=function(){o.$broadcast("changeView",!0,n.isShowSetting),r.open({windowClass:"img_console console",templateUrl:BASE_URL+"templates/scene.console.bg.tpl.html",controller:"BgConsoleCtrl",resolve:{obj:function(){return{fileType:1}}}}).result.then(function(e){return e.width/e.height===1?(n.newCoverImage=e,n.newCoverImage.tmbPath=e.data,n.newCoverImage.path=e.data,n.scene.cover=n.newCoverImage.path,void h.changeSceneCover(n.scene.cover)):void r.open({windowClass:"console seven-contain",templateUrl:BASE_URL+"templates/scene.console.imageCrop.tpl.html",controller:"imageCropCtrl",backdrop:"static",resolve:{obj:function(){return{type:"square",properties:{src:e.data},cw:250}}}}).result.then(function(e){var t={width:e.width,height:e.height,data:e.src,type:"imgSrc"};n.newCoverImage=t,n.newCoverImage.tmbPath=t.data,n.newCoverImage.path=t.data,n.scene.cover=n.newCoverImage.path,h.changeSceneCover(n.scene.cover)},function(e){})},function(e){})};var E=null;n.countCharacters=countCharacters,n.saveSceneSettings=function(e){if(n.maxLength30(),!n.scene.name||!n.scene.name.trim())return n.invalidText="noneName",void d.openMsgDialog({msg:"微课标题不能为空！"},function(){});if(n.scene.description||(n.scene.description="微学宝，人人都是微课大师！"),null==n.scene.property.autoFlip){if(n.scene.property.autoFlip=!1,n.scene.property.autoFlip&&!n.scene.property.autoFlipTime)return void(n.invalidText="请选择翻页频率")}else if(n.scene.property.autoFlip&&!n.scene.property.autoFlipTime)return void(n.invalidText="请选择翻页频率");var t=countCharacters(n.scene.name.trim());if(!(t>48)){if("1"===n.scene.isShow&&!n.scene.tagId)return void d.openMsgDialog({msg:"请选择申请微课的微课类型"},function(){$("#tag").focus()});if(n.scene.property&&n.scene.property.eqAdType==g.CUSTOM_BOTTOM&&(!n.scene.property.bottomLabel||!n.scene.property.bottomLabel.id))return void d.openMsgDialog({msg:"请选择您要使用的自定义底标！"},function(){});if(n.scene.property&&n.scene.property.bottomLabel&&n.scene.property.bottomLabel.name&&countCharacters(n.scene.property.bottomLabel.name)>16)return void d.openMsgDialog({msg:"自定义名称不能超过16个字符"},function(){});if(n.scene.property&&n.scene.property.bottomLabel&&!n.scene.property.bottomLabel.name&&n.scene.property.bottomLabel.url&&"http://"!=n.scene.property.bottomLabel.url)return void d.openMsgDialog({msg:"请输入自定义底标名称"},function(){});if(n.scene.accessCode&&("0"!=n.scene.applyPromotion||"0"!=n.scene.applyTemplate))return void d.openMsgDialog({msg:"申请样例、推荐的微课不能同时设置密码，请修改。"});if(3==n.sceneStatue&&(!n.scene.accessCode||4!=n.scene.accessCode.length))return void d.openMsgDialog({msg:"请输入有效的微课密码！"});if(n.scene.promIds&&n.activityPageTpls.length&&!n.scene.property.activityPageId)return void d.openMsgDialog({msg:"请选择活动尾页！"});if(n.oldSceneApplyState.promIds&&n.scene.property.eqAdType!=g.FREEPAGE)return void d.openMsgDialog({msg:"该微课已选择参加活动，不可以清除微学宝尾页，请重新选择！"});if(n.scene.promIds&&(n.scene.property.eqAdType!=g.FREEPAGE||n.scene.property.adSpend))return void d.openMsgDialog({msg:"该微课已选择清除微学宝尾页，不可以参加活动；请复制该微课展示后，再次选择参与活动。"});if(n.appendActive&&!n.scene.promIds)return void d.openMsgDialog({msg:"请选择活动尾页！"});if(n.scene.property&&n.scene.property.autoFlipTime>60)return void d.openMsgDialog({msg:"自动翻页时间不能超过60秒。"});n.scene.property.eqAdType=parseInt(n.scene.property.eqAdType,10);var o=0;0===o?x(e):o&&o>n.userXd?d.openMsgDialog({msg:'当前选择需要消耗微币<font color="#ff6e6e">'+o+'</font>个<br/>微币余额不足(<font color="#ff6e6e">'+(n.userXd||0)+'</font>个)<span class="get-xd"><a href="http://bbs.e.wesambo.com/forum.php?mod=viewthread&tid=297&extra=page%3D1" target = "_blank">获取微币</a></span>'}):o?d.openConfirmDialog({msg:'当前选择需要消耗微币<font color="#ff6e6e">'+o+'</font>个<br/>微币余额为<font color="#ff6e6e">'+(n.userXd||0)+"</font>个"},function(){x(e)}):x(e)}},n.oldSceneApplyState={applyPromotion:"",applyTemplate:"",promIds:""},n.getSceneDetail=function(){i.getCurrentScenePromise().then(function(){n.scene=angular.copy(i.getCurrentScene()),n.scene.price=""+(n.scene.price||"0"),n.oldSceneApplyState.applyPromotion=n.scene.applyPromotion=""+n.scene.applyPromotion,n.oldSceneApplyState.applyTemplate=n.scene.applyTemplate=""+n.scene.applyTemplate,n.scene.isTpl=""+n.scene.isTpl,n.scene.isShow=n.scene.isShow?""+n.scene.isShow:"0",n.oldSceneApplyState.promIds=n.scene.promIds=n.scene.promIds?parseFloat(n.scene.promIds):null,2==n.scene.pageMode&&(n.scene.pageMode=0),n.scene.property?angular.isString(n.scene.property)&&(n.scene.property=JSON.parse(n.scene.property)):n.scene.property={},E=n.scene.loadingLogo||n.scene.property.loadingLogo,n.scene.property.hasOwnProperty("triggerLoop")||(n.scene.property.triggerLoop=!0),n.scene.property.hasOwnProperty("slideNumber")||(n.scene.property.slideNumber=!0),n.scene.property.autoFlipTime||(n.scene.property.autoFlipTime=3),n.adSpend=n.scene.property.adSpend||0,n.isFormerScene=!1,n.scene.property.hideEqAd?(n.adSpend=u.getPriceByADType(g.HIDE),n.scene.property.eqAdType=g.HIDE,n.eqShowType=T.EQHIDE):n.scene.property.eqAdType?v(n.scene.property.eqAdType):n.scene.createTime<14165028e5?(n.isFormerScene=!0,n.adSpend=u.getPriceByADType(g.HIDE),v(g.HIDE)):n.scene.property.isAdvancedUser?n.scene.property.bottomLabel&&n.scene.property.bottomLabel.id?(n.isFormerScene=!0,n.adSpend=u.getPriceByADType(g.CUSTOM_BOTTOM),v(g.CUSTOM_BOTTOM)):(n.isFormerScene=!0,n.adSpend=u.getPriceByADType(g.DEFAULT_BOTTOM),v(g.DEFAULT_BOTTOM)):(n.adSpend=u.getPriceByADType(g.FREEPAGE),v(g.FREEPAGE),n.scene.startDate&&n.scene.endDate&&(n.startDate=new Date(n.scene.startDate),n.endDate=new Date(n.scene.endDate),n.alwaysOpen=!1)),n.scene.type=""+n.scene.type,n.scene.bgAudio&&(n.scene.bgAudio=angular.isString(n.scene.bgAudio)?JSON.parse(n.scene.bgAudio):n.scene.bgAudio);var e=n.$watch("$parent.scene.bgAudio",function(e){n.scene.bgAudio=angular.isString(e)?JSON.parse(e):e});n.$on("$destroy",function(){e()})})},n.types=m.getSceneType(),n.tplPrices=[];var L=p.sceneTplPricesPromise.then(function(e){for(var t=0;t<e.data.list.length;t++)"免费"!=e.data.list[t].name&&-1==e.data.list[t].name.indexOf("微币")&&(e.data.list[t].name+="微币");n.tplPrices=e.data.list||[]}),P=[];n.sceneTags=[];var A=p.sceneTagsPromise.then(function(e){n.sceneTags=P=e.data.list||[]});e.all([L,A]).then(function(){n.getSceneDetail()});var k=n.$watch("scene.type",function(e){e&&(n.sceneTags=[],angular.forEach(P,function(t){e==t.bizType&&n.sceneTags.push(t)}))});n.$on("$destroy",function(){k()}),n.pagemodes=[{id:0,name:"上下翻页"},{id:1,name:"上下惯性翻页"},{id:3,name:"左右惯性翻页"},{id:4,name:"左右翻页"},{id:5,name:"左右连续翻页"},{id:6,name:"立体翻页"},{id:7,name:"卡片翻页"},{id:8,name:"放大翻页"},{id:9,name:"交换翻页"},{id:10,name:"翻书翻页"},{id:11,name:"上下连续翻页"},{id:12,name:"掉落翻页"}];var _=[11,12];if(!n.isAllowedToAccessNewPageFlip)for(var O=0;O<n.pagemodes.length;O++)for(var F=0;F<_.length;F++)n.pagemodes[O].id==_[F]&&(n.pagemodes.splice(O,1),O--);n.userXd=0,n.getUserXd=function(){s.getUserXd().then(function(e){n.userXd=e.data.obj||0})},n.getUserXd(),p.pageTplsPromise.then(function(e){e.data.list&&e.data.list.length>0?n.pageTpls=e.data.list:n.pageTpls=[]}),p.bottomPageTplsPromise.then(function(e){e.data.list&&e.data.list.length>0?n.bottomPageTpls=e.data.list:n.bottomPageTpls=[]}),n.chooseLastPage=function(e){n.scene.property.lastPageId=e,v(g.FREEPAGE,!0)},n.chooseCustomBottomLabel=function(e){n.scene.property.bottomLabel||(n.scene.property.bottomLabel={}),n.scene.property.bottomLabel.id=e,v(g.CUSTOM_BOTTOM,!0)},n.maxLength30=function(){if(n.scene.description&&(n.scene.description=n.scene.description.replace(/\n|\r/g," ")),n.scene.description&&n.scene.description.length>30){var e=n.scene.description.replace(/[^\x00-\xff]/g,"xx");if(e.length>60){var t=e.substring(0,60).replace(/xx/g,"中").length;n.scene.description=n.scene.description.substring(0,t)}}},n.maxLength24=function(){if(n.scene.name&&(n.scene.name=n.scene.name.replace(/\n|\r/g," ")),n.scene.name&&n.scene.name.length>24){var e=n.scene.name.replace(/[^\x00-\xff]/g,"xx");if(e.length>48){var t=e.substring(0,48).replace(/xx/g,"中").length;n.scene.name=n.scene.name.substring(0,t)}}},n.uploadLoadingLogo=function(){r.open({windowClass:"img_console console",templateUrl:BASE_URL+"templates/scene.console.bg.tpl.html",controller:"BgConsoleCtrl",resolve:{obj:function(){return{fileType:1}}}}).result.then(function(e){n.scene.loadingLogo=e.data,o.$broadcast("showLoading",n.scene.loadingLogo,e.data)},function(e){})},n.moreActivities=function(){},n.isLoadingLogoAccessible=l.isAllowToAccess(l.accessDef.LOADING_LOGO),n.isTemplatePaymentAccessible=l.isAllowToAccess(l.accessDef.TEMPLATE_PAYMENT),n.cancelSceneSetting=function(){n.$parent.sceneSetting.showFlag=!1},n.fourNumberPassword=function(){n.scene.accessCode&&(n.scene.accessCode=n.scene.accessCode.replace(/\D/g,""),n.scene.accessCode.length>4&&(n.scene.accessCode=n.scene.accessCode.substr(0,4)))},n.isScenePasswordAccessible=l.isAllowToAccess(l.accessDef.SCENE_PASSWORD),n.activityPageTpls=[],n.selectedActivity=null,n.getActivityPageTpl=function(e){if(n.oldSceneApplyState.promIds&&n.scene.promIds!==n.oldSceneApplyState.promIds)return d.openMsgDialog({msg:"该微课已经参与活动，不可参与其他活动；请复制该微课展示后，再次选择参与活动。"}),void(n.scene.promIds=n.oldSceneApplyState.promIds);if(n.scene.promIds){var t=null;angular.forEach(n.activities,function(e){e.id===n.scene.promIds&&(t=e.sceneId,n.selectedActivity=e)}),t&&c.getPageTpls(t).then(function(t){t.data.list&&t.data.list.length>0?(n.activityPageTpls=t.data.list,n.scene.property.activityPageId&&!e||(n.activityPageTpls.length?(n.scene.property.activityPageId=n.activityPageTpls[0].id,n.chooseActivityPageTpl(n.scene.property.activityPageId)):n.scene.property.activityPageId=null)):n.activityPageTpls=[]})}else n.activityPageTpls=[],n.scene.property.activityPageId=null},n.chooseActivityPageTpl=function(e){n.scene.property.activityPageId=e,h.replaceActivePage(e)}}]).value("eqADTypeChoice",{HIDE:0,FREEPAGE:1,DEFAULT_BOTTOM:2,CUSTOM_BOTTOM:3}),angular.module("scene.create.console.shape").controller("ShapeConsoleCtrl",["$scope","shapeService",function(e,t){e.getShapeByPage=function(e,o){t.getShapeByPage(e,o)};var o=t.svgList;e.currentPage=1,e.totalItems=o.length;var n=e.pageSize=21;e.$watch("currentPage",function(t){e.toPage=t,e.getShapeByPage(t,n)}),e.confirm=function(){e.$close({type:"rect"})},e.pageChanged=function(t){return 1>t||t>e.totalItems/18+1?void alert("此页超出范围"):void(e.currentPage=t)},e.cancel=function(){e.$dismiss()},e.selectSvg=function(o){var n=t.shapeList[o].type,i=t.shapeList[o].viewBox;e.$close({type:n,viewBox:i})}}]),angular.module("scene.create.console.sound").controller("soundCtrl",["$rootScope","$scope","$translate","soundService","ModalService","obj","uploaderService","$modal","fileService","dataCacheService","$stateParams",function(e,t,o,n,i,s,l,c,a,d,p){t.myValue_spd=5,t.myValue_pit=5,t.myValue_vol=5,t.soundUploadCode=function(){var e=document.location.href,o=e.indexOf("?"),n=e.substring(38,o);$("#codeKuang").css("background",'url("/assets/images/re-design/bg_mc_code.png") no-repeat'),$.ajax({type:"GET",url:"http://"+window.location.host+"/index.php?c=scene&a=detail&id="+n,success:function(e){$("#codeSound").qrcode({text:"http://"+window.location.host+"/index.php?c=Mobile&token="+e.token+"&type=2",width:125,height:125})}}),sessionStorage.setItem("mySounds",""),document.getElementById("codeUpload").style.display="block",document.getElementById("codeKuang").style.display="block",$("#codeSound").css("display","inline-block"),$("#codePic").css("display","none"),$("#soundCode").css("display","block"),$("#picCode").css("display","none"),window.cc=setInterval(function(){$.ajax({type:"GET",url:"http://"+window.location.host+"/index.php?c=Scene&a=mobfile&type=2",success:function(e){"200"==e.code?(console.log("success"),a.getFileByCategory(1,10,"0","2").then(function(e){t.sounds=e.data.list,t.sound=e.data.list,clearInterval(window.cc)}),document.getElementById("codeUpload").style.display="none",document.getElementById("codeKuang").style.display="none",document.getElementById("codeSound").children[0].remove()):"400"==e.code&&console.log("false")}})},5e3)};var u=t.sounds=[],g=t.type=s.type;t.selectSoundError="",t.uploader=l.uploader(s.type,11194304);var m=t.pageSize=10,h=1;t.actionContent=!1,t.pagination={},t.sound={},t.soundLink={src:""};var f=!1;window.localStorage?(f=2==g?localStorage.getItem("musicTag"):localStorage.getItem("soundTag"),"true"==f?t.isMySound=!0:"false"!=f&&f?t.isMySound="history":t.isMySound=!1):t.isMySound=!1,t.alertAction=!0,t.soundAction=!1,t.popSoundAction=function(){t.soundAction=!0},t.closeAction=function(){t.soundAction=!1,y.indexOf(e.user.id)>-1&&(t.alertAction=!1)},t.actionShow=!1;var y=[];if(window.localStorage){var b=localStorage.getItem("setSoundAction");b&&(y=b.split(","),y.indexOf(e.user.id)>-1&&(t.alertAction=!1))}if(t.isCheckbox=function(t){t&&(y.push(e.user.id),localStorage.setItem("setSoundAction",y.join(",")))},4==g&&s.elemDef.sound&&s.elemDef.sound.src&&(t.sound=s.elemDef.sound),2==g&&s.elemDef.bgAudio)if("string"==typeof s.elemDef.bgAudio){var S=JSON.parse(s.elemDef.bgAudio);t.sound=S,S&&S.src&&(t.sound.url=S.src)}else t.sound=s.elemDef.bgAudio,s.elemDef.bgAudio.src&&(t.sound.url=s.elemDef.bgAudio.src);t.$on("uploadfiles.add",function(e){2==t.type?d.clear("mySounds"):d.clear("fileService1"),t.selectTab(!0)}),t.$on("thumbnailList.update",function(e,o){for(var n,i=0;i<t.uploader.queue.length;i++)if(100==t.uploader.queue[i].progress){t.uploader.queue.splice(i,1),n=o,u.unshift(n);for(var r=0;10>r;r++)0===u[i].size?u[i].size=null:u[i].size>0&&u[i].size<1024?u[i].size=u[i].size+" KB":u[i].size>=1024&&(u[i].size=(u[i].size/1024).toPrecision(2)+" MB")}u.length>0&&(t.actionContent=!1),2==t.type?d.clear("mySounds"):d.clear("fileService1")}),t.getSounds=function(e){t.toPage=e,4==g?t.isMySound?n.getMySounds(e):t.getSysMusicList(t.sysCatId,e):2==g&&(t.isMySound?n.getMyAudios(e):t.getSysMusicList(t.sysCatId,e))},t.getSoundsTo=function(e){searchVal=document.getElementById("search-value").value,t.toPage=e,4==g?t.isMySound?n.getMySounds(e):t.getSysMusicList(t.sysCatId,e):2==g&&(t.isMySound?n.getMyAudios(e):t.getSysMusicList(t.sysCatId,e))},window.enterSearchSound=function(e){var o=event||window.event||arguments.callee.caller.arguments[0];o&&13==o.keyCode&&(searchVal=document.getElementById("search-value").value,t.toPage=e,4==g?t.isMySound?n.getMySounds(e):t.getSysMusicList(t.sysCatId,e):2==g&&(t.isMySound?n.getMyAudios(e):t.getSysMusicList(t.sysCatId,e)))},t.sysCate=!t.isMySound,t.selectTab=function(e){window.localStorage&&(2==t.type?localStorage.setItem("musicTag",e):localStorage.setItem("soundTag",e)),e?t.sysCate=!1:t.sysCate=!0,t.isMySound=e,"history"==e?t.getHistory():t.getSounds(1)},t.setPageMusic=function(e,o,n){if(t.selectSound(e,o,n),music&&h){var r=PREFIX_URL+"index.php?c=scene&a=bg_music";music.num=parseInt(h),music.sceneId=parseInt(sceneId),$.ajax(r,{type:"post",data:JSON.stringify(music),headers:{"Content-Type":"text/plain; charset=UTF-8"},success:function(e){i.openActionResultDialog({msg:"设置成功！",success:!0,bgStyle:{backgroundColor:"rgba(0,0,0,.3)",position:"fixed",top:0,bottom:"-150px",left:"-180px",right:"-180px"}},function(){t.$dismiss()})}})}else i.openMsgDialog({msg:"当前未选择任何音乐！",btn:"确定",bgStyle:{backgroundColor:"rgba(0,0,0,.3)",position:"fixed",top:0,bottom:"-150px",left:"-180px",right:"-180px"}})},t.getHistory=function(){a.getFilesHistory(2).then(function(o){o.data.success&&e.$broadcast("sounds.update",o.data,g,t.type)})},t.openConvert=function(){t.track="女",t.trackId=0,$("#convert").modal({show:!0}),$("body *:last").hide(),$("#convertMusic").attr("src")||""==$("#convertMusic").attr("src")||(new_obj=$("<audio id='convertMusic' src='' autoplay>"),$(".container").append(new_obj))},setTimeout(t.openConvert,0),t.playConvertSound=function(){var e=$(event.target).closest(".sound-flex").find('input:radio[name="aaa"]:checked');console.log(e.val());var t=$("#convertVal").val(),o=$(event.target).closest(".sound-flex").find(".voice_spd_num").eq(0).val();console.log(o);var n=$(event.target).closest(".sound-flex").find(".voice_pit_num").eq(0).val();console.log(n);var i=$(event.target).closest(".sound-flex").find(".voice_vol_num").eq(0).val();console.log(i);var r=PREFIX_URL+"index.php?c=Text2audio&a=getaudio&text="+t+"&per="+e.val()+"&spd="+o+"&pit="+n+"&vol="+i;$("#convertMusic").attr("src",r)},t.downloadSound=function(){var e=$(event.target).closest(".sound-flex").find('input:radio[name="aaa"]:checked'),t=$("#convertVal").val(),o=$(event.target).closest(".sound-flex").find(".voice_spd_num").eq(0).val(),n=$(event.target).closest(".sound-flex").find(".voice_pit_num").eq(0).val(),i=$(event.target).closest(".sound-flex").find(".voice_vol_num").eq(0).val(),r=PREFIX_URL+"index.php?c=Text2audio&a=downaudio&text="+t+"&per="+e.val()+"&spd="+o+"&pit="+n+"&vol="+i;window.open(r)},t.setConvertSound=function(){var e=$(event.target).parent().parent().parent().parent().parent().parent().parent().find('input:radio[name="aaa"]:checked'),o=$("#convertVal").val(),n=$(event.target).closest(".sound-flex").find(".voice_spd_num").eq(0).val(),r=$(event.target).closest(".sound-flex").find(".voice_pit_num").eq(0).val(),s=$(event.target).closest(".sound-flex").find(".voice_vol_num").eq(0).val(),l=window.location.href.split("=")[1],c=(window.location.href.split("?")[0],p.sceneId),a={};if(""!=o&&l){var d=PREFIX_URL+"index.php?c=Text2audio&a=bacurl&text="+o+"&per="+e.val()+"&spd="+n+"&pit="+r+"&vol="+s;$.ajax(d,{type:"get",success:function(e){a.num=parseInt(l),a.url=JSON.parse(e).url,a.sceneId=parseInt(c);var o=PREFIX_URL+"index.php?c=scene&a=bg_music";$.ajax(o,{type:"post",data:JSON.stringify(a),headers:{"Content-Type":"text/plain; charset=UTF-8"},success:function(e){i.openActionResultDialog({msg:"设置当前页音乐成功！",btn:"确定",success:!0,bgStyle:{position:"fixed",top:"0px",bottom:"-15px",left:"0px",right:"0px",backgroundColor:"rgba(0, 0, 0, 0.298039)"}},function(){t.$dismiss()})}})}})}else i.openActionResultDialog({msg:"设置当前页音乐失败！",btn:"确定",success:!1,bgStyle:{position:"fixed",top:"0px",bottom:"-15px",left:"0px",right:"0px",backgroundColor:"rgba(0, 0, 0, 0.298039)"}})},t.changeTrack=function(){"女"==t.track?t.track="男":t.track="女",0==t.trackId?t.trackId=1:t.trackId=0},$("body").on("mousedown",".voice_spd",function(e){var t=e.offsetX,o=Math.ceil(t/447*9),n=11.1111111111111*o+"%";$(this).children(".voice_spd_green").eq(0).animate({width:n});$(this).parent().parent().find(".voice_spd_num").eq(0).val(o)}),$("body").on("mousedown",".voice_pit",function(e){var t=e.offsetX,o=Math.ceil(t/447*9),n=11.1111111111111*o+"%";$(this).children(".voice_pit_green").eq(0).animate({width:n});$(this).parent().parent().find(".voice_pit_num").eq(0).val(o)}),$("body").on("mousedown",".voice_vol",function(e){var t=e.offsetX,o=Math.ceil(t/447*9),n=11.1111111111111*o+"%";$(this).children(".voice_vol_green").eq(0).animate({width:n});$(this).parent().parent().find(".voice_vol_num").eq(0).val(o)}),t.soundSpd=function(e){var t=$(".voice_spd_num").eq(0).val(),o=t%1;if(0!=o||t>9)$(".voice_spd_num").eq(0).val(9),$(".voice_spd_green").eq(0).animate({width:"100%"},100);else{if(""==t)return;var n=11.1111111111111*t+"%";$(".voice_spd_green").eq(0).animate({width:n},100)}},t.soundPit=function(e){var t=$(".voice_pit_num").eq(0).val(),o=t%1;if(0!=o||t>9)$(".voice_pit_num").eq(0).val(9),$(".voice_pit_green").eq(0).animate({width:"100%"},100);else{if(""==t)return;var n=11.1111111111111*t+"%";$(".voice_pit_green").eq(0).animate({width:n},100)}},t.soundVol=function(e){var t=$(".voice_vol_num").eq(0).val(),o=t%1;if(0!=o||t>9)$(".voice_vol_num").eq(0).val(9),$(".voice_vol_green").eq(0).animate({width:"100%"},100);else{if(""==t)return;var n=11.1111111111111*t+"%";$(".voice_vol_green").eq(0).animate({width:n},100)}},t.clearCurrentMusic=function(){i.openConfirmDialog({
msg:"确定清空当前页面音乐吗？",btn:"确定",btn:"取消",bgStyle:{position:"fixed",left:"-180px",top:0,right:"-180px",bottom:"-153px",backgroundColor:"rgba(0,0,0,.3)"}},function(){var e=window.location.href.split("=")[1],t=(window.location.href.split("?")[0],p.sceneId),o={},n=PREFIX_URL+"index.php?c=scene&a=bg_music";o.num=parseInt(e),o.sceneId=parseInt(t),o.url="",o.type="del",$.ajax(n,{type:"post",data:JSON.stringify(o),headers:{"Content-Type":"text/plain; charset=UTF-8"},success:function(e){i.openActionResultDialog({msg:"清除成功",success:!0,bgStyle:{backgroundColor:"rgba(0,0,0,.3)",position:"fixed",top:0,bottom:"-153px",left:"-180px",right:"-180px"}})}})},function(){})},t.urlLink=function(){c.open({windowClass:"console six-contain",templateUrl:BASE_URL+"templates/scene.console.soundLink.tpl.html",controller:"SoundLinkCtrl",resolve:{obj:function(){return s.type}}}).result.then(function(){t.isMySound=!0,t.selectTab(!0)},function(){})},t.isSoundSelected=function(e,t,o){return!(!t||void 0!=t.length)&&(2===e?t.id?t.id==o.id:t.url==o.url:4===e?t.id?t.id==o.id:t.src==o.src:void 0)},t.selectSound=function(e,o,n){music=e,h=window.location.href.split("=")[1];var i=window.location.href.split("?")[0];sceneId=i.substring(i.length-7),e&&e.url&&"/"==e.url.substr(0,1)&&(e.url=e.url.substr(1,e.url.length)),n?t.sound={}:t.sound=e},t.clearSearchVal=function(){searchVal="",document.getElementById("search-value").value=""},t.playSound=function(t,o){t.stopPropagation(),e.$broadcast("sound.play",u[o])},t.deleteMySound=function(e,o){e.stopPropagation(),i.openConfirmDialog({msg:"确定删除此音乐吗？"},function(){2==t.type?d.clear("mySounds"):d.clear("fileService1"),n.deleteMySound(u[o].id)})},t.clear=function(){music=null,t.sound={}},t.ok=function(e,o,n){t.selectSound(e,o,n),t.sound&&void 0==t.sound.url&&(t.sound.url=t.sound.path,console.log(t.sound.url)),t.sound&&t.sound.url&&"/"==t.sound.url.substr(0,1)&&(t.sound.url=t.sound.url.substr(1,t.sound.url.length));var i,s=t.sound;4==g&&(i=s&&s.src?{name:s.name,src:s.src,id:s.id}:{},t.$close(i)),2==g&&(r=s.url?{url:s.url,name:s.name,id:s.id}:{},t.$close(r))},t.cancel=function(){t.$dismiss()},t.$on("sounds.update",function(e,o,n){if(u.length=0,o.list.length>0){t.actionContent=!1,$.each(o.list,function(e,t){0===t.path.indexOf("http://")&&(t.isValue=!0),t.size<1024&&t.size>0?t.size=t.size+" KB":t.size>=1024?t.size=(t.size/1024).toPrecision(2)+" MB":0===t.size&&(t.size=null),4==n?u.push({id:t.id,name:t.name,src:t.path,isPlaying:!1,size:t.size,isValue:t.isValue}):2==n&&u.push({id:t.id,name:t.name,url:t.path,isPlaying:!1,size:t.size,isValue:t.isValue})});var i=o.map;i&&(t.pagination={totalItems:i.count,pageSize:i.pageSize,currentPage:i.pageNo,numPages:Math.ceil(i.count/i.pageSize)})}else t.pagination.totalItems=0,t.actionContent=!0}),t.$on("mySounds.delete",function(e,o){o===t.sound.id&&(t.sound={}),2==g?n.getMyAudios(t.pagination.currentPage):4==g&&n.getMySounds(t.pagination.currentPage)}),t.getSysMusicCategory=function(e){a.getSysMusicCategory(e)},t.$on("sysMusic.update",function(e){t.sysMusicList=a.sysMusicList}),t.getSysMusicCategory(g),t.getSysMusicList=function(e,o){t.sysCatId=e,n.getSysMusicList(o,m,g,e)},"history"==t.isMySound?t.getHistory():t.isMySound?4==g?n.getMySounds(h):n.getMyAudios(h):t.getSysMusicList(0,h)}]),angular.module("scene.create.console.soundComponent",["app.directives.addelement"]),angular.module("scene.create.console.soundComponent").controller("SoundComponentConsoleCtrl",["$scope","obj","$modal",function(e,t,o){e.model={title:t.properties.title,imgSrc:t.properties.imgSrc,sound:t.sound},e.authError="",e.buttons=[{id:1,text:"有惊喜",btnStyle:{width:"100px",backgroundColor:"rgb(244, 113, 31)",height:"30px","text-align":"center","line-height":"30px",color:"rgb(255, 255, 255)"}},{id:2,text:"听一听",btnStyle:{width:"100px",backgroundColor:"rgb(253, 175, 7)",height:"30px","text-align":"center","line-height":"30px",color:"rgb(255, 255, 255)"}},{id:3,text:"点我听歌",btnStyle:{width:"100px",backgroundColor:"rgb(121, 196, 80)",height:"30px","text-align":"center","line-height":"30px",color:"rgb(255, 255, 255)"}},{id:4,text:"点播歌曲",btnStyle:{width:"100px",height:"30px",backgroundColor:"#fff","text-align":"center",border:"1px solid #3FB816","line-height":"30px",color:"rgb(0, 0, 0)"}}],e.openImageModal=function(){o.open({windowClass:"img_console console",templateUrl:BASE_URL+"templates/scene.console.bg.tpl.html",controller:"BgConsoleCtrl",resolve:{obj:function(){return{fileType:1}}}}).result.then(function(o){e.model.title="",e.btnIndex=-1,e.model.btnStyle={width:"115px",height:"115px","line-height":"1",backgroundColor:"transparent"},e.model.imgSrc=t.properties.imgSrc=o.data},function(e){})},angular.forEach(e.buttons,function(o,n){""!==e.model.title&&t.css.backgroundColor&&t.css.backgroundColor==o.btnStyle.backgroundColor&&(e.btnIndex=n)}),e.confirm=function(){return null!=e.model.imgSrc||e.model.title&&0!==e.model.title.length?!e.model.sound||$.isEmptyObject(e.model.sound)?void(e.authError="您还没有选择音效"):(t.sound=e.model.sound,t.properties.title=e.model.title,void e.$close(e.model)):(e.authError="按钮名称不能为空",void $('.form-list input[type="text"].btn-name').focus())},e.openSoundModal=function(){o.open({windowClass:"console img_console",templateUrl:BASE_URL+"templates/scene.console.sound.tpl.html",controller:"soundCtrl",resolve:{obj:function(){return{elemDef:t,type:4}}}}).result.then(function(t){e.model.sound=t},function(){})},e.cancel=function(){e.$dismiss()},e.chooseTabButton=function(o,n){e.model.title=o.text,e.model.btnStyle=o.btnStyle,e.btnIndex=n,e.model.imgSrc=t.properties.imgSrc=null}}]),angular.module("scene.create.console.statistics",[]),angular.module("scene.create.console.statistics").controller("StatisticsConsoleCtrl",["$scope","obj",function(e,t){e.model={title:t.title,properties:{layout:t.properties.layout,size:t.properties.size,color:t.properties.color,icon:t.properties.icon,imgSrc:t.properties.imgSrc}},e.authError="",e.confirm=function(){angular.extend(t,e.model);var o=parseInt(t.css.height,10)||0;e.model.properties.imgSrc&&115>o&&(e.model.btnStyle={width:"320px",height:"115px",lineHeight:"115px",backgroundColor:"transparent"}),"counter-lr"===e.model.properties.layout&&(!e.model.properties.imgSrc&&80>o&&(e.model.btnStyle={height:"40px",lineHeight:"40px",width:"80px"}),e.model.properties.imgSrc&&155>o&&(e.model.btnStyle=e.model.btnStyle||{},e.model.btnStyle.height=e.model.btnStyle.lineHeight="155px")),e.$close(e.model)},e.cancel=function(){e.$dismiss()},e.chooseEqfont=function(t){e.model.properties.icon=t,e.model.properties.imgSrc=null}}]),angular.module("scenobj.creatobj.consolobj.tel",["app.directives.addelement"]),angular.module("scenobj.creatobj.consolobj.tel").controller("TelConsoleCtrl",["$scope","obj","$modal",function(e,t,o){e.btnIndex=0,e.model={title:t.properties.title,number:t.properties.number,imgSrc:t.properties.imgSrc},e.authError="",e.buttons=[{id:1,text:"一键拨号",btnStyle:{width:"80px",backgroundColor:"rgb(250, 188, 61)",height:"30px","text-align":"center","line-height":"30px",color:"rgb(255, 255, 255)"}},{id:2,text:"热线电话",btnStyle:{width:"80px",backgroundColor:"rgb(50, 190, 166)",height:"30px","text-align":"center","line-height":"30px",color:"rgb(255, 255, 255)"}},{id:3,text:"拨打电话",btnStyle:{width:"80px",backgroundColor:"rgb(224, 79, 95)",height:"30px","text-align":"center","line-height":"30px",color:"rgb(255, 255, 255)"}},{id:4,text:"一键拨号",btnStyle:{width:"80px",height:"30px",backgroundColor:"rgb(37, 183, 211)","text-align":"center","line-height":"30px",color:"rgb(255, 255, 255)"}}],e.openImageModal=function(){o.open({windowClass:"img_console console",templateUrl:BASE_URL+"templates/scene.console.bg.tpl.html",controller:"BgConsoleCtrl",resolve:{obj:function(){return{fileType:1}}}}).result.then(function(o){e.model.title="",e.btnIndex=-1,e.model.btnStyle={width:"115px",height:"115px","line-height":"1",backgroundColor:"transparent"},e.model.imgSrc=t.properties.imgSrc=o.data},function(e){})},angular.forEach(e.buttons,function(o,n){""!==e.model.title&&t.css.backgroundColor&&t.css.backgroundColor==o.btnStyle.backgroundColor&&(e.btnIndex=n)}),e.confirm=function(){return null!=e.model.imgSrc||e.model.title&&0!==e.model.title.length?e.model.number&&0!==e.model.title.number?void e.$close(e.model):(e.authError="电话号码不能为空",void $('.form-list input[type="text"].tel-button').focus()):(e.authError="按钮名称不能为空",void $('.form-list input[type="text"].btn-name').focus())},e.cancel=function(){e.$dismiss()},e.chooseTabButton=function(o,n){e.model.title=o.text,e.model.btnStyle=o.btnStyle,e.btnIndex=n,e.model.imgSrc=t.properties.imgSrc=null}}]),angular.module("scene.create.console.video",[]),angular.module("scene.create.console.video").controller("VideoCtrl",["$scope","$translate","obj","$modal","$state","$location","fileService","ModalService","dataCacheService","$rootScope",function(e,t,o,n,i,r,s,l,c,a){function d(e){var t=e.substring(e.indexOf("src=")+4),o=t.substring(t.indexOf("://")+3),n=o.substring(0,o.indexOf("/"));return n.indexOf("v.qq")>=0||n.indexOf("tudou")>=0||n.indexOf("youku")>=0}function p(t){e.cancelSelect(),s.getMyvideo(t,12).success(function(t){e.videoList=t.list;var o=t.map;o&&(e.pagination={totalItems:o.count,pageSize:o.pageSize,currentPage:o.pageNo,numPages:Math.ceil(o.count/o.pageSize)}),e.currentPage=o.pageNo})}var u=[];e.common=!0,e.mine=!1,e.pagination={},e.currentPage=1,e.toPage=1,e.videoList={},e.model||(e.model={}),e.authError="",e.model.src=o.properties.src,e.manageObj={selected:!1,selectedObj:[]},e.changeCommon=function(){e.common=!0,e.mine=!1},e.changeMine=function(){e.common=!1,e.mine=!0,p(e.currentPage)},e.getvideos=function(t){return e.currentPage=parseInt(t),1>t||t>e.pagination.numPages?void alert("请输入有效页码"):p(e.currentPage)},e.$watch("currentPage",function(t,o){e.toPage=t}),e.doUpload=function(){return 1===parseInt(a.user.type)?window.confirm("您好！该功能目前只向企业用户开放，点击确定申请成为企业用户")?window.open("https://wetool.im/f/0viuuz"):void 0:void n.open({windowClass:"video_upload_console console",templateUrl:BASE_URL+"templates/scene.console.psd.tpl.html",controller:"PsdCtrl",resolve:{obj:function(){return{type:"v"}}}}).result.then(function(t){p(e.currentPage)},function(e){})},e.setVideos=function(t){var o={src:t.path,type:"v2"};e.$close(o)},e.manage=function(){e.manageObj.manageAll=!0},e.cancelSelect=function(){for(var t=0;t<u.length;t++)e.manageObj.selectedObj[u[t]].selected=!1;u=[],e.manageObj.selected=!1,e.manageObj.selectedObj=[]},e.deleteFile=function(t){if(t&&e.selVideo(t),0==u.length)return void(e.authError="请选择要删除的视频");var o=u.join(",");l.openConfirmDialog({msg:"确定删除所选的视频?"},function(){c.clear("fileService"),s.deleteFile(o)})},e.$on("files.delete",function(){p(e.currentPage)}),e.selVideo=function(t){e.manageObj.selectedObj[t.id]=t,e.manageObj.selectedObj[t.id].selected=!e.manageObj.selectedObj[t.id].selected,e.manageObj.selectedObj[t.id].selected?u.push(t.id):u.splice(jQuery.inArray(t.id,u),1),u.length>0?e.manageObj.selected=!0:e.manageObj.selected=!1},e.confirm=function(){if(!e.model.src&&e.common)return $("textarea").focus(),void(e.authError="请输入视频地址");var t=d(e.model.src),o={src:e.model.src,type:"v1"};return t?void e.$close(o):($("textarea").addClass("error"),$("textarea").change(function(){$(this).removeClass("error")}),e.common?void(e.authError="暂不支持添加此视频！"):void(e.authError="请选择视频！"))},e.cancel=function(){e.$dismiss()}}]),angular.module("scene.create.pageTpl",[]),angular.module("scene.create.pageTpl").controller("PageTplController",["$scope","pageTplService",function(e,t){e.$watch("tpl",function(t){if(e.tplElements=[],t&&t.obj&&t.obj.elements){var o=angular.copy(t.obj.elements);$.each(o,function(t,o){"4"==o.type&&(o.isEditable||(o.isEditable=1),e.tplElements.push(o))})}},!0),e.pageChildLabel=function(){var o,n=[];for(o=0;o<e.pageLabelAll.length;o++)e.pageLabelAll[o].ischecked&&n.push(e.pageLabelAll[o].id);e.tpl.obj.elements&&$.each(e.tplElements,function(t,o){$.each(e.tpl.obj.elements,function(e,t){o.id==t.id&&(-1==o.isEditable?t.isEditable=-1:delete t.isEditable)})}),t.updataChildLabel(n,e.pageIdTag).then(function(){alert("分配成功！"),e.controlView.pageList=!1},function(){})}}]),angular.module("create.userGuide",[]).controller("CreateUserGuideCtrl",["$rootScope","$scope",function(e,t){if(window.localStorage){var o=JSON.parse(localStorage.getItem("createUserGuide"));o&&o[e.user.id]?t.firstLogin=!1:(t.firstLogin=!0,o=o||{},o[e.user.id]=1,localStorage.setItem("createUserGuide",JSON.stringify(o)))}t.myInterval=-1,t.userGuideSlides=[{image:CLIENT_CDN+"assets/images/scene/user-guide1.png"},{image:CLIENT_CDN+"assets/images/scene/user-guide2.png"},{image:CLIENT_CDN+"assets/images/scene/user-guide3.png"},{image:CLIENT_CDN+"assets/images/scene/user-guide4.png"},{image:CLIENT_CDN+"assets/images/scene/user-guide5.png"},{image:CLIENT_CDN+"assets/images/scene/user-guide6.png"}],t.close=function(){t.firstLogin=!1},t.currentIndex=0;var n=t.$watch("userGuideSlides",function(){angular.forEach(t.userGuideSlides,function(e,o){e.active&&(t.currentIndex=o)})},!0);t.$on("$destroy",n)}]),angular.module("scene.create.longpage.preview",[]).controller("longPagePreview",["$scope","obj",function(e,t){e.host=t.scene.code,e.height=parseInt(1.5*t.height+100),e.url=PREFIX_URL+"v-"+e.host,e.close=function(){e.$close()};new Promise(function(t,o){window.setTimeout(function(){$("#codeImg").qrcode({text:PREFIX_URL+"v-"+e.host,width:100,height:100})},1e3*Math.random())})}]);