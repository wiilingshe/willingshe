angular.module("usercenter.apply",["services.usercenter","services.i18nNotifications"]),angular.module("usercenter.apply").controller("ApplyCtrl",["$rootScope","$scope","usercenterService","$modal","ModalService","i18nNotifications","MineService","userinfo","$translate","$timeout",function(e,r,t,c,n,o,a,s,l,d){function u(){0===q?(r.isCodeAccessiable=!1,r.codeTip="获取验证码",q=60):(r.isCodeAccessiable=!0,r.codeTip="重新发送("+q+")",d(function(){q--,u()},1e3))}r.applyInfo={},r.applyInfo.nick=s.nick,r.invoiceStat=s.invoice,r.actionerror="",r.serverLabel=[],r.cateLabel=[],r.payLabel=[];var h;r.applyXiuke=!0,r.title=s.title,0===s.status||3===s.status?(h=0,r.applyXiuke=!0):(h=1,r.applyXiuke=!1);var p=function(e){t.getAPPlyMessage(e).then(function(t){switch(e){case"province":r.serverLabel=t.data.list,t.data.list.length>0&&(r.moreArea=!0);break;case"company_industry":r.cateLabel=t.data.list,t.data.list.length>0&&(r.moreLabel=!0);break;case"payType":r.payLabel=t.data.list}})};p("province"),p("company_industry"),p("payType"),r.cancel=function(){r.$dismiss()},r.cate_cancel=function(e){for(var t=0;t<r.cateLabel.length;t++)if(r.cateLabel[t].ischecked=!1,r.cateSelected.length>0)for(var c=0;c<r.cateSelected.length;c++)r.cateLabel[t].id===r.cateSelected[c].id&&(r.cateLabel[t].ischecked=!0);r.cateError="",setTimeout(function(){$(e.target).parents(".dropdown.open").trigger("click")})},r.server_cancel=function(e){for(i=0;i<r.serverLabel.length;i++)if(r.serverLabel[i].ischecked=!1,r.serverSelected.length>0)for(k=0;k<r.serverSelected.length;k++)r.serverLabel[i].id===r.serverSelected[k].id&&(r.serverLabel[i].ischecked=!0);setTimeout(function(){$(e.target).parents(".dropdown.open").trigger("click")}),r.serverError=""},r.scene_cancel=function(e){for(i=0;i<r.myShowScene.length;i++)if(r.myShowScene[i].ischecked=!1,r.sceneSelected.length>0)for(k=0;k<r.sceneSelected.length;k++)r.myShowScene[i].id===r.sceneSelected[k].id&&(r.myShowScene[i].ischecked=!0);setTimeout(function(){$(e.target).parents(".dropdown.open").trigger("click")}),r.sceneError=""},r.checkIntroFormat=function(e){return e.shortIntroduction?countCharacters(e.shortIntroduction)>30?(r.introError="简短介绍不能超过30个字符",!1):(r.introError="",!0):(r.introError="请填写简短介绍",!1)},r.checkIntroFormat1=function(e){return e.introduction?countCharacters(e.introduction)>400?(r.introError1="秀客介绍不能超过400个字符",!1):(r.introError1="",!0):(r.introError1="请填写秀客介绍",!1)},t.getUserScene().then(function(e){e.data.list.length>0?r.myShowScene=e.data.list:r.myShowScene=null});var f=[];r.sceneSelected=[],r.sceneSelect=function(e,t,c){return f=[],angular.forEach(r.myShowScene,function(e){e.ischecked&&f.push({code:e.code,name:e.name})}),3!==f.length?(r.sceneError="请选择三个代表作品",!1):(r.sceneSelected=f,r.sceneNull="",void(c&&(setTimeout(function(){$(t.target).parents(".dropdown.open").trigger("click")}),r.sceneError="")))};var m=function(){return 3!==r.sceneSelected.length?(r.sceneNull="请选择三个代表作品",!1):(r.sceneNull="",!0)},S=[],v=[];r.serverSelected=[],r.serverSubmit=function(e,t,c){return S=[],angular.forEach(r.serverLabel,function(e){e.ischecked&&S.push({name:e.name,id:e.id})}),S.length<=0?void(r.serverError="请选择服务地域"):S.length>3?void(r.serverError="服务地域不能超过3个"):(r.serverSelected=S,void(c&&(setTimeout(function(){$(t.target).parents(".dropdown.open").trigger("click")}),r.serverError="",r.serverNull="")))};var g=function(){return r.serverSelected.length<=0||r.serverSelected.length>3?(r.serverNull="请选择1-3个服务地域",!1):(r.serverNull="",!0)},y=[],E=[];r.cateSelected=[],r.queren=function(e,t,c){return y=[],angular.forEach(r.cateLabel,function(e){e.ischecked&&y.push({name:e.name,id:e.id})}),y.length<=0?void(r.cateError="请选择擅长领域"):y.length>3?void(r.cateError="擅长领域不能超过3个"):(r.cateSelected=y,r.cateNull="",void(c&&(setTimeout(function(){$(t.target).parents(".dropdown.open").trigger("click")}),r.cateError="")))};var b=function(){return r.cateSelected.length<=0||r.cateSelected.length>3?(r.cateNull="请选择1-3个擅长领域",!1):(r.cateNull="",!0)},w=[],I=function(){w=[];var e=!1;return angular.forEach(r.payLabel,function(r){r.ischecked&&(w.push(r.id),e=!0)}),w=w.join(","),e?(r.payError="",!0):(r.payError="请选择支付方式",!1)},L=/^[0-9]*$/;r.checkQQFormat=function(e){return e.qq&&!L.test(e.qq)?(r.qqError="qq填写格式错误",!1):e.qq?(r.qqError="",!0):(r.qqError="请填写QQ号码",!1)};var _=function(e){return e.wechat?(r.wechatError="",!0):(r.wechatError="请填写微信号",!1)};r.checkEmailFormat=function(e){var t=/^([a-zA-Z0-9]+[_|\_|\.|-]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[\.|-]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;return e.email&&!t.test(e.email)?(r.emailError="邮箱格式不正确",!1):e.email?(r.emailError="",!0):(r.emailError="邮箱不能为空",!1)},r.checkCode=function(e){return e.code?(r.codeError="",!0):(r.codeError="请输入手机验证码",!1)},r.getCode=function(e,c){return e.phone?(r.telError="",void t.relMobileCode(e.phone,c).then(function(e){e.data.success?u():r.telError=e.data.msg})):(r.telError="请填写手机号码",!1)};var q=60;r.checkFormFormat=function(e){return!!(r.checkIntroFormat(e)&&r.checkIntroFormat1(e)&&m()&&g()&&b()&&I()&&r.checkQQFormat(e)&&_(e)&&r.checkEmailFormat(e))},r.submit=function(e){if(r.checkFormFormat(e)){for(F&&!F.checkPhone&&1!==F.checkPhone&&r.checkCode(e),v=[],E=[],k=0;k<r.cateSelected.length;k++)E.push(r.cateSelected[k].id);for(_cateSelected2=E.join(","),i=0;i<r.serverSelected.length;i++)v.push(r.serverSelected[i].id);_serverSelected2=v.join(",");var c={shortIntroduction:e.shortIntroduction,introduction:e.introduction,represent1:r.sceneSelected[0].code+"_"+r.sceneSelected[0].name,represent2:r.sceneSelected[1].code+"_"+r.sceneSelected[1].name,represent3:r.sceneSelected[2].code+"_"+r.sceneSelected[2].name,qq:e.qq,wechat:e.wechat,phone:e.phone,email:e.email,addr:_serverSelected2||"",pay:w||"",good:_cateSelected2||"",code:e.code,type:h};t.saveApplyInfo(c).then(function(e){e.data.success?(r.applyInfo=e.data.map.status,o.pushForCurrentRoute("visitor.apply","notify.success"),r.$close(r.applyInfo)):r.authError=e.data.msg})}},r.checkFormFormat2=function(e){return!!(r.checkIntroFormat(e)&&r.checkIntroFormat1(e)&&m()&&g()&&b()&&I()&&r.checkQQFormat(e)&&_(e)&&r.checkEmailFormat(e))},r.reset=function(e){if(r.sceneSelect(),r.serverSubmit(),r.queren(),r.checkFormFormat2(e)){for(E=[],k=0;k<r.cateSelected.length;k++)E.push(r.cateSelected[k].id);for(_cateSelected2=E.join(","),v=[],i=0;i<r.serverSelected.length;i++)v.push(r.serverSelected[i].id);_serverSelected2=v.join(",");var c={nick:r.applyInfo.nick,shortIntroduction:e.shortIntroduction,introduction:e.introduction,represent1:r.sceneSelected[0].code+"_"+r.sceneSelected[0].name,represent2:r.sceneSelected[1].code+"_"+r.sceneSelected[1].name,represent3:r.sceneSelected[2].code+"_"+r.sceneSelected[2].name,qq:e.qq,wechat:e.wechat,email:e.email,addr:_serverSelected2||"",pay:w||"",good:_cateSelected2||"",type:h,phone:e.phone,code:e.code};t.resetApplyInfo(c).then(function(e){e.data.success?(o.pushForCurrentRoute("visitor.apply","notify.success"),r.$close({applyInfoNew:c,status:e.data.map.status})):r.authError=e.data.msg})}},r.showPhone=!0;var F;0!==s.status&&d(function(){t.getVisitorMsg().then(function(e){if(e.data.obj){F=r.applyInfo=e.data.obj;var t=angular.copy(r.applyInfo.phone);F.checkPhone&&1==F.checkPhone&&(r.showPhone=!1,r.$watch("applyInfo.phone",function(e,c){e&&e!==t?r.showPhone=!0:r.showPhone=!1}));for(var c=F.represent1,n=c.substr(0,c.indexOf("_")),o=F.represent2,a=o.substr(0,o.indexOf("_")),i=F.represent3,s=i.substr(0,i.indexOf("_")),l=0;l<r.myShowScene.length;l++)r.myShowScene[l].code!==n&&r.myShowScene[l].code!==a&&r.myShowScene[l].code!==s||(r.myShowScene[l].ischecked=!0,r.sceneSelected.push(r.myShowScene[l]));var d=F.tagList;for(l=0;l<d.length;l++){for(var u=0;u<r.serverLabel.length;u++)d[l].tagId===r.serverLabel[u].id&&(r.serverLabel[u].ischecked=!0,r.serverSelected.push({name:d[l].name,id:d[l].tagId}));for(var h=0;h<r.payLabel.length;h++)d[l].tagId===r.payLabel[h].id&&(r.payLabel[h].ischecked=!0);for(var p=0;p<r.cateLabel.length;p++)d[l].tagId===r.cateLabel[p].id&&(r.cateLabel[p].ischecked=!0,r.cateSelected.push({name:d[l].name,id:d[l].tagId}))}}})},1e3),r.invoice=function(){c.open({windowClass:"six-contain",templateUrl:BASE_URL+"templates/usercenter.console.invoice.tpl.html",controller:"InvoiceCtrl",scope:r,resolve:{userinfo:function(){return{}}}}).result.then(function(e){},function(){})}}]);