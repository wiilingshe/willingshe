angular.module("spread.dataCollect",[]),angular.module("spread.dataCollect").controller("DataCollectCtrl",["$rootScope","$scope","$timeout","dataService","ModalService","i18nNotifications",function(t,e,a,d,n,l){function o(t,a,n){d.getDataBySceneId(t,a,n,h).then(function(t){t.data.list.length>0&&(r=t.data.list.shift().slice(1));for(var a=0;a<t.data.list.length;a++)t.data.list[a].$$id=t.data.list[a][0],t.data.list[a].splice(0,1);if(c.length<1)for(a=0;a<r.length;a++)c.push({title:r[a],selected:!1,id:a});if(e.dataShow.length>0)for(e.dataShowList.length=0,a=0;a<e.dataShow.length;a++)for(var d=0;d<e.dataHeaders.length;d++)e.dataShow[a].id==e.dataHeaders[d].id&&(e.dataHeaders[d].selected=!0);else if(c.length>0&&c.length<8)for(a=0;a<c.length;a++)c[a].selected=!0,isTimeColumnSelected=!0;else if(c.length>7)for(var n=0;8>n;n++)c[n].selected=!0;e.dataList=t.data.list,e.totalItems=t.data.map.count,e.page.currentPage=t.data.map.pageNo,e.toPage=t.data.map.pageNo,s(),e.totalItems<1e3?e.showUp=!1:(e.showUp=!0,f())})}function s(){e.dataShow.length=0;for(var t=0;t<c.length;t++)c[t].selected&&(e.dataShow.push({title:c[t].title,selected:!0,id:c[t].id}),e.dataContain=!0);if(e.dataShow.length<1)e.dataShowList.length=0;else for(var a=0;a<e.dataList.length;a++){var d=e.dataShowList[a]=[];for(d.push(e.dataList[a].$$id),d.$$id=d[0],d.splice(0,1),t=0;t<e.dataShow.length;t++){var n=e.dataShow[t].id;d.push(e.dataList[a][n])}}0===e.dataShow.length?e.dataContain=!1:1==e.dataShow.length?e.tdW="100%":2==e.dataShow.length?e.tdW="50%":3==e.dataShow.length?e.tdW="33.3%":4==e.dataShow.length?e.tdW="25%":5==e.dataShow.length?e.tdW="20%":6==e.dataShow.length?e.tdW="16.5%":7==e.dataShow.length&&(e.tdW="14.5%")}e.totalItems=0,e.page={currentPage:1},e.toPage="",e.dataList=[];var c=e.dataHeaders=[],r=[];e.dataShow=[],e.dataShowList=[];var h=t.branchid;e.branchEdit=!0,e.branchDelete=!0,e.branchExport=!0,a(function(){21==e.user.type&&(e.user.extPermi?(/^([\d,]+,)?1(,[\d,]*)?$/.test(e.user.extPermi)?e.branchEdit=!0:e.branchEdit=!1,/^([\d,]+,)?2(,[\d,]*)?$/.test(e.user.extPermi)?e.branchDelete=!0:e.branchDelete=!1,/^([\d,]+,)?3(,[\d,]*)?$/.test(e.user.extPermi)?e.branchExport=!0:e.branchExport=!1):e.branchEdit=!1)},100),e.selectHeader=function(t,e,a){s()};var g=PREFIX_S3_URL+"index.php?c=scenedata&a=excel&flag=noheader&id="+e.sceneId+(h?"&user="+h:""),u=PREFIX_S3_URL+"index.php?c=scenedata&a=excel&id="+e.sceneId+(h?"&user="+h:"");e.dataOutNoHeader=function(){location.href=g},e.dataOutNoHeaderPage=function(t,a){var d;d=g+(/\?/.test(g)?"&":"?")+"start="+t+"&end="+a,location.href=d,e.dataPageList=!1},e.dataOutDirect=function(){location.href=u},e.dataOutPage=function(t,a){var d;d=u+(/\?/.test(u)?"&":"?")+"start="+t+"&end="+a,location.href=d,e.dataPageList=!1};var f=function(t,a){e.dataPageNums=[],e.dataPageobg={};for(var d=Math.ceil(e.totalItems/10,16),n=Math.ceil(d/100,16),l=1;n+1>l;l++)e.start=100*(l-1)+1,e.end=100*l,l==n&&(e.end=d),e.dataPageobg={start:e.start,end:e.end},e.dataPageNums.push(e.dataPageobg)};e.dataDelete=function(t,a){var s,c;for(selectIds=[],i=0;i<e.dataShowList.length;i++)e.dataShowList[i].selected&&selectIds.push(e.dataShowList[i].$$id);return selectIds.length?(s={ids:selectIds},c="确认删除选中数据？",void n.openConfirmDialog({msg:c},function(){d.deleteDataBySceneId(e.sceneId,s).then(function(t){200==t.data.code&&(l.pushForCurrentRoute("data.delete.success","notify.success"),e.allSelect.selected=!1,o(e.sceneId,e.page.currentPage,10))})})):void alert("您还没有选择数据")},e.allSelect={selected:!1},e.selectAll=function(){for(var t=0,a=e.dataShowList.length;a>t;t++)e.dataShowList[t].selected=e.allSelect.selected},e.selectData=function(t){t.selected||(e.allSelect.selected=!1)},e.pageChanged=function(t){return 1>t||t>e.totalItems/10+1?void alert("此页超出范围"):(e.allSelect.selected=!1,e.page.currentPage=t,void o(e.sceneId,t,10))},o(e.sceneId,e.page.currentPage,10),e.clickDown=function(){$(".origin-ul").css({height:"auto"})}}]);