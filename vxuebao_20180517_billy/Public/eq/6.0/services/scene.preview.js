angular.module("scene.preview",["services.scene"]),angular.module("scene.preview").factory("sceneViewService",["$http",function(e){var t={};return t.getSceneData=function(t){var a="index.php?c=scene&a=view&id="+t+"&time="+(new Date).getTime();return e({withCredentials:!0,method:"GET",url:PREFIX_URL+a})},t.getSelfLastPage=function(t){var a="index.php?c=scene&a=getlastpagebg&id="+t;return e({withCredentials:!0,method:"GET",url:PREFIX_S1_URL+a})},t.getActivityPage=function(t){var a="eqs/trailer/"+t;return e({withCredentials:!0,method:"GET",url:PREFIX_S2_URL+a})},t}]).factory("sceneDataParseService",["sceneViewService","sceneService","$rootScope",function(e,t,a){function n(t,a){t.obj.property.lastPageId?e.getSelfLastPage(t.obj.property.lastPageId).then(function(e){e.data.obj?(i(t.obj,e.data),t.list.push(e.data.obj),m.lastPage=a[a.length-1],l(a,t)):(o(t.obj),m.lastPage=a[a.length-1],l(a,t))}):(o(t.obj,a),m.lastPage=a[a.length-1],l(a,t))}function o(e,t){var a="http://e.wesambo.com",n='{"id":439882,"pageId":129810,"sceneId":16060,"num":1,"type":"4","isInput":0,"title":null,"content":null,"status":1,"css":{"borderRadius":"10px","borderStyle":"solid","zIndex":"9","borderColor":"rgba(0,0,0,1)","paddingTop":"0px","height":"141","backgroundColor":"","color":"","boxShadow":"0px 0px 0px #333333","borderWidth":"0px","width":"142.13709677419354","left":"92px","paddingBottom":"0px","top":"177px"},"properties":{"height":"100px","imgStyle":{"width":142,"height":142,"marginTop":"-0.5px","marginLeft":"0px"},"width":"100px","src":"group1/M00/BA/DA/yq0KA1Rq8COAAYRjAAKU4OVYum0889.jpg"}}',o='{"id":"","sceneId":"","num":2,"name":null,"properties":null,"elements":[{"id":439880,"pageId":129810,"sceneId":16060,"num":0,"type":"3","isInput":0,"title":null,"content":null,"status":1,"css":{},"properties":{"bgColor":"#E6E9EE"}},{"id":439881,"pageId":129810,"sceneId":16060,"num":1,"type":"2","isInput":0,"title":null,"content":"<div style=\\"text-align: center;\\"><span style=\\"line-height: 1; background-color: initial;\\"><font size=\\"4\\" color=\\"#888888\\"><b>微课名称</b></font></span></div>","status":1,"css":{"height":"65","zIndex":"10","width":"320","left":"0px","top":"77px"},"properties":{}},{"id":439882,"pageId":129810,"sceneId":16060,"num":1,"type":"2","isInput":0,"title":null,"content":"<div class=\\"bottom-logo\\" style=\\"text-align: center;cursor:pointer;height:142px;width:142px;border-radius:10px;\\"><em style=\\"color:white;line-height:142px;font-size:30px;\\" class=\\"eqf-love\\"></em></div>","status":1,"css":{"height":"157","width":"172","left":"77px","top":"170px"},"properties":{}},{"id":439883,"pageId":129810,"sceneId":16060,"num":1,"type":"2","isInput":0,"title":null,"content":"<div style=\\"width:280px;height:1px;background-color:rgba(60,60,60,0.4);cursor:pointer;position:absolute;left:0;-webkit-filter:drop-shadow(0px 1px 0px rgba(60,60,60,0.4));top:12px;\\"></div>","status":1,"css":{"height":"24","width":"280","left":"21px","top":"122px"},"properties":{}},{"id":439885,"pageId":129810,"sceneId":16060,"num":1,"type":"2","isInput":0,"title":null,"content":"<div style=\\"text-align: center;padding-top: 0;\\" id=\\"scenead\\"><span style=\\"font-size: small; line-height: 1; background-color: initial;\\"><a href=\\"'+PREFIX_S1_URL+"index.php?c=scene&a=link&id=16060&amp;url="+encodeURIComponent(a)+'\\" target=\\"_blank\\"><font color=\\"#888888\\">免费创建一个微课？→</font><font color=\\"#23a3d3\\">'+lastpagetext+'</font></a></span></div>","status":1,"css":{"borderRadius":"0px","borderStyle":"solid","height":"30","paddingTop":"0px","borderColor":"rgba(222,220,227,1)","zIndex":"12","boxShadow":"0px 0px 0px rgba(200,200,200,0.6)","color":"","backgroundColor":"rgba(255,255,255,0)","borderWidth":"0px","width":"320","left":"1px","paddingBottom":"20px","top":"420px"},"properties":{"anim":{"type":1,"direction":3,"duration":"1","delay":"0.6"}}}]}';o=o.replace(/id=16060/,"id="+e.id);var i=JSON.parse(o);i.num=t.length+1,e.cover&&"group1/M00/61/8A/yq0KA1T2vYSAEgo7AACovQVgHxk048.jpg"!=e.cover&&(i.elements[2]=JSON.parse(n),i.elements[2].properties.src=e.cover),i.elements[1].content=i.elements[1].content.replace(/微课名称/,e.name?e.name:""),t.push(i)}function i(e,t){var a='{"id":81395,"pageId":"","sceneId":"","num":1,"type":"4","isInput":0,"title":null,"content":null,"status":1,"css":{"borderRadius":"%","borderStyle":"solid","height":"158","zIndex":"1000","paddingTop":"0px","borderColor":"rgba(0,0,0,1)","boxShadow":"0 0px 0px #333333","color":"#000000","backgroundColor":"white","borderWidth":"0px","width":"158","left":"84px","paddingTop":"11px","paddingLeft":"10px","top":"170px"},"properties":{"height":"100px","imgStyle":{"width":139,"height":136,"marginTop":"0px","marginLeft":"0px"},"width":"100px","src":"group1/M00/01/30/yq0JCFQpOR-AOULFAAFBPO1yzBQ984.jpg"}}',n='{"id":439882,"pageId":129810,"sceneId":16060,"num":1,"type":"2","isInput":0,"title":null,"content":"<div class=\\"bottom-logo\\" style=\\"text-align: center;cursor:pointer;height:136px;width:139px;\\"><em style=\\"color:white;line-height:136px;font-size:120px;\\" class=\\"eqf-eqxiu\\"></em></div>","status":1,"css":{"height":"158","width":"158","left":"84px","top":"170px","backgroundColor":"white"},"properties":{}}',o='{"id":81465,"pageId":"","sceneId":"","num":1,"type":"2","isInput":0,"title":null,"content":"<div style=\\"text-align: center;\\"><font color=\\"#ffffff\\" size=\\"3\\">击此处进行编辑</font></div>","status":1,"css":{"zIndex":"102","height":"65","width":"320","left":"0px","top":"70px"},"properties":{}}',i='{"id":2557867,"pageId":129810,"sceneId":16060,"num":1,"type":"2","isInput":0,"title":null,"content":"<div class=\\"logo-shadow1\\" style=\\"text-align: center;cursor:pointer;height:127px;width:220px;transform:rotate(-45deg);-webkit-transform:rotate(-45deg);position:absolute;left:20px;top:56px;\\"></div>","status":1,"css":{"height":"257","width":"257","left":"78px","top":"175px"},"properties":{}}',s='{"id":439883,"pageId":129810,"sceneId":16060,"num":1,"type":"2","isInput":0,"title":null,"content":"<div style=\\"width:280px;height:1px;background-color:rgba(60,60,60,0.4);cursor:pointer;position:absolute;left:0;-webkit-filter:drop-shadow(0px 1px 0px rgba(60,60,60,0.4));top:12px;\\"></div>","status":1,"css":{"height":"24","width":"280","left":"21px","top":"122px"},"properties":{}}';t.obj.sceneId=e.id;for(var p,r=0;r<t.obj.elements.length;r++)"4"!=t.obj.elements[r].type||"group1/M00/A5/5E/yq0KA1QmePmAKr7yAAEByp5jyLc752.jpg"!=t.obj.elements[r].properties.src&&"group1/M00/C5/9D/yq0KA1SH1zuAFgkLAAAFgBR8hJs456.png"!=t.obj.elements[r].properties.src&&"group1/M00/C5/3F/yq0KA1SHp-2AQZZZAAB-7rIaK6I743.png"!=t.obj.elements[r].properties.src&&"group1/M00/C5/9D/yq0KA1SH1zuAeQuFAAAFfUkeXDc110.png"!=t.obj.elements[r].properties.src||(t.obj.elements.splice(r,1),r--),"2"==t.obj.elements[r].type&&(t.obj.elements.splice(r,1),r--);"group1/M00/61/8A/yq0KA1T2vYSAEgo7AACovQVgHxk048.jpg"!=e.cover?(p=JSON.parse(a),p.properties.src=e.cover):p=JSON.parse(n),t.obj.elements.push(p),t.obj.elements.push(JSON.parse(i)),t.obj.elements.push(JSON.parse(s));var l=JSON.parse(o);l.content=l.content.replace(/击此处进行编辑/,e.name),t.obj.elements.push(l);for(var g=0;g<t.obj.elements.length;g++)"2"==t.obj.elements[g].type&&/http:\/\/service.e.wesambo.com\/eqs\/link/.test(t.obj.elements[g].content)&&(t.obj.elements[g].content=t.obj.elements[g].content.replace(/;url=.*com"/,";url="+encodeURIComponent(redirectUrl)+'"'))}function s(t,a){e.getSelfLastPage(t.obj.property.bottomLabel.id).then(function(e){if(e.data.success){var n=a[a.length-1];n.elements||(n.elements=[]),n.elements=n.elements.concat(e.data.obj.elements),l(a,t)}})}function p(e,t){r(e,t),l(t,e)}function r(e,t){var a,n="http://e.wesambo.com",o="微学宝技术支持",i='{"id":480292,"pageId":136042,"sceneId":16060,"num":1,"type":"2","isInput":0,"title":null,"content":"<div style=\\"text-align: center;transform: none;-webkit-animation: fadeIn 2s ease 1s both;-webkit-animation-play-state: initial;\\"><a href=\\"'+PREFIX_S1_URL+"eqs/link?id=16060&amp;url="+encodeURIComponent(n)+'\\" target=\\"_blank\\" style=\\"font-size: x-small;display:block;line-height: 10px;\\"><font color=\\"#ffffff\\">'+o+'</font></a></div>","status":1,"css":{"zIndex":"1000","height":"20","width":"129","left":"97px","top":"418px","backgroundColor":"rgba(0,0,0,0.6)","borderRadius":"20px"},"properties":{"anim":{"type":0,"direction":0,"duration":2,"delay":"0"}}}';i=i.replace(/id=16060/,"id="+e.id),a=t[t.length-1].elements,t[t.length-1].elements||(a=t[t.length-1].elements=[]),a.push(JSON.parse(i))}function l(e,t){var n=t.obj.pageMode;t.obj.property.slideNumber?t.obj.property.slideDisplay="block":t.obj.property.slideDisplay="none",t.obj.property.slideNumber=!0;var o,i={bgAudio:t.obj.bgAudio};for(o=1;o<=e.length;o++){$('<section class="main-page"><div class="m-img" id="page'+o+'"></div></section>').appendTo(".phone-view"),e.length>1&&($('<section class="u-arrow-bottom"><div class="pre-wrap"><div class="pre-box1"><div class="pre1"></div></div><div class="pre-box2"><div class="pre2"></div></div></div></section>').appendTo("#page"+o),$('<section class="u-arrow-right"><div class="pre-wrap-right"><div class="pre-box3"><div class="pre3"></div></div><div class="pre-box4"><div class="pre4"></div></div></div></section>').appendTo("#page"+o)),1==o&&$(".phone-view .main-page").eq(0).addClass("z-current");var s=o;e[s-1].properties&&!$.isEmptyObject(e[s-1].properties)?e[s-1].properties.image||(e[s-1].properties.scratch?addScratchEffect(i,e,s):e[s-1].properties.finger?(v=[],v.push({num:s,finger:e[s-1].properties.finger}),lockEffect(i,e,v,$(".m-img").width(),$(".m-img").height())):e[s-1].properties.fallingObject?fallingObject(e,s):e[s-1].properties.effect?!function(t){window[e[t-1].properties.effect.name].doEffect(i,t,e,renderPage)}(s):renderPage(eqShow,s,e)):(renderPage(eqShow,s,e),1==s&&playVideo(i)),o==e.length&&eqxiu.app($(".phone-view"),t.obj.pageMode,e,t),a.view&&$(".phone-view .wrapper-background").css({top:0,right:0,marginTop:0,marginRight:0})}0===n||1==n||2==n||6==n||7==n||8==n||11==n||12==n?$(".phone-view .u-arrow-right").hide():3!=n&&4!=n&&5!=n&&9!=n&&10!=n||$(".phone-view .u-arrow-bottom").hide()}function g(t){var a=[];$.extend(!0,a,u._pages),m.activePage&&a.push(m.activePage);var n=a.length+1;if(!t){o({name:m.sceneName},a),m.lastPage=a[a.length-1];var s=a[a.length-1];return m.haseLastPage?d(m.lastPageNum,s):($(".phone-view .main-page").last().after('<section class="main-page"><div class="m-img" id="page'+n+'"></div></section>'),m.lastPageNum=n,renderPage(eqShow,m.lastPageNum,a),m.haseLastPage=!0),u.app.changeAppPage(),void u.app.setPageData(a)}e.getSelfLastPage(t).then(function(e){if(e.data.success){if(m.lastPage=e.data.obj,m.haseLastPage){var t={id:"1",name:m.sceneName,cover:m.sceneCover};i(t,e.data),d(m.lastPageNum,e.data.obj),a.push(e.data.obj)}else $(".phone-view .main-page").last().after('<section class="main-page"><div class="m-img" id="page'+n+'"></div></section>'),m.lastPageNum=n,renderPage(eqShow,m.lastPageNum,a.push([e.data.obj])),m.haseLastPage=!0;u.app.changeAppPage(),u.app.setPageData(a)}})}function d(e,a){$("#page"+e).empty(),t.templateEditor.parse({def:a,appendTo:"#page"+e,mode:"view"})}function c(e,t,a,n){var o=0;for(e.length;o<e.length;o++){var i=e[o];if(i.pageId=t.id,a.name&&a.url&&"http://"!=a.url)2==i.type&&i.content.indexOf("e.wesambo.com科技公司")>0&&(i.content=i.content.replace(/e.wesambo.com科技公司/,'<a href="'+PREFIX_S1_URL+"eqs/link?id="+n+"&amp;url="+encodeURIComponent(a.url)+'" target=_blank>'+a.name+"</a>"));else if(a.name)2==i.type&&i.content.indexOf("e.wesambo.com科技公司")>0&&(i.content=i.content.replace(/e.wesambo.com科技公司/,a.name));else if(/微学宝技术支持/.test(i.content)){i.content='<div style="text-align: center;">'+i.content+"</div>";var s={zIndex:"1000",height:"33",width:"129",left:"97px"};$.extend(i.css,s)}else 2==i.type&&i.content&&(i.content="");i.css.zIndex=200}}function h(){u.app.removeLastPage(),u.app.changeAppPage(),m.haseLastPage=!1}a.view=!0,a.$on("changeView",function(e,t,n){n?a.view=!1:a.view=!0});var u={};u.app=eqxiu;var m={haseLastPage:!1,sceneName:"",sceneCover:"",lastPage:null,activePage:null,activePageNum:null,lastPageNum:null};u._pages=[],u.parse=function(e){m.activePage=null,e.obj.property&&(e.obj.property=JSON.parse(e.obj.property)||{}),e.obj.name&&(m.sceneName=e.obj.name),e.obj.cover&&(m.sceneCover=e.obj.cover),e.obj.bgAudio&&"string"==typeof e.obj.bgAudio?e.obj.bgAudio=JSON.parse(e.obj.bgAudio):$("#audio_btn").hide();var t=(e.obj.pageMode,e.list);if($.extend(!0,u._pages,e.list),e.obj.property.hideEqAd)l(t,e);else switch(e.obj.property.eqAdType){case 1:m.haseLastPage=!0,n(e,t),m.lastPageNum=t.length+1;break;case 2:p(e,t);break;case 3:s(e,t);break;default:m.haseLastPage=!0,n(e,t)}};var v=[];return u.changeBottomType=function(t,a,n,o){if("eqFree"==t){g(a),u.app.lastPage();var i=u._pages.length;d(i,u._pages[u._pages.length-1])}else if("eqLink"==t){if(m.lastPageNum=null,m.haseLastPage&&(h(),m.lastPage=null),u.app.lastPage(!!m.activePage),2==o){var s=[];$.extend(!0,s,u._pages);var p=s[s.length-1];return p.elements||(p.elements=[]),r(p,s),void d(u._pages.length,p)}if(!n||!n.id)return;e.getSelfLastPage(n.id).then(function(e){if(e.data.success){var t={};$.extend(!0,t,u._pages[u._pages.length-1]),t.elements||(t.elements=[]),c(e.data.obj.elements,t,n,u._pages[0].sceneId),t.elements=t.elements.concat(e.data.obj.elements),d(u._pages.length,t)}})}else m.lastPageNum=null,m.haseLastPage?(h(),m.lastPage=null):d(u._pages.length,u._pages[u._pages.length-1]),u.app.lastPage()},u.removeActivePage=function(){u.app.removeLastPage(m.haseLastPage),u.app.changeAppPage(),u.app.lastPage(),m.activePageNum=null},u.playVideo=function(e){var t={bgAudio:e};e||(t.bgAudio={url:""}),playVideo(t),e||$("#audio_btn").hide()},u.changeScrollMode=function(e){u.app.changeScrollMode(e),0===e||1==e||2==e||6==e||7==e||8==e||11==e||12==e?($(".phone-view .u-arrow-right").hide(),$(".phone-view .u-arrow-bottom").show()):3!=e&&4!=e&&5!=e&&9!=e&&10!=e||($(".phone-view .u-arrow-bottom").hide(),$(".phone-view .u-arrow-right").show())},u.changeSceneName=function(e){m.sceneName=e},u.changeSceneCover=function(e){m.sceneCover=e},u.replaceActivePage=function(t){e.getActivityPage(t).then(function(e){var t,a=[];m.haseLastPage?($.extend(!0,a,u._pages),m.lastPage&&a.push(m.lastPage),a.push(e.data.obj),t=a.length,m.activePage?d(m.activePageNum,e.data.obj):($(".phone-view .main-page").last().prev().after('<section class="main-page"><div class="m-img" id="page'+t+'"></div></section>'),m.activePageNum=t,renderPage(eqShow,m.activePageNum,a)),u.app.setPageData(a),u.app.changeAppPage()):($.extend(!0,a,u._pages),a.push(e.data.obj),t=a.length,m.activePage?d(m.activePageNum,e.data.obj):($(".phone-view .main-page").last().after('<section class="main-page"><div class="m-img" id="page'+t+'"></div></section>'),m.activePageNum=t,renderPage(eqShow,m.activePageNum,a)),u.app.changeAppPage(),u.app.setPageData(a)),m.activePage=e.data.obj})},u}]);