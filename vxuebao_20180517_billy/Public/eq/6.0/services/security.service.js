angular.module("security.service",["security.retryQueue","security.authority","ui.bootstrap.modal"]).factory("security",["$rootScope","$http","$q","$location","securityRetryQueue","$modal","authority","$ocLazyLoad",function(e,t,n,r,o,i,s,a){function c(e){e=e||"/",window.location.href=e}function u(){if(R&&(l(R,!1),R=null),U)throw new Error("Trying to open a dialog that is already open!");a.load("controllers/security.login.form").then(function(){U=i.open({windowClass:"login-container",keyboard:!1,templateUrl:"/Public/eq/6.0/templates/login.form.tpl.html",controller:"LoginFormController"}),U.result.then(h,h)},function(e){console.log(e)})}function l(e,t){e.close(t)}function h(e){U=null,e?("/home/login"==r.path()&&r.path("/home",!1),o.retryAll()):(o.cancelAll(),c())}function d(e){if(y)throw new Error("Trying to open a dialog that is already open!");a.load("controllers/security.login.reset").then(function(){y=i.open({windowClass:"login-container",keyboard:!1,templateUrl:"/Public/eq/6.0/templates/login.reset.tpl.html",controller:"ResetFormController",resolve:{resetKey:function(){return e}}}),y.result.then(function(){y=null},function(){T.currentUser||r.path("/home",!1).search({}),y=null})},function(e){console.log(e)})}function p(e){if(U&&(l(U,!0),U=null),R)throw new Error("Trying to open a dialog that is already open!");a.load("controllers/security.register.form").then(function(){R=i.open({windowClass:"login-container",keyboard:!1,templateUrl:"/Public/eq/6.0/templates/register.form.tpl.html",controller:"RegisterFormController",resolve:{regMsg:function(){return e}}}),R.result.then(function(){R=null},function(){"/home/register"==r.path()&&r.path("/home",!1),R=null})},function(e){console.log(e)})}function f(e){if(C)throw new Error("Trying to open a dialog that is already open!");a.load("controllers/security.otherregister.form").then(function(){C=i.open({windowClass:"login-container",keyboard:!1,templateUrl:"/Public/eq/6.0/templates/register.otherregister.tpl.html",controller:"OtherRegisterFormController",resolve:{otherRegisterInfo:function(){return e}}})},function(e){console.log(e)})}function g(e){P=e}function w(){return P}function m(){U=null}var U=null,y=null,R=null,C=null;o.onItemAddedCallbacks.push(function(e){o.hasMore()&&T.showLogin()});var P={},T={getLoginReason:function(){return o.retryReason()},showLogin:function(){u()},showRegister:function(e){p(e)},showOtherRegister:function(){f()},getUserDetail:function(e,n,r){var o=PREFIX_URL+"base/relUserInfo?type="+e+"&openId="+n+"&accessToken="+r,i=new Date;return o+="&date="+i.getTime(),t({method:"GET",url:o,withCredentials:!0})},checkUniqueness:function(e){var n=PREFIX_S1_URL+"index.php?c=user&a=checkN&username="+e,r=new Date;return n+="&date="+r.getTime(),t({method:"GET",url:n,withCredentials:!0})},addRegisterInfo:g,getRegisterInfo:w,login:function(e){var n=this,o=t.post(PREFIX_URL+"index.php?c=user&a=login",e,{withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}});return o.then(function(e){return 200===e.status?(n.isValidateCodeLogin=!1,e.data.success===!0?(l(U,!0),T.requestCurrentUser().then(function(){("/home"==r.path()||"/home/login"==r.path())&&r.path("main")}),e.data):e.data):void T.isAuthenticated()},function(e){T.isAuthenticated()})},closeLoginDialog:m,register:function(e,n){var o=t.post(PREFIX_URL+"index.php?c=user&a=register"+n,e,{withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}});return o.then(function(e){return 200===e.status?(alert(e.data.msg),void r.path("home/login")):void T.isAuthenticated()},function(e){T.isAuthenticated()})},qqLogin:function(e,t){T.getThirdPartyInfo(e).then(function(n){var r=n.openid,o=(n.client_id,{email:"",password:"",openId:r,accessToken:e,type:"qq",expires:t});T.thirdPartLogin(o)})},thirdPartLogin:function(e){var n=t.post(PREFIX_URL+"index.php?c=otherlogin",$.param(qqRegisterInfo),{withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}});return n.then(function(e){if(200===e.status){if(e.data.success!==!0)return e.data;("/home"==r.path()||"/home/login"==r.path())&&r.path("main"),T.setLoginSuccess(!0),T.requestCurrentUser(),l(C,!0)}else T.isAuthenticated()},function(e){T.isAuthenticated()})},getThirdPartyInfo:function(e){var t="https://graph.qq.com/oauth2.0/me?access_token="+e;return $.ajax({type:"get",url:t,dataType:"jsonp",jsonp:"jsoncallback",jsonpCallback:"callback",xhrFields:{withCredentials:!0}})},weiChatLogin:function(e){return t.post(PREFIX_URL+"index.php?c=otherlogin&code="+e+"&type=weixin&time="+(new Date).getTime(),{},{withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}})},cancelRegister:function(){R=null,r.path("/home",!1)},hasRel:function(e){R&&l(R,!1);var n=new Date,o=PREFIX_URL+"base/user/hasRel?type="+e.type+"&openId="+e.openId+"&time="+n.getTime(),i=t.get(o,{withCredentials:!0});i.then(function(t){200===t.status?t.data.success===!0?(("/home"==r.path()||"/home/login"==r.path())&&r.path("main"),T.requestCurrentUser()):"未关联账号"==t.data.msg&&f(e):T.isAuthenticated()},function(e){T.isAuthenticated()})},cancelLogin:function(){U=null,r.path("/home",!1)},logout:function(e){t({withCredentials:!0,method:"GET",url:PREFIX_URL+"?c=user&a=logout"}).then(function(t){T.currentUser=null,c(e)},function(){T.currentUser=null,c(e)})},userPromise:null,requestCurrentUser:function(){if(T.isAuthenticated())return n.when(T.currentUser);var e=new Date;return T.userPromise?T.userPromise:(T.userPromise=t.get(PREFIX_URL+"index.php?c=user&a=check&time="+e.getTime(),{withCredentials:!0}).then(function(e){return T.userPromise=null,e.data.success&&(T.currentUser=e.data.obj,(!T.currentUser.roleIdList||T.currentUser.roleIdList.length<=0)&&(T.currentUser.roleIdList=[2])),T.currentUser},function(){T.userPromise=null}),T.userPromise)},resetPassByKey:function(e,n){var r={key:n,newPwd:e};return t.post(PREFIX_URL+"index.php?c=user&a=reset_password",$.param(r),{withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}})},currentUser:null,isAuthenticated:function(){return!!T.currentUser},isLoginSuccess:!1,setLoginSuccess:function(e){T.isLoginSuccess=e},thirdPartyUrl:{weiChatUrl:"https://open.weixin.qq.com/connect/qrconnect?appid=wxc5f1bbae4bb93ced&redirect_uri=http%3A%2F%2Fe.wesambo.com&response_type=code&scope=snsapi_login&state=WECHAT_STATE#wechat_redirect",qqUrl:"https://graph.qq.com/oauth2.0/authorize?response_type=token&client_id="+client_id+"&redirect_uri="+redirect_uri+"&scope=get_user_info",weiboUrl:"https://api.weibo.com/oauth2/authorize?client_id=3508809852&response_type=token&redirect_uri=http://e.wesambo.com"},isAllowToAccess:function(e){if(!T.currentUser)return!1;var t=s.userRoleDef[T.currentUser.type];return!!(t&&(t.code&e)>0)},accessDef:s.accessDef,isEditor:function(){if(!T.currentUser)return!1;var e=T.currentUser.roleIdList;if(!e)return!1;for(var t=0;t<e.length;t++)if("4"==e[t])return!0;return!1},isAdvancedUser:function(){return!(!T.currentUser||"3"!=T.currentUser.type)},isVendorUser:function(){return!(!T.currentUser||"4"!=T.currentUser.type)},requestResetPassword:function(e){d(e)},validateToken:function(e){var n="changepw?token="+e;return t.get(PREFIX_URL+n,{withCredentials:!0})},resetPassword:function(e,n){var r=PREFIX_URL+"index.php?c=Usercenter&a=changePwd",o={oldPwd:e,newPwd:n};return t.post(r,$.param(o),{withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}})},retrievePassword:function(e,n,r,o){var i=PREFIX_URL+"index.php?c=user&a=forget_password",s={email:e,geetest_challenge:n,geetest_validate:r,geetest_seccode:o};return t.post(i,$.param(s),{withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}})}};return T}]);