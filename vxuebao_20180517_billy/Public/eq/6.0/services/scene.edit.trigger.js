angular.module("scene.edit.trigger",[]).factory("triggerService",["$rootScope",function(e){function n(e,n,r,t,d){var i=s(e,n,r,d).ids,f=i.indexOf(t);f>=0||i.push(t)}function r(e,n,r,t,d){var i=l[r];if(i&&i.sends.length){var f=s(e,n,r,d).ids,u=f.indexOf(t);0>u||f.splice(u,1)}}function t(n,r,t,d){var s=u(n,t,d).ids,i=s.indexOf(r);!i>=0&&(s.push(r),e.$broadcast("receive.element.update",n,r,t,d))}function d(n,r,t,d){var s=u(n,t,d).ids,i=s.indexOf(r);!0>i&&(s.splice(i,1),e.$broadcast("receive.element.update",n,r,t,d))}function s(e,n,r,t){var d=i(e,r,t).handles,s=a(d,n);if(s)return s;var f={type:n,ids:[]};return d.push(f),f}function i(e,n,r){var t=f(n),d=t.sends,s=o(d,r);if(s)return s;var i={sendIndex:r,delay:0,type:e,handles:[]};return d.push(i),i}function f(e){return l[e]||(l[e]={sends:[],receives:[]}),l[e]}function u(e,n,r){var t=f(n),d=t.receives,s=a(d,e);if(s)return s;var i={type:e,ids:[]};return d.push(i),i}function a(e,n){for(var r=0;r<e.length;r++)if(n==e[r].type)return e[r];return null}function o(e,n){for(var r=0;r<e.length;r++)if(n==e[r].sendIndex)return e[r];return null}var g={},l={};return g.getTrigger=function(e){return l[e]},g.getReceiveIds=function(e,n,r){if("number"!=typeof e||"number"!=typeof n||"number"!=typeof r)return[];var t=s(e,n,r).ids;return angular.copy(t)},g.getSendIds=function(e,n){if("number"!=typeof e||"number"!=typeof n)return[];var r=u(e,n).ids;return angular.copy(r)},g.setTrigger=function(e,n){"number"==typeof e&&"object"==typeof n&&(l[e]=n)},g.addTrigger=function(e,r,d,s,f){"number"==typeof e&&"number"==typeof r&&"number"==typeof d&&"number"==typeof s&&(l[d]&&l[d].sends[f]||i(e,d,f),n(e,r,d,s,l[d].sends[f].sendIndex),t(r,d,s,f))},g.deleteTrigger=function(e,n,t,s,i){"number"==typeof e&&"number"==typeof n&&"number"==typeof t&&"number"==typeof s&&l[t]&&l[t].sends[i]&&(r(e,n,t,s,l[t].sends[i].sendIndex),d(n,t,s,i))},g.clearTrigger=function(e){var n=l[e];if(n){for(var r=!1,t=!1,d=0;d<n.sends.length;d++){if("number"==typeof n.sends[d].sendIndex)for(var s=0;s<n.sends[d].handles.length;s++)if(n.sends[d].handles[s].ids.length){r=!0;break}if(r)break}for(var i=0;i<n.receives.length;i++)if(n.receives[i].ids.length){t=!0;break}r||t||delete l[e]}},g.resetTrigger=function(e){if("number"==typeof e){var n=utilTrigger.getSendType(),r=utilTrigger.getHandleType();for(var t in n)for(var d in r){var s=n[t].value,i=r[d].value,f=u(i,e).ids;f.length&&$.each(f,function(n,r){for(var t=g.getTrigger(r).sends,d=0;d<t.length;d++)"undefined"==typeof t[d].sendIndex&&t[d].hasOwnProperty("sendIndex")&&(t.splice(d,1),d--);var f=r;$.each(t,function(n,r){var t=n;$.each(r.handles,function(n,r){if(r.value,r.ids.length){var u=r.ids;for(d=0;d<u.length;d++)u[d]==e&&g.deleteTrigger(s,i,f,e,t)}})})});var a=g.getTrigger(e);if(a&&a.sends.length)for(var o=0;o<a.sends.length;o++)"undefined"==typeof a.sends[o].sendIndex&&triggerSends[o].hasOwnProperty("sendIndex")?(a.sends.splice(o,1),o--):g.deleteTriggerBySendIndex(o,e)}}},g.deleteTriggerBySendIndex=function(n,r){var t=l[r];if(t&&t.sends.length){for(var d=0;d<t.sends.length;d++)"undefined"==typeof t.sends[d].sendIndex&&triggerSends[d].hasOwnProperty("sendIndex")&&(t.sends.splice(d,1),d--);var s=t.sends[n].type;$.each(t.sends[n].handles,function(t,d){var i=d.type;if(d.ids.length)for(var f=0;f<d.ids.length;f++)e.$broadcast("delete.random.elem",d.ids[f]),g.deleteTrigger(s,i,r,d.ids[f],n),f--}),t.sends.splice(n,1)}},g.getSend=i,g}]);