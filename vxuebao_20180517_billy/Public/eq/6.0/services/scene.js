angular.module("services.scene",["services.history","services.select","scene.create.console.pictures","scene.edit.trigger","services.dataCache","security.login.toolbar"]),angular.module("services.scene").factory("sceneService",["$http","$rootScope","$modal","$q","security","$cacheFactory","historyService","selectService","picturesService","ModalService","triggerService","$translate","i18nNotifications","dataCacheService","$ocLazyLoad",function(e,t,n,i,o,r,l,c,s,a,d,p,u,h,f){function g(e){he.splice(he.indexOf(fe[e]),1),delete fe[e]}function b(e){ue.obj.elements=e,$("#nr").empty(),pe.parse({def:ue.obj,appendTo:"#nr",mode:"edit"});for(var n in e)if(3==e[n].type){var i="";e[n].properties.imgSrc&&(i=e[n].properties.imgSrc),t.$broadcast("show.edit.bg",i);break}t.$broadcast("dom.changed")}function m(e){angular.copy({},fe),$.each(e,function(e,t){fe[t.id]=t})}function v(e,t){var n={},i=$("#nr .edit_area"),o=i.children().last(),r=i.children(".maxIndex"),l=1;if(l=r.length>0?parseInt(r.css("z-index"),10)+1:o.length>0?parseInt(o.css("z-index"),10)+1:101,t)return t.zIndex=l,parseInt(t.top,10)>$("#nr .edit_area").outerHeight()-20&&(t.top=$("#nr .edit_area").outerHeight()-20+"px"),t;var c=$("#nr .edit_area").outerWidth(),s=c;return"v"==e?s=50:"4"==e?s=80:5!=(""+e).charAt(0)&&"6"!=e&&"r"!=e&&"c"!=e&&"a"!=e||(s=200),n={top:parseInt($(".edit_wrapper").scrollTop()-300)+parseInt($(window).height()/2)},n.zIndex=l,n}function y(e,t,n,i){var o=parseInt(e.css.top,10)+10*ge,r=parseInt(e.css.left,10);o+34>$("#nr .edit_area").outerHeight()?(t.css.top=o+"px",t.css.left=r+10+"px"):(t.css.top=o+34+"px",t.css.left=e.css.left,n==i&&ge++)}function C(){return Math.ceil(1e10*Math.random())}function w(e,t,n){var i,o=C(),r={};switch(e=(""+e).charAt(0)){case"1":r={id:o,properties:{title:p.instant("common.scene.COMMIT")},type:"1",pageId:ue.obj.id,sceneId:ue.obj.sceneId};break;case"2":i=v(e,t),$.extend(!0,i,{width:320,height:38}),r={content:p.instant("common.scene.EDIT_TIP"),css:i,id:o,num:1,pageId:ue.obj.id,properties:{},sceneId:ue.obj.sceneId,title:null,type:"2"};break;case"3":for(var l=[],c=0;c<he.length;c++)"3"==he[c].type&&l.push(he[c]);if(l.length>0)return l[0];r={content:null,css:{},id:o,num:0,pageId:ue.obj.id,properties:{bgColor:null,imgSrc:null},sceneId:ue.obj.sceneId,title:null,type:"3"};break;case"4":i=v(e,t),i.width="100px",i.height="100px",r={content:"",css:i,id:o,num:1,pageId:ue.obj.id,properties:{width:"100px",height:"100px",src:""},sceneId:ue.obj.sceneId,title:null,type:"4"};break;case"5":i=v(e,t),i.width="200px",$.extend(!0,i,{color:"#66cc00",borderWidth:"1",borderStyle:"solid",borderColor:"#66cc00",borderRadius:"0",backgroundColor:"#ffffff"}),r={content:"",css:i,id:o,num:1,pageId:ue.obj.id,properties:{placeholder:p.instant("common.scene.NAMED")},isInput:1,sceneId:ue.obj.sceneId,title:p.instant("common.scene.NAMED"),type:"5"};break;case"6":i=v(e,t),i.width="100px",$.extend(!0,i,{color:"#fff",borderRadius:"0",backgroundColor:"#66cc00"}),r={content:"",css:i,id:o,num:1,pageId:ue.obj.id,properties:{title:p.instant("common.scene.COMMIT")},sceneId:ue.obj.sceneId,title:null,type:"6"};break;case"8":i=v(e,t),$.extend(!0,i,{color:"rgb(255, 255, 255)",width:"100px",height:"40px",lineHeight:"40px",borderWidth:"0",borderStyle:"solid",borderColor:"#ccc",borderRadius:"0",backgroundColor:"rgb(244, 113, 31)"}),r={content:"",css:i,id:o,num:1,pageId:ue.obj.id,properties:{title:p.instant("common.scene.DIALING"),number:""},sceneId:ue.obj.sceneId,title:null,type:"8"};break;case"a":i=v(e,t),i.width="200px",delete i.height,$.extend(!0,i,{color:"#676767",borderWidth:"0",borderStyle:"solid",borderColor:"#ccc",borderRadius:"0",backgroundColor:"#f9f9f9"}),r={content:"",css:i,id:o,num:1,pageId:ue.obj.id,properties:{icon:"eqf-star",size:"rating-m",color:"#66cc00"},isInput:1,sceneId:ue.obj.sceneId,title:"",type:"a"};break;case"c":i=v(e,t),i.width="200px",delete i.height,$.extend(!0,i,{color:"#676767",borderWidth:"1",borderStyle:"solid",borderColor:"#08a1ef",borderRadius:"0",backgroundColor:"#ffffff"}),r={content:"",css:i,id:o,num:1,pageId:ue.obj.id,properties:{titleStyle:{backgroundColor:"#08a1ef",color:"#ffffff"},optionStyle:{borderBottomWidth:"1",borderBottomStyle:"solid",borderBottomColor:"#08a1ef"}},choices:'{"seq":3,"options":[{"id":1,"label":"选项1"},{"id":2,"label":"选项2"},{"id":3,"label":"选项3"}]}',isInput:1,sceneId:ue.obj.sceneId,title:"",type:"c"};break;case"d":i=v(e,t),$.extend(!0,i,{width:"70px",height:"70px",lineHeight:"70px",color:"#66cc00",borderWidth:"0",borderStyle:"solid",borderColor:"#ccc",borderRadius:"35px",backgroundColor:"#f9f9f9"}),r={content:"",css:i,id:o,num:1,pageId:ue.obj.id,properties:{layout:"counter-tb",size:"counter-m",color:"#66cc00",icon:"icon-yulan"},sceneId:ue.obj.sceneId,title:"",type:"d"};break;case"h":i=v(e,t),$.extend(!0,i,{color:"#555",width:"100px",height:"100px"}),r={content:"",css:i,id:o,pageId:ue.obj.id,properties:{type:"rect"},sceneId:ue.obj.sceneId,title:null,type:"h"};break;case"i":i=v(e,t),$.extend(!0,i,{width:"70px",height:"70px",lineHeight:"70px",color:"#66cc00",borderWidth:"0",borderStyle:"solid",borderColor:"#ccc",borderRadius:"35px",backgroundColor:"#f9f9f9"}),r={content:"",css:i,id:o,num:1,pageId:ue.obj.id,properties:{layout:"counter-tb",size:"counter-m",color:"#66cc00",icon:"icon-dianzandian"},sceneId:ue.obj.sceneId,title:"",type:"i"};break;case"l":i=v(e,t),$.extend(!0,i,{color:"rgb(255, 255, 255)",width:"100px",height:"40px",lineHeight:"40px",borderWidth:"0",borderStyle:"solid",borderColor:"#ccc",borderRadius:"0",backgroundColor:"rgb(244, 113, 31)"}),r={content:"",css:i,id:o,num:1,pageId:ue.obj.id,properties:{title:p.instant("common.scene.BUY")},sceneId:ue.obj.sceneId,title:null,type:"l"};break;case"m":i=v(e,t),i.width="320px",i.height="240px",r={content:"",css:i,id:o,num:1,pageId:ue.obj.id,properties:{width:"400px",height:"300px"},sceneId:ue.obj.sceneId,title:null,type:"m"};break;case"n":i=v(e,t),r={content:"",css:i,id:o,pageId:ue.obj.id,properties:{pics:[]},sceneId:ue.obj.sceneId,title:null,type:"n"};break;case"p":i=v(e,t),r={content:"",css:i,id:o,num:1,pageId:ue.obj.id,properties:{title:p.instant("common.scene.ATLAS")},sceneId:ue.obj.sceneId,title:null,type:"p"};break;case"r":i=v(e,t),i.width="200px",delete i.height,$.extend(!0,i,{color:"#676767",borderWidth:"1",borderStyle:"solid",borderColor:"#08a1ef",borderRadius:"0",backgroundColor:"#ffffff"}),r={content:"",css:i,id:o,num:1,pageId:ue.obj.id,properties:{titleStyle:{backgroundColor:"#08a1ef",color:"#ffffff"},optionStyle:{borderBottomWidth:"1",borderBottomStyle:"solid",borderBottomColor:"#08a1ef"}},choices:'{"seq":3,"options":[{"id":1,"label":"选项1"},{"id":2,"label":"选项2"},{"id":3,"label":"选项3"}]}',isInput:1,sceneId:ue.obj.sceneId,title:"",type:"r"};break;case"s":i=v(e,t),$.extend(!0,i,{color:"rgb(255, 255, 255)",width:"100px",height:"40px",lineHeight:"40px",borderWidth:"0",borderStyle:"solid",borderColor:"#ccc",borderRadius:"0",backgroundColor:"rgb(244, 113, 31)"}),r={content:"",css:i,id:o,num:1,pageId:ue.obj.id,properties:{title:p.instant("common.scene.SURPRISE")},sceneId:ue.obj.sceneId,title:null,type:"s"};break;case"t":i=v(e,t),i.width="200px",i.height="40px",$.extend(!0,i,{color:"#fff",borderRadius:"0",backgroundColor:"#66cc00"}),r={content:"",css:i,id:o,num:1,pageId:ue.obj.id,properties:{title:"下一页"},sceneId:ue.obj.sceneId,title:null,type:"t"};break;case"v":i=v(e,t),i.width="200px",i.height="200px",r={content:"",css:i,id:o,num:1,pageId:ue.obj.id,properties:{src:""},sceneId:ue.obj.sceneId,title:null,type:"v"};break;case"x":i=v(e,t),$.extend(!0,i,{width:320,height:38}),r={content:p.instant("common.scene.EDIT_TIP"),css:i,id:o,num:1,pageId:ue.obj.id,properties:{dataUrl:""},sceneId:ue.obj.sceneId,title:null,type:(""+e).charAt(0)}}return n&&$.extend(!0,r,n),he.push(r),fe[r.id]=r,r}function x(e,n,i){var o=pe.wrapComp(n,"edit");$("#nr .edit_area").append(o);for(var r=pe.getInterceptors(),c=0;c<r.length;c++)r[c](o,n);return pe.getEventHandlers()[(""+e).charAt(0)](o,n),i||(l.addPageHistory(ue.obj.id,ue.obj.elements),t.$broadcast("dom.changed"),o.trigger("mousedown")),o}function I(e,t){var n=[];return"g101"==e&&(n.push(createCustomComp("501")),n.push(createCustomComp("502")),n.push(createCustomComp("503")),n.push(createCustomComp("601"))),n}function k(e,n){de.currentElemDef=n;var i=n.css.height||0;$(e).css({"min-height":i,cursor:"text"}),$(e).parents("li").hasClass("inside-active")||($(e).bind("click",function(e){e.stopPropagation()}),$(document).bind("mousedown",function(o){t.$broadcast("convert.html.canvas",n,e),$(e).css({"min-height":"inherit",cursor:"default"}),$("#btn-toolbar").find("input[type=text][data-edit]").blur(),$("#btn-toolbar")&&$("#btn-toolbar").remove(),$(e).unbind("click");var r=n.content;n.content=$(e).html(),r!=n.content&&t.$broadcast("hisChange"),$(e).children().css("color")&&(n.css.color=$(e).children().css("color"));var l=parseInt($(e).parent().height(),10);l>i&&(n.css.height=l,$(e).parents("li").height(l)),$(e).parents("li").removeClass("inside-active").css("user-select","none"),$(e).removeAttr("contenteditable"),window.getSelection&&window.getSelection().modify("move","right","line"),$(document).unbind("mousedown")}),$(e).parents("li").addClass("inside-active").css("user-select","text"),t.$broadcast("text.click",e))}function E(e,t){var n=function(t){if(!t.data)return g(e.id);e.properties.src=t.data,e.properties.id=t.id;var n=t.width/t.height;if(imgElem=$("#"+e.id),imgElem.length>0){var i=$("#inside_"+e.id).width();boxHeight=$("#inside_"+e.id).height(),boxRate=i/boxHeight,n>=boxRate?(imgElem.outerHeight(boxHeight),imgElem.outerWidth(boxHeight*n),imgElem.css("marginLeft",-(imgElem.outerWidth()-i)/2),imgElem.css("marginTop",0)):(imgElem.outerWidth(i),imgElem.outerHeight(i/n),imgElem.css("marginTop",-(imgElem.outerHeight()-boxHeight)/2),imgElem.css("marginLeft",0)),imgElem.attr("src",PREFIX_FILE_HOST+t.data),e.properties.imgStyle={},e.properties.imgStyle.width=imgElem.outerWidth(),e.properties.imgStyle.height=imgElem.outerHeight(),e.properties.imgStyle.marginTop=imgElem.css("marginTop"),e.properties.imgStyle.marginLeft=imgElem.css("marginLeft")}else t.width>$("#nr .edit_area").width()&&(t.width=$("#nr .edit_area").width(),t.height=t.width/n),t.height>$("#nr .edit_area").height()&&(t.height=$("#nr .edit_area").height(),t.width=t.height*n),e.css.width=t.width,e.css.height=t.height,e.properties.imgStyle={},e.properties.imgStyle.width=t.width,e.properties.imgStyle.height=t.height,e.properties.imgStyle.marginTop="0",e.properties.imgStyle.marginLeft="0",x(e.type,e)};return t?t.data?n(t):g(e.id):Z(e,function(e){n(e)},function(){e.properties.src||g(e.id)})}function j(e){me||n.open({windowClass:"console six-contain shape-console",templateUrl:"/Public/eq/6.0/templates/scene.console.shape.tpl.html",controller:"ShapeConsoleCtrl",resolve:{obj:function(){return e}}}).result.then(function(t){var n=$("#"+e.id);if(e.properties.type=t.type,e.properties.viewBox=t.viewBox,n.length){var i=$("#nr").find("#inside_"+e.id);i.remove(),x(e.type,e)}else x(e.type,e)},function(){$("#"+e.id).length||g(e.id)})}function S(e){me||n.open({windowClass:"console",templateUrl:"/Public/eq/6.0/templates/scene.console.adr.tpl.html",controller:"AdrConsoleCtrl",resolve:{obj:function(){return e}}}).result.then(function(t){var n=$("#"+e.id);if(e.properties.zoom=t[0].zoom,e.properties.pointX=t[0].pointX,e.properties.pointY=t[0].pointY,e.properties.mapSrc=t[0].src,n.length){var i=$("#nr").find("#inside_"+e.id);i.remove(),x(e.type,e)}else x(e.type,e)},function(){$("#"+e.id).length||g(e.id)})}function T(e){n.open({windowClass:"console seven-contain",templateUrl:"/Public/eq/6.0/templates/scene.console.button.tpl.html",controller:"ButtonConsoleCtrl",resolve:{obj:function(){return e}}}).result.then(function(t){e.properties.title=t.title,e.properties.number=t.number,$.extend(!0,e.css,t.btnStyle);var n=$("#"+e.id,$("#nr"));n.length>0&&n.parents("li").remove(),x(e.type,e)},function(){$("#"+e.id).length||g(e.id)})}function R(e,t,i){n.open({windowClass:"console six-contain",templateUrl:"/Public/eq/6.0/templates/scene.console.turnTo.tpl.html",controller:"TurnToConsoleCtrl",resolve:{obj:function(){return{type:e,mType:t,data:i}}}}).result.then(function(e){i.properties.title=e.title,i.properties.number=e.number,$.extend(!0,i.css,e.btnStyle);var t=$("#"+i.id,$("#nr"));t.length>0&&t.parents("li").remove(),x(i.type,i)},function(){$("#"+i.id).length||g(i.id)})}function _(e){me||(me=n.open({windowClass:"console six-contain",templateUrl:"/Public/eq/6.0/templates/scene.console.tel.tpl.html",controller:"TelConsoleCtrl",resolve:{obj:function(){return e}}}).result.then(function(t){me=null,e.properties.title=t.title,e.properties.number=t.number,t.title.replace(/ /g,"&nbsp;"),$.extend(!0,e.css,t.btnStyle),$("#"+e.id).length>0&&$("#"+e.id).parents("li").remove(),x(e.type,e)},function(){me=null,$("#"+e.id).length||g(e.id)}))}function U(e){me||(me=n.open({windowClass:"console seven-contain",templateUrl:"/Public/eq/6.0/templates/scene.console.input.tpl.html",controller:"InputConsoleCtrl",resolve:{obj:function(){return e}}}).result.then(function(t){me=null,t.type&&(e.type=t.type),e.properties.placeholder=t.title,e.properties.required=t.required,e.title=t.title,$.extend(!0,e.css,t.btnStyle);var n=$("#"+e.id);n.length>0&&n.parents("li").remove(),x(e.type,e)},function(){me=null,$("#"+e.id).length||g(e.id)}))}function L(e){me||(me=n.open({windowClass:"console eight-contain",templateUrl:"/Public/eq/6.0/templates/scene.console.radio-checkbox.tpl.html",controller:"RadioCheckboxConsoleCtrl",resolve:{obj:function(){return e}}}).result.then(function(t){me=null,e.title=t.title,e.type=t.type;var n=$("#nr").find("#inside_"+e.id);n.length&&n.remove(),x(e.type,e)},function(){me=null,$("#"+e.id).length||g(e.id)}))}function F(e){me||(me=n.open({windowClass:"console seven-contain",templateUrl:"/Public/eq/6.0/templates/scene.console.rating.tpl.html",controller:"RatingConsoleCtrl",resolve:{obj:function(){return e}}}).result.then(function(t){me=null;var n=$("#nr").find("#inside_"+e.id);n.length&&n.remove(),x(e.type,e)},function(){me=null,$("#"+e.id).length||g(e.id)}))}function q(e){me||(me=n.open({windowClass:"console six-contain",templateUrl:"/Public/eq/6.0/templates/scene.console.counter.tpl.html",controller:"CounterConsoleCtrl",resolve:{obj:function(){return e}}}).result.then(function(t){me=null,$.extend(!0,e.css,t.btnStyle),$("#"+e.id).length>0&&$("#"+e.id).parents("li").remove(),x(e.type,e)},function(){me=null,$("#"+e.id).length||g(e.id)}))}function M(e){me||(me=n.open({windowClass:"console six-contain",templateUrl:"/Public/eq/6.0/templates/scene.console.statistics-component.tpl.html",controller:"StatisticsConsoleCtrl",resolve:{obj:function(){return e}}}).result.then(function(t){me=null,$.extend(!0,e.css,t.btnStyle),$("#"+e.id).length>0&&$("#"+e.id).parents("li").remove(),x(e.type,e)},function(){me=null,$("#"+e.id).length||g(e.id)}))}function A(e){me||(me=n.open({windowClass:"console six-contain",templateUrl:"/Public/eq/6.0/templates/scene.console.link-component.tpl.html",controller:"LinkComponentConsoleCtrl",resolve:{obj:function(){return e}}}).result.then(function(t){me=null,isNaN(e.properties.url)&&(e.properties.url=PREFIX_S1_URL+"eqs/link?id="+e.sceneId+"&url="+encodeURIComponent(e.properties.url)),$.extend(!0,e.css,t.btnStyle),$("#"+e.id).length>0&&$("#"+e.id).parents("li").remove(),x(e.type,e)},function(){me=null,$("#"+e.id).length||g(e.id)}))}function X(e){me||(me=n.open({windowClass:"console six-contain",templateUrl:"/Public/eq/6.0/templates/scene.console.sound-component.tpl.html",controller:"SoundComponentConsoleCtrl",resolve:{obj:function(){return e}}}).result.then(function(t){me=null,t.title.replace(/ /g,"&nbsp;"),$.extend(!0,e.css,t.btnStyle),$("#"+e.id).length>0&&$("#"+e.id).parents("li").remove(),x(e.type,e)},function(){me=null,$("#"+e.id).length||g(e.id)}))}function D(e){me||(me=n.open({windowClass:"console seven-contain pictures1 pictures2",backdrop:"static",templateUrl:"/Public/eq/6.0/templates/scene.console.pictures1.tpl.html",controller:"pictures1Ctrl",resolve:{obj:function(){return e}}}).result.then(function(t){me=null,e.properties=t;var n=$("#inside_"+e.id);n.length&&n.remove(),x(e.type,e)},function(){me=null,$("#"+e.id).length||g(e.id)}))}function H(e,t){var n=re;N(n,2,function(e){n.bgAudio&&h.pushUsedFile(2,e.id),e.url||e.src?(h.removeUsedFile(2,e.id),n.bgAudio=e):n.bgAudio=null},function(){me=null})}function z(e,t){var n=re;B(n,2,function(e){n.bgAudio&&h.pushUsedFile(2,e.id),e.url||e.src?(h.removeUsedFile(2,e.id),n.bgAudio=e):n.bgAudio=null},function(){me=null})}function O(e,t){B(e,4,function(t){var n=$("#inside_"+e.id);t.src?(e.sound=t,n.children(".sound").length||$('<div class="sound eqf-music">').click(function(){O(e)}).appendTo(n)):(delete e.sound,n.children(".sound").remove())},function(){me=null})}function B(e,t,i,o){me||(me=n.open({windowClass:"console img_console",templateUrl:"/Public/eq/6.0/templates/scene.console.sound.tpl.html",controller:"soundCtrl",resolve:{obj:function(){return{elemDef:e,type:t}}}}).result.then(function(e){me=null,i(e)},function(){me=null}))}function N(e,t,i,o){me||(me=n.open({windowClass:"console six-contain",templateUrl:"/Public/eq/6.0/templates/scene.console.sound2.tpl.html",controller:"soundCtrl",resolve:{obj:function(){return{elemDef:e,type:t}}}}).result.then(function(e){me=null,i(e)},function(){me=null}))}function G(e){me||(me=n.open({windowClass:"console seven0-contain",templateUrl:"/Public/eq/6.0/templates/scene.console.video.tpl.html",controller:"VideoCtrl",resolve:{obj:function(){return e}}}).result.then(function(t){me=null,e.properties=t,$("#"+e.id).length||x(e.type,e)},function(){me=null,$("#"+e.id).length||g(e.id)}))}function W(e,n){n?function(n){if(3==n.type){var i={type:3,properties:{src:n.data,id:n.id}};n.height/n.width>=1008/642&&n.height/n.width<=1.578125?(t.$broadcast("scene.bg.replace",{type:"imgSrc",src:n.data,id:n.id},e),l.addPageHistory(ue.obj.id,ue.obj.elements)):te(i,function(n){t.$broadcast("scene.bg.replace",{type:"imgSrc",src:n.src,id:n.id},e),l.addPageHistory(ue.obj.id,ue.obj.elements)},function(){$("#"+e.id).length||g(e.id)})}"backgroundColor"==n.type&&(t.$broadcast("scene.bg.replace",n,e),l.addPageHistory(ue.obj.id,ue.obj.elements))}(n):Z(e,function(n){if("imgSrc"==n.type){var i={type:3,properties:{src:n.data,id:n.id}};n.height/n.width>=1008/642&&n.height/n.width<=1.578125?(t.$broadcast("scene.bg.replace",{type:"imgSrc",src:n.data,id:n.id},e),l.addPageHistory(ue.obj.id,ue.obj.elements)):te(i,function(n){t.$broadcast("scene.bg.replace",{type:"imgSrc",src:n.src,id:n.id},e),l.addPageHistory(ue.obj.id,ue.obj.elements)},function(){$("#"+e.id).length||g(e.id)})}"backgroundColor"==n.type&&(t.$broadcast("scene.bg.replace",n,e),l.addPageHistory(ue.obj.id,ue.obj.elements))},function(){$("#"+e.id).length||g(e.id)})}function J(e){me||(me=n.open({windowClass:"console six-contain randomevent-console",templateUrl:"/Public/eq/6.0/templates/scene.console.randomevent.tpl.html",controller:"RandomEventCtrl",resolve:{obj:function(){return e}}}).result.then(function(n){me=null,n&&0!==n.length&&(e.properties.pics=n,$("#"+e.id).length||x(e.type,e),t.$broadcast("create.randomevent.trigger",e))},function(){me=null,$("#"+e.id).length||g(e.id)}))}function Y(e){me||(me=n.open({windowClass:"console ppt_console",templateUrl:"/Public/eq/6.0/templates/scene.console.ppt.tpl.html",controller:"PptCtrl",resolve:{obj:function(){return e}}}).result.then(function(t){me=null,e.properties.src=t,$("#"+e.id).length||x(e.type,e)},function(){me=null,$("#"+e.id).length||g(e.id)}))}function V(e){me||(me=n.open({windowClass:"console psd_console",templateUrl:"/Public/eq/6.0/templates/scene.console.psd.tpl.html",controller:"PsdCtrl",resolve:{obj:function(){return{type:"z"}}}}).result.then(function(t){me=null,e.properties.src=t,$("#"+e.id).length||x(e.type,e)},function(){me=null,$("#"+e.id).length||g(e.id)}))}function Z(e,t,i){if(!me){var o="0";3==e.type&&(o="0"),4==e.type&&(o="1"),me=n.open({windowClass:"console img_console",templateUrl:"/Public/eq/6.0/templates/scene.console.bg.tpl.html",controller:"BgConsoleCtrl",resolve:{obj:function(){return{fileType:o,elemDef:e}}}}).result.then(function(e){me=null,e.data?t(e):i(e)},function(e){me=null,i(e)})}}function K(e,n,i){de.currentElemDef=e,t.$broadcast("showStylePanel",{activeTab:"style"})}function Q(e,n,i){de.currentElemDef=e,t.$broadcast("showStylePanel",{activeTab:"anim"})}function ee(e,n,i){de.currentElemDef=e,t.$broadcast("showStylePanel",{activeTab:"trigger"})}function te(e,t,i){f.load("controllers/scene.create.console.imageCrop").then(function(){me=n.open({windowClass:"console seven-contain pictures1",templateUrl:"/Public/eq/6.0/templates/scene.console.imageCrop.tpl.html",controller:"imageCropCtrl",backdrop:"static",resolve:{obj:function(){return e}}}).result.then(function(e){me=null,"function"==typeof t&&t(e)},function(e){me=null,"function"==typeof i&&i(e)})})}function ne(){$(".content").trigger("mousedown"),de.currentElemDef=null,t.$broadcast("showStylePanel",{activeTab:"trigger"})}function ie(e){e.sceneId=ue.obj.sceneId,n.open({windowClass:"console six-contain",templateUrl:"/Public/eq/6.0/templates/scene.console.link.tpl.html",controller:"LinkConsoleCtrl",resolve:{obj:function(){return e}}}).result.then(function(t){t&&"http://"!=t?(isNaN(t)?e.properties.url=PREFIX_S1_URL+"eqs/link?id="+e.sceneId+"&url="+encodeURIComponent(t):e.properties.url=t,$("#inside_"+e.id).find(".fa-link").removeClass("fa-link").addClass("fa-anchor")):(delete e.properties.url,$("#inside_"+e.id).find(".fa-anchor").removeClass("fa-anchor").addClass("fa-link"))})}function oe(e,t){var n=$(".element",e)[0];$(n).mousedown(function(e){$(this).parents("li").hasClass("inside-active")&&e.stopPropagation()}),$(n).bind("contextmenu",function(e){$(this).parents("li").hasClass("inside-active")?e.stopPropagation():$(this).blur()}),$(n).bind("dblclick",function(e){return!$("#nr").find(".mask-trigger").length&&(k(n,t),$("#popMenu").hide(),void e.stopPropagation())}),$(n).bind("keydown",function(e){e.stopPropagation()})}t.presentPageObj=null;var re,le,ce,se,ae,de={},pe=eqShow.templateParser("jsonParser"),ue=null,he=null,fe={},ge=($("#nr .edit_area"),0),be=!1;de.historyBack=function(){l.canBack(ue.obj.id)&&(he=l.back(ue.obj.id),m(he),b(he),t.$broadcast("close.style.panel"))},de.historyForward=function(){l.canForward(ue.obj.id)&&(he=l.forward(ue.obj.id),m(he),b(he),t.$broadcast("close.style.panel"))},de.createCompGroup=function(e,n){for(var i=I(e),o=0;o<i.length;o++){var r=w(i[o].type,n,i[o]);n=n?{left:n.left,top:parseInt(n.top,10)+50+"px"}:{left:"60px",top:"150px"},x(i[o].type,r,!0)}l.addPageHistory(ue.obj.id,ue.obj.elements),t.$broadcast("dom.changed")},createCustomComp=function(e,t){var n;switch(e){case"501":n={css:{left:"60px",top:"100px"},properties:{placeholder:p.instant("common.scene.NAME")},title:p.instant("common.scene.NAME"),type:501};break;case"502":n={properties:{placeholder:p.instant("common.scene.MOBILE")},title:p.instant("common.scene.MOBILE"),type:502};break;case"503":n={properties:{placeholder:p.instant("common.scene.EMAIL")},title:p.instant("common.scene.EMAIL"),type:503};break;case"601":n={css:{left:"110px"},properties:{title:p.instant("common.scene.COMMIT")},type:601}}return n},de.createComp=function(e,n,i){var o;if(searchVal="","g"==(""+e).charAt(0))return void de.createCompGroup(e,n);if("9"==(""+e).charAt(0))return void z(o,2);if("q"==(""+e).charAt(0))return void H(o,2);if(o=w(e,n),4==e)return"longpage"==i?void t.$broadcast("picture.show"):void E(o);if("h"==e)return void j(o);if("m"==e)return void S(o);if(5==e)return void U(o);if(6==e)return void T(o);if("t"==e)return void R(e,i,o);if(8==e)return void _(o);if(22==e)return void Y(o);if("z"==e)return void V(o);if("p"==e)return void D(o);if("v"==e)return void G(o);if(3==e)return"longpage"==i?void t.$broadcast("bg.show"):void W(o);if("r"==e||"c"==e)return void L(o);if("a"==e)return void F(o);if("i"==e)return i&&(o.properties.icon=i),void q(o);if("d"==e)return i&&(o.properties.icon=i),void M(o);if("l"==e)return void A(o);if("s"==e)return void X(o);if("n"==e)return void J(o);if(2==e||"x"==e){var r=x(e,o);$(".element",r).trigger("dblclick").focus(),setTimeout(function(){if(window.getSelection){var e=window.getSelection();e.modify("move","left","line"),e.modify("extend","right","line")}})}else x(e,o)},de.updateCompPosition=function(e,n,i){for(var o=0;o<he.length;o++)"inside_"+he[o].id==e&&(he[o].css?(he[o].css.left=n.left,he[o].css.top=n.top,i||l.addPageHistory(ue.obj.id,he)):(he[o].css=n,i||l.addPageHistory(ue.obj.id,he)));t.$$phase||t.$apply()},de.updateCompAngle=function(e,n){for(var i=0;i<he.length;i++)"inside_"+he[i].id==e&&(he[i].css?he[i].css.transform="rotateZ("+n+"deg)":he[i].css={},l.addPageHistory(ue.obj.id,he));t.$apply()},de.setCopy=function(e){be=e,t.$broadcast("copyState.update",e)},de.getCopy=function(){return be},de.getPageNames=function(t){var n="index.php?c=scene&a=pagelist&id="+t+"&date="+(new Date).getTime();return e({withCredentials:!0,method:"GET",url:PREFIX_URL+n})},de.changePageSort=function(t,n){var i="index.php?c=page&a=pageSort&id="+n+"&pos="+t+"&date="+(new Date).getTime();return e({withCredentials:!0,method:"GET",url:PREFIX_URL+i})},de.updateCompSize=function(e,n,i){for(var o=0;o<he.length;o++)"inside_"+he[o].id==e&&(he[o].css||(he[o].css={}),he[o].css.width=n.width,he[o].css.height=n.height,n.lineHeight&&(he[o].css.lineHeight=n.lineHeight),he[o].css.top=n.top,he[o].css.left=n.left,he[o].properties.width=n.width,he[o].properties.height=n.height,n.imgStyle&&(he[o].properties.imgStyle=n.imgStyle),i||l.addPageHistory(ue.obj.id,he));t.$$phase||t.$apply()},de.savePageNames=function(t){var n="index.php?c=page&a=savePageName",i={id:t.id,sceneId:t.sceneId,name:t.name};return e({withCredentials:!0,method:"POST",url:PREFIX_URL+n,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:$.param(i)})},de.resetCss=function(){$("#nr .edit_area li").each(function(e,t){var n=fe[t.id.replace(/inside_/g,"")];n&&(n.css||(n.css={}),n.css.zIndex=e)})},de.copyElement=function(){ge=0,ae=ue.obj.id;var e=c.getElements(),t=[];$.each(e,function(e,n){t.push(fe[n])}),ce=angular.copy(t),se=angular.copy(t),de.setCopy(!0)},de.isCurrentPageSubmitButtonAlreadyExist=function(){var e=!1;return angular.forEach(ue.obj.elements,function(t){6==(""+t.type).charAt(0)&&(e=!0)}),e},de.pasteElement=function(){for(var e=0,n=[],i=de.isCurrentPageSubmitButtonAlreadyExist(),o=0;o<ce.length;o++)if(6!==ce[o].type&&601!==ce[o].type||!i){ce[o].pageId=ue.obj.id,ce[o].id=C(),ae==ce[o].pageId?(e++,y(se[o],ce[o],e,ce.length)):(ge=0,ce[o].css=angular.copy(se[o].css));var r=angular.copy(ce[o]);he.push(r),fe[r.id]=r,n.push(x(r.type,r,!0))}ae=ue.obj.id,l.addPageHistory(ue.obj.id,ue.obj.elements),t.$broadcast("dom.changed"),angular.forEach(c.getElements(),function(e){$("#inside_"+e).children(".bar").hide()}),c.clearElements(),$.each(n,function(e,t){t.children(".bar").show(),c.addElement(t.attr("id").split("_")[1])})},de.openCropModal=function(e,t,n){te(e,t,n)},de.replaceBgImage=function(e,n,i){var o=e;n.style.backgroundImage="url("+PREFIX_FILE_HOST+o+")",i.properties.bgColor=null,i.properties.imgSrc=o,t.$broadcast("show.edit.bg")};var me=null;return utilTrigger.getSendType(),utilTrigger.getHandleType(),de.openTriggerMode=ne,pe.addInterceptor(function(e,n,i){function r(){var i=$('<ul id="popMenu" class="dropdown-menu" style="min-width: 150px; display: block;" role="menu" aria-labelledby="dropdownMenu1"><li class="edit" role="presentation"><a role="menuitem" tabindex="-1"><div class="eqf-write"></div>编辑</a></li><li class="style" role="presentation"><a role="menuitem" tabindex="-1"><div class="eqf-type"></div>样式</a></li><li class="animation" role="presentation"><a role="menuitem" tabindex="-1"><div class="eqf-move"></div>动画</a></li><li class="sound" role="presentation"><a role="menuitem" tabindex="-1"><div class="eqf-music"></div>音效</a></li><li class="trigger" role="presentation"><a role="menuitem" tabindex="-1"><div class="eqf-chufa"></div>触发</a></li><li class="link" role="presentation"><a role="menuitem" tabindex="-1"><div class="eqf-link"></div>链接</a></li><li class="copy" role="presentation"><a role="menuitem" tabindex="-1"><div class="eqf-scene-copy"></div>复制</a></li><li class="cut" role="presentation"><a role="menuitem" tabindex="-1"><div class="eqf-cut"></div>裁切</a></li><li role="presentation" class="bottom_bar"><a title="置顶"><div class="eqf-top up-all"></div></a><a title="上移一层"><div class="eqf-up up"></div></a><a title="下移一层"><div class="eqf-down down"></div></a><a title="置底"><div class="eqf-under down-all"></div></a><a title="删除"><div class="eqf-scene-delete remove"></div></a></li></ul>').css({position:"absolute","user-select":"none"});return be&&i.find(".copy").after($('<li class="paste" role="presentation"><a role="menuitem" tabindex="-1"><div class="eqf-print"></div>粘贴</a></li>')),i.find(".edit").click(function(t){switch(t.stopPropagation(),n.type.toString().charAt(0)){case"1":break;case"2":k(e.find(".element").get(0),n);break;case"x":k(e.find(".element").get(0),n);break;case"3":break;case"4":E(n);break;case"h":j(n);break;case"m":S(n);break;case"5":U(n);break;case"6":T(n);break;case"t":R(n);break;case"7":break;case"8":_(n);break;case"9":break;case"g":break;case"p":D(n);break;case"v":G(n);break;case"r":case"c":L(n);break;case"a":F(n);break;case"l":A(n);break;case"s":X(n);break;case"i":q(n);break;case"d":M(n);break;case"n":P(n)}i.hide()}),i.find(".style").click(function(t){t.stopPropagation(),K(n,function(t){if(1==n.type)for(var i in n.properties.labels)t.backgroundColor&&(n.properties.labels[i].color.backgroundColor=t.backgroundColor,$(".label_content").css("background-color",t.backgroundColor)),t.color&&(n.properties.labels[i].color.color=t.color,$(".label_content").css("color",t.color));else $(".element-box",e).css(t),$.extend(!0,n.css,t)}),i.hide()}),i.find(".animation").click(function(e){e.stopPropagation(),Q(n,function(e){n.properties.anim=e}),i.hide()}),i.find(".link").click(function(e){e.stopPropagation(),ie(n),i.hide()}),i.find(".remove").click(function(e){e.stopPropagation(),t.$broadcast("element.delete")}),i.find(".sound").click(function(e){e.stopPropagation(),O(n,4),i.hide()}),i.find(".trigger").click(function(e){e.stopPropagation();var t=utilTrigger.getHandleType();$.each(t,function(e,t){d.getSendIds(t.value,n.id)}),ee(n,function(e){n.properties.trigger=e}),i.hide()}),i.find(".down").click(function(t){var n=e,i=n.prev();if(!(i.length<=0)){console.log("down");var o,r,l=n.attr("id").slice(7),c=i.attr("id").slice(7),s=n.css("zIndex");if(n.css("zIndex",i.css("zIndex")),i.css("zIndex",s),i.before(n),he.length>1){for(var a=0;a<he.length;a++)if(he[a].id==l)o=a;else{if(he[a].id!=c)continue;r=a}var d=he[r];he[r]=he[o],he[o]=d}}}),i.find(".up").click(function(t){var n=e,i=n.next();if(!(i.length<=0)){console.log("up");var o,r,l=n.attr("id").slice(7).nextID=i.attr("id").slice(7),c=n.css("zIndex");if(n.css("zIndex",i.css("zIndex")),i.css("zIndex",c),i.after(n),he.length>1){for(var s=0;s<he.length;s++)if(he[s].id==l)o=s;else{if(he[s].id!=nextID)continue;r=s}var a=he[r];he[r]=he[o],he[o]=a}}}),i.find(".up-all").click(function(t){var n=e,i=n.siblings("li"),o=i.last(),r=n.attr("id").slice(7),l=[];o.after(n),n.css("zIndex",i.length+1),i.each(function(e,t){$(t).css("zIndex",e+1)}),console.log("up-all");for(var c=0;c<he.length;c++)he[c].id!=r&&l.push(he[c]);for(var c=0;c<he.length;c++)he[c].id==r&&l.push(he[c]);he=l}),i.find(".down-all").click(function(t){var n=e,i=n.siblings("li"),o=i.first(),r=n.attr("id").slice(7),l=[];o.before(n),n.css("zIndex",1),i.each(function(e,t){$(t).css("zIndex",e+2)}),console.log("down-all");for(var c=0;c<he.length;c++)he[c].id==r&&l.push(he[c]);for(var c=0;c<he.length;c++)he[c].id!=r&&l.push(he[c]);he=l}),i.find(".copy").click(function(e){e.stopPropagation(),$(".modal-dialog")[0]||de.copyElement(),i.hide()}),i.find(".paste").click(function(e){e.stopPropagation(),$(".modal-dialog")[0]||de.pasteElement(),
i.hide()}),i.find(".cut").click(function(e){e.stopPropagation(),te(n,function(){l.addPageHistory(ue.obj.id,ue.obj.elements)}),i.hide()}),2!=n.type&&4!=n.type&&"h"!=n.type&&"x"!=n.type&&i.find(".trigger").hide(),2!=n.type&&4!=n.type&&5!=n.type&&"h"!=n.type&&"x"!=n.type&&501!=n.type&&502!=n.type&&503!=n.type&&i.find(".sound").hide(),o.isAllowToAccess(o.accessDef.SCENE_EDIT_TRIGGER)||i.find(".trigger").hide(),o.isAllowToAccess(o.accessDef.SCENE_EDIT_SOUND)||i.find(".sound").hide(),4!=n.type&&"h"!=n.type&&"x"!=n.type&&i.find(".link").hide(),4!=n.type&&i.find(".cut").hide(),"p"==n.type&&(i.find(".animation").hide(),i.find(".style").hide()),(6==n.type||601==n.type)&&i.find(".copy").hide(),i}if("view"!=i){n.trigger&&d.setTrigger(n.id,n.trigger);var c=$("#eq_main");n.sound&&$('<div class="sound eqf-music">').click(function(){O(n)}).appendTo(e),e.on("contextmenu",".element-box",function(i){function o(e,t){$("#"+t).remove(),e.css({left:i.pageX+c.scrollLeft()+15,top:i.pageY+c.scrollTop(),zIndex:10001}).appendTo(c),c.mousemove(function(n){e=$("#"+t),(n.pageX<e.offset().left-20||n.pageX>e.offset().left+e.width()+20||n.pageY<e.offset().top-20||n.pageY>e.offset().top+e.height()+20)&&(e.hide(),$(this).unbind("mousemove"))})}if(i.stopPropagation(),"none"!=$(".select-panel").css("display"))return!1;if($("#nr").find(".mask-trigger").length){if(de.currentElemDef&&t.$broadcast("create.trigger.menu",e,i),!$(".edit_area").find(".switch-original").length){var l=$('<div class="switch">');e.append(l).children(".bar").hide()}return!1}$("#comp_setting:visible").length>0&&"p"!=n.type&&(de.currentElemDef=n,t.$broadcast("showStylePanel"));var s=r();return o(s,"popMenu"),!1}),e.on("click",function(t){return t.stopPropagation(),$("#nr").find(".mask-trigger").length?void 0:(K(n,function(t){if(1==n.type)for(var i in n.properties.labels)t.backgroundColor&&(n.properties.labels[i].color.backgroundColor=t.backgroundColor,$(".label_content").css("background-color",t.backgroundColor)),t.color&&(n.properties.labels[i].color.color=t.color,$(".label_content").css("color",t.color));else $(".element-box",e).css(t),$.extend(!0,n.css,t)}),!1)}),e.attr("title","按住鼠标进行拖动，点击鼠标进行编辑")}}),pe.bindEditEvent("2",function(e,t){oe(e,t)}),pe.bindEditEvent("x",function(e,t){oe(e,t)}),pe.bindEditEvent("3",function(e,t){}),pe.bindEditEvent("v",function(e,t){var n=$(".element",e)[0];$(n).unbind("dblclick"),$(n).bind("dblclick",function(){G(t),$("#popMenu").hide()})}),pe.bindEditEvent("4",function(e,t){var n=$(".element",e)[0];$(n).unbind("dblclick"),$(n).bind("dblclick",function(){return!$("#nr").find(".mask-trigger").length&&(E(t),void $("#popMenu").hide())})}),pe.bindEditEvent("m",function(e,t){var n=$(".element",e)[0];$(n).unbind("dblclick"),$(n).bind("dblclick",function(){return!$("#nr").find(".mask-trigger").length&&(S(t),void $("#popMenu").hide())})}),pe.bindEditEvent("n",function(e,t){var n=$(".element",e)[0];$(n).bind("dblclick",function(){return!$("#nr").find(".mask-trigger").length&&(P(t),void $("#popMenu").hide())})}),pe.bindEditEvent("h",function(e,t){var n=$(".element",e)[0];$(n).unbind("dblclick"),$(n).bind("dblclick",function(){return!$("#nr").find(".mask-trigger").length&&(j(t),void $("#popMenu").hide())})}),pe.bindEditEvent("5",function(e,t){var n=$(".element",e)[0];$(n).unbind("dblclick"),$(n).bind("dblclick",function(){U(t),$("#popMenu").hide()})}),pe.bindEditEvent("r",function(e,t){var n=$(".element",e)[0];$(n).unbind("dblclick"),$(n).bind("dblclick",function(){L(t),$("#popMenu").hide()})}),pe.bindEditEvent("c",function(e,t){var n=$(".element",e)[0];$(n).unbind("dblclick"),$(n).bind("dblclick",function(){L(t),$("#popMenu").hide()})}),pe.bindEditEvent("a",function(e,t){var n=$(".element",e)[0];$(n).unbind("dblclick"),$(n).bind("dblclick",function(){F(t),$("#popMenu").hide()})}),pe.bindEditEvent("p",function(e,t){var n=$(".element",e)[0];$(n).unbind("dblclick"),$(n).bind("dblclick",function(){D(t),$("#popMenu").hide()}),s.setProperties(t.properties)}),pe.bindEditEvent("6",function(e,t){var n=$(".element",e)[0];$(n).unbind("dblclick"),$(n).bind("dblclick",function(){T(t),$("#popMenu").hide()})}),pe.bindEditEvent("t",function(e,t){var n=$(".element",e)[0];$(n).unbind("dblclick"),$(n).bind("dblclick",function(){R(t),$("#popMenu").hide()})}),pe.bindEditEvent("8",function(e,t){var n=$(".element",e)[0];$(n).unbind("dblclick"),$(n).bind("dblclick",function(){_(t),$("#popMenu").hide()})}),pe.bindEditEvent("l",function(e,t){var n=$(".element",e)[0];$(n).unbind("dblclick"),$(n).bind("dblclick",function(){A(t),$("#popMenu").hide()})}),pe.bindEditEvent("s",function(e,t){var n=$(".element",e)[0];$(n).unbind("dblclick"),$(n).bind("dblclick",function(){X(t),$("#popMenu").hide()})}),pe.bindEditEvent("i",function(e,t){var n=$(".element",e)[0];$(n).unbind("dblclick"),$(n).bind("dblclick",function(){q(t),$("#popMenu").hide()})}),pe.bindEditEvent("d",function(e,t){var n=$(".element",e)[0];$(n).unbind("dblclick"),$(n).bind("dblclick",function(){M(t),$("#popMenu").hide()})}),de.templateEditor=pe,de.createByTpl=function(t){var n=PREFIX_URL+"index.php?c=scene&a=createBySys";return e({withCredentials:!0,method:"POST",url:n,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:$.param(t)})},de.getSceneDetail=function(t,n){var i="index.php?c=scene&a=detail&id="+t;return n&&(i+=(/\?/.test(i)?"&":"?")+"user="+n),le=e({withCredentials:!0,method:"GET",url:PREFIX_URL+i}),re=null,le.then(function(e){""==e.data.obj.bgAudio.url?e.data.obj.bgAudio=null:e.data.obj.bgAudio=e.data.obj.bgAudio,re=e.data.obj}),le},de.getCurrentScene=function(){return re},de.getCurrentScenePromise=function(){return le},de.saveSceneSettings=function(t){t=angular.copy(t),angular.isObject(t.bgAudio)&&(t.bgAudio=JSON.stringify(t.bgAudio)),t.image=null;var n="index.php?c=scene&a=saveSettings";return e({withCredentials:!0,method:"POST",url:PREFIX_URL+n,headers:{"Content-Type":"text/plain; charset=UTF-8"},data:JSON.stringify(t)})},de.publishScene=function(t){var n="index.php?c=scene&a=publish&id="+t,i=new Date;return n+="&time="+i.getTime(),e({withCredentials:!0,method:"GET",url:PREFIX_URL+n})},de.publishSceneLongPage=function(t,n){var i={temp:n},o="index.php?c=scene&a=publish&id="+t,r=new Date;return o+="&time="+r.getTime(),e({withCredentials:!0,method:"POST",url:PREFIX_URL+o,headers:{"Content-Type":"text/plain; charset=UTF-8"},data:JSON.stringify(i)})},de.closeScene=function(t){var n="index.php?c=scene&a=off&id="+t,i=new Date;return n+="&time="+i.getTime(),e({withCredentials:!0,method:"GET",url:PREFIX_URL+n})},de.openScene=function(t){var n="index.php?c=scene&a=on&id="+t,i=new Date;return n+="&time="+i.getTime(),e({withCredentials:!0,method:"GET",url:PREFIX_URL+n})},de.createBlankScene=function(t,n,i,o){var r={name:t,type:n,pageMode:i,islongpage:o},l="index.php?c=scene&a=create";return e({withCredentials:!0,method:"POST",url:PREFIX_URL+l,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:$.param(r)})},de.copySceneById=function(t){var n="index.php?c=scene&a=createByCopy&id="+t;return e({withCredentials:!0,method:"GET",url:PREFIX_URL+n})},de.deleteSceneById=function(t,n){var i="index.php?c=scene&a=delscene&id="+t;return n&&(i+="&backup="+n),e({withCredentials:!0,method:"GET",url:PREFIX_URL+i})},de.revoke=function(t){var n="m/scene/revoke?id="+t+"&time="+(new Date).getTime();return e({withCredentials:!0,method:"GET",url:PREFIX_URL+n})},de.getSceneByPage=function(t,n,o){var r="";n||o?(r="index.php?c=scene&a=createpage&id="+t,o&&(r+="&copy=true")):r="index.php?c=scene&a=design&id="+t;var l=i.defer(),c=new Date;return r+=(/\?/.test(r)?"&":"?")+"time="+c.getTime(),e({withCredentials:!0,method:"GET",url:PREFIX_URL+r}).then(function(e){l.resolve(e),ue=e.data,ue.obj.elements||(ue.obj.elements=[]),he=ue.obj.elements;for(var t=0;he&&t<he.length;t++)fe[he[t].id]=he[t]},function(e){l.reject(e)}),l.promise},de.recordTplUsage=function(t){var n="index.php?c=scene&a=usepage&id="+t;return e({withCredentials:!0,method:"POST",url:PREFIX_URL+n})},de.getSceneTpl=function(t){var n=r.get("tplCache")?r.get("tplCache"):r("tplCache"),o=i.defer();if(n.get(t)){var l=$.extend(!0,{},n.get(t));l.data.obj.scene&&l.data.obj.scene.bgAudio&&(re.bgAudio=l.data.obj.scene.bgAudio);for(var c=0;c<l.data.obj.elements.length;c++){var s=l.data.obj.elements[c];s.id=C(),s.sceneId=ue.obj.sceneId,s.pageId=ue.obj.id}he=l.data.obj.elements;for(var a=0;a<he.length;a++)fe[he[a].id]=he[a];o.resolve(l)}else{var d="index.php?c=scene&a=syspageinfo&id="+t,p=new Date;d+=(/\?/.test(d)?"&":"?")+"time="+p.getTime(),e({withCredentials:!0,method:"GET",url:PREFIX_URL+d}).then(function(e){n.put(e.data.obj.id,$.extend(!0,{},e)),e.data.obj.scene&&e.data.obj.scene.bgAudio&&(re.bgAudio=e.data.obj.scene.bgAudio);for(var t=0;t<e.data.obj.elements.length;t++){var i=e.data.obj.elements[t];i.id=C(),i.sceneId=ue.obj.sceneId,i.pageId=ue.obj.id}he=e.data.obj.elements;for(var r=0;r<he.length;r++)fe[he[r].id]=he[r];o.resolve(e)},function(e){o.reject(e)})}return o.promise},de.saveScene=function(t){t.elements.length<he.length&&(console.log("controller 和 scene数据传递出错"),t.elements=he);var n="index.php?c=scene&a=savepage";return e({withCredentials:!0,method:"POST",url:PREFIX_URL+n,headers:{"Content-Type":"text/plain; charset=UTF-8"},data:JSON.stringify(t)})},de.deletePage=function(t){var n="index.php?c=scene&a=delPage&id="+t;return e({withCredentials:!0,method:"GET",url:PREFIX_URL+n})},de.createCustomComp=createCustomComp,de.openAudioModal=z,de.openBgModal=W,de.getElements=function(){return he},de.getElementsMap=function(){return fe},de.deleteElement=g,de.getSceneObj=function(){return ue},de.getCompanyTpls=function(t,n){var i="/m/scene/tpl/company/list?pageNo="+t+"&pageSize="+n;return e({withCredentials:!0,method:"GET",url:PREFIX_URL+i})},de.createCompanyTpls=function(t){var n="/m/scene/tpl/company/set?id="+t;return e({withCredentials:!0,method:"POST",url:PREFIX_URL+n})},de.clearCompanyTpls=function(t){var n="/m/scene/tpl/company/unset?id="+t;return e({withCredentials:!0,method:"POST",url:PREFIX_URL+n})},de.getPageTpls=function(n,i,o,r,l,c,s,a,d){var p="index.php?c=scene&a=syslist",u=new Date;p+=(/\?/.test(p)?"&":"?")+"time="+u.getTime();var h={tplType:1,bizType:i,tagId:o,order:c,freeTplSetting:s,name:a,createUser:d,pageNo:r?r:1,pageSize:l?l:12};return e({withCredentials:!0,method:"POST",url:PREFIX_URL+p,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:$.param(h)}).then(function(e){200==e.data.code&&(de.scenes=e.data,t.$broadcast("getSampleList",e.data))})},de.getPageTplTypesTwo=function(t,n){var i="index.php?c=upfile&a=systag&type=2&bizType="+n,o=new Date;return i+=(/\?/.test(i)?"&":"?")+"time="+o.getTime(),e({withCredentials:!0,method:"GET",url:PREFIX_URL+i})},de.saveMyTpl=function(t){var n="index.php?c=user&a=saveMyTpl";return e({withCredentials:!0,method:"POST",url:PREFIX_URL+n,headers:{"Content-Type":"text/plain; charset=UTF-8"},data:JSON.stringify(t)})},de.saveCompanyTpl=function(t){var n="index.php?c=company&a=saveMyTpl";return e({withCredentials:!0,method:"POST",url:PREFIX_URL+n,headers:{"Content-Type":"text/plain; charset=UTF-8"},data:JSON.stringify(t)})},de.previewScene=function(t){var n="index.php?c=user&a=getMyTpl&id="+t,o=new Date;n+=(/\?/.test(n)?"&":"?")+"time="+o.getTime();var l=i.defer();return e({withCredentials:!0,method:"GET",url:PREFIX_URL+n}).then(function(e){for(var t=r.get("tplCache")?r.get("tplCache"):r("tplCache"),n=0;n<e.data.list.length;n++){var i={data:{obj:{elements:e.data.list[n].elements,scene:e.data.obj}}};t.put(e.data.list[n].id,$.extend(!0,{},i))}l.resolve(e)}),l.promise},de.previewSceneLongpage=function(t,n,o,l,c,s){var a=n?"index.php?c=upfile&a=userList&pageNo="+(s?s:1)+"&pageSize=21&fileType="+(3==n?0:1):"index.php?c=user&a=getMyTpl&id="+t+"&islong=1",d=new Date;a+=(/\?/.test(a)?"&":"?")+"time="+d.getTime();var p=i.defer();return e({withCredentials:!0,method:"GET",url:PREFIX_URL+a}).then(function(e){for(var t=r.get("tplCache")?r.get("tplCache"):r("tplCache"),n=0;n<e.data.list.length;n++){var i={data:{obj:{elements:e.data.list[n].elements,scene:e.data.obj}}};t.put(e.data.list[n].id,$.extend(!0,{},i))}p.resolve(e)}),p.promise},de.transferScene=function(t,n){var i=PREFIX_URL+"index.php?c=scene&a=transfer";return i+="&loginName="+n,i+="&id="+t,i+="&time="+(new Date).getTime(),e({withCredentials:!0,method:"POST",url:i})},de.getSceneTemplatePrices=function(){var t=PREFIX_URL+"index.php?c=statics&a=scene_template_prices";return e({withCredentials:!0,method:"GET",url:t})},de.soundLink=function(t,n){var i="index.php?c=upfile&a=savewl&url="+t+"&fileType="+n,o=new Date;return i+="&time="+o.getTime(),e({withCredentials:!0,method:"GET",url:PREFIX_URL+i})},de.getElementData=w,de.addImg=E,de.addBg=W,de}]);