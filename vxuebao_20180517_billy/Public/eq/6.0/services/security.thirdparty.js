angular.module("security.thirdparty",["security.service"]).factory("thirdpartyService",["$rootScope","$http","$location","$window","security","$translate","i18nNotifications",function(e,t,n,i,o,r,a){function c(e){var t="https://graph.qq.com/oauth2.0/authorize?",n=client_id,i=["client_id="+n,"redirect_uri="+e,"scope=get_user_info","response_type=token"],o=i.join("&");return u=t+o}function s(e){var t="https://open.weixin.qq.com/connect/qrconnect?",n="wx5a3ca7ea184c3a3b",i=["appid="+n,"redirect_uri="+e,"scope=snsapi_login","response_type=code","state=WECHAT_STATE#wechat_redirect"],o=i.join("&");return d=t+o}var u,d,p={qqUrl:c,wxUrl:s,qqLogin:function(e,t){p.getThirdPartyInfo(e).then(function(n){var i=n.openid,o=(n.client_id,{email:"",password:"",openId:i,accessToken:e,type:"qq",expires:t});p.thirdPartLogin(o)})},thirdPartLogin:function(e){var i=t.post(PREFIX_URL+"index.php?c=otherlogin",$.param(e),{withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}});return i.then(function(e){if(200===e.status){if(e.data.success!==!0)return e.data;("/home"==n.path()||"/home/login"==n.path())&&n.path("main"),o.setLoginSuccess(!0),o.requestCurrentUser()}else o.isAuthenticated()},function(e){o.isAuthenticated()})},getThirdPartyInfo:function(e){var t="https://graph.qq.com/oauth2.0/me?access_token="+e;return $.ajax({type:"get",url:t,dataType:"jsonp",jsonp:"jsoncallback",jsonpCallback:"callback",xhrFields:{withCredentials:!0}})},weiChatLogin:function(e){return t.post(PREFIX_URL+"index.php?c=otherlogin&code="+e+"&type=weixin&time="+(new Date).getTime(),{},{withCredentials:!0,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}})},unbindRelation:function(n){var i={type:n},o="m/u/unRelation";t({withCredentials:!0,method:"POST",url:PREFIX_URL+o,data:$.param(i),headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}).then(function(t){t.data.success&&e.$broadcast("mail.unbind.success",n)})},wxBindAccount:function(e){p.bindAccountCommon(e)},qqBindAccount:function(e){p.getThirdPartyInfo(e.access_token).then(function(t){var n=t.openid,i=(t.client_id,{openId:n,accessToken:e.access_token,expires:e.expires_in,type:"qq"});p.bindAccountCommon(i)},function(e){})},bindAccountCommon:function(n){var i="m/u/bind/third";t({withCredentials:!0,method:"POST",url:PREFIX_URL+i,data:$.param(n),headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}).then(function(t){t.data.success?e.$broadcast("rel.success",n.type):a.pushForCurrentRoute("already.bind.error","notify.success",{msg:t.data.msg})},function(e){alert(r.instant("common.security.SERVER_ERROR"))})},openThirtyPartyWindow:function(e){var t,n=redirect_uri;"qq"==e?t=p.qqUrl(n):"weixin"==e&&(t=p.wxUrl(n)),i.open(t,"_blank","width=600,height=600,menubar=no,toolbar=no,location=no,directories=no,status=no,scrollbars=yes,resizable=yes")}};return p}]);