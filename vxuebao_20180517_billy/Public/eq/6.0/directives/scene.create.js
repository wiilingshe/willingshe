angular.module("scene.create",["app.directives.editor","services.scene","services.modal","app.directives.component","services.pagetpl","save.template","scene.create.console","app.directives.comp.editor","app.directives.addelement","scene.my.upload","services.i18nNotifications","services.history","security.service","scene.edit.select","scene.edit.common","scene.edit.keymap","scene.edit.bg","scene.userGuide","services.staticRes","scene.create.pageTpl","scene.create.hoverElement","scene.preview","services.file","services.dataCache","ui.bootstrap"]),angular.module("scene.create").directive("changeColor",function(){return{link:function(e,t,i){t.bind("click",function(){$(t).addClass("current")})}}}).directive("thumbTpl",["sceneService","ModalService","fileService",function(e,t,i){return{scope:{myTpl:"="},replace:!1,template:'<div class="delete-element hint--bottom hint--rounded" ng-click="deleteMyTpl($event)" data-hint="删除此文件"><span class="eqf-scene-delete"></span></div>',link:function(n,o,s){"LI"==o.get(0).tagName?(n.$emit("myPageList.delete",s.id,o),s.noDel&&o.empty(),n.deleteMyTpl=function(i){i.stopPropagation(),t.openConfirmDialog({msg:"确定删除此模板?"},function(){e.deletePage(n.myTpl.id).then(function(){n.$emit("myPageList.update",s.id,o,n.myTpl.id)},function(e){alert("服务器异常!")})})},$('<div class = "tmp-bg"></div>').appendTo(o),e.templateEditor.parse({def:n.myTpl,appendTo:o,mode:"view"}),$(".edit_area",o).css("transform","scale(0.25) translateX(-480px) translateY(-729px)")):(n.$emit("myPageList.delete",s.id,o.parent()),s.noDel&&o.empty(),n.deleteMyTpl=function(e){e.stopPropagation(),t.openConfirmDialog({msg:"确定删除此文件?"},function(){i.deleteFile1(n.myTpl.id).then(function(){n.$emit("myPageList.update",s.id,o.parent(),n.myTpl.id)},function(e){alert("服务器异常!")})})})}}}]).directive("converToImage",["selectService",function(e){function t(e,t,i){t.mousedown(function(e){$(".content").trigger("mousedown")})}return{restrict:"EA",link:t}}]).directive("switchBtn",[function(){return{require:"ngModel",restrict:"AE",template:'<div class="switch" ng-click="switch()"><div class="circle-con"><i class="circle"></i></div></div>',link:function(e,t,i,n){var o=t.find(".switch");n.$render=function(){o.toggleClass("switch-open",angular.equals(n.$modelValue,"enable")),o.toggleClass("switch-close",angular.equals(n.$modelValue,"disable"))},o.bind("click",function(){var t=o.hasClass("switch-open");e.$apply(function(){n.$setViewValue(t?"disable":"enable"),n.$render()})})}}}]).directive("loadErr",[function(){return{restrict:"A",link:function(e,t,i){t.bind("error",function(){i.$set("src","assets/images/create/pic.svg"),t.addClass("load-err")})}}}]).directive("closePanel",[function(){return{scope:{pause:"@",model:"@"},restrict:"A",templateUrl:"",link:function(e,t,i,n){function o(t){"false"==e.pause&&t.stopPropagation()}function s(t){e.$apply(function(){e.$eval("$parent."+e.model+"=false")})}var d=$(document);t.click(o),d.click(s),t.on("$destroy",function(){d.unbind("click",s),t.unbind("click")})}}}]).factory("gridGuide",["panStateTracker","DetectionBox","selectService","editAreaBorderCollisionDetector",function(e,t,i,n){var o={init:function(e,t){t?t:this.boxWidth,sessionStorage.getItem("pageid")==sessionStorage.getItem("longpageID")?sessionStorage.getItem("longpageHeight"):486;this.color=this.getColor()?this.getColor():"rgba(150, 150, 150, 0.2)",this.$container=e,this.render(),setTimeout(function(){"disable"!=o.getVisable()&&o.show()},1)},render:function(){$(".eq-block-grid").length>0&&$(".eq-block-grid").remove(),$(".eq-block-guides").length>0&&$(".eq-block-guides").remove(),this.domElement=$('<div class="eq-block-grid">'),this.canvasElement=$('<canvas class="eq-block-grid-inner">').appendTo(this.domElement)},show:function(){this.domElement.appendTo(this.$container),this.paint(),this.enabled=!0},hide:function(){this.domElement&&this.domElement.remove(),this.enabled=!1},setVisable:function(e){window.localStorage&&localStorage.setItem("sceneGridVisable",e)},getVisable:function(){return window.localStorage?localStorage.getItem("sceneGridVisable"):void 0},setColor:function(e){window.localStorage&&localStorage.setItem("sceneGridColor",e)},getColor:function(){return window.localStorage?localStorage.getItem("sceneGridColor"):void 0},getGuideState:function(){return window.localStorage?localStorage.getItem("sceneGridState"):void 0},setGuideState:function(e){window.localStorage&&localStorage.setItem("sceneGridState",e)},getSnapState:function(){return window.localStorage?localStorage.getItem("sceneSnapState"):void 0},setSnapState:function(e){window.localStorage&&localStorage.setItem("sceneSnapState",e)},paint:function(e,t){e||(e=this.boxWidth?this.boxWidth:32),t||(t=sessionStorage.getItem("pageid")==sessionStorage.getItem("longpageID")?sessionStorage.getItem("longpageHeight"):486);var i=320,n=t?t:486,o=Math.round(n/e),s=Math.round(i/e),d=e,a=e,r=(n-a*o)/2;this.canvasElement.css({left:0,top:0}),this.canvasElement.attr({width:i,height:n}),this.canvasElement.parent().css({width:i,height:n,marginRight:-160}),this.$container.find(".eq-block-guides").css({width:i,height:n});var c=this.canvasElement.get(0).getContext("2d");c.clearRect(0,0,i,n);for(var l=1;s>l;l++)c.fillStyle=this.color,c.fillRect(Math.floor(l*d),0,1,n);for(var g=1;o>g;g++)c.fillStyle=this.color,c.fillRect(0,Math.floor(g*a)+r,i,1)},getRows:function(){return 16},getCols:function(){return 10}},s={snap:!o.getSnapState()||o.getSnapState(),action:"move",threshold:1,enabled:!o.getGuideState()||o.getSnapState()},d={init:function(e){this.guides={h:[],v:[]},this.slideBounds={width:320,height:486,x:0,y:0},this.render(),e.append(this.domElement),this.options=s},render:function(){this.domElement=$('<div class="eq-block-guides">')},start:function(n){if(this.options.enabled){this.allBlocks=[],e.forEach(function(e,i){d.allBlocks.push(new t(e))}),this.targetBlocks=[],angular.forEach(i.getElements(),function(e){d.allBlocks.forEach(function(t){t.element.attr("id")=="inside_"+e&&d.targetBlocks.push(t)})}),this.gridLines=[];var a=o.getCols(),r=o.getRows(),c=Math.round(this.slideBounds.width/a),l=Math.round(this.slideBounds.height/r),g=(this.slideBounds.height-l*r)/2;if(o.enabled){for(var h=1;a>h;h++)this.gridLines.push(this.getCenterEdge({x:h*c,y:0,width:0,height:this.slideBounds.height},"grid-col-"+h,"horizontal"));for(var u=1;r>u;u++)this.gridLines.push(this.getCenterEdge({x:0,y:u*l+g,width:this.slideBounds.width,height:0},"grid-row-"+u,"vertical"))}this.gridLines.push(this.getCenterEdge({x:this.slideBounds.width/2,y:0,width:0,height:this.slideBounds.height},"grid-col-center","horizontal")),this.gridLines.push(this.getCenterEdge({x:0,y:this.slideBounds.height/2,width:this.slideBounds.width,height:0},"grid-row-center","vertical")),this.options=$.extend(s,n)}},stop:function(){this.clearGuideElements()},sync:function(e){this.options.enabled&&(this.findGuides(e),this.renderGuides())},findGuides:function(e){e=angular.extend({x:0,y:0,width:0,height:0},e),this.guides.h.length=0,this.guides.v.length=0;var t={x:n.bigDetectionBoxPointA.x+e.x,y:n.bigDetectionBoxPointA.y+e.y,width:n.bigDetectionBoxPointB.x-n.bigDetectionBoxPointA.x+e.width,height:n.bigDetectionBoxPointB.y-n.bigDetectionBoxPointA.y+e.height},i=this.getEdges(t,"target-bounds","resize"===this.options.action);this.combinedBounds=t,this.allBlocks.forEach(function(e){-1===d.targetBlocks.indexOf(e)&&d.compageEdges(i,d.getEdges(e.measure(),e.getID()),d.options.threshold)}),this.gridLines.forEach(function(e){d.compageEdges(i,e,d.options.threshold)}),this.guides.h.sort(function(e,t){return e.distance-t.distance}),this.guides.v.sort(function(e,t){return e.distance-t.distance})},enforceGuides:function(e){if(this.options.enabled){var t=this.options.threshold;this.options.threshold=3,this.findGuides(e),this.options.threshold=t;var i,n=0,o=0;this.guides.h.length&&(i=this.guides.h[0],n=i.compareEdge.x-i.targetEdge.x),this.guides.v.length&&(i=this.guides.v[0],o=i.compareEdge.y-i.targetEdge.y),e.x+=n,e.y+=o}},compageEdges:function(e,t,i){var n;e.h.forEach(function(e){t.h.forEach(function(t){n=Math.abs(e.x-t.x),i>n&&d.guides.h.push({distance:n,targetEdge:e,compareEdge:t})})}),e.v.forEach(function(e){t.v.forEach(function(t){n=Math.abs(e.y-t.y),i>n&&d.guides.v.push({distance:n,targetEdge:e,compareEdge:t})})})},renderGuides:function(){var e=[];this.guides.h.forEach(function(t){e.push(d.renderGuide(t))}),this.guides.v.forEach(function(t){e.push(d.renderGuide(t))}),this.clearGuideElements(e)},renderGuide:function(e){var t=e.targetEdge,i=e.compareEdge,n=$('[data-guide-id="'+i.id+'"]');0===n.length&&(n=$('<div data-guide-id="'+i.id+'">').appendTo(this.domElement),setTimeout(function(){n.addClass("show")},1));var o={top:Math.min(i.bounds.y,this.combinedBounds.y),right:Math.max(i.bounds.x+i.bounds.width,this.combinedBounds.x+this.combinedBounds.width),bottom:Math.max(i.bounds.y+i.bounds.height,this.combinedBounds.y+this.combinedBounds.height),left:Math.min(i.bounds.x,this.combinedBounds.x)};if("number"==typeof i.y){var s="s"===t.direction?-1:0;n.addClass("guide-h"),n.css({top:Math.floor(i.y+s),left:o.left,width:o.right-o.left})}else{var d="e"===t.direction?-1:0;n.addClass("guide-v"),n.css({left:Math.floor(i.x+d),top:o.top,height:o.bottom-o.top})}return i.id},getEdges:function(e,t,i){var n={h:[{id:t+"-h1",bounds:e,x:e.x,offset:0,direction:"w"},{id:t+"-h2",bounds:e,x:e.x+e.width/2,offset:-e.width/2,direction:"hc"},{id:t+"-h3",bounds:e,x:e.x+e.width,offset:-e.width,direction:"e"}],v:[{id:t+"-v1",bounds:e,y:e.y,offset:0,direction:"n"},{id:t+"-v2",bounds:e,y:e.y+e.height/2,offset:-e.height/2,direction:"vc"},{id:t+"-v3",bounds:e,y:e.y+e.height,offset:-e.height,direction:"s"}]};return i&&(n.h.splice(1,1),n.v.splice(1,1)),n},getCenterEdge:function(e,t,i){var n={h:[],v:[]};return"vertical"===i?n.v.push({id:t+"-v2",bounds:e,y:e.y+e.height/2,offset:-e.height/2,direction:t}):n.h.push({id:t+"-h2",bounds:e,x:e.x+e.width/2,offset:-e.width/2,direction:t}),n},clearGuideElements:function(e){var t=this.domElement.find(".guide-v, .guide-h");e&&e.length&&(t=t.filter(function(t,i){return-1===e.indexOf(i.getAttribute("data-guide-id"))})),t.remove()}};return{grid:o,guide:d}}]).directive("gridGuideSetting",["gridGuide",function(e){return{scope:!0,template:'<div class="grid-guide-setting"><div class="setting-group"><span>网格开关</span><div class="setting-choice"><switch-btn ng-model="config.gridState"></switch-btn></div></div><div class="setting-group"><span>网格大小</span><div class="setting-choice" style="margin-left: 40px;"><input type="number" min="10" max="320" style="width: 45px;height: 20px;color: #666;line-height: 20px;padding:0 0 0 5px;" ng-model="grid.boxWidth"></div></div><div class="setting-group" style="height:60px;"><span style="height:24px;">网格颜色</span><div class="color-contain"><input class="color-picker-input" ng-model="grid.color" type="text" /><a class="color-picker" ng-style="{backgroundColor: grid.color}" ng-model="grid.color" colorpicker="rgba" disable="{{gridGuideSetting.showFlag}}"></a></div></div><div class="setting-group"><span>智能参考</span><div class="setting-choice"><switch-btn ng-model="config.guideState"></switch-btn></div></div><div class="setting-group"><span>吸附效果</span><div class="setting-choice"><switch-btn ng-model="config.snapState"></switch-btn></div></div></div>',link:function(e,t){function i(){e.$apply(function(){e.gridGuideSetting.showFlag=!1})}var n=$(document);t.on("$destroy",function(){n.unbind("click",i)}),n.click(i)},controller:["$scope",function(t){t.findHeight=function(){return pageHeight=sessionStorage.getItem("pageid")==sessionStorage.getItem("longpageID")?sessionStorage.getItem("longpageHeight"):486,pageHeight},t.grid=e.grid,t.guide=e.guide,t.config={gridState:t.grid.getVisable()||"enable",guideState:"false"==t.grid.getGuideState()?"disable":"enable",snapState:"false"==t.grid.getSnapState()?"disable":"enable"},t.grid.boxWidth=32,t.$watch("config.gridState",function(e){t.container=!!$(".edit_wrapper")[0],"enable"===e?(t.$parent.gridGuideSetting.isGridEnabled=!0,t.container&&(t.grid.show(t.grid.boxWidth),t.findHeight())):"disable"===e&&(t.$parent.gridGuideSetting.isGridEnabled=!1,t.grid.hide()),t.grid.setVisable(e)}),t.$watch("grid.color",function(e){t.container=!!$(".edit_wrapper")[0],e&&(t.container&&t.grid.paint(t.grid.boxWidth,t.findHeight()),t.grid.setColor(e))}),t.$watch("config.guideState",function(e){t.container=!!$(".edit_wrapper")[0],t.container&&("enable"===e?(t.guide.options.enabled=!0,t.grid.setGuideState(!0)):"disable"===e&&(t.guide.options.enabled=!1,t.grid.setGuideState(!1)))}),t.$watch("grid.boxWidth",function(e){if(t.container=!!$(".edit_wrapper")[0],e){var i=parseInt(e,10);t.container&&t.grid.paint(i,t.findHeight())}}),t.$watch("config.snapState",function(e){t.container=!!$(".edit_wrapper")[0],t.container&&("enable"===e?(t.guide.options.snap=!0,t.grid.setSnapState(!0)):"disable"===e&&(t.guide.options.snap=!1,t.grid.setSnapState(!1)))})}]}}]);