angular.module("scene.create.console.setting.trigger").directive("eqxTrigger",["$compile","$translate","sceneService","triggerService",function(e,i,r,n){function t(e,i,t){var f=r.currentElemDef;e.$watch("sendType",function(i){1==i.value?f=e.elemDef=r.currentElemDef:2==i.value&&(f=e.elemDef=r.getSceneObj().obj)},!0);var v,h=$("#nr");h.find(".edit_area").find("li"),e.$on("element.triggered.add",function(i,r,n){$(".switch-original").remove(),v=$("#inside_"+e.elemDef.id);var t=$('<div class="switch-original">');v.append(t).children(".bar").hide(),a(e,e.elemDef,r,n)}),e.$on("create.trigger.menu",function(i,r,n){if(!r.find(".switch-original").length){var t=l(e,r);o(t,"triggerMenu",n)}}),e.$on("switch.triggered.state",function(i,r,n,t,a){var l=$("#inside_"+t);n.type,r?d(l,e.sendType,u,f.id,t,a):c(l,e.sendType,u,f.id,t,a)}),e.$on("show.random.trigger",function(i,r,t,a){n.getSendIds(u.RANDOMEVENT.value,r.id);var l=utilTrigger.getHandleType().RANDOMEVENT.value;g(e.sendType,l,r.id,t.id,a),n.getTrigger(r.id)}),e.$on("cancel.element.trigger",function(i,n,t,a){if(v=$("#inside_"+n),s(v,e.sendType,u,t,n,a),"n"==p[n].type&&($("#nr").find("#inside_"+n).remove(),r.deleteElement(n)),e.triggerEvents.length)for(var l=0;l<e.triggerEvents.length;l++){var d=!0;if(e.triggerEvents[l].handles)for(var c=0;c<e.triggerEvents[l].handles.length;c++)e.triggerEvents[l].handles[c].ids.length&&(d=!1);d&&(e.triggerEvents.splice(l,1),l--)}}),e.$on("select.trigger.original",function(i){var n=h.find(".edit_area").children("li");$('<div class="mask-trigger">').insertAfter(".edit_area").click(function(){$(this).remove(),n.each(function(){var e=$(this),i=e.attr("ctype"),r=parseInt(e.attr("id").replace("inside_",""),10);(2==i||4==i||"h"==i||"x"==i)&&e.css({"background-color":"","z-index":p[r].css.zIndex})});var i=parseInt($(".switch-original").parent().attr("id").replace("inside_",""),10);f=e.elemDef=r.currentElemDef=p[i],"4"==f.type?$scope.triggerOriginal="图片1":"2"==f.type?$scope.triggerOriginal="文字1":"h"==f.type?$scope.triggerOriginal="形状1":"x"==f.type&&($scope.triggerOriginal="多字体1"),e.$apply()}),n.each(function(){var e=$(this),i=e.attr("ctype");(2==i||4==i||"h"==i||"x"==i)&&e.css({"background-color":"rgba(255,255,255,0.9)","z-index":10001})})})}function a(i,r,t,a){var l=$("#nr"),d=l.find(".edit_area").children("li");l.find(".mask-trigger").remove(),e('<div class="trigger-elem-list" trigger-elem-list panel-draggable></div>')(i).appendTo(".content"),$('<div class="mask-trigger">').insertAfter("#nr .edit_area");var c;if(n.getTrigger(r.id)&&(c=n.getTrigger(r.id).sends),d.each(function(){var e=$(this),i=e.attr("ctype");(2==i||4==i||"h"==i||"x"==i)&&(e.css({"background-color":"rgba(255,255,255,0.9)","z-index":10001}),c&&c.length&&$.each(c,function(i,r){i!=a&&$.each(r.handles,function(i,r){r.ids.length&&$.each(r.ids,function(i,r){e.attr("id")=="inside_"+r&&e.css({"background-color":"","z-index":""})})})}))}),r){var s=[];$.each(u,function(e,i){if(2!=i.value){var t=n.getSendIds(i.value,r.id);$.each(t,function(e,i){s.push(i)})}}),$.each(s,function(e,i){var r=l.find("#inside_"+i);r.css({"background-color":"","z-index":""})}),$("#comp_setting").css({zIndex:"1060"})}}function l(e,i){var r=e.currentIndex,n=$('<ul id="triggerMenu" class="dropdown-menu" style="min-width: 100px; display: block;" role="menu" aria-labelledby="dropdownMenu1"><li class="trigger-show" role="presentation"><a role="menuitem" tabindex="-1"><div class="eqf-dengpao1"></div>显示</a></li><li class="trigger-hide" role="presentation"><a role="menuitem" tabindex="-1"><div class="eqf-dengpao1" style="color: #5F5F5F;"></div>隐藏</a></li><li class="trigger-none" role="presentation"><a role="menuitem" tabindex="-1"><div style="width: 21px;"></div>取消</a></li></ul>').css({position:"absolute","user-select":"none"}),t=$(".edit_area").find(".switch-original"),a=parseInt(t.parent().attr("id").replace("inside_",""),10),l=parseInt(i.attr("id").replace("inside_",""),10);return n.children(".trigger-show").click(function(){d(i,e.sendType,u,a,l,r),n.hide(),e.$apply()}),n.children(".trigger-hide").click(function(){c(i,e.sendType,u,a,l,r),n.hide(),e.$apply()}),n.children(".trigger-none").click(function(){s(i,e.sendType,u,a,l,r),n.hide(),$.each(e.triggerElements,function(e,i){l==i.id&&(i.checked=!1,i.triggerType="")}),e.$apply()}),n}function d(e,i,r,t,a,l){e.children(".boom").length||(e.children(".boom1").remove(),$('<div class="boom">').appendTo(e),n.deleteTrigger(i.value,r.HIDE.value,t,a,l),n.addTrigger(i.value,r.SHOW.value,t,a,l))}function c(e,i,r,t,a,l){e.children(".boom1").length||(e.children(".boom").remove(),$('<div class="boom1">').appendTo(e),n.deleteTrigger(i.value,r.SHOW.value,t,a,l),n.addTrigger(i.value,r.HIDE.value,t,a,l))}function s(e,i,r,t,a,l){e.children(".boom, .boom1").remove(),n.deleteTrigger(i.value,r.SHOW.value,t,a,l),n.deleteTrigger(i.value,r.HIDE.value,t,a,l),n.deleteTrigger(i.value,r.RANDOMEVENT.value,t,a,l)}function g(e,i,r,t,a){n.deleteTrigger(e.value,i,r,t,a),n.addTrigger(e.value,i,r,t,a)}function o(e,i,r){var n=$("#eq_main");$("#"+i).remove(),e.css({left:r.pageX+n.scrollLeft()+15,top:r.pageY+n.scrollTop(),zIndex:10001}).appendTo(n),n.mousemove(function(r){e=$("#"+i),(r.pageX<e.offset().left-20||r.pageX>e.offset().left+e.width()+20||r.pageY<e.offset().top-20||r.pageY>e.offset().top+e.height()+20)&&(e.hide(),$(this).unbind("mousemove"))})}var u=(utilTrigger.getSendType(),utilTrigger.getHandleType()),p=r.getElementsMap();return{restrict:"EA",link:t}}]).directive("leavePanel",function(){function e(e,i,r){i.hover(function(){},function(){e.obj={showTriggerPanel:!1},e.$apply()})}return{restrict:"EA",link:e}}).directive("triggerElemList",["$translate","sceneService","triggerService",function(e,i,r){function n(e,n,a){var l=angular.copy(i.getSceneObj().obj.elements),d=i.getElementsMap(),c={};e.triggerElements=[];var s;1==e.sendType.value?s=e.elemDef.trigger:2==e.sendType.value&&(e.elemDef.properties||(e.elemDef.properties={}),s=e.elemDef.properties.trigger);var g=$("#nr").find(".edit_area").children("li");$.each(l,function(e,i){("2"==i.type||"4"==i.type||"h"==i.type||"x"==i.type)&&(c[i.type]||(c[i.type]=[]),c[i.type].push(i))}),$.each(c,function(i,r){$.each(r,function(i,r){"4"==r.type?r.name="图片":"2"==r.type?r.name="文字":"h"==r.type?r.name="形状":"x"==r.type&&(r.name="多字体"),r.name+=i+1,r.id!=e.elemDef.id&&e.triggerElements.push(r)})}),s&&s.sends&&$.each(s.sends,function(i,r){i!=e.currentIndex&&$.each(r.handles,function(i,r){r.ids.length&&$.each(r.ids,function(i,r){for(var n=0;n<e.triggerElements.length;n++)e.triggerElements[n].id==r&&(e.triggerElements.splice(n,1),n--)})})}),e.changed=function(i){i.checked?(r.deleteTrigger(e.sendType.value,t.HIDE.value,e.elemDef.id,i.id,e.currentIndex),r.addTrigger(e.sendType.value,t.SHOW.value,e.elemDef.id,i.id,e.currentIndex)):(r.deleteTrigger(e.sendType.value,t.SHOW.value,e.elemDef.id,i.id,e.currentIndex),r.deleteTrigger(e.sendType.value,t.HIDE.value,e.elemDef.id,i.id,e.currentIndex))},e.confirmList=function(){$(".mask-trigger").remove(),$(".trigger-list").remove(),e.elemDef&&($(".switch-original").remove(),$("#triggerMenu").hide(),$(".edit_area").find(".boom, .boom1").remove()),g.each(function(){var e=$(this),i=e.attr("ctype"),r=parseInt(e.attr("id").replace("inside_",""),10);(2==i||4==i||"h"==i||"x"==i)&&e.css({"background-color":"","z-index":d[r].css.zIndex})});var i,r=!1;1==e.sendType.value?i=e.elemDef.trigger:2==e.sendType.value&&(e.elemDef.properties||(e.elemDef.properties={}),i=e.elemDef.properties.trigger),i&&i.sends&&i.sends[e.currentIndex]?($.each(i.sends[e.currentIndex].handles,function(e,i){i.ids.length&&(r=!0)}),r||e.triggerEvents.splice(e.currentIndex,1)):e.triggerEvents.splice(e.currentIndex,1)},e.$watch("elemDef",function(i){var r;1==e.sendType.value?r=i.trigger:2==e.sendType.value&&(i.properties||(i.properties={}),r=i.properties.trigger),r&&r.sends&&$.each(r.sends,function(i,r){$.each(r.handles,function(i,r){$.each(r.ids,function(i,n){$.each(e.triggerElements,function(e,i){i.id==n&&(i.checked=!0,i.triggerType=r.type)})})})})},!0)}var t=(utilTrigger.getSendType(),utilTrigger.getHandleType());return{restrict:"EA",templateUrl:BASE_URL+"templates/scene.console.triggerelemlist.tpl.html",replace:!1,link:n}}]).directive("highlightElement",function(){function e(e,i,r){var n,t=$("#nr").find("li");setTimeout(function(){i.find(".trigger-elem").hover(function(i){n=$(this).attr("id").substring(8),$.each(t,function(i,r){"inside_"+e.elemDef.id!=$(r).attr("id")&&$(r).css({zIndex:"","background-color":""})}),$("#inside_"+n).css({"z-index":10001,"background-color":"rgba(255,255,255,0.9)"})},function(){$.each(e.triggerElements,function(e,i){$("#inside_"+i.id).css({"z-index":10001,"background-color":"rgba(255,255,255,0.9)"})})})},0)}return{restrict:"EA",link:e}});