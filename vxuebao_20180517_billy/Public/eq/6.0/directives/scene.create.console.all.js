angular.module("scene.create.console.imageCrop").directive("eqxCropPreview",["imageCropService","dataCacheService",function(t,e){function i(t,i){n(t,i),t.$on("$destroy",function(){p=!1}),t.$on("cropItem.change",function(t,e){r(e)}),t.$on("cropImage.ok",function(n,o){p||(d=o,e.clear("fileService"),s(t,i))}),t.$on("crop.success",function(e,i){4==d.type&&h(i),t.$close(i)})}function n(t,e){e.hide().load(function(){e.show();var i=$(".image_crop"),n={width:i.width(),height:i.height()},r=n.width/n.height;c={width:this.width,height:this.height};var s,h=c.width/c.height;c.width>n.width||c.height>n.height?h>r?(e.css({width:n.width,height:n.width/h}),s={position:"absolute",top:"50%",marginTop:-n.width/h/2}):(e.css({width:n.height*h,height:n.height}),s={margin:"auto"}):s={position:"absolute",left:"50%",top:"50%",marginLeft:-c.width/2,marginTop:-c.height/2},l={width:e.width(),height:e.height()},o(t,e,s)})}function o(t,e,i){var n=e.parent().attr("ctype"),o=l.width,r=l.height;if(3==n||"square"==n){var s=t.$parent.cropOption.currentItem;o>r?o=r*s.ratio:r=o/s.ratio,e.Jcrop({keySupport:!1,aspectRatio:s.ratio,allowSelect:!1,setSelect:[0,0,o,r],onRelease:function(){this.setOptions({setSelect:[0,0,o,r]})}},function(){a=this})}else e.Jcrop({keySupport:!1,aspectRatio:o/r,allowSelect:!1,setSelect:[0,0,o,r],onRelease:function(){this.setOptions({setSelect:[0,0,o,r]})}},function(){a=this});$(".jcrop-holder").css(i)}function r(t){var e,i=l.width,n=l.height;if(-1===t.ratio){var o=a.tellSelect();e=t.lock?{aspectRatio:o.w/o.h,setSelect:[0,0,o.w,o.h]}:{aspectRatio:0,setSelect:[0,0,o.w,o.h]}}else 0===t.ratio?e={aspectRatio:i/n,setSelect:[0,0,i,n]}:(i>n?i=n*t.ratio:n=i/t.ratio,e={aspectRatio:i/n,setSelect:[0,0,i,n]});a.setOptions(e)}function s(e,i){var n=a.tellSelect();if(n.w===l.width&&n.h===l.height||0===n.w&&0===n.h){if(!d)return;return void e.$dismiss(d.properties.src)}p=!0;var o=c.width/l.width;n.w=parseInt(n.w*o,10),n.h=parseInt(n.h*o,10),n.x=parseInt(n.x*o,10),n.y=parseInt(n.y*o,10),n.src=i.attr("src").split(PREFIX_FILE_HOST)[1],n.x+n.w>c.width&&(n.w=c.width-n.x),n.y+n.h>c.height&&(n.h=c.height-n.y),3==d.type?n.fileType=0:n.fileType=1,delete n.x2,delete n.y2,d.cw&&(n.cw=d.cw),t.cropImage(n)}function h(t){var e=d;e.properties.src=t.src;var i=t.width/t.height,n=$("#"+e.id),o=$("#inside_"+e.id),r=o.width(),s=o.height(),h=r/s;i>=h?(s=r/i,o.height(s),e.css.height=s,e.properties.height=s,n.outerHeight(s),n.outerWidth(r),n.css("marginLeft",0),n.css("marginTop",0)):(r=s*i,o.width(r),e.css.width=r,e.properties.width=r,n.outerWidth(r),n.outerHeight(s),n.css("marginTop",0),n.css("marginLeft",0)),n.attr("src",PREFIX_FILE_HOST+t.src),e.properties.imgStyle={},e.properties.imgStyle.width=n.outerWidth(),e.properties.imgStyle.height=n.outerHeight(),e.properties.imgStyle.marginTop=n.css("marginTop"),e.properties.imgStyle.marginLeft=n.css("marginLeft")}var a,c,l,d,p=!1;return{link:i}}]),angular.module("scene.create.console.link",["services.scene","common.directives.dropDown","ui.bootstrap"]).directive("limitLinkLength",["ModalService",function(t){var e=40;return{restrict:"A",require:"?ngModel",link:function(i,n,o,r){n.blur(function(){var i=n.val()||"";i.length>e&&t.openMsgDialog({msg:'<div align="left">提示：链接过长有可能会导致链接组件打不开，建议生成短链接后再使用。生成短链接地址<a href="http://dwz.cn" target="_blank"><font color="#08A1EF">http://dwz.cn</font></a></div>'},function(){})})}}}]),angular.module("scene.create.console.pictures1").directive("eqxPicturesCropPreview",["picturesCropService",function(t){function e(e,n){var o=t.getCoordinateObj();i(n,o),e.$on("$destroy",function(){a=c=l=null,t.initCoordinateObj(),t.setCropping(!1)}),e.$on("cropItem.change",function(t,e){s(e)}),e.$on("image.delete",function(){$(".image_crop").children("div").remove()}),e.$on("cropImage.ok",function(t,i){h(e,i,o)})}function i(t,e){var i=$(".image_crop"),o={width:i.width(),height:i.height()},r=o.width/o.height;t.hide().load(function(){var i={width:this.width,height:this.height};t.removeAttr("style").show();var s,h=i.width/i.height;i.width>o.width||i.height>o.height?h>r?(t.css({width:o.width,height:o.width/h}),s={position:"absolute",top:"50%",marginTop:-o.width/h/2}):(t.css({width:o.height*h,height:o.height}),s={margin:"auto"}):s={position:"absolute",left:"50%",top:"50%",marginLeft:-i.width/2,marginTop:-i.height/2},c={width:t.width(),height:t.height()};var a=t.attr("index");t.attr("src"),$.extend(e.items[a],{displaySize:c}),n(t,e,s,a)})}function n(t,e,i,n){a&&(a.destroy(),a=null);var r=c.width,s=c.height,h=e.items[n].coordinate;h&&(h.w>r&&(h.w=r,h.h=r/e.ratio),h.h>s&&(h.h=s,h.w=s*e.ratio),h.x2=h.x+h.w,h.y2=h.y+h.h);var d;d=l&&-1===l.ratio?0:e.ratio||r/s,t.Jcrop({keySupport:!1,aspectRatio:d,allowSelect:!1,setSelect:h?[h.x,h.y,h.x2,h.y2]:[0,0,r,s],onRelease:function(){this.setOptions({setSelect:[0,0,r,s]})},onSelect:function(){a&&o(n,e)}},function(){a=this,o(n,e)}),$(".jcrop-holder").css(i)}function o(t,e){var i=a.tellSelect();e.ratio=i.w/i.h,$.extend(e.items[t].coordinate,i),$.each(e.items,function(t,i){var n=i.coordinate;n&&r(n,e)})}function r(t,e){var i=t.w/t.h;i>e.ratio?(t.w=t.h*e.ratio,t.x2=t.x+t.w):(t.h=t.w/e.ratio,t.y2=t.y+t.h)}function s(t){l=t;var e,i=c.width,n=c.height;if(-1===t.ratio){var o=a.tellSelect();e=t.lock?{aspectRatio:o.w/o.h,setSelect:[0,0,o.w,o.h]}:{aspectRatio:0,setSelect:[0,0,o.w,o.h]}}else i>n?i=n*t.ratio:n=i/t.ratio,e={aspectRatio:i/n,setSelect:[0,0,i,n]};a.setOptions(e)}function h(e,i,n){var o=[];$.each(n.items,function(e,i){var s=i.coordinate,h=i.realSize;if(s&&h)if(r(s,n),Math.ceil(h.width/h.height*100)!==Math.ceil(s.w/s.h*100)){if(i.displaySize){var a=h.width/i.displaySize.width;s.w=Math.ceil(s.w*a),s.h=Math.ceil(s.h*a),s.x=Math.ceil(s.x*a),s.y=Math.ceil(s.y*a)}else{var c=s.w/s.h,l=h.width/h.height;l>c?(s.w=Math.ceil(h.height*c),s.h=h.height):(s.w=h.width,s.h=Math.ceil(h.width/c))}s.x+s.w>i.realSize.width&&(s.w=h.width-s.x),s.y+s.h>i.realSize.height&&(s.h=h.height-s.y),s.w===h.width&&s.h===h.height||0===s.w||0===s.h?o.push({src:s.src,desc:"",height:s.h,width:s.w}):(delete s.x2,delete s.y2,t.setCropping(!0),t.cropImage(s),t.setCropCount())}else o.push({src:s.src,desc:"",height:s.h,width:s.w})}),0===t.getCropCount()&&(i.picStyle=i.picStyle.value,i.children=o,e.setPicturesSize(i),e.$close(i))}var a,c,l;return{link:e}}]),angular.module("scene.create.console.radio.checkbox",[]),angular.module("scene.create.console.radio.checkbox").directive("stopPropagation",function(){return function(t,e){e.bind("keydown",function(t){t.stopPropagation()})}}),angular.module("scene.create.console.scene-setting-component").directive("sceneSettingComponent",[function(){return{scope:!0,controller:"SceneSettingComponentController",templateUrl:BASE_URL+"templates/scene.console.setting.component.tpl.html",link:function(t,e,i){setTimeout(function(){e.find(".scene-setting-info.fade").addClass("in")})}}}]),angular.module("scene.create.console.shape").directive("renderShapeElement",["shapeService","$compile",function(t,e){function i(i,n,o){function r(n){var o,r,c;$(".svg-panel ul").empty();for(var l=0;l<n.length;l++){var d=$('<li class="svg-element" ng-click="selectSvg('+l+')"></li>');if(e(d)(i),d.appendTo(".svg-panel ul"),n[l].type.indexOf("symbol")<0)r=document.createElementNS(eqxiuSvg.NAMESPACE,"svg"),r.setAttribute("style","position:absolute;left: 50%;margin-left:-32px;top:50%;margin-top:-32px;"),r.setAttribute("xmlns",eqxiuSvg.NAMESPACE),r.setAttribute("version","1.1"),r.setAttribute("width",h),r.setAttribute("height",a),r.setAttribute("preserveAspectRatio","xMidYMid"),c=eqxiuSvg.ShapeFromType(n[l].type),c.setAttribute("fill","#E2E2E2"),r.appendChild(c),d.append(r),s=eqxiuSvg.boundingBox(c),o=[Math.round(s.x)||0,Math.round(s.y)||0,Math.round(s.width)||32,Math.round(s.height)||32].join(" "),r.setAttribute("viewBox",o);else{c=eqxiuSvg.ShapeFromType(n[l].type,null,null,l),r='<svg class="svgElement" xmlns="'+eqxiuSvg.NAMESPACE+'" version="1.1" width="'+h+'" height="'+a+'" preserveAspectRatio="none">'+c+"</svg>",d.get(0).innerHTML=r,s=eqxiuSvg.boundingBox($("#path_"+l).get(0)),o=[Math.round(s.x)||0,Math.round(s.y)||0,Math.round(s.width)||32,Math.round(s.height)||32].join(" ");var p=d.find(".svgElement");p.get(0).setAttribute("viewBox",o),p.attr({style:"position:absolute;left: 50%;margin-left:-32px;top:50%;margin-top:-32px;"})}t.shapeList[l].viewBox=o,$(d).on("mouseover",function(t){$($($(t.target).find("svg")[0]).children()[0]).attr("fill",""),$($($(t.target).find("svg")[0]).children()[0]).attr("fill","#66cc00")}),$(d).on("mouseleave",function(t){$($($(t.target).find("svg")[0]).children()[0]).attr("fill",""),$($($(t.target).find("svg")[0]).children()[0]).attr("fill","#E2E2E2")})}}var h=(t.svgList,64),a=64;i.$on("render.shape.page",function(t,e){r(e)})}return{restrict:"EA",link:i}}]),angular.module("scene.create.console.sound").directive("eqxAudio",function(){function t(t,i){var n={};i.bind("pause",function(){i.attr("src")&&t.$apply(function(){n.isPlaying=!1})}).bind("play",function(){i.attr("src")&&t.$apply(function(){n.isPlaying=!0})});var o=i.get(0);t.$on("sound.play",function(t,i){e(n,i,o),n=i})}function e(t,e,i){var n,o={};o.src=e.src||e.url,n=0===o.src.indexOf("http://")?o.src:PREFIX_FILE_HOST+o.src;var r=n.substr(n.lastIndexOf("/")+1),s=i.src.substr(n.lastIndexOf("/")+1);null==t.id?r==s&&e.isPlaying?i.pause():r!=s||e.isPlaying?(i.src=n,i.play(),t.isPlaying=!1,e.isPlaying=!0):i.play():t.id==e.id&&e.isPlaying?i.pause():t.id!=e.id||e.isPlaying?(i.src=n,i.play(),t.isPlaying=!1,e.isPlaying=!0):i.play()}return{link:t}});