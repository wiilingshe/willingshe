!function(){function e(e){function n(n,t,o,r,i,a,c,s,l){function d(e,n){function o(){u(f)}e.$on("element.delete",function(e){f=a.getElements();for(var e=0,n=f.length;n>e;e++){var t=$("#nr").find("#inside_"+f[e]).attr("ctype");if("5"==t.charAt(0)||"a"==t||"r"==t||"c"==t)return void s.openConfirmDialog({msg:"将删除已收集的数据",confirmName:"确定",cancelName:"取消"},o)}u(f)}),e.$on("element.selectall",function(){p()}),e.$on("scene.bg.replace",function(n,o,r){var i=$("#nr .edit_area").parent(),a=i;e.currentBgDef=r;var c=$(".wrapper-background").get(0),s=sessionStorage.getItem("pageid")==sessionStorage.getItem("longpageID")?sessionStorage.getItem("longpageHeight"):486;if(c||(c=document.createElement("div"),$(c).prependTo(a).addClass("wrapper-background").css({height:s,backgroundSize:"cover",backgroundPosition:"50% 50%",zIndex:-1}).attr("id",r.id)),"imgSrc"==o.type){var l=o.src;l.indexOf("/Uploads/")>0&&(l=l.slice(l.indexOf("/Uploads/")+8)),c.style.backgroundImage="url("+PREFIX_FILE_HOST+l+")",r.properties.bgColor=null,r.properties.imgSrc=l,r.properties.id=o.id,t.$broadcast("show.edit.bg",l)}else"backgroundColor"==o.type&&(c.style.backgroundImage="none",c.style.backgroundColor=o.data.color,r.properties.imgSrc=null,r.properties.bgColor=o.data.color,t.$broadcast("show.edit.bg"))}),e.$on("remove.scene.bg",function(n){$(".wrapper-background").css({backgroundColor:"transparent",backgroundImage:"none"}).removeAttr("id"),e.controlView.showBgTag=!1}),e.$on("delete.random.elem",function(e,n){"n"==v[n].type&&($("#nr").find("#inside_"+n).remove(),i.deleteElement(n))}),e.$on("convert.html.canvas",function(e,n,t){}),e.$on("select.less.id",function(n,t){v[t]&&g(e,v[t],$("#nr #"+t).get(0))}),e.$on("select.less",function(n,t){t&&t.length&&$.each(t,function(n,t){v[t]&&g(e,v[t],$("#nr #"+t).get(0))})})}function g(e,t,o,r){if(r=r||window.html2canvas,"function"==typeof r&&"x"==t.type){var i=n.defer();e.completeHtml2Canvas=i.promise;var a=$(o).closest("li").clone();a.appendTo("#nr .edit_area").css({position:"absolute",zIndex:2,opacity:0,transform:""}),setTimeout(function(){var n=a.find(".element-box").get(0),o=a.width(),c=a.height();$(n).attr("style","").css({color:t.css.color,width:o+"px",height:c+"px"}),a.css({transform:""}),r(n,{width:o,height:c,onrendered:function(n){a.remove();n.toDataURL();i.resolve(),e.completeHtml2Canvas=null}})},0)}}function m(e){e=e||window.html2canvas,setTimeout(function(){var n=$(".edit_areaBox");e(n,{width:320,height:625,onrendered:function(e){var n=e.toDataURL();t.$broadcast("make.shortPic.complete",n)}})},0)}function u(e){var n=i.getSceneObj(),o=i.getElementsMap();utilTrigger.getHandleType(),c.addPageHistory(n.obj.id,n.obj.elements),$.each(e,function(e,n){l.resetTrigger(parseInt(n,10)),$("#nr").find("#inside_"+n).remove(),i.deleteElement(n)}),$.each(o,function(e,n){l.clearTrigger(e);var t=l.getTrigger(e);t?n.trigger=t:delete n.trigger}),c.addPageHistory(n.obj.id,n.obj.elements),a.clearElements(),t.$broadcast("hideStylePanel"),$("#popMenu").hide()}function p(){a.clearElements();var e=$("#nr").find("ul").find("li");e.children(".bar").show(),e.each(function(e,n){a.addElement($(n).attr("id").split("_")[1])})}t.$on("make.shortPic",function(){m(e)});var f,v=i.getElementsMap();return{restrict:"EA",link:d}}window.html2canvas=e,angular.module("scene.edit.common",["services.scene","services.select","services.history"]).directive("editCommon",["$q","$rootScope","$location","$translate","sceneService","selectService","historyService","ModalService","triggerService",n])}"function"==typeof define&&define.amd?require(["html2canvas"],function(n){e(n)}):e()}();