require(["hammer"],function(t){angular.module("app.directives.component",["services.scene","services.select","scene.create.console.pictures","scene.edit.trigger"]).directive("compDraggable",function(){return{restrict:"A",link:function(t,e,i){t.$on("$destroy",function(){$(e).draggable(),$(e).draggable("destroy"),e=null}),e.on("$destroy",function(){$(e).draggable(),$(e).draggable("destroy"),e=null}),$(e).draggable({revert:!1,stack:".comp-draggable",helper:"panel"==i.compDraggable||"page"==i.compDraggable?"clone":"",appendTo:"parent",containment:"panel"==i.compDraggable||"page"==i.compDraggable?"":"parent",zIndex:1049,opacity:.35,stop:function(t,e){$(t.toElement).one("click",function(t){t.stopImmediatePropagation()})}})}}}).directive("compDroppable",function(){return{restrict:"A",link:function(t,e,i){t.$on("$destroy",function(){$(e).droppable(),$(e).droppable("destroy"),e=null}),e.on("$destroy",function(){$(e).droppable(),$(e).droppable("destroy"),e=null}),$(e).droppable({accept:".comp-draggable",hoverClass:"drop-hover",drop:function(e,i){if(3!=i.draggable.attr("ctype")){var n={left:i.offset.left-$(this).offset().left+"px",top:i.offset.top-$(this).offset().top+"px"};"panel"==i.draggable.attr("comp-draggable")?t.createComp(i.draggable.attr("ctype"),n):t.updateCompPosition(i.draggable.attr("id"),n)}else t.createComp(3)}})}}}).directive("photoDraggable",function(){return{restrict:"A",link:function(t,e,i){t.$on("$destroy",function(){$(e).draggable(),$(e).draggable("destroy"),e=null}),e.on("$destroy",function(){$(e).draggable(),$(e).draggable("destroy"),e=null}),$(e).draggable({revert:!1,helper:"clone",appendTo:".img_list",zIndex:1049,opacity:.35,stop:function(t,e){$(t.toElement).one("click",function(t){t.stopImmediatePropagation()})}})}}}).service("Point",function(){function t(t,e){this.x=t,this.y=e}return t.prototype.add=function(e,i){return new t(this.x+e,this.y+i)},t.prototype.middle=function(e){return new t((this.x+e.x)/2,(this.y+e.y)/2)},t.prototype.detectionPointA=function(t){this.x=t.x<this.x?t.x:this.x,this.y=t.y<this.y?t.y:this.y},t.prototype.detectionPointB=function(t){this.x=t.x>this.x?t.x:this.x,this.y=t.y>this.y?t.y:this.y},t}).factory("DetectionBox",["Point",function(t){function e(t){this.element=t,this.init()}return e.prototype.init=function(){var e=this.element.position();this.startPointA=new t(e.left,e.top);var i=this.element.get(0);this.startPosition={top:parseInt(i.style.top,10)||0,left:parseInt(i.style.left,10)||0};var n=/[0-9]*[.]*[0-9]*deg/.exec(i.style.transform||i.style.webkitTransform||i.style.mozTransform||i.style.msTransform||i.style.oTransform||""),o=n&&n.length?n[0]:"0";this.angle=parseInt(o,10),this.radian=2*this.angle*Math.PI/360;var r=this.element.width(),a=this.element.height();this.elementWidth=r,this.elementHeight=a,this.left=this.startPosition.left,this.top=this.startPosition.top,this.ratio=r/a,this.width=Math.abs(r*Math.cos(this.radian))+Math.abs(a*Math.sin(this.radian)),this.height=Math.abs(r*Math.sin(this.radian))+Math.abs(a*Math.cos(this.radian)),this.startPointB=this.startPointA.add(this.width,this.height),this.startPointO=this.startPointA.middle(this.startPointB)},e.prototype.getID=function(){return this.element.attr("id")},e.prototype.measure=function(){return{x:this.startPointA.x,y:this.startPointA.y,width:this.width,height:this.height}},e}]).service("panStateTracker",function(){var t={},e={};return t.clear=function(){e={}},t.register=function(t){e[t.attr("id")]=t},t.isElementHasBeenRegisted=function(t){return!!e[t.attr("id")]},t.remove=function(t){delete e[t.attr("id")]},t.forEach=function(t){angular.forEach(e,t)},t}).controller("MouseCompSelectController",["$scope","$element","Point","DetectionBox","panStateTracker","selectService",function(t,e,i,n,o,r){function a(t,n,o,r,a){e.get(0).style.position="relative",this.startPositionX=t,this.startPositionY=n,this.width=o,this.height=r,this.selectAreaPointA=new i(t,n),this.selectAreaPointB=new i(t+o,n+r),this.startFlag=a,this.selectAreaTemplate=e.find(".edit-area-select-container"),this.selectAreaTemplate.length||(this.selectAreaTemplate=$('<div class="edit-area-select-container"></div>'),e.append(this.selectAreaTemplate));var s=e.offset(),l=$("#nr").offset();this.offset=s,this.containerOffset=l,$(window).resize(function(){angular.extend(s,e.offset()),angular.extend(l,$("#nr").offset())})}e.css("user-select","none");var s=this;s.allComponents=[],s.selectedComponents=[],a.prototype.selectStart=function(t,i){angular.extend(this.offset,e.offset()),angular.extend(this.containerOffset,$("#nr").offset()),s.allComponents=[],o.forEach(function(t){s.allComponents.push(t)}),this.startPositionX=t,this.startPositionY=i,this.startFlag=!0,this.updateSelectedElements()},a.prototype.isSelectStarted=function(){return this.startFlag},a.prototype.selectMove=function(t){this.width=t.clientX-this.startPositionX,this.height=t.clientY-this.startPositionY,this.updateCurrentPosition(),this.width>4&&this.height>4&&(this.updateSelectArea(),this.updateSelectedElements())},a.prototype.selectEnd=function(){this.startPositionX=this.startPositionY=this.width=this.height=0,this.startFlag=!1,this.updateCurrentPosition(),this.updateSelectArea()},a.prototype.getLocalPoint=function(t){return new i(t.x-this.offset.left,t.y-this.offset.top)},a.prototype.updateSelectArea=function(){var t=this.getLocalPoint(this.selectAreaPointA);this.selectAreaTemplate.css("left",t.x),this.selectAreaTemplate.css("top",t.y),this.selectAreaTemplate.height(this.height),this.selectAreaTemplate.width(this.width)},a.prototype.updateCurrentPosition=function(){this.selectAreaPointA.x=this.width>0?this.startPositionX:this.width+this.startPositionX,this.selectAreaPointA.y=this.height>0?this.startPositionY:this.height+this.startPositionY,this.width=Math.abs(this.width),this.height=Math.abs(this.height),this.selectAreaPointB.x=this.selectAreaPointA.x+this.width,this.selectAreaPointB.y=this.selectAreaPointA.y+this.height},a.prototype.updateSelectedElements=function(){s.selectedComponents=[];var t=this,e=r.getElements();angular.forEach(s.allComponents,function(i){var n=i.attr("id").split("_")[1];return t.contains(i)?(i.children(".bar").show(),void(-1===e.indexOf(n)&&r.addElement(n))):(-1!==e.indexOf(n)&&r.deleteElement(n),void i.children(".bar").hide())})},a.prototype.contains=function(t){var e=new n(t),o=new i(this.containerOffset.left+e.startPointO.x,this.containerOffset.top+e.startPointO.y),r=this.selectAreaPointA.y>804?this.selectAreaPointA.y+376:this.selectAreaPointA.y-214,a=this.selectAreaPointB.y>804?this.selectAreaPointB.y+376:this.selectAreaPointB.y-214;return o.x-296>=this.selectAreaPointA.x-502&&o.x-296<=this.selectAreaPointB.x-502&&o.y-100>=r&&o.y-100<=a};var l=new a(0,0,0,0,(!1));e.bind("mousedown",function(t){var e=$(t.target);$("#nr").find(".mask-trigger").length||e.hasClass("comp-resize")||e.parents("li.comp-resize").length||e.hasClass("ui-draggable")||e.parents(".ui-draggable").length||e.parents("#containment").length||e.parents(".create_left").length||($("body").css({"user-select":"none",cursor:"default"}),l.selectStart(t.clientX,t.clientY))}),e.bind("mousemove",function(t){l.isSelectStarted()&&l.selectMove(t)}),e.bind("mouseup",function(){l.isSelectStarted()&&($("body").css({"user-select":"initial",cursor:"default"}),l.selectEnd())})}]).directive("mouseCompSelect",[function(){return{restrict:"A",controller:"MouseCompSelectController"}}]).factory("editAreaBorderCollisionDetector",["DetectionBox","Point",function(t,e){function i(){this.editAreaWidth=320,this.editAreaHeight=486,this.detectionBoxs=[]}function n(){this.editArea=new i}return i.prototype.initDetectBoxWithElements=function(e){this.detectionBoxs=[];var i=this;angular.forEach(e,function(e){i.detectionBoxs.push(new t(e))})},n.prototype.initWithElements=function(t){this.editArea.initDetectBoxWithElements(t),this.initBigDetectionBoxPoints()},n.prototype.initBigDetectionBoxPoints=function(){this.bigDetectionBoxPointA=new e(this.editArea.editAreaWidth,this.editArea.editAreaHeight),this.bigDetectionBoxPointB=new e(0,0),this.minimumWidth=this.editArea.editAreaWidth,this.minimumHeight=this.editArea.editAreaHeight;var t=this;angular.forEach(this.editArea.detectionBoxs,function(e){t.bigDetectionBoxPointA.detectionPointA(e.startPointA),t.bigDetectionBoxPointB.detectionPointB(e.startPointB),t.minimumWidth>e.elementWidth&&(t.minimumWidth=e.elementWidth),t.minimumHeight>e.elementHeight&&(t.minimumHeight=e.elementHeight)});var i=(this.bigDetectionBoxPointA.x+this.bigDetectionBoxPointB.x)/2,n=(this.bigDetectionBoxPointA.y+this.bigDetectionBoxPointB.y)/2;this.bigDetectionBoxPointO=new e(i,n)},n.prototype.refreshBoxInfo=function(){angular.forEach(this.editArea.detectionBoxs,function(t){t.init()}),this.initBigDetectionBoxPoints()},n.prototype.translateIntoProperMoveDelta=function(t){var e={x:t.deltaX,y:t.deltaY};return e},n.prototype.compDragMoveDelta=function(t){return this.translateIntoProperMoveDelta(t)},new n}]).controller("MultiCompDragController",["selectService","$scope","$element","editAreaBorderCollisionDetector","panStateTracker","gridGuide","$rootScope",function(t,e,i,n,o,r,a){o.clear();var s=this;s.selectedComponents=[],s.initCollisionDetectorWithElements=function(){s.selectedComponents=[];var e=$("#nr");angular.forEach(t.getElements(),function(t){s.selectedComponents.push(e.find("#inside_"+t))}),n.initWithElements(s.selectedComponents)},s.isKeyboard=!1,s.compDragStart=function(e){t.getElements().length&&(s.initCollisionDetectorWithElements(),r.guide.start({action:"move"}),s.isKeyboard=!!e,s.isKeyboard||angular.forEach(s.selectedComponents,function(t){t.css("opacity",.35)}))},s.compDragMove=function(e){if(t.getElements().length){var i=n.compDragMoveDelta({deltaX:e.deltaX,deltaY:e.deltaY});!s.isKeyboard&&r.guide.options.snap&&r.guide.enforceGuides(i),angular.forEach(n.editArea.detectionBoxs,function(t){var e="translate3d("+i.x+"px, "+i.y+"px, 0) rotateZ("+t.angle+"deg)";t.element.css("transform",e)}),r.guide.sync(i),a.$broadcast("boxOuter")}},s.compDragEnd=function(i){if(t.getElements().length){angular.forEach(s.selectedComponents,function(t){t.css("opacity",1)});var o=n.compDragMoveDelta({deltaX:i.deltaX,deltaY:i.deltaY});!s.isKeyboard&&r.guide.options.snap&&r.guide.enforceGuides(o);var l=n.editArea.detectionBoxs.length;angular.forEach(n.editArea.detectionBoxs,function(t,i){var n="translate3d(0, 0, 0) rotateZ("+t.angle+"deg)";t.element.css("transform",n);var r={top:t.startPosition.top+o.y,left:t.startPosition.left+o.x};t.element.css("top",r.top),t.element.css("left",r.left),e.updateCompPosition(t.element.attr("id"),r,l-1>i)}),r.guide.stop(),a.$broadcast("boxOuter")}}}]).directive("multiCompDrag",function(){return{restrict:"A",controller:"MultiCompDragController"}}).directive("compDrag",["panStateTracker","$rootScope",function(e,i){return{require:"^multiCompDrag",restrict:"A",link:function(i,n,o,r){if(!e.isElementHasBeenRegisted(n)){if(e.register(n),n.on("$destroy",function(){e.remove(n)}),n.find("img").length){var a=$('<div class="dragTemplate" style="position: absolute;left: 0;top: 0;right: 0;bottom: 0;background-color: #fff;opacity: 0;"></div>');a.bind("dblclick",function(){a.siblings(".element").trigger("dblclick")}),n.find(".element-box-contents").append(a)}var s=new t(n.find(".element-box-contents").get(0));s.get("pan").set({threshold:0}),s.on("panstart",function(t){return!$(".edit_area").find(".switch").length&&(!n.hasClass("inside-active")&&(t.preventDefault(),t.srcEvent.preventDefault(),$("body").css({"user-select":"none",cursor:"default"}),void r.compDragStart()))}),s.on("panmove",function(t){return t.preventDefault(),!$(".edit_area").find(".switch").length&&(!n.hasClass("inside-active")&&void r.compDragMove(t))}),s.on("panend",function(t){return!$(".edit_area").find(".switch").length&&(!n.hasClass("inside-active")&&(r.compDragEnd(t),$("body").css({"user-select":"initial",cursor:"default"}),void $(t.srcEvent.target).one("click",function(t){return t.stopImmediatePropagation(),t.stopPropagation(),t.preventDefault(),!1})))})}}}}]).directive("compRotate",["$rootScope",function(e){return{restrict:"A",link:function(i,n,o){var r=$(n),a=$('<div class="bar bar-rotate bar-radius">');r.append(a).append('<div class="bar bar-line">');var s,l={},c=new t(a.get(0));c.get("pan").set({threshold:0}),c.on("panstart",function(t){$("body").css({"user-select":"none",cursor:'url("/assets/images/mouserotate.ico"), default'});var e=r.parent();l={x:parseFloat(r.css("left"))+e.offset().left+r.width()/2,y:parseFloat(r.css("top"))+e.offset().top+r.height()/2}}),c.on("panmove",function(t){var i=t.center,n=i.x-l.x,o=i.y-l.y,a=Math.abs(n/o);s=Math.atan(a)/(2*Math.PI)*360,n>0&&0>o?s=360+s:n>0&&o>0?s=180-s:0>n&&o>0?s=180+s:0>n&&0>o&&(s=360-s),s>360&&(s-=360),r.css({transform:"rotateZ("+s+"deg)"}),e.$broadcast("boxOuter")}),c.on("panend",function(t){$("body").css({"user-select":"initial",cursor:"default"}),i.updateCompAngle(r.attr("id"),s),i.$broadcast("updateTransform",s,r.attr("id").split("_")[1]),e.$broadcast("boxOuter")})}}}]).directive("compResize",["selectService","multiCompResize","Cursor","gridGuide","$rootScope",function(e,i,n,o,r){function a(e,n,a,s){a.css("cursor",s);var l,c=new t(a.get(0));c.get("pan").set({threshold:0,direction:t.DIRECTION_ALL}),c.on("panstart",function(){$("body").css({"user-select":"none",cursor:"default"}),i.resizeStart(n),o.guide.start({action:"resize"}),l=$(n).height()}),c.on("panmove",function(t){var e=i.resizeMove(n,s,t);if("DIV"===n.get(0).tagName){if(e.height<0&&$(n).height()<=486)return $(n).height(486);$(n).height(l+e.height),sessionStorage.setItem("longpageHeight",l+e.height)}o.guide.sync(e),r.$broadcast("boxOuter",l+e.height,n.get(0).tagName)}),c.on("panend",function(){$("body").css({"user-select":"initial",cursor:"default"}),i.resizeEnd(e,n),o.guide.stop(),r.$broadcast("boxOuter",$(n).height(),n.get(0).tagName)})}return{restrict:"A",link:function(t,i){var o=$('<div class="bar bar-n"><div class="bar-radius"></div></div>'),r=$('<div class="bar bar-s"><div class="bar-radius"></div></div>'),s=$('<div class="bar bar-e"><div class="bar-radius"></div></div>'),l=$('<div class="bar bar-w"><div class="bar-radius"></div></div>'),c=$('<div class="bar bar-ne bar-radius">'),d=$('<div class="bar bar-nw bar-radius">'),h=$('<div class="bar bar-se bar-radius">'),p=$('<div class="bar bar-sw bar-radius">'),u=$('<div class="bar bar-s long-bar" style="height: 30px;text-align:center;background:none; width: 60%;margin-left: 68px;margin-top: 18px;background-color: #eee;font-size:12px;line-height:30px;"><b style="display:inline-block;margin:0 10px;width: 0;height: 0;border-left: 5px solid transparent;border-right: 5px solid transparent;border-bottom: 10px solid #666;"></b>拖动调节页面高度<b style="display:inline-block;margin:0 10px;width: 0;height: 0;border-left: 5px solid transparent;border-right: 5px solid transparent;border-top: 10px solid #666;"></b></div>');"DIV"===i.get(0).tagName?(!isEmpty(t.longpage)||t.tpl.obj.properties&&t.tpl.obj.properties.longpage)&&!$(".edit_areaBox").find(".long-bar")[0]&&(i.append(u),u.show(),a(t,i,u,n.RESIZE_S)):(i.append(o).append(r).append(s).append(l).append(d).append(h).append(p).append(c).unbind("mousedown").mousedown(function(i){var n=!!$("#nr").find(".mask-trigger").length;if(!n){var o=$(this).attr("id").split("_")[1];if(i.ctrlKey||i.shiftKey)"none"!=$(this).children(".bar").first().css("display")?$(this).children(".bar").hide():($(this).children(".bar").show(),e.addElement(o));else{if("none"!=$(this).children(".bar").first().css("display"))return;$(this).children(".bar").show().end().siblings().children(".bar").hide(),e.clearElements(),e.addElement(o)}t.safeApply(function(){})}}),i.find(".element-box").unbind("click").bind("click",function(t){(t.ctrlKey||t.shiftKey)&&t.stopPropagation()}),i.parent().unbind("mousedown").mousedown(function(i){$(i.target).closest("li").length||($(this).children("li").children(".bar").hide(),t.$emit("hideStylePanel"),e.clearElements(),t.safeApply(function(){}))}),a(t,i,s,n.RESIZE_E),a(t,i,l,n.RESIZE_W),a(t,i,o,n.RESIZE_N),a(t,i,r,n.RESIZE_S),a(t,i,c,n.RESIZE_NE),a(t,i,d,n.RESIZE_NW),a(t,i,h,n.RESIZE_SE),a(t,i,p,n.RESIZE_SW))}}}]).service("Cursor",function(){var t={RESIZE_W:"w-resize",RESIZE_E:"e-resize",RESIZE_N:"n-resize",RESIZE_S:"s-resize",RESIZE_SE:"se-resize",RESIZE_SW:"sw-resize",RESIZE_NE:"ne-resize",RESIZE_NW:"nw-resize"};return t}).factory("multiCompResize",["selectService","picturesService","Cursor","editAreaBorderCollisionDetector","sceneService",function(t,e,i,n,o){var r,a,s=1,l=1,c=(n.editArea.editAreaWidth,n.editArea.editAreaHeight,null),d=null,h={};return h.selectedComponents=[],h.initCollisionDetectorWithElements=function(){h.selectedComponents=[];var e=$("#nr");angular.forEach(t.getElements(),function(t){h.selectedComponents.push(e.find("#inside_"+t))}),n.initWithElements(h.selectedComponents)},h.resizeStart=function(){h.initCollisionDetectorWithElements(),c=n.bigDetectionBoxPointA,d=n.bigDetectionBoxPointB,r=n.minimumWidth,a=n.minimumHeight},h.checkTopBorder=function(t,e){return this},h.checkRightBorder=function(t,e){return this},h.checkLeftBorder=function(t,e){return this},h.checkBottomBorder=function(t,e){return this},h.checkMinHeight=function(t,e,i,n){var o=Math.floor(i-n);return t.deltaY*e>o&&(t.deltaY=o*e),this},h.checkMinWidth=function(t,e,i,n){var o=Math.floor(i-n);return t.deltaX*e>o&&(t.deltaX=o*e),this},h.compResizeWithRatio=function(t,e){switch(e){case i.RESIZE_SE:angular.forEach(n.editArea.detectionBoxs,function(e){var i=parseInt(t.deltaY*e.ratio,10),n=t.deltaY,o={deltaX:i,deltaY:n};h.checkRightBorder(o,e.startPointB).checkBottomBorder(o,e.startPointB).checkMinHeight(o,-1,e.elementHeight,l).checkMinWidth(o,-1,e.elementWidth,s),i!==o.deltaX&&(n=o.deltaX/e.ratio,o.deltaY=Math.abs(n)<Math.abs(o.deltaY)?n:o.deltaY),t.deltaY=o.deltaY,t.deltaX=o.deltaX});break;case i.RESIZE_SW:angular.forEach(n.editArea.detectionBoxs,function(e){var i=parseInt(-t.deltaY*e.ratio,10),n=t.deltaY,o={deltaX:i,deltaY:n};h.checkLeftBorder(o,e.startPointA).checkBottomBorder(o,e.startPointB).checkMinHeight(o,-1,e.elementHeight,l).checkMinWidth(o,1,e.elementWidth,s),i!==o.deltaX&&(n=-o.deltaX/e.ratio,o.deltaY=Math.abs(n)<Math.abs(o.deltaY)?n:o.deltaY),t.deltaY=o.deltaY,t.deltaX=o.deltaX});break;case i.RESIZE_NE:angular.forEach(n.editArea.detectionBoxs,function(e){var i=parseInt(-t.deltaY*e.ratio,10),n=t.deltaY,o={deltaX:i,deltaY:n};h.checkTopBorder(o,e.startPointA).checkRightBorder(o,e.startPointB).checkMinHeight(o,1,e.elementHeight,l).checkMinWidth(o,-1,e.elementWidth,s),i!==o.deltaX&&(n=-o.deltaX/e.ratio,o.deltaY=Math.abs(n)<Math.abs(o.deltaY)?n:o.deltaY),t.deltaY=o.deltaY,t.deltaX=o.deltaX});break;case i.RESIZE_NW:angular.forEach(n.editArea.detectionBoxs,function(e){var i=parseInt(t.deltaY*e.ratio,10),n=t.deltaY,o={deltaX:i,deltaY:n};h.checkLeftBorder(o,e.startPointA).checkTopBorder(o,e.startPointA).checkMinHeight(o,1,e.elementHeight,l).checkMinWidth(o,1,e.elementWidth,s),i!==o.deltaX&&(n=o.deltaX/e.ratio,o.deltaY=Math.abs(n)<Math.abs(o.deltaY)?n:o.deltaY),t.deltaY=o.deltaY,t.deltaX=o.deltaX})}return this},h.resizeMove=function(t,e,o){var d={deltaX:o.deltaX,deltaY:o.deltaY},p=null;switch(e){case i.RESIZE_W:h.checkLeftBorder(d,c).checkMinWidth(d,1,r,s),p={x:d.deltaX,y:0,width:-d.deltaX,height:0},angular.forEach(n.editArea.detectionBoxs,function(t){t.element.css({left:t.left+d.deltaX,width:t.elementWidth-d.deltaX})});break;case i.RESIZE_E:p={x:0,y:0,width:d.deltaX,height:0},angular.forEach(n.editArea.detectionBoxs,function(t){t.element.css("width",t.elementWidth+d.deltaX)});break;case i.RESIZE_N:h.checkTopBorder(d,c).checkMinHeight(d,1,a,l),p={x:0,y:d.deltaY,width:0,height:-d.deltaY},angular.forEach(n.editArea.detectionBoxs,function(t){t.element.css({top:t.top+d.deltaY,height:t.elementHeight-d.deltaY})});break;case i.RESIZE_S:p={x:0,y:0,width:0,height:d.deltaY},angular.forEach(n.editArea.detectionBoxs,function(t){t.element.css("height",t.elementHeight+d.deltaY)});break;case i.RESIZE_SE:p={x:0,y:0,width:d.deltaX,height:d.deltaY},angular.forEach(n.editArea.detectionBoxs,function(t){var e=t.elementHeight+d.deltaY,i=e*t.ratio;t.element.css({height:e,width:i})});break;case i.RESIZE_SW:p={x:d.deltaX,y:0,width:-d.deltaX,height:d.deltaY},angular.forEach(n.editArea.detectionBoxs,function(t){var e=t.elementHeight+d.deltaY,i=e*t.ratio;t.element.css({left:t.left-(i-t.elementWidth),height:e,width:i})});break;case i.RESIZE_NE:p={x:0,y:d.deltaY,width:d.deltaX,height:-d.deltaY},angular.forEach(n.editArea.detectionBoxs,function(t){var e=t.elementHeight-d.deltaY,i=e*t.ratio;t.element.css({top:t.top+d.deltaY,height:e,width:i})});break;case i.RESIZE_NW:p={x:d.deltaX,y:d.deltaY,width:-d.deltaX,height:-d.deltaY},angular.forEach(n.editArea.detectionBoxs,function(t){var e=t.elementHeight-d.deltaY,i=e*t.ratio;t.element.css({top:t.top+d.deltaY,left:t.left-(i-t.elementWidth),height:e,width:i})})}return angular.forEach(h.selectedComponents,function(t){h.setChildrenSizeMove(t)}),p},h.setChildrenSizeMove=function(t){var e=t.children(".element-box"),i={width:e.width(),height:e.height()};if("4"==t.attr("ctype").charAt(0)||"n"==t.attr("ctype").charAt(0)){var n=t.find("img"),o=n.width()/n.height(),r=i.width/i.height;o>=r?(n.outerHeight(i.height),n.outerWidth(i.height*o),n.css("marginLeft",-(n.outerWidth()-i.width)/2),n.css("marginTop",0)):(n.outerWidth(i.width),n.outerHeight(i.width/o),n.css("marginTop",-(n.outerHeight()-i.height)/2),n.css("marginLeft",0))}else"p"==t.attr("ctype").charAt(0)?t.find(".fluxslider, .images, .image1, .image2").css({width:i.width,height:i.height}):(t.find(".element").css({width:i.width,height:i.height}),"i"!=t.attr("ctype")&&"d"!=t.attr("ctype")||t.find(".comp_counter").css({"line-height":i.height+"px"}))},h.resizeEnd=function(t){angular.forEach(h.selectedComponents,function(e,i){h.setChildrenSizeEnd(t,e,i<h.selectedComponents.length-1),t.$broadcast("updateMaxRadius",e)})},h.setChildrenSizeEnd=function(t,i,n){var r=i.position(),a={width:i.width(),height:i.height(),left:r.left,top:r.top};if("i"==i.attr("ctype")||"d"==i.attr("ctype"))a.lineHeight=a.height+"px";else if("4"==i.attr("ctype").charAt(0)||"n"==i.attr("ctype").charAt(0)){var s=i.find("img"),l={width:a.width,height:a.height,left:a.left,top:a.top,imgStyle:{width:s.width(),height:s.height(),marginTop:s.css("marginTop"),marginLeft:s.css("marginLeft")}};o.updateCompSize(i.attr("id"),l,n)}else if("p"==i.attr("ctype").charAt(0)){var c=e.getProperties();if(!c||!c.children)return;var d=i.find(".slider"),h=d.attr("id");d.empty();for(var p=0;p<c.children.length;p++)d.append('<img src="'+PREFIX_FILE_HOST+c.children[p].src+'">');utilPictures.deleteInterval(h),new flux.slider("#nr #"+h,{autoplay:c.autoPlay,delay:c.interval,pagination:!1,transitions:[utilPictures.getPicStyle(c.picStyle).name],width:a.width,height:a.height,bgColor:c.bgColor,onStartEnd:function(t){utilPictures.addInterval(h,t)}}),o.updateCompSize(i.attr("id"),a,n)}else o.updateCompSize(i.attr("id"),a,n)},h}]).directive("pasteElement",["sceneService",function(t){function e(){var e=$('<ul id="pasteMenu" class="dropdown-menu" style="min-width: 100px; display: block;" role="menu" aria-labelledby="dropdownMenu1"><li class="paste" style="text-align:center;" role="presentation"><a role="menuitem" tabindex="-1"><div class="fa fa-paste"></div>&nbsp;&nbsp;粘贴</a></li></ul>').css({position:"absolute","user-select":"none"});return e.find(".paste").on("click",function(){t.pasteElement(),e.hide()}),e}return{restrict:"EA",link:function(i,n,o){var r=$(n);r.on("contextmenu",function(i){if(t.getCopy()){var n=e(),o=$("#eq_main"),r=$("#pasteMenu");r.length>0&&r.remove(),o.append(n),n.css({left:i.pageX+o.scrollLeft()+15,top:i.pageY+o.scrollTop()}).show(),o.mousemove(function(t){var e=$("#pasteMenu");(t.pageX<e.offset().left-20||t.pageX>e.offset().left+e.width()+20||t.pageY<e.offset().top-20||t.pageY>e.offset().top+e.height()+20)&&(e.hide(),$(this).unbind("mousemove"))})}return!1})}}}]).directive("eqxEditDestroy",["selectService",function(t){return{link:function(e,i){i.on("$destroy",function(){t.clearElements(),utilPictures.clearInterval()})}}}]).directive("elementAnim",["selectService",function(t){function e(t,i,n,o){if(i.length&&o<i.length){var r=t.get(0);t.css("animation",""),r.offsetWidth=r.offsetWidth,t.css("animation",n[o]+" "+i[o].duration+"s ease 0s").css("animation-fill-mode","backwards"),t.one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){o++,e(t,i,n,o)})}}return{restrict:"EA",link:function(t,i){var n;t.$on("previewCurrentChange",function(t,e){n=n=$("#inside_"+e.elemId+" .element-box");var i=n.get(0);i.offsetWidth=i.offsetWidth,n.css("animation",e.animClasses[e.count]+" "+e.anim.duration+"s ease 0s").css("animation-fill-mode","backwards")}),t.$on("previewAllChanges",function(t,i){n=n=$("#inside_"+i.elemId+" .element-box"),e(n,i.animations,i.animClasses,i.count)})}}}]).directive("outerBox",["DetectionBox","i18nNotifications","storageService",function(t,e,i){return{restrict:"AE",link:function(n,o,r,a){function s(t){"red"==t?(l.show(),l.css("background-color","#ff5548"),o.find(".internal-box").toggleClass("out-warning",!1),isOuter=!0):"yellow"==t?(l.show(),isOuter=!1,l.css("background-color","#F2A653"),d&&o.find(".internal-box").toggleClass("out-warning",!0)):(isOuter=!1,o.find(".internal-box").toggleClass("out-warning",!1),l.hide()),d&&o.toggleClass("on",isOuter)}var l=$("#warn"),c="";l.click(function(){"red"==c?(e.removeAll(),e.pushForCurrentRoute("outbox.warning","notify.warning")):"yellow"==c&&(e.removeAll(),e.pushForCurrentRoute("outbox.tip","notify.warning"))});var d="false"==i.get("create.phoneView");d||(o.css("border-color","transparent"),o.find(".internal-box").css("border-color","transparent")),n.$on("switchBox",function(t,e){"longpage"!=e&&(d=!e,e?(o.css("border-color","transparent"),o.find(".internal-box").css("border-color","transparent")):(o.css("border-color",""),o.find(".internal-box").css("border-color",""),s(c)))}),n.$on("boxOuter",function(i){var o,r="",a=0,l=n.tpl.obj.elements;for(o=isEmpty(n.tpl.obj.properties&&n.tpl.obj.properties.longpage)?486:parseInt(n.tpl.obj.properties.longpage.longpageHeight);a<l.length;a++)if(l[a].type&&3!=l[a].type){var h=l[a].id,p=$("#inside_"+h);if(0!=p.length){var u=p.position(),g=new t(p);if(d&&(u.left<-29||u.top<-19||g.startPointB.y>o+17||g.startPointB.x>345)){r="red";break}(u.left<-1||u.top<-1||g.startPointB.y>o||g.startPointB.x>320)&&(r="yellow")}}c!=r&&("red"==r?(e.removeAll(),e.pushForCurrentRoute("outbox.warning","notify.warning")):"yellow"==r?(e.removeAll(),e.pushForCurrentRoute("outbox.tip","notify.warning")):e.removeAll()),c=r,s(r)})}}}])});