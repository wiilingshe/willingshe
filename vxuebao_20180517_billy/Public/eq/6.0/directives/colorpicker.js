angular.module("colorpicker.module",[]).factory("Helper",function(){return{closestSlider:function(e){var o=e.matches||e.webkitMatchesSelector||e.mozMatchesSelector||e.msMatchesSelector;return o.bind(e)("I")?e.parentNode:e},getOffset:function(e,o){for(var t=0,n=0,r=0,i=0;e&&!isNaN(e.offsetLeft)&&!isNaN(e.offsetTop);)t+=e.offsetLeft,n+=e.offsetTop,o||"BODY"!==e.tagName?(r+=e.scrollLeft,i+=e.scrollTop):(r+=document.documentElement.scrollLeft||e.scrollLeft,i+=document.documentElement.scrollTop||e.scrollTop),e=e.offsetParent;return{top:n,left:t,scrollX:r,scrollY:i}},stringParsers:[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return[e[1],e[2],e[3],e[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return[2.55*e[1],2.55*e[2],2.55*e[3],e[4]]}},{re:/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/,parse:function(e){return[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]}},{re:/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/,parse:function(e){return[parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16),parseInt(e[3]+e[3],16)]}}]}}).factory("Color",["Helper",function(e){return{value:{h:1,s:1,b:1,a:1},rgb:function(){var e=this.toRGB();return"rgb("+e.r+","+e.g+","+e.b+")"},rgba:function(){var e=this.toRGB();return"rgba("+e.r+","+e.g+","+e.b+","+e.a+")"},hex:function(){return this.toHex()},RGBtoHSB:function(e,o,t,n){e/=255,o/=255,t/=255;var r,i,a,l;return a=Math.max(e,o,t),l=a-Math.min(e,o,t),r=0===l?null:a===e?(o-t)/l:a===o?(t-e)/l+2:(e-o)/l+4,r=(r+360)%6*60/360,i=0===l?0:l/a,{h:r||1,s:i,b:a,a:n||1}},setColor:function(o){o=o.toLowerCase();for(var t in e.stringParsers)if(e.stringParsers.hasOwnProperty(t)){var n=e.stringParsers[t],r=n.re.exec(o),i=r&&n.parse(r);if(i)return this.value=this.RGBtoHSB.apply(null,i),!1}},setHue:function(e){this.value.h=1-e},setSaturation:function(e){this.value.s=e},setLightness:function(e){this.value.b=1-e},setAlpha:function(e){this.value.a=parseInt(100*(1-e),10)/100},toRGB:function(e,o,t,n){e||(e=this.value.h,o=this.value.s,t=this.value.b),e*=360;var r,i,a,l,s;return e=e%360/60,s=t*o,l=s*(1-Math.abs(e%2-1)),r=i=a=t-s,e=~~e,r+=[s,l,0,0,l,s][e],i+=[l,s,s,l,0,0][e],a+=[0,0,l,s,s,l][e],{r:Math.round(255*r),g:Math.round(255*i),b:Math.round(255*a),a:n||this.value.a}},toHex:function(e,o,t,n){var r=this.toRGB(e,o,t,n);return"#"+(1<<24|parseInt(r.r,10)<<16|parseInt(r.g,10)<<8|parseInt(r.b,10)).toString(16).substr(1)}}}]).factory("Slider",["Helper",function(e){var o={maxLeft:0,maxTop:0,callLeft:null,callTop:null,knob:{top:0,left:0}},t={};return{getSlider:function(){return o},getLeftPosition:function(e){return Math.max(0,Math.min(o.maxLeft,o.left+((e.pageX||t.left)-t.left)))},getTopPosition:function(e){return Math.max(0,Math.min(o.maxTop,o.top+((e.pageY||t.top)-t.top)))},setSlider:function(n,r){var i=e.closestSlider(n.target),a=e.getOffset(i,r);o.knob=i.children[0].style,o.left=n.pageX-a.left-window.pageXOffset+a.scrollX,o.top=n.pageY-a.top-window.pageYOffset+a.scrollY,t={left:n.pageX,top:n.pageY}},setSaturation:function(e,t){o={maxLeft:100,maxTop:100,callLeft:"setSaturation",callTop:"setLightness"},this.setSlider(e,t)},setHue:function(e,t){o={maxLeft:0,maxTop:100,callLeft:!1,callTop:"setHue"},this.setSlider(e,t)},setAlpha:function(e,t){o={maxLeft:0,maxTop:100,callLeft:!1,callTop:"setAlpha"},this.setSlider(e,t)},setKnob:function(e,t){o.knob.top=e+"px",o.knob.left=t+"px"}}}]).directive("colorpicker",["$document","$compile","Color","Slider","Helper",function(e,o,t,n,r){return{scope:{disable:"@"},require:"?ngModel",restrict:"A",link:function(i,a,l,s){var c,u={x:parseInt(l.x,10)||0,y:parseInt(l.y,10)||0},p=l.colorpicker?l.colorpicker:"hex",f=angular.isDefined(l.colorpickerPosition)?l.colorpickerPosition:"bottom",d=!!angular.isDefined(l.colorpickerInline)&&l.colorpickerInline,h=!!angular.isDefined(l.colorpickerFixedPosition)&&l.colorpickerFixedPosition,v=angular.isDefined(l.colorpickerParent)?a.parent():angular.element(document.body),g=!!angular.isDefined(l.colorpickerWithInput)&&l.colorpickerWithInput,m=g?'<input type="text" name="colorpicker-input">':"",k=d?"":'<button type="button" class="close close-colorpicker">&times;</button>',b='<div class="colorpicker dropdown" ng-click="$event.stopPropagation();"><div class="dropdown-menu"><colorpicker-saturation><i></i></colorpicker-saturation><colorpicker-hue><i></i></colorpicker-hue><colorpicker-alpha><i></i></colorpicker-alpha><colorpicker-preview></colorpicker-preview>'+m+k+"</div></div>",x=angular.element(b),w=t,y=x.find("colorpicker-hue"),L=x.find("colorpicker-saturation"),S=x.find("colorpicker-preview"),P=x.find("i");if(o(x)(i),i.disable&&i.$watch("disable",function(e,o){e!=o&&"false"==e&&F()}),g){var T=x.find("input");T.on("mousedown",function(e){e.stopPropagation()}).on("keyup",function(e){var o=this.value;a.val(o),s&&i.$apply(s.$setViewValue(o)),e.stopPropagation(),e.preventDefault()}),a.on("keyup",function(){T.val(a.val())})}var C=function(){e.on("mousemove",I),e.on("mouseup",M)};"rgba"===p&&(x.addClass("alpha"),c=x.find("colorpicker-alpha"),c.on("click",function(e){n.setAlpha(e,h),I(e)}).on("mousedown",function(e){n.setAlpha(e,h),C()})),y.on("click",function(e){n.setHue(e,h),I(e)}).on("mousedown",function(e){n.setHue(e,h),C()}),L.on("click",function(e){n.setSaturation(e,h),I(e)}).on("mousedown",function(e){n.setSaturation(e,h),C()}),h&&x.addClass("colorpicker-fixed-position"),x.addClass("colorpicker-position-"+f),"true"===d&&x.addClass("colorpicker-inline"),v.append(x),s&&(s.$render=function(){a.val(s.$viewValue)},i.$watch(l.ngModel,function(){$()})),a.on("$destroy",function(){x.remove()});var H=function(){try{S.css("backgroundColor",w[p]())}catch(e){S.css("backgroundColor",w.toHex())}L.css("backgroundColor",w.toHex(w.value.h,1,1,1)),"rgba"===p&&(c.css.backgroundColor=w.toHex())},I=function(e){var o=n.getLeftPosition(e),t=n.getTopPosition(e),r=n.getSlider();n.setKnob(t,o),r.callLeft&&w[r.callLeft].call(w,o/100),r.callTop&&w[r.callTop].call(w,t/100),H();var l=w[p]();return a.val(l),s&&i.$apply(s.$setViewValue(l)),g&&T.val(l),!1},M=function(){e.off("mousemove",I),e.off("mouseup",M)},$=function(){w.setColor(a.val()),P.eq(0).css({left:100*w.value.s+"px",top:100-100*w.value.b+"px"}),P.eq(1).css("top",100*(1-w.value.h)+"px"),P.eq(2).css("top",100*(1-w.value.a)+"px"),H()},A=function(){var e,o=r.getOffset(a[0]);return angular.isDefined(l.colorpickerParent)&&(o.left=0,o.top=0),"top"===f?e={top:o.top-147+u.y,left:o.left+u.x}:"right"===f?e={top:o.top+u.y,left:o.left+126+u.x}:"bottom"===f?e={top:o.top+a[0].offsetHeight+2+u.y,left:o.left+u.x}:"left"===f?e={top:o.top+u.y,left:o.left-150+u.x}:"sceneToobar"===f&&(e={top:o.top+u.y-110,left:o.left-150+u.x+40}),{top:e.top+"px",left:e.left+"px"}},B=function(){F()};d===!1?a.on("click",function(){$(),x.addClass("colorpicker-visible").css(A()),e.on("mousedown",B)}):($(),x.addClass("colorpicker-visible").css(A())),x.on("mousedown",function(e){e.stopPropagation(),e.preventDefault()});var D=function(e){s&&i.$emit(e,{name:l.ngModel,value:s.$modelValue})},F=function(){x.hasClass("colorpicker-visible")&&(x.removeClass("colorpicker-visible"),D("colorpicker-closed"),e.off("mousedown",B))};x.find("button").on("click",function(){F()})}}}]);